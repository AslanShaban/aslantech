<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>تطبيق إدارة الأعمال الشامل</title>
	<script src="https://cdn.tailwindcss.com"></script>
    <meta name="theme-color" content="#0ea5e9">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
	
	<!-- مكتبات خارجية -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
	<style>
		@import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');
		:root {
			--background-primary: #f8fafc;
			--background-secondary: #ffffff;
            --background-secondary-hover: #f1f5f9;
			--text-primary: #1e293b;
			--text-secondary: #64748b;
			--accent-primary: #0ea5e9;
			--accent-primary-hover: #0284c7;
			--shadow-color: rgba(0, 0, 0, 0.07);
            --border-color: #e2e8f0;
		}
		body {
			font-family: 'Cairo', sans-serif;
			background-color: var(--background-primary);
			color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
		}
		.container {
			max-width: 1600px;
			margin: 0 auto;
			padding: 1rem;
		}
		@media (min-width: 640px) {
			.container {
				padding: 2rem;
			}
		}
		.dashboard-card, .form-section, .data-table-wrapper, .settings-card {
			background-color: var(--background-secondary);
			border-radius: 1rem;
			box-shadow: 0 4px 6px -1px var(--shadow-color), 0 2px 4px -2px var(--shadow-color);
			padding: 1.5rem;
			transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s;
		}
		.dashboard-card:hover {
			transform: translateY(-5px);
			box-shadow: 0 10px 15px -3px var(--shadow-color), 0 4px 6px -4px var(--shadow-color);
		}
        .dashboard-card.sortable-ghost {
            background: rgba(14, 165, 233, 0.2);
            border: 2px dashed var(--accent-primary);
        }
        .dashboard-card .handle { cursor: grab; }
        .dashboard-card .handle:active { cursor: grabbing; }

		.form-section, .settings-card {
			margin-bottom: 2rem;
		}
		.data-table-container {
			overflow-x: auto;
			max-height: 280px; /* This is key for independent scrolling */
			overflow-y: auto; /* This is key for independent scrolling */
		}
		.data-table {
			width: 100%;
			border-collapse: collapse;
		}
		.data-table th, .data-table td {
			padding: 1rem;
			text-align: right;
			border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
		}
        .data-table td.allow-wrap, .data-table th.allow-wrap {
			white-space: normal;
			min-width: 150px; /* Provide a minimum width for wrapped content */
		}
		.data-table thead {
            border-bottom: 2px solid var(--border-color);
		}
		.data-table th {
			background-color: var(--background-secondary);
			color: var(--text-primary);
			font-weight: 700;
			position: sticky;
			top: 0;
			z-index: 10;
            box-shadow: 0 2px 2px -1px var(--shadow-color); 
		}
		.data-table tbody tr {
			transition: background-color 0.2s ease;
		}
		.data-table tbody tr:hover {
			background-color: var(--background-secondary-hover);
		}
		.btn {
			padding: 0.6rem 1.25rem;
			border-radius: 0.75rem;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.2s ease-in-out;
			display: inline-flex;
			align-items: center;
			justify-content: center;
			gap: 0.5rem;
			border: 1px solid transparent;
			box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
		}
		.btn:disabled {
			opacity: 0.6;
			cursor: not-allowed;
		}
		.btn-primary {
			background-color: var(--accent-primary);
			color: #ffffff;
		}
		.btn-primary:hover:not(:disabled) {
			background-color: var(--accent-primary-hover);
			transform: translateY(-2px);
			box-shadow: 0 4px 8px rgba(2, 132, 199, 0.2);
		}
		.btn-danger { background-color: #ef4444; color: #ffffff; }
		.btn-danger:hover:not(:disabled) { background-color: #dc2626; }
		.btn-edit { background-color: #f59e0b; color: #ffffff; }
		.btn-edit:hover:not(:disabled) { background-color: #d97706; }
		.input, .select {
			width: 100%;
			padding: 0.75rem 1rem;
			border-radius: 0.75rem;
			border: 1px solid var(--border-color);
			margin-top: 0.25rem;
			transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.3s, color 0.3s;
			background-color: var(--background-secondary);
			color: var(--text-primary);
		}
		.input:focus, .select:focus {
			outline: none;
			border-color: var(--accent-primary);
			box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2);
		}
		.tab-btn {
			padding: 0.75rem 1.5rem;
			font-weight: 600;
			border-radius: 0.75rem;
			transition: all 0.3s ease;
			color: var(--text-secondary);
			border-bottom: 3px solid transparent;
		}
		.tab-btn.active {
			color: var(--accent-primary);
			border-bottom-color: var(--accent-primary);
		}
		.tab-btn:not(.active):hover {
			color: var(--text-primary);
		}
		#nav-tabs {
			border-bottom: 1px solid var(--border-color);
            overflow-y: auto;
            max-height: calc(100vh - 80px); /* Adjust based on header height */
		}
        #main-content {
            transition: margin-right 0.3s ease;
        }
        body.sidebar-active #main-content {
            margin-right: 16rem; /* Same as sidebar width */
        }
        #sidebar {
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }
        body.sidebar-active #sidebar {
            transform: translateX(0);
        }
        .tab-btn {
            justify-content: flex-start;
            text-align: right;
            border-bottom: none;
            border-right: 4px solid transparent;
            border-radius: 0.5rem;
        }
        .tab-btn.active {
            color: var(--accent-primary);
            background-color: var(--background-secondary-hover);
            border-right-color: var(--accent-primary);
        }
		#invoice-view-modal, #quotation-view-modal {
			max-height: 90vh;
			overflow-y: auto;
		}
		.report-kpi-card-new {
			background-image: linear-gradient(135deg, var(--tw-gradient-stops));
			color: white;
			border-radius: 1rem;
			padding: 1.5rem;
			display: flex;
			flex-direction: column;
			justify-content: space-between;
			min-height: 140px;
		}
		.report-table {
			width: 100%;
			border-collapse: collapse;
			margin-top: 1rem;
		}
		.report-table th, .report-table td {
			padding: 0.75rem 1rem;
			border: 1px solid var(--border-color);
			white-space: nowrap;
		}
		.report-table thead th {
			background-color: var(--background-secondary-hover);
			font-weight: bold;
		}
		.report-table tbody tr:nth-of-type(even) {
			background-color: var(--background-primary);
		}
		.copy-btn {
			background-color: var(--background-secondary-hover);
			border: 1px solid var(--border-color);
			padding: 0.25rem 0.5rem;
			font-size: 0.75rem;
			cursor: pointer;
			border-radius: 0.5rem;
		}
		.copy-btn:hover {
			background-color: var(--border-color);
		}
		.table-header-bar {
			border-bottom: 1px solid var(--border-color);
		}
        @media (max-width: 767px) {
            .dashboard-card, .form-section, .data-table-wrapper, .settings-card {
                padding: 1rem;
            }
            .data-table th, .data-table td {
                padding: 0.5rem 0.75rem;
            }
            h2 {
                font-size: 1.25rem; /* text-xl */
            }
            h3 {
                font-size: 1.125rem; /* text-lg */
            }
			#nav-tabs {
				flex-direction: row;
				overflow-x: auto;
				padding: 0.5rem;
				gap: 0.5rem;
			}
			.tab-btn {
				flex-direction: column;
				gap: 0.25rem;
				padding: 0.5rem;
				border-right: none;
				border-bottom: 4px solid transparent;
			}
			.tab-btn i { width: auto; }
			.tab-btn.active {
				border-bottom-color: var(--accent-primary);
				border-right-color: transparent;
			}
        }
	</style>
</head>
<body class="bg-slate-50">
	
	<!-- شاشة تسجيل الدخول -->
	<div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-100">
		<div class="w-full max-w-sm p-8 space-y-6 bg-white rounded-xl shadow-lg text-center">
			<h2 class="text-3xl font-bold text-sky-600">تسجيل الدخول</h2>
			<p class="text-slate-500">أهلاً بك مجدداً! الرجاء إدخال بياناتك.</p>
			<form id="login-form">
				<div class="mb-4 text-right">
					<label for="username" class="block mb-2 font-semibold text-slate-700">البريد الإلكتروني</label>
					<input type="email" id="username" class="input" required autocomplete="email">
				</div>
				<div class="mb-6 text-right">
					<label for="password" class="block mb-2 font-semibold text-slate-700">كلمة المرور</label>
					<input type="password" id="password" class="input" required autocomplete="current-password">
				</div>
				 <p id="login-error" class="text-red-500 mb-4 hidden">البريد الإلكتروني أو كلمة المرور غير صحيحة.</p>
				<button type="submit" class="w-full text-lg btn btn-primary">دخول</button>
                <div class="mt-4">
                    <a href="#" id="forgot-password-link" class="text-sm text-sky-600 hover:underline">هل نسيت كلمة المرور؟</a>
                </div>
			</form>
		</div>
	</div>

	<!-- حاوية التطبيق الرئيسية -->
    <div id="app-container" class="hidden md:flex bg-slate-50">
        <!-- Sidebar -->
        <aside id="sidebar" class="bg-white shadow-lg w-64 transition-transform duration-300 ease-in-out z-40 fixed top-0 right-0 h-full">
            <div class="p-5 flex items-center justify-center gap-3 border-b">
                <img id="header-logo" src="" alt="شعار الشركة" class="h-14 max-h-14 object-contain hidden">
                <i id="header-default-icon" class="fas fa-tasks text-3xl text-sky-500"></i>
                <h1 class="text-lg font-bold text-sky-600" id="header-company-name">إدارة الأعمال</h1>
            </div>
            <nav id="nav-tabs" class="flex flex-col p-4 space-y-2">
                <button class="tab-btn active" data-tab="dashboard"><i class="fas fa-tachometer-alt w-6"></i> الرئيسية</button>
                <button class="tab-btn" data-tab="products"><i class="fas fa-boxes w-6"></i> المستودعات</button>
                <button class="tab-btn" data-tab="sales"><i class="fas fa-chart-line w-6"></i> المبيعات</button>
                <button class="tab-btn" data-tab="purchases"><i class="fas fa-shopping-cart w-6"></i> المشتريات</button>
                <button class="tab-btn" data-tab="returns"><i class="fas fa-undo w-6"></i> المرتجعات</button>
                <button class="tab-btn" data-tab="expenses"><i class="fas fa-wallet w-6"></i> المصاريف</button>
                <button class="tab-btn" data-tab="customers"><i class="fas fa-users w-6"></i> العملاء</button>
                <button class="tab-btn" data-tab="suppliers"><i class="fas fa-truck w-6"></i> الموردين</button>
                <button class="tab-btn" data-tab="quotations"><i class="fas fa-file-invoice w-6"></i> عروض الأسعار</button>
                <button class="tab-btn" data-tab="invoices"><i class="fas fa-file-invoice-dollar w-6"></i> الفواتير</button>
                <button class="tab-btn" data-tab="reports"><i class="fas fa-chart-pie w-6"></i> التقارير</button>
                <button class="tab-btn" data-tab="activity_log" id="activity-log-tab-btn" style="display: none;"><i class="fas fa-history w-6"></i> سجل النشاط</button>
                <button class="tab-btn" data-tab="settings" id="settings-tab-btn"><i class="fas fa-cog w-6"></i> الإعدادات</button>
            </nav>
        </aside>

        <!-- Main Content -->
        <div id="main-content" class="flex-1 flex flex-col h-screen">
            <header class="bg-white shadow-md p-4 flex justify-between items-center">
                <button id="menu-toggle" class="btn btn-primary">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="flex items-center gap-4">
                    <div id="user-info" class="text-right">
                        <p id="user-email" class="font-semibold hidden sm:block text-slate-700"></p>
                        <p id="user-role-display" class="text-sm font-bold text-sky-600"></p>
                    </div>
                    <button id="logout-btn" class="btn btn-danger">
                        <i class="fas fa-sign-out-alt"></i>
                        <span class="hidden sm:inline">تسجيل الخروج</span>
                    </button>
                </div>
            </header>

            <main class="flex-1 p-4 sm:p-8 overflow-y-auto">
		        <!-- محتوى التبويبات -->
		        <div id="tab-content">
			<!-- تبويب الرئيسية -->
			<div id="dashboard" class="tab-pane">
				<div class="form-section">
					<h3 class="text-2xl font-semibold mb-4">عرض بيانات يوم محدد</h3>
					<form id="dashboard-date-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
						<div>
							<label for="dashboard-date" class="text-slate-600 mb-1">تحديد التاريخ</label>
							<input type="date" id="dashboard-date" class="input">
						</div>
						<button type="submit" class="btn btn-primary w-full md:w-auto">عرض البيانات</button>
					</form>
				</div>
				<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8" id="dashboard-metrics">
					<div class="dashboard-card" data-id="total-sales-card">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-lg font-bold">إجمالي المبيعات (اليوم)</p>
                                <p class="text-3xl font-extrabold" id="total-sales">0</p>
                            </div>
							<div class="flex items-center gap-4">
								<i class="fas fa-chart-line text-4xl text-sky-500 opacity-50"></i>
								<i class="fas fa-arrows-alt handle text-slate-400 cursor-grab" title="تحريك"></i>
							</div>
                        </div>
                    </div>
					<div class="dashboard-card" data-id="total-purchases-card">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-lg font-bold">إجمالي المشتريات (اليوم)</p>
                                <p class="text-3xl font-extrabold" id="total-purchases">0</p>
                            </div>
                            <div class="flex items-center gap-4">
								<i class="fas fa-shopping-cart text-4xl text-green-500 opacity-50"></i>
								<i class="fas fa-arrows-alt handle text-slate-400 cursor-grab" title="تحريك"></i>
							</div>
                        </div>
                    </div>
					<div class="dashboard-card" data-id="total-expenses-card">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-lg font-bold">إجمالي المصاريف (اليوم)</p>
                                <p class="text-3xl font-extrabold" id="total-expenses">0</p>
                            </div>
							<div class="flex items-center gap-4">
								<i class="fas fa-wallet text-4xl text-yellow-500 opacity-50"></i>
								<i class="fas fa-arrows-alt handle text-slate-400 cursor-grab" title="تحريك"></i>
							</div>
                        </div>
                    </div>
					<div class="dashboard-card" data-id="net-profit-card">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-lg font-bold">الربح الصافي (اليوم)</p>
                                <p class="text-3xl font-extrabold" id="net-profit">0</p>
                            </div>
							<div class="flex items-center gap-4">
								<i class="fas fa-money-bill-wave text-4xl text-purple-500 opacity-50"></i>
								<i class="fas fa-arrows-alt handle text-slate-400 cursor-grab" title="تحريك"></i>
							</div>
                        </div>
                    </div>
					<div class="dashboard-card" data-id="remaining-fund-card">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-lg font-bold">صافي الصندوق (اليوم)</p>
                                <p class="text-3xl font-extrabold" id="remaining-fund">0</p>
                            </div>
							<div class="flex items-center gap-4">
								<i class="fas fa-cash-register text-4xl text-teal-500 opacity-50"></i>
								<i class="fas fa-arrows-alt handle text-slate-400 cursor-grab" title="تحريك"></i>
							</div>
                        </div>
                    </div>
                    <div class="dashboard-card md:col-span-2 lg:col-span-1" data-id="profitable-products-card">
						<div class="flex justify-between items-center">
							<h4 class="font-bold mb-2">المنتجات الأكثر ربحاً</h4>
							<i class="fas fa-arrows-alt handle text-slate-400 cursor-grab" title="تحريك"></i>
						</div>
                        <div id="most-profitable-products">
                            <p class="text-sm text-slate-500">لا توجد بيانات كافية.</p>
                        </div>
                    </div>
				</div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="dashboard-card">
                        <h3 class="text-xl font-semibold mb-4">مقارنة المبيعات الشهرية (آخر 6 أشهر)</h3>
                        <canvas id="monthly-sales-chart"></canvas>
                    </div>
                    <div class="dashboard-card">
                        <h3 class="text-xl font-semibold mb-4">مؤشرات الأداء الرئيسية</h3>
                        <div id="kpi-container" class="space-y-4">
                            <!-- KPIs will be injected here -->
                        </div>
                    </div>
                </div>
			</div>

			<!-- تبويب المستودع (المنتجات) -->
			<div id="products" class="tab-pane hidden">
				<h2 class="text-3xl font-bold mb-6 text-center text-slate-800">إدارة المنتجات</h2>
                <div class="mb-6 flex justify-end">
                    <button id="show-add-product-modal-btn" class="btn btn-primary add-btn-disabled" disabled><i class="fas fa-plus mr-2"></i>إضافة منتج جديد</button>
                </div>
				
				<div class="data-table-wrapper mt-8">
					<div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6 text-center">
						<div class="p-4 bg-sky-50 rounded-lg">
							<h4 class="text-sm font-semibold text-sky-800">إجمالي المنتجات</h4>
							<p id="stats-total-products" class="text-2xl font-bold text-sky-900">0</p>
						</div>
						<div class="p-4 bg-green-50 rounded-lg">
							<h4 class="text-sm font-semibold text-green-800">قيمة المخزون</h4>
							<p id="stats-stock-value" class="text-2xl font-bold text-green-900">0</p>
						</div>
						<div class="p-4 bg-yellow-50 rounded-lg">
							<h4 class="text-sm font-semibold text-yellow-800">منخفض المخزون</h4>
							<p id="stats-low-stock" class="text-2xl font-bold text-yellow-900">0</p>
						</div>
						<div class="p-4 bg-red-50 rounded-lg">
							<h4 class="text-sm font-semibold text-red-800">منتجات نافدة</h4>
							<p id="stats-out-of-stock" class="text-2xl font-bold text-red-900">0</p>
						</div>
					</div>
					<div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-4 pb-4 table-header-bar">
						<div class="flex flex-col sm:flex-row gap-4 w-full md:w-auto">
							<div class="relative w-full sm:w-64">
								<span class="absolute inset-y-0 left-0 flex items-center pl-3"><i class="fas fa-search text-slate-400"></i></span>
								<input type="text" id="product-search-input" class="w-full pl-10 input" placeholder="ابحث بالاسم...">
							</div>
							<div class="relative w-full sm:w-64">
								<span class="absolute inset-y-0 left-0 flex items-center pl-3"><i class="fas fa-warehouse text-slate-400"></i></span>
							   <select id="warehouse-filter" class="w-full pl-10 select">
								   <option value="">كل المستودعات</option>
							   </select>
						   </div>
							<div class="relative w-full sm:w-64">
								 <span class="absolute inset-y-0 left-0 flex items-center pl-3"><i class="fas fa-filter text-slate-400"></i></span>
								<select id="product-supplier-filter" class="w-full pl-10 select">
									<option value="">فلترة حسب المورد</option>
								</select>
							</div>
                            <div class="relative w-full sm:w-64">
                                 <span class="absolute inset-y-0 left-0 flex items-center pl-3"><i class="fas fa-tags text-slate-400"></i></span>
                                <select id="product-category-filter" class="w-full pl-10 select">
                                    <option value="">فلترة حسب النوع</option>
                                </select>
                            </div>
						</div>
						<div class="flex flex-wrap justify-end items-center gap-2">
							<button id="delete-selected-products-btn" class="btn btn-danger" disabled><i class="fas fa-trash-alt"></i><span>حذف المحدد</span></button>
							<label class="btn bg-green-600 hover:bg-green-700 text-white cursor-pointer"><i class="fas fa-file-excel"></i><span>استيراد</span><input type="file" id="import-products-excel" class="hidden" accept=".xlsx, .xls, .csv"></label>
							<button id="export-products-btn" class="btn bg-sky-600 hover:bg-sky-700 text-white"><i class="fas fa-file-download"></i><span>تصدير Excel</span></button>
						</div>
					</div>
					<div class="data-table-container">
						<table class="data-table" id="products-table-export">
							<thead>
								<tr>
									<th class="no-export"><input type="checkbox" id="select-all-products"></th>
									<th>الاسم</th>
									<th>نوع المنتج</th>
									<th>المستودع</th>
									<th>سعر التكلفة</th>
									<th>الكمية</th>
									<th>المورد</th>
									<th class="no-export">الإجراءات</th>
								</tr>
							</thead>
							<tbody id="products-table"></tbody>
						</table>
					</div>
				</div>
			</div>

			<!-- تبويب المبيعات -->
			<div id="sales" class="tab-pane hidden">
				<h2 class="text-3xl font-bold text-slate-800 mb-6 text-center">إدارة المبيعات</h2>
                <div class="mb-6 flex justify-end">
                    <button id="show-add-sale-modal-btn" class="btn btn-primary add-btn-disabled" disabled><i class="fas fa-plus mr-2"></i>إضافة عملية بيع</button>
                </div>
				<div class="data-table-wrapper mt-8">
					<div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-4 pb-4 table-header-bar">
						<h3 class="text-2xl font-semibold">سجل المبيعات</h3>
						<form id="sales-filter-form" class="flex flex-wrap items-end gap-2">
							<input type="date" id="sales-filter-date" class="input text-sm p-2 w-48">
							<button type="submit" class="btn btn-primary text-sm">عرض</button>
							<button type="button" id="sales-clear-filter" class="btn bg-slate-300 text-sm">عرض الكل</button>
						</form>
						<div class="flex flex-wrap gap-2">
							<button id="export-sales-btn" class="btn btn-primary bg-sky-500 hover:bg-sky-600"><i class="fas fa-file-excel"></i> تصدير Excel</button>
						</div>
					</div>
					<div class="data-table-container">
						<table class="data-table" id="sales-table-export">
							<thead>
								<tr>
									<th>التاريخ</th>
									<th>النوع</th>
									<th>الاسم/المنتج</th>
									<th>المستودع</th>
									<th>الكمية</th>
									<th>العميل</th>
									<th>المبلغ</th>
									<th class="no-export">الإجراءات</th>
								</tr>
							</thead>
							<tbody id="sales-table"></tbody>
						</table>
					</div>
				</div>
			</div>

			<!-- تبويب المرتجعات -->
			<div id="returns" class="tab-pane hidden">
				<h2 class="text-3xl font-bold text-slate-800 mb-6 text-center">إدارة المرتجعات</h2>
                <div class="mb-6 flex justify-end">
                    <button id="show-add-return-modal-btn" class="btn btn-primary add-btn-disabled" disabled><i class="fas fa-plus mr-2"></i>إضافة عملية إرجاع</button>
                </div>
				<div class="data-table-wrapper mt-8">
					<div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-4 pb-4 table-header-bar">
						<h3 class="text-2xl font-semibold">سجل المرتجعات</h3>
						<div class="flex flex-wrap gap-2">
							<button id="export-returns-btn" class="btn btn-primary bg-sky-500 hover:bg-sky-600"><i class="fas fa-file-excel"></i> تصدير Excel</button>
						</div>
					</div>
					<div class="data-table-container">
						<table class="data-table" id="returns-table-export">
							<thead>
								<tr>
									<th>التاريخ</th>
									<th>المنتج</th>
									<th>المستودع</th>
									<th>الكمية</th>
									<th>السبب</th>
									<th class="no-export">الإجراءات</th>
								</tr>
							</thead>
							<tbody id="returns-table"></tbody>
						</table>
					</div>
				</div>
			</div>

			<!-- تبويب المشتريات -->
			<div id="purchases" class="tab-pane hidden">
				<h2 class="text-3xl font-bold text-slate-800 mb-6 text-center">إدارة المشتريات (المصروفات)</h2>
				<div class="mb-6 flex justify-end">
					<button id="show-add-purchase-modal-btn" class="btn btn-primary add-btn-disabled" disabled><i class="fas fa-plus mr-2"></i>إضافة عملية شراء</button>
				</div>
				<div class="data-table-wrapper mt-8">
					<div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-4 pb-4 table-header-bar">
						<h3 class="text-2xl font-semibold">سجل المشتريات</h3>
						<form id="purchases-filter-form" class="flex flex-wrap items-end gap-2">
							<input type="date" id="purchases-filter-date" class="input text-sm p-2 w-48">
							<button type="submit" class="btn btn-primary text-sm">عرض</button>
							<button type="button" id="purchases-clear-filter" class="btn bg-slate-300 text-sm">عرض الكل</button>
						</form>
						<div class="flex flex-wrap gap-2">
							<button id="export-purchases-btn" class="btn btn-primary bg-sky-500 hover:bg-sky-600"><i class="fas fa-file-excel"></i> تصدير Excel</button>
						</div>
					</div>
					<div class="data-table-container">
						<table class="data-table" id="purchases-table-export">
							<thead>
								<tr>
									<th>التاريخ</th>
									<th>البند</th>
									<th>المورد</th>
									<th>المبلغ</th>
									<th class="no-export">الإجراءات</th>
								</tr>
							</thead>
							<tbody id="purchases-table"></tbody>
						</table>
					</div>
				</div>
			</div>

			<!-- تبويب المصاريف -->
			<div id="expenses" class="tab-pane hidden">
				<h2 class="text-3xl font-bold text-slate-800 mb-6 text-center">إدارة المصاريف</h2>
                <div class="mb-6 flex justify-end">
                    <button id="show-add-expense-modal-btn" class="btn btn-primary add-btn-disabled" disabled><i class="fas fa-plus mr-2"></i>إضافة مصروف جديد</button>
                </div>
				<div class="data-table-wrapper mt-8">
					<div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-4 pb-4 table-header-bar">
						<h3 class="text-2xl font-semibold">سجل المصاريف</h3>
						<form id="expenses-filter-form" class="flex flex-wrap items-end gap-2">
							<input type="date" id="expenses-filter-date" class="input text-sm p-2 w-48">
							<button type="submit" class="btn btn-primary text-sm">عرض</button>
							<button type="button" id="expenses-clear-filter" class="btn bg-slate-300 text-sm">عرض الكل</button>
						</form>
						<div class="flex flex-wrap gap-2">
							<button id="export-expenses-btn" class="btn btn-primary bg-sky-500 hover:bg-sky-600"><i class="fas fa-file-excel"></i> تصدير Excel</button>
						</div>
					</div>
					<div class="data-table-container">
						<table class="data-table" id="expenses-table-export">
							<thead>
								<tr>
									<th>التاريخ</th>
									<th>النوع</th>
									<th>المبلغ</th>
									<th>الوصف</th>
									<th class="no-export">الإجراءات</th>
								</tr>
							</thead>
							<tbody id="expenses-table"></tbody>
						</table>
					</div>
				</div>
			</div>

			<!-- تبويب العملاء -->
			<div id="customers" class="tab-pane hidden">
				<h2 class="text-3xl font-bold text-slate-800 mb-6 text-center">إدارة العملاء</h2>
                <div class="mb-6 flex justify-end">
                    <button id="show-add-customer-modal-btn" class="btn btn-primary add-btn-disabled" disabled><i class="fas fa-plus mr-2"></i>إضافة عميل جديد</button>
                </div>
				<div class="data-table-wrapper mt-8">
					<div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-4 pb-4 table-header-bar">
						<h3 class="text-2xl font-semibold">قائمة العملاء</h3>
						<div class="flex flex-wrap gap-2">
							<button id="export-customers-btn" class="btn btn-primary bg-sky-500 hover:bg-sky-600"><i class="fas fa-file-excel"></i> تصدير Excel</button>
						</div>
					</div>
					<div class="data-table-container">
						<table class="data-table" id="customers-table-export">
							<thead>
								<tr>
									<th>الاسم</th>
									<th>رقم الهاتف</th>
									<th>البريد الإلكتروني</th>
                                    <th>نقاط الولاء</th>
									<th>العنوان</th>
									<th class="no-export">الإجراءات</th>
								</tr>
							</thead>
							<tbody id="customers-table"></tbody>
						</table>
					</div>
				</div>
			</div>

			<!-- تبويب الموردين -->
			<div id="suppliers" class="tab-pane hidden">
				 <h2 class="text-3xl font-bold text-slate-800 mb-6 text-center">إدارة الموردين</h2>
                 <div class="mb-6 flex justify-end">
                    <button id="show-add-supplier-modal-btn" class="btn btn-primary add-btn-disabled" disabled><i class="fas fa-plus mr-2"></i>إضافة مورد جديد</button>
                </div>
				<div class="data-table-wrapper mt-8">
					<div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-4 pb-4 table-header-bar">
						<h3 class="text-2xl font-semibold">قائمة الموردين</h3>
						<div class="flex flex-wrap gap-2">
							<button id="export-suppliers-btn" class="btn btn-primary bg-sky-500 hover:bg-sky-600"><i class="fas fa-file-excel"></i> تصدير Excel</button>
						</div>
					</div>
					<div class="data-table-container">
						<table class="data-table" id="suppliers-table-export">
							<thead>
								<tr>
									<th>ID المورد <span class="text-xs text-slate-400">(للاستيراد)</span></th>
									<th>الاسم</th>
									<th>رقم الهاتف</th>
									<th>البريد الإلكتروني</th>
									<th>العنوان</th>
									<th class="no-export">الإجراءات</th>
								</tr>
							</thead>
							<tbody id="suppliers-table"></tbody>
						</table>
					</div>
				</div>
			</div>

			<!-- تبويب عروض الأسعار -->
			<div id="quotations" class="tab-pane hidden">
				<h2 class="text-3xl font-bold text-slate-800 mb-6 text-center">إدارة عروض الأسعار</h2>
                <div class="mb-6 flex justify-end">
                    <button id="show-add-quotation-modal-btn" class="btn btn-primary add-btn-disabled" disabled><i class="fas fa-plus mr-2"></i>إضافة عرض سعر</button>
                </div>
				<div class="data-table-wrapper mt-8">
					<div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-4 pb-4 table-header-bar">
						<h3 class="text-2xl font-semibold">قائمة عروض الأسعار</h3>
						<div class="flex flex-wrap gap-2">
							<button id="export-quotations-btn" class="btn btn-primary bg-sky-500 hover:bg-sky-600"><i class="fas fa-file-excel"></i> تصدير Excel</button>
						</div>
					</div>
					<div class="data-table-container">
						<table class="data-table" id="quotations-table-export">
							<thead>
								<tr>
									<th>رقم العرض</th>
									<th>التاريخ</th>
									<th>العميل</th>
									<th>المبلغ الإجمالي</th>
									<th>الخصم</th>
                                    <th>الضريبة</th>
									<th>تاريخ الانتهاء</th>
									<th>الحالة</th>
									<th class="no-export">الإجراءات</th>
								</tr>
							</thead>
							<tbody id="quotations-table"></tbody>
						</table>
					</div>
				</div>
			</div>

			<!-- تبويب الفواتير -->
			<div id="invoices" class="tab-pane hidden">
				 <h2 class="text-3xl font-bold text-slate-800 mb-6 text-center">إدارة الفواتير</h2>
                 <div class="mb-6 flex justify-end">
                    <button id="show-add-invoice-modal-btn" class="btn btn-primary add-btn-disabled" disabled><i class="fas fa-plus mr-2"></i>إضافة فاتورة</button>
                </div>
				<div class="data-table-wrapper mt-8">
					<div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-4 pb-4 table-header-bar">
						<h3 class="text-2xl font-semibold">قائمة الفواتير</h3>
						<form id="invoice-export-form" class="grid grid-cols-1 sm:grid-cols-2 gap-2 items-end">
							<div>
								<label for="invoice-start-date" class="text-xs">من تاريخ</label>
								<input type="date" id="invoice-start-date" class="p-2 text-sm input">
							</div>
							<div>
								<label for="invoice-end-date" class="text-xs">إلى تاريخ</label>
								<input type="date" id="invoice-end-date" class="p-2 text-sm input">
							</div>
							<div class="flex gap-2 col-span-full sm:col-span-auto">
								<button type="button" id="export-invoices-excel-btn" class="w-full text-sm btn btn-primary bg-green-600 hover:bg-green-700"><i class="fas fa-file-excel"></i> تصدير Excel</button>
							</div>
						</form>
					</div>
					<div class="data-table-container">
						<table class="data-table" id="invoices-table-export">
							<thead>
								<tr>
									<th>رقم الفاتورة</th>
									<th>التاريخ</th>
									<th>العميل</th>
									<th>المبلغ الإجمالي</th>
									<th class="no-export">الإجراءات</th>
								</tr>
							</thead>
							<tbody id="invoices-table"></tbody>
						</table>
					</div>
				</div>
			</div>

			<!-- تبويب التقارير -->
			  <div id="reports" class="tab-pane hidden">
				  <h2 class="text-3xl font-bold text-slate-800 mb-6 text-center">التقارير المتقدمة</h2>
				  <div class="form-section no-print">
					  <h3 class="text-2xl font-semibold">تحديد فترة التقرير</h3>
					  <form id="reports-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end mt-4">
						  <div class="flex flex-col">
							  <label for="start-date" class="text-slate-600 mb-1">تاريخ البدء</label>
							  <input type="date" id="start-date" class="input" required>
						  </div>
						  <div class="flex flex-col">
							  <label for="end-date" class="text-slate-600 mb-1">تاريخ الانتهاء</label>
							  <input type="date" id="end-date" class="input" required>
						  </div>
						  <button type="submit" class="btn btn-primary w-full">عرض التقرير</button>
					  </form>
				  </div>
				  
				  <div id="report-results" class="hidden">
					  <div id="printable-content">
						  <!-- بداية رأس التقرير -->
						  <div class="p-6 mb-6 bg-white rounded-lg shadow-md">
							  <div class="flex justify-between items-start pb-4 border-b border-slate-200">
								  <div class="flex items-center gap-4">
                                      <div id="report-logo-container"></div>
                                      <div>
                                          <h3 class="text-2xl font-bold text-sky-600" id="report-company-name">اسم الشركة</h3>
                                          <p class="text-sm text-slate-500" id="report-company-address">عنوان الشركة</p>
                                      </div>
                                  </div>
								  <div class="text-right">
									  <h4 class="text-xl font-bold" id="report-title">تقرير الأداء</h4>
									  <p class="text-sm text-slate-500" id="report-date-range">للفترة من ... إلى ...</p>
								  </div>
							  </div>
							  <div class="flex justify-end mt-4 gap-2 no-print">
								  <button id="print-report-btn" class="btn btn-primary"><i class="fas fa-print"></i> طباعة</button>
								  <button id="export-report-pdf-btn" class="btn bg-red-500 text-white"><i class="fas fa-file-pdf"></i> تصدير PDF</button>
								  <div class="flex items-center gap-2">
									  <select id="advanced-export-type" class="p-2 text-sm select">
										  <option value="all">تقرير شامل (Excel)</option>
										  <option value="sales">تقرير المبيعات</option>
										  <option value="purchases">تقرير المشتريات</option>
										  <option value="expenses">تقرير المصاريف</option>
										  <option value="invoices">تقرير الفواتير</option>
										  <option value="profits">تقرير الأرباح</option>
										  <option value="inventory">تقرير المستودع</option>
									  </select>
									  <button id="export-advanced-report-excel-btn" class="btn bg-green-500 text-white"><i class="fas fa-file-excel"></i> تصدير</button>
								  </div>
							  </div>
						  </div>
						  	<!-- نهاية رأس التقرير -->

						  <!-- بطاقات مؤشرات الأداء الرئيسية -->
						  <div class="p-6">
							  <h4 class="text-xl font-semibold mb-4 text-slate-700">ملخص الأداء</h4>
							  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
								  <div class="report-kpi-card-new from-sky-500 to-cyan-400">
									  <div class="flex justify-between items-center">
										  <p class="font-bold">إجمالي المبيعات</p>
										  <i class="fas fa-dollar-sign text-2xl opacity-70"></i>
									  </div>
									  <p class="text-3xl font-extrabold text-right" id="report-sales">0</p>
								  </div>
								   <div class="report-kpi-card-new from-emerald-500 to-green-400">
									  <div class="flex justify-between items-center">
										  <p class="font-bold">الربح الصافي</p>
										  <i class="fas fa-chart-line text-2xl opacity-70"></i>
									  </div>
									  <p class="text-3xl font-extrabold text-right" id="report-profit">0</p>
								  </div>
								  <div class="report-kpi-card-new from-amber-500 to-yellow-400">
									  <div class="flex justify-between items-center">
										  <p class="font-bold">إجمالي المشتريات</p>
										  <i class="fas fa-shopping-cart text-2xl opacity-70"></i>
									  </div>
									  <p class="text-3xl font-extrabold text-right" id="report-purchases">0</p>
								  </div>
								  <div class="report-kpi-card-new from-rose-500 to-red-400">
									  <div class="flex justify-between items-center">
										  <p class="font-bold">إجمالي المصاريف</p>
										  <i class="fas fa-wallet text-2xl opacity-70"></i>
									  </div>
									  <p class="text-3xl font-extrabold text-right" id="report-expenses">0</p>
								  </div>
							  </div>

                              <h4 class="mt-10 text-xl font-semibold mb-4 text-slate-700">ملخص رأس المال</h4>
                              <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                                  <div class="report-kpi-card-new from-blue-500 to-indigo-400">
                                      <p class="font-bold">رأس المال الأولي</p>
                                      <p class="text-3xl font-extrabold text-right" id="report-initial-capital">0</p>
                                  </div>
                                  <div class="report-kpi-card-new from-gray-500 to-slate-400">
                                      <p class="font-bold">قيمة المخزون الحالية</p>
                                      <p class="text-3xl font-extrabold text-right" id="report-current-stock-value">0</p>
                                  </div>
                                  <div id="report-capital-growth-card" class="report-kpi-card-new">
                                      <p class="font-bold">نمو رأس المال</p>
                                      <p class="text-3xl font-extrabold text-right" id="report-capital-growth">0</p>
                                  </div>
                              </div>

							  <!-- الرسوم البيانية -->
							  <h4 class="mt-10 text-xl font-semibold mb-4 text-slate-700">تحليلات بيانية</h4>
							  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
								  <div class="dashboard-card">
									  <h4 class="text-xl font-semibold mb-4">ملخص الأداء المالي</h4>
									  <canvas id="performanceChart" style="max-height: 350px;"></canvas>
								  </div>
								  <div class="dashboard-card">
									  <h4 class="text-xl font-semibold mb-4">أعلى المبيعات (منتجات وخدمات)</h4>
									  <canvas id="salesDistributionChart" style="max-height: 350px;"></canvas>
								  </div>
							  </div>
							  
							  <!-- الجداول التفصيلية -->
							  <h4 class="mt-10 text-xl font-semibold mb-4 text-slate-700">بيانات تفصيلية</h4>
							  <div class="space-y-8">
								  <div class="dashboard-card">
									  <h4 class="text-lg font-semibold mb-4">المنتجات الأكثر مبيعاً</h4>
									  <div class="data-table-container">
										  <table class="report-table" id="top-products-table-export">
											  <thead><tr><th>المنتج</th><th>الكمية المباعة</th><th>إجمالي الأرباح</th></tr></thead>
											  <tbody id="top-products-table"></tbody>
										  </table>
									  </div>
								  </div>
								  <div class="dashboard-card">
									  <h4 class="text-lg font-semibold mb-4">أفضل العملاء</h4>
									  <div class="data-table-container">
										  <table class="report-table" id="top-customers-table-export">
											  <thead><tr><th>العميل</th><th>إجمالي المشتريات</th></tr></thead>
											  <tbody id="top-customers-table"></tbody>
										  </table>
									  </div>
								  </div>
								   <div class="dashboard-card">
									  <h4 class="text-lg font-semibold mb-4">ملخص المصاريف حسب النوع</h4>
									  <div class="data-table-container">
										  <table class="report-table" id="detailed-expenses-report-table">
											  <thead><tr><th>نوع المصروف</th><th>إجمالي المبلغ</th></tr></thead>
											  <tbody id="detailed-expenses-report-table-body"></tbody>
										  </table>
									  </div>
								  </div>
								  <div class="dashboard-card">
									  <h4 class="text-lg font-semibold mb-4">تقرير الرواتب للموظفين</h4>
									  <div class="data-table-container">
										  <table class="report-table" id="salaries-by-employee-report-table">
											  <thead>
												  <tr>
													  <th>اسم الموظف</th>
													  <th>إجمالي المبلغ المدفوع</th>
												  </tr>
											  </thead>
											  <tbody id="salaries-by-employee-report-table-body"></tbody>
										  </table>
									  </div>
								  </div>
								  <div class="dashboard-card">
									  <h4 class="text-lg font-semibold mb-4">تنبيهات نفاد المخزون (الكمية صفر)</h4>
									  <div class="data-table-container">
										  <table class="report-table" id="low-stock-table-export">
											  <thead><tr><th>المنتج</th><th>المستودع</th><th>الكمية المتبقية</th></tr></thead>
											  <tbody id="low-stock-table"></tbody>
										  </table>
									  </div>
								  </div>
							  </div>
						  </div>

					  </div>
				  </div>
			  </div>

            <!-- تبويب سجل النشاط -->
            <div id="activity_log" class="tab-pane hidden">
                <h2 class="text-3xl font-bold text-slate-800 mb-6 text-center">سجل نشاط المستخدمين</h2>
                <div class="data-table-wrapper">
					<div class="data-table-container">
						<table class="data-table">
							<thead>
								<tr>
									<th>الوقت والتاريخ</th>
									<th>المستخدم</th>
									<th>الإجراء</th>
									<th>التفاصيل</th>
								</tr>
							</thead>
							<tbody id="activity-log-table"></tbody>
						</table>
					</div>
                </div>
            </div>


			<!-- تبويب الإعدادات -->
			<div id="settings" class="tab-pane hidden">
				<h2 class="text-3xl font-bold text-slate-800 mb-6 text-center">الإعدادات</h2>
				 <div class="settings-card">
					 <h3 class="text-2xl font-semibold mb-4 border-b pb-2">معلومات الشركة والإعدادات المالية</h3>
					 <form id="settings-form" class="space-y-4">
						 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
							 <div>
								 <label for="setting-company-name" class="block mb-1 font-semibold text-slate-700">اسم الشركة</label>
								 <input type="text" id="setting-company-name" class="input">
							 </div>
							 <div>
								 <label for="setting-company-phone" class="block mb-1 font-semibold text-slate-700">الهاتف</label>
								 <input type="text" id="setting-company-phone" class="input">
							 </div>
						 </div>
						 <div>
							 <label for="setting-company-address" class="block mb-1 font-semibold text-slate-700">العنوان</label>
							 <input type="text" id="setting-company-address" class="input">
						 </div>
						  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
							 <div>
								 <label for="setting-currency" class="block mb-1 font-semibold text-slate-700">رمز العملة</label>
								 <input type="text" id="setting-currency" class="input" placeholder="e.g., JOD, USD, SAR">
							 </div>
							 <div>
								 <label for="setting-initial-fund" class="block mb-1 font-semibold text-slate-700">رأس مال الصندوق الأولي</label>
								 <input type="number" step="0.01" id="setting-initial-fund" class="input">
							 </div>
						 </div>
                         <div>
                             <label for="setting-loyalty-points" class="block mb-1 font-semibold text-slate-700">نقاط الولاء (نقطة لكل X مبلغ)</label>
                             <input type="number" step="1" id="setting-loyalty-points" class="input" placeholder="مثال: 10 (نقطة لكل 10 دنانير)">
                         </div>
						 <div class="text-left">
							 <button type="submit" class="btn btn-primary">حفظ الإعدادات</button>
						 </div>
					 </form>
                     <div class="mt-6 pt-4 border-t">
                         <label for="setting-company-logo" class="block mb-2 font-semibold text-slate-700">شعار الشركة</label>
                         <input type="file" id="setting-company-logo" class="input" accept="image/png, image/jpeg, image/gif">
                         <div class="mt-4">
                             <img id="company-logo-preview" src="" alt="معاينة الشعار" class="max-h-32 rounded hidden bg-slate-100 p-2">
                             <button id="remove-logo-btn" class="btn btn-danger mt-2 hidden"><i class="fas fa-trash"></i> إزالة الشعار</button>
                         </div>
                     </div>
				 </div>

				 <!-- قسم إدارة المستودعات -->
				 <div id="warehouse-management-section" class="settings-card">
					<h3 class="text-2xl font-semibold mb-4 border-b pb-2">إدارة المستودعات</h3>
                    <div class="mb-6 flex justify-end">
                        <button id="show-add-warehouse-modal-btn" class="btn btn-primary add-btn-disabled" disabled><i class="fas fa-plus mr-2"></i>إضافة مستودع جديد</button>
                    </div>
					<div class="mt-8 data-table-wrapper">
						<h4 class="text-xl font-semibold mb-4">قائمة المستودعات</h4>
						<div class="data-table-container">
							<table class="data-table">
								<thead>
									<tr>
										<th>الاسم</th>
                                        <th>الموقع</th>
                                        <th>الموظف المسؤول</th>
                                        <th>رقم الهاتف</th>
										<th class="no-export">الإجراءات</th>
									</tr>
								</thead>
								<tbody id="warehouses-table"></tbody>
							</table>
						</div>
					</div>
				</div>

                <!-- قسم إدارة أنواع المنتجات -->
                <div id="product-types-management-section" class="settings-card">
                    <h3 class="text-2xl font-semibold mb-4 border-b pb-2">إدارة أنواع المنتجات</h3>
                    <div class="mb-6 flex justify-end">
                        <button id="show-add-product-type-modal-btn" class="btn btn-primary add-btn-disabled" disabled><i class="fas fa-plus mr-2"></i>إضافة نوع جديد</button>
                    </div>
                    <div class="mt-8 data-table-wrapper">
                        <h4 class="text-xl font-semibold mb-4">قائمة أنواع المنتجات</h4>
                        <div class="data-table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>الاسم</th>
                                        <th class="no-export">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="product-types-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                 <!-- قسم إدارة الموظفين - جديد -->
                 <div id="employee-management-section" class="settings-card" style="display: none;">
                     <h3 class="text-2xl font-semibold mb-4 border-b pb-2">إدارة الموظفين</h3>
                     <div class="mb-6 flex justify-end">
                        <button id="show-add-employee-modal-btn" class="btn btn-primary add-btn-disabled" disabled><i class="fas fa-plus mr-2"></i>إضافة موظف جديد</button>
                    </div>
                     <div class="mt-8 data-table-wrapper">
                         <h4 class="text-xl font-semibold mb-4">قائمة الموظفين</h4>
                         <div class="data-table-container">
                             <table class="data-table">
                                 <thead>
                                     <tr>
                                         <th>الاسم</th>
                                         <th>المسمى الوظيفي</th>
                                         <th>الرقم الوظيفي</th>
                                         <th>رقم الهاتف</th>
                                         <th>موقع العمل</th>
                                         <th class="no-export">الإجراءات</th>
                                     </tr>
                                 </thead>
                                 <tbody id="employees-table"></tbody>
                             </table>
                         </div>
                     </div>
                 </div>

				 <div id="user-management-section" class="settings-card">
					 <h3 class="text-2xl font-semibold mb-4 border-b pb-2">إدارة المستخدمين</h3>
                     <div class="mb-6 flex justify-end">
                        <button id="show-add-user-modal-btn" class="btn btn-primary add-btn-disabled" disabled><i class="fas fa-plus mr-2"></i>إضافة مستخدم جديد</button>
                    </div>
					  <div class="mt-8 data-table-container">
						  <h4 class="text-xl font-semibold mb-4">قائمة المستخدمين</h4>
						  <table class="data-table">
							  <thead>
								  <tr>
									  <th>البريد الإلكتروني</th>
									  <th>الصلاحية</th>
									  <th>الإجراءات</th>
								  </tr>
							  </thead>
							  <tbody id="users-table">
								  <!-- User rows will be inserted here -->
							  </tbody>
						  </table>
					  </div>
				 </div>
                <div id="backup-management-section" class="settings-card" style="display: none;">
                    <h3 class="text-2xl font-semibold mb-4 border-b pb-2">النسخ الاحتياطي والاستعادة</h3>
                    <div class="flex flex-wrap items-center gap-4">
                        <button id="export-backup-btn" class="btn btn-primary bg-sky-600 hover:bg-sky-700">
                            <i class="fas fa-file-export"></i> تصدير نسخة احتياطية
                        </button>
                        <label class="text-white cursor-pointer btn bg-green-600 hover:bg-green-700">
                            <i class="fas fa-file-import"></i> استيراد نسخة احتياطية
                            <input type="file" id="import-backup-input" class="hidden" accept=".json">
                        </label>
                    </div>
                    <p class="p-3 mt-4 text-sm text-red-600 bg-red-50 rounded-lg"><i class="mr-2 fas fa-exclamation-triangle"></i><strong>تحذير:</strong> استيراد نسخة احتياطية سيقوم بحذف جميع البيانات الحالية بشكل نهائي واستبدالها ببيانات الملف الذي تم رفعه. يرجى توخي الحذر الشديد.</p>
                </div>
			</div>


		</div>
	</div>

	<!-- Modals -->
	<div id="custom-overlay" class="fixed inset-0 z-40 flex items-center justify-center hidden bg-black bg-opacity-50"></div>
	<div id="custom-alert" class="fixed z-50 hidden w-full max-w-sm p-6 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-lg top-1/2 left-1/2">
		<p id="alert-message" class="mb-4 text-lg font-semibold text-center"></p>
		<div class="flex justify-center">
			<button id="alert-ok-btn" class="w-1/2 btn btn-primary">حسناً</button>
		</div>
	</div>
	<div id="custom-confirm" class="fixed z-50 hidden w-full max-w-sm p-6 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-lg top-1/2 left-1/2">
		<p id="confirm-message" class="mb-6 text-lg font-semibold text-center"></p>
		<div class="flex justify-center gap-4">
			<button id="confirm-ok-btn" class="w-1/2 btn btn-danger">تأكيد</button>
			<button id="confirm-cancel-btn" class="w-1/2 btn bg-slate-200 hover:bg-slate-300">إلغاء</button>
		</div>
	</div>
	<div id="invoice-view-modal" class="fixed z-50 hidden w-full max-w-4xl p-4 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-2xl md:p-8 top-1/2 left-1/2">
		<div id="invoice-view-content"></div>
		<div class="flex justify-end gap-4 p-4 mt-4 rounded-b-lg bg-slate-50 no-print">
			<button id="invoice-print-btn" class="btn btn-primary"><i class="fas fa-print"></i> طباعة / حفظ PDF</button>
			<button id="invoice-close-btn" class="btn btn-danger bg-slate-500 hover:bg-slate-600">إغلاق</button>
		</div>
	</div>
    <div id="quotation-view-modal" class="fixed z-50 hidden w-full max-w-4xl p-4 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-2xl md:p-8 top-1/2 left-1/2" style="max-height: 90vh; overflow-y: auto;">
		<div id="quotation-view-content"></div>
		<div class="flex justify-end gap-4 p-4 mt-4 rounded-b-lg bg-slate-50 no-print">
			<button id="quotation-print-btn" class="btn btn-primary"><i class="fas fa-print"></i> طباعة / حفظ PDF</button>
			<button id="quotation-close-btn" class="btn bg-slate-500 hover:bg-slate-600">إغلاق</button>
		</div>
	</div>
    <div id="forgot-password-modal" class="fixed z-50 hidden w-full max-w-sm p-6 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-lg top-1/2 left-1/2">
		<h3 class="mb-4 text-xl font-bold text-center">إعادة تعيين كلمة المرور</h3>
        <p class="mb-6 text-center text-slate-600">أدخل بريدك الإلكتروني وسنرسل لك رابطاً لإعادة تعيين كلمة مرورك.</p>
		<form id="forgot-password-form">
            <div class="mb-4">
                <label for="reset-email" class="block mb-2 font-semibold text-right text-slate-700">البريد الإلكتروني</label>
                <input type="email" id="reset-email" class="input" required>
            </div>
            <div class="flex justify-center gap-4 mt-6">
                <button type="submit" class="w-1/2 btn btn-primary">إرسال الرابط</button>
                <button type="button" id="forgot-password-cancel-btn" class="w-1/2 btn bg-slate-200 hover:bg-slate-300">إلغاء</button>
            </div>
        </form>
	</div>

    <!-- Generic Modal for Forms -->
    <div id="form-modal-overlay" class="fixed inset-0 z-40 hidden bg-black bg-opacity-60"></div>
    <div id="form-modal" class="fixed z-50 hidden w-full max-w-3xl p-4 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-2xl top-1/2 left-1/2" style="max-height: 90vh; display: none; flex-direction: column;">
        <div class="flex items-center justify-between pb-4 border-b">
            <h3 id="form-modal-title" class="text-2xl font-bold text-slate-800"></h3>
            <button id="form-modal-close-btn" class="text-2xl text-slate-500 hover:text-slate-800">&times;</button>
        </div>
        <div id="form-modal-body" class="flex-grow py-4 overflow-y-auto">
            <!-- Dynamic form content will be injected here -->
        </div>
        <div class="flex justify-end gap-2 pt-4 border-t">
             <button type="submit" id="form-modal-submit-btn" class="btn btn-primary">حفظ</button>
             <button type="button" id="form-modal-cancel-btn" class="btn bg-slate-300">إلغاء</button>
        </div>
    </div>
	
    <script type="module">
// --- Firebase SDKs (Modern Modular Version) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, 
            signOut, 
            createUserWithEmailAndPassword,
            sendPasswordResetEmail
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            addDoc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            getDoc, 
            getDocs, 
            query, 
            where, 
            orderBy, 
            limit,
            runTransaction,
            writeBatch,
            serverTimestamp,
            increment
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { 
            getStorage, 
            ref, 
            uploadString, 
            getDownloadURL,
            deleteObject
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- Firebase Settings ---
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
          apiKey: "AIzaSyAXAAe2GEqCf6KpuiJBGVhp82KchbiuIgQ",
          authDomain: "aslan-tech.firebaseapp.com",
          projectId: "aslan-tech",
          storageBucket: "aslan-tech.firebasestorage.app",
          messagingSenderId: "743540389534",
          appId: "1:743540389534:web:b6f3f12d425233ebbd6d8f",
          measurementId: "G-49VC8T9W8D"
        };
        
        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const auth = getAuth(app);
        // A secondary app instance for creating users without signing out the admin
        const secondaryApp = initializeApp(firebaseConfig, "secondary");
        const secondaryAuth = getAuth(secondaryApp);

        // --- Global Variables ---
        let appSettings = { currency: 'د.أ', initialFund: 0, companyName: 'شركتك', companyAddress: '', companyPhone: '', loyaltyPointsRate: 0 };
        let itemToEdit = null;
        let performanceChart = null;
        let salesDistributionChart = null;
        let monthlySalesChart = null;
        let currentInvoiceId = null;
        let currentQuotationId = null;
        let currentUser = {
            auth: null,
            role: 'visitor' // Default role
        };
        let supplierIdToNameMap = new Map();
        let supplierNumericIdToNameMap = new Map();
		let supplierNumericIdToDocIdMap = new Map();
        let productsCache = [];
        let customersCache = [];
        let employeesCache = [];
        let warehousesCache = [];
        let productTypesCache = [];

        // --- Modal Elements ---
        const formModal = document.getElementById('form-modal');
        const formModalOverlay = document.getElementById('form-modal-overlay');
        const formModalTitle = document.getElementById('form-modal-title');
        const formModalBody = document.getElementById('form-modal-body');
        const formModalSubmitBtn = document.getElementById('form-modal-submit-btn');
        const formModalCancelBtn = document.getElementById('form-modal-cancel-btn');
        const formModalCloseBtn = document.getElementById('form-modal-close-btn');

        // --- Modal Functions ---
        function showModal(title, formHTML, submitHandler) {
            formModalTitle.textContent = title;
            formModalBody.innerHTML = formHTML;
            formModal.style.display = 'flex'; // Use flex to enable column layout
            formModalOverlay.classList.remove('hidden');
            
            // It's important to remove the old event listener before adding a new one
            // to avoid multiple handlers being called on subsequent modal uses.
            formModalSubmitBtn.replaceWith(formModalSubmitBtn.cloneNode(true));
            document.getElementById('form-modal-submit-btn').addEventListener('click', submitHandler);
        }

        function hideModal() {
            formModal.style.display = 'none';
            formModalOverlay.classList.add('hidden');
            formModalBody.innerHTML = ''; // Clear content to prevent old data flashing
        }
        
        // --- User Feedback Functions ---
        const showMessage = (message) => {
            document.getElementById('alert-message').textContent = message;
            document.getElementById('custom-alert').classList.remove('hidden');
            document.getElementById('custom-overlay').classList.remove('hidden');
        };

        function showConfirm(message, onConfirm) {
            const confirmModal = document.getElementById('custom-confirm');
            const overlay = document.getElementById('custom-overlay');
            document.getElementById('confirm-message').textContent = message;
            confirmModal.classList.remove('hidden');
            overlay.classList.remove('hidden');
            const okBtn = document.getElementById('confirm-ok-btn');
            const cancelBtn = document.getElementById('confirm-cancel-btn');
            const confirmHandler = () => { onConfirm(); closeHandler(); };
            const closeHandler = () => {
                confirmModal.classList.add('hidden');
                overlay.classList.add('hidden');
                okBtn.removeEventListener('click', confirmHandler);
                cancelBtn.removeEventListener('click', closeHandler);
            };
            okBtn.addEventListener('click', confirmHandler, { once: true });
            cancelBtn.addEventListener('click', closeHandler, { once: true });
        }
        
        // --- Utility Functions ---
        function getLocalDate() {
            const date = new Date();
            const offset = date.getTimezoneOffset();
            const localDate = new Date(date.getTime() - (offset*60*1000));
            return localDate.toISOString().split('T')[0];
        }

        function copyToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showMessage('تم نسخ ID المورد بنجاح!');
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
                showMessage('فشل النسخ.');
            }
            document.body.removeChild(textArea);
        }

        // --- Dashboard Metrics & Charts ---
        async function updateAdvancedDashboardMetrics() {
            // 1. Most Profitable Products
            const salesSnapshot = await getDocs(collection(db, 'sales'));
            const profitableProducts = {};
            salesSnapshot.docs.forEach(doc => {
                const sale = doc.data();
                const profit = (sale.price - (sale.cost || 0)) * (sale.qty || 1);
                if (sale.type === 'product' && profit > 0) {
                    profitableProducts[sale.name] = (profitableProducts[sale.name] || 0) + profit;
                }
            });
            const topProducts = Object.entries(profitableProducts)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 5);

            const profitableProductsDiv = document.getElementById('most-profitable-products');
            if (topProducts.length > 0) {
                profitableProductsDiv.innerHTML = topProducts.map(([name, profit]) => `
                    <div class="flex justify-between items-center text-sm py-1 border-b border-slate-200">
                        <span>${name}</span>
                        <span class="font-bold text-green-600">${profit.toFixed(2)} ${appSettings.currency}</span>
                    </div>
                `).join('');
            } else {
                profitableProductsDiv.innerHTML = `<p class="text-sm text-slate-500">لا توجد بيانات كافية.</p>`;
            }

            // 2. Monthly Sales Chart
            const sixMonthsAgo = new Date();
            sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
            const monthlySales = {};
            const salesForChart = salesSnapshot.docs
                .map(doc => doc.data())
                .filter(sale => new Date(sale.date) >= sixMonthsAgo);

            for(let i=5; i>=0; i--) {
                const d = new Date();
                d.setMonth(d.getMonth() - i);
                const monthKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                monthlySales[monthKey] = 0;
            }

            salesForChart.forEach(sale => {
                const monthKey = sale.date.substring(0, 7); // YYYY-MM
                if (monthlySales.hasOwnProperty(monthKey)) {
                    monthlySales[monthKey] += sale.amount;
                }
            });

            const chartTextColor = '#1e293b';
            const chartGridColor = 'rgba(0, 0, 0, 0.1)';

            if (monthlySalesChart) {
                monthlySalesChart.destroy();
            }
            monthlySalesChart = new Chart(document.getElementById('monthly-sales-chart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: Object.keys(monthlySales),
                    datasets: [{
                        label: 'إجمالي المبيعات',
                        data: Object.values(monthlySales),
                        borderColor: '#0ea5e9',
                        backgroundColor: 'rgba(14, 165, 233, 0.2)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: chartTextColor },
                            grid: { color: chartGridColor }
                        },
                        x: {
                            ticks: { color: chartTextColor },
                            grid: { color: chartGridColor }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: chartTextColor } }
                    }
                }
            });

            // 3. Other KPIs
            const customersSnapshot = await getDocs(collection(db, 'customers'));
            const totalCustomers = customersSnapshot.size;
            const averageSale = salesSnapshot.size > 0 ? (salesSnapshot.docs.reduce((sum, doc) => sum + doc.data().amount, 0) / salesSnapshot.size) : 0;

            const kpiContainer = document.getElementById('kpi-container');
            kpiContainer.innerHTML = `
                <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                    <span class="font-semibold">إجمالي عدد العملاء</span>
                    <span class="font-bold text-lg text-sky-600">${totalCustomers}</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                    <span class="font-semibold">متوسط قيمة الفاتورة</span>
                    <span class="font-bold text-lg text-sky-600">${averageSale.toFixed(2)} ${appSettings.currency}</span>
                </div>
            `;
        }
        
        // --- Firebase Core Functions ---
        async function addOrUpdateItem(collectionName, data, id = null, actionDetails = null) {
            try {
                const action = id ? 'update' : 'add';
                const docRef = id ? doc(db, collectionName, id) : doc(collection(db, collectionName));
                
                if(action === 'add') {
                    data.createdAt = serverTimestamp();
                }
                data.updatedAt = serverTimestamp();

                await setDoc(docRef, data, { merge: true });

                if (actionDetails) {
                    const logAction = action === 'add' ? actionDetails.add : actionDetails.update;
                    const logId = id || docRef.id;
                    await logActivity(logAction, `ID: ${logId}`);
                }
                return true;
            } catch (e) {
                console.error("Add/Update error:", e);
                showMessage(`حدث خطأ أثناء إضافة/تحديث البيانات: ${e.message}`);
                return false;
            }
        }
        
        async function deleteItem(collectionName, id, itemName = '') {
            try {
                await runTransaction(db, async (transaction) => {
                    const itemRef = doc(db, collectionName, id);
                    const itemDoc = await transaction.get(itemRef);
                    if (!itemDoc.exists()) {
                        console.log(`Item ${id} in ${collectionName} does not exist. Nothing to delete.`);
                        return;
                    };

                    const itemData = itemDoc.data();
                    itemName = itemData.name || itemData.productName || itemData.type || itemData.email || `ID: ${id}`;

                    if (collectionName === 'sales' && itemData.type === 'product' && itemData.productId) {
                        const productRef = doc(db, 'products', itemData.productId);
                        const productDoc = await transaction.get(productRef);
                        if (productDoc.exists()) {
                            transaction.update(productRef, { qty: increment(itemData.qty) });
                        } else {
                            console.warn(`Product with ID ${itemData.productId} not found when deleting sale ${id}. Stock not updated.`);
                        }
                    } else if (collectionName === 'purchases' && itemData.productId) {
                        const productRef = doc(db, 'products', itemData.productId);
                        const productDoc = await transaction.get(productRef);
                        if (productDoc.exists() && productDoc.data().qty >= itemData.qty) {
                            transaction.update(productRef, { qty: increment(-itemData.qty) });
                        } else {
                            console.warn(`Could not decrement stock for deleted purchase ${id}, product ${itemData.productId} not found or insufficient stock.`);
                        }
                    } else if (collectionName === 'returns' && itemData.productId) {
                        const productRef = doc(db, 'products', itemData.productId);
                        const productDoc = await transaction.get(productRef);
                        if (productDoc.exists() && productDoc.data().qty >= itemData.qty) {
                            transaction.update(productRef, { qty: increment(-itemData.qty) });
                        } else {
                            console.warn(`Could not decrement stock for deleted return ${id}, product ${itemData.productId} not found or insufficient stock.`);
                        }
                    }
                    
                    transaction.delete(itemRef);
                });
                
                await logActivity(`حذف ${collectionName}`, `"${itemName}" (ID: ${id})`);
                return true;
            } catch (e) {
                console.error("Delete error:", e);
                showMessage(`حدث خطأ أثناء حذف البيانات: ${e.message}`);
                return false;
            }
        }

        // --- Authentication ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Immediately show the app and hide login screen
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                document.getElementById('user-email').textContent = user.email;
                currentUser.auth = user;

                // Asynchronously fetch role and data
                const initializeAppForUser = async () => {
                    try {
                        const userDoc = await getDoc(doc(db, 'users', user.uid));
                        if (userDoc.exists()) {
                            currentUser.role = userDoc.data().role;
                        } else {
                            const allUsersSnapshot = await getDocs(query(collection(db, 'users'), limit(1)));
                            if (allUsersSnapshot.empty) { // First ever user becomes admin
                                currentUser.role = 'admin';
                                await setDoc(doc(db, 'users', user.uid), { email: user.email, role: 'admin' }, { merge: true });
                            } else {
                                currentUser.role = 'visitor'; // Default for safety
                            }
                        }
                        
                        document.getElementById('user-role-display').textContent = translateRole(currentUser.role);
                        
                        // Apply permissions first to show/hide UI elements correctly
                        applyPermissions(currentUser.role);

                        // Now load all the data
                        await refreshAllDataOnLogin();

                    } catch (error) {
                        console.error("Error during post-login data refresh:", error);
                        showMessage("حدث خطأ أثناء تحميل بيانات التطبيق. قد لا تظهر بعض البيانات بشكل صحيح.");
                        // Don't sign out automatically, let the user decide
                    }
                };

                initializeAppForUser();

            } else {
                currentUser = { auth: null, role: 'visitor' };
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-container').classList.add('hidden');
                document.getElementById('user-email').textContent = '';
                document.getElementById('user-role-display').textContent = '';
                clearAllTables();
            }
        });

        function translateRole(role) {
            const roles = { admin: 'مدير', user: 'مستخدم', visitor: 'زائر' };
            return roles[role] || role;
        }

        function clearAllTables() {
            const tableIds = ['products-table', 'sales-table', 'returns-table', 'purchases-table', 'expenses-table', 'customers-table', 'suppliers-table', 'quotations-table', 'invoices-table', 'activity-log-table', 'users-table', 'employees-table', 'warehouses-table'];
            tableIds.forEach(id => {
                const table = document.getElementById(id);
                if(table) table.innerHTML = '';
            });
            if (monthlySalesChart) monthlySalesChart.destroy();
            if (performanceChart) performanceChart.destroy();
            if (salesDistributionChart) salesDistributionChart.destroy();
        }


        // --- UI and Tab Management ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabId).classList.remove('hidden');
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            
            if (tabId === 'sales') { refreshSales(); } 
            else if (tabId === 'returns') { refreshReturns(); } 
            else if (tabId === 'purchases') { refreshPurchases(); } 
            else if (tabId === 'expenses') { refreshExpenses(); } 
            else if (tabId === 'quotations') { refreshQuotations(); } 
            else if (tabId === 'activity_log') { refreshActivityLog(); }
        }

        function populateSelect(selectId, data, valueField, textField, displayTpl = null, addEmptyOption = true) {
            const select = document.getElementById(selectId);
            if (!select) return;
            const currentValue = select.value;
            select.innerHTML = addEmptyOption ? `<option value="">اختر</option>` : '';
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item[valueField];
                option.textContent = displayTpl ? displayTpl(item) : item[textField];
                select.appendChild(option);
            });
            select.value = currentValue;
        }
        
        // --- Data Refresh and Display Functions ---
		async function refreshProducts() {
			const searchTerm = document.getElementById('product-search-input').value.toLowerCase();
			const supplierIdFilter = document.getElementById('product-supplier-filter').value;
			const warehouseIdFilter = document.getElementById('warehouse-filter').value;
            const categoryFilter = document.getElementById('product-category-filter').value;

			const q = query(collection(db, 'products'), orderBy('name'));
			const snapshot = await getDocs(q);
			
			const allProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

			productsCache = allProducts; 

			let filteredProducts = productsCache;

			if (warehouseIdFilter) {
				filteredProducts = filteredProducts.filter(p => p.warehouseId === warehouseIdFilter);
			}

			if (supplierIdFilter) {
				filteredProducts = filteredProducts.filter(p => p.supplierId === supplierIdFilter);
			}

			if (searchTerm) {
				filteredProducts = filteredProducts.filter(p => p.name.toLowerCase().includes(searchTerm));
			}
            if (categoryFilter) {
                filteredProducts = filteredProducts.filter(p => p.category === categoryFilter);
            }

            // Populate category filter
            const categoryFilterSelect = document.getElementById('product-category-filter');
            const categories = [...new Set(allProducts.map(p => p.category).filter(Boolean))];
            const currentCategory = categoryFilterSelect.value;
            categoryFilterSelect.innerHTML = '<option value="">فلترة حسب النوع</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categoryFilterSelect.appendChild(option);
            });
            categoryFilterSelect.value = currentCategory;


			const tableBody = document.getElementById('products-table');
			tableBody.innerHTML = '';
			let totalValue = 0, lowStockCount = 0, outOfStockCount = 0;
			
			filteredProducts.forEach(p => {
				totalValue += (p.cost || 0) * (p.qty || 0);
				if (p.qty === 0) outOfStockCount++;
				else if (p.qty > 0 && p.qty <= 10) lowStockCount++;

				const row = tableBody.insertRow();
				let qtyClass = p.qty <= 0 ? 'bg-red-100 text-red-700 font-bold' : (p.qty <= 10 ? 'bg-yellow-100 text-yellow-700' : '');
				row.innerHTML = `
					<td class="no-export"><input type="checkbox" class="product-checkbox" data-id="${p.id}"></td>
					<td class="whitespace-nowrap">${p.name}</td>
					<td>${p.category || 'N/A'}</td>
					<td>${p.warehouseName || 'غير محدد'}</td>
					<td>${(p.cost || 0).toFixed(2)} ${appSettings.currency}</td>
					<td class="${qtyClass} text-center">${p.qty}</td>
					<td>${p.supplierName || 'غير محدد'}</td>
					<td class="whitespace-nowrap no-export">
						<button class="btn btn-edit text-sm edit-btn" data-id="${p.id}" data-category="product">تعديل</button>
						<button class="btn btn-danger text-sm delete-btn" data-id="${p.id}" data-category="products">حذف</button>
					</td>`;
			});
			document.getElementById('stats-total-products').textContent = filteredProducts.length;
			document.getElementById('stats-stock-value').textContent = `${totalValue.toFixed(2)} ${appSettings.currency}`;
			document.getElementById('stats-low-stock').textContent = lowStockCount;
			document.getElementById('stats-out-of-stock').textContent = outOfStockCount;
			toggleDeleteSelectedButton();
			await populateProductSelects(); 
			applyPermissions(currentUser.role);
		}


        async function refreshSales(date) {
            let q;
            if(date) {
                q = query(collection(db, 'sales'), where('date', '==', date), orderBy('date', 'desc'));
            } else {
                q = query(collection(db, 'sales'), orderBy('date', 'desc'), limit(200));
            }
            const snapshot = await getDocs(q);
            const sales = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const tableBody = document.getElementById('sales-table');
            tableBody.innerHTML = '';
            sales.forEach(s => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td class="whitespace-nowrap">${s.date}</td>
                    <td>${s.type === 'product' ? 'منتج' : 'خدمة'}</td>
                    <td class="whitespace-nowrap">${s.name}</td>
                    <td>${s.warehouseName || '-'}</td>
                    <td>${s.qty || 1}</td>
                    <td class="whitespace-nowrap">${s.customerName || 'غير محدد'}</td>
                    <td>${(s.amount || 0).toFixed(2)} ${appSettings.currency}</td>
                    <td class="whitespace-nowrap no-export">
                        <button class="btn bg-green-500 text-white text-sm create-invoice-from-sale-btn" data-id="${s.id}">إنشاء فاتورة</button>
                        <button class="btn btn-edit text-sm edit-btn" data-id="${s.id}" data-category="sale">تعديل</button>
                        <button class="btn btn-danger text-sm delete-btn" data-id="${s.id}" data-category="sales">حذف</button>
                    </td>`;
            });
            applyPermissions(currentUser.role);
        }

        async function refreshReturns() {
            const q = query(collection(db, 'returns'), orderBy('date', 'desc'), limit(200));
            const snapshot = await getDocs(q);
            const returns = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const tableBody = document.getElementById('returns-table');
            tableBody.innerHTML = '';
            returns.forEach(r => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td class="whitespace-nowrap">${r.date}</td>
                    <td class="whitespace-nowrap">${r.productName}</td>
                    <td>${r.warehouseName || '-'}</td>
                    <td>${r.qty}</td>
                    <td class="allow-wrap">${r.reason || ''}</td>
                    <td class="whitespace-nowrap no-export">
                        <button class="btn btn-danger text-sm delete-btn" data-id="${r.id}" data-category="returns">حذف</button>
                    </td>`;
            });
            applyPermissions(currentUser.role);
        }
        
        async function refreshPurchases(date) {
            let q;
            if (date) {
                q = query(collection(db, 'purchases'), where('date', '==', date), orderBy('date', 'desc'));
            } else {
                q = query(collection(db, 'purchases'), orderBy('date', 'desc'), limit(200));
            }
            const snapshot = await getDocs(q);
            const purchases = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const tableBody = document.getElementById('purchases-table');
            tableBody.innerHTML = '';
            purchases.forEach(p => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td class="whitespace-nowrap">${p.date}</td>
                    <td class="whitespace-nowrap">${p.itemName}</td>
                    <td class="whitespace-nowrap">${p.supplierName || 'غير محدد'}</td>
                    <td>${(p.amount || 0).toFixed(2)} ${appSettings.currency}</td>
                    <td class="whitespace-nowrap no-export">
                        <button class="btn btn-edit text-sm edit-btn" data-id="${p.id}" data-category="purchase">تعديل</button>
                        <button class="btn btn-danger text-sm delete-btn" data-id="${p.id}" data-category="purchases">حذف</button>
                    </td>`;
            });
            applyPermissions(currentUser.role);
        }

        async function refreshExpenses(date) {
            let q;
            if (date) {
                q = query(collection(db, 'expenses'), where('date', '==', date), orderBy('date', 'desc'));
            } else {
                q = query(collection(db, 'expenses'), orderBy('date', 'desc'), limit(200));
            }
            const snapshot = await getDocs(q);
            const expenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const tableBody = document.getElementById('expenses-table');
            tableBody.innerHTML = '';
            expenses.forEach(e => {
                const row = tableBody.insertRow();
                // If expense is salary and has employee name, add it to description for display
                let description = e.description || '';
                if (e.type === 'رواتب' && e.employeeName) {
                    description = `راتب: ${e.employeeName}` + (description ? ` - ${description}` : '');
                }
                row.innerHTML = `
                    <td>${e.date}</td>
                    <td>${e.type}</td>
                    <td>${(e.amount || 0).toFixed(2)} ${appSettings.currency}</td>
                    <td class="allow-wrap">${description}</td>
                    <td class="whitespace-nowrap no-export">
                        <button class="btn btn-edit text-sm edit-btn" data-id="${e.id}" data-category="expense">تعديل</button>
                        <button class="btn btn-danger text-sm delete-btn" data-id="${e.id}" data-category="expenses">حذف</button>
                    </td>`;
            });
            applyPermissions(currentUser.role);
        }

        async function refreshCustomers() {
            const q = query(collection(db, 'customers'), orderBy('name'));
            const snapshot = await getDocs(q);
            const customers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            customersCache = customers; // Cache the customers
            const tableBody = document.getElementById('customers-table');
            tableBody.innerHTML = '';
            customers.forEach(c => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td class="whitespace-nowrap">${c.name}</td>
                    <td>${c.phone || ''}</td>
                    <td>${c.email || ''}</td>
                    <td>${c.loyaltyPoints || 0}</td>
                    <td class="allow-wrap">${c.address || ''}</td>
                    <td class="whitespace-nowrap no-export">
                        <button class="btn btn-edit text-sm edit-btn" data-id="${c.id}" data-category="customer">تعديل</button>
                        <button class="btn btn-danger text-sm delete-btn" data-id="${c.id}" data-category="customers">حذف</button>
                    </td>`;
            });
            applyPermissions(currentUser.role);
        }

		async function refreshSuppliers() {
			const snapshot = await getDocs(collection(db, 'suppliers'));
			let suppliers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
			
			suppliers.sort((a, b) => (a.supplierNumericId || 0) - (b.supplierNumericId || 0));
			
			supplierIdToNameMap.clear();
			supplierNumericIdToNameMap.clear();
			supplierNumericIdToDocIdMap.clear();
			suppliers.forEach(s => {
				supplierIdToNameMap.set(s.id, s.name);
				if (s.supplierNumericId) {
					const key = String(s.supplierNumericId).trim();
					supplierNumericIdToNameMap.set(key, s.name);
					supplierNumericIdToDocIdMap.set(key, s.id);
				}
			});

			const tableBody = document.getElementById('suppliers-table');
			tableBody.innerHTML = '';
			suppliers.forEach(s => {
				const row = tableBody.insertRow();
				row.innerHTML = `
					<td class="whitespace-nowrap">
						<div class="flex items-center gap-2">
							<span>${s.supplierNumericId || 'N/A'}</span>
							<button class="copy-btn" data-id="${s.supplierNumericId || ''}"><i class="fas fa-copy"></i></button>
						</div>
					</td>
					<td class="whitespace-nowrap">${s.name}</td>
					<td>${s.phone || ''}</td>
					<td>${s.email || ''}</td>
					<td class="allow-wrap">${s.address || ''}</td>
					<td class="whitespace-nowrap no-export">
						<button class="btn btn-edit text-sm edit-btn" data-id="${s.id}" data-category="supplier">تعديل</button>
						<button class="btn btn-danger text-sm delete-btn" data-id="${s.id}" data-category="suppliers">حذف</button>
					</td>`;
			});
			 document.querySelectorAll('.copy-btn').forEach(button => {
				 button.addEventListener('click', (e) => {
					 const id = e.currentTarget.dataset.id;
					 if(id) {
						 copyToClipboard(id);
					 }
				 });
			 });
			
			const filterSelect = document.getElementById('product-supplier-filter');
			filterSelect.innerHTML = '<option value="">كل الموردين</option>';
			suppliers.forEach(s => {
				const option = document.createElement('option');
				option.value = s.id;
				option.textContent = s.name;
				filterSelect.appendChild(option);
			});

			applyPermissions(currentUser.role);
		}

        async function refreshQuotations() {
            const q = query(collection(db, 'quotations'), orderBy('quotationNumber', 'desc'));
            const snapshot = await getDocs(q);
            const quotations = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const tableBody = document.getElementById('quotations-table');
            tableBody.innerHTML = '';
            quotations.forEach(q => {
                const row = tableBody.insertRow();
                const today = new Date();
                today.setHours(0,0,0,0);
                const isExpired = q.expiryDate && new Date(q.expiryDate) < today;

                const statusClasses = q.status === 'converted' 
                    ? 'bg-green-100 text-green-800' 
                    : isExpired ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800';
                const statusText = q.status === 'converted' 
                    ? 'تم تحويلها' 
                    : isExpired ? 'منتهية الصلاحية' : 'جديد';

                row.innerHTML = `
                    <td>${q.quotationNumber}</td>
                    <td class="whitespace-nowrap">${q.date}</td>
                    <td class="whitespace-nowrap">${q.customerName}</td>
                    <td>${(q.totalAmount || 0).toFixed(2)} ${appSettings.currency}</td>
                    <td>${q.discount || 0}%</td>
                    <td>${q.tax || 0}%</td>
                    <td>${q.expiryDate || 'N/A'}</td>
                    <td><span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClasses}">${statusText}</span></td>
                    <td class="whitespace-nowrap no-export">
                        <button class="btn bg-blue-500 text-white text-sm view-quotation-btn" data-id="${q.id}" data-category="quotation">عرض</button>
                        <button class="btn btn-edit text-sm edit-btn" data-id="${q.id}" data-category="quotation">تعديل</button>
                        ${q.status !== 'converted' ? `<button class="btn bg-green-500 text-white text-sm convert-quotation-btn" data-id="${q.id}" data-category="quotation">تحويل إلى فاتورة</button>` : ''}
                        <button class="btn btn-danger text-sm delete-btn" data-id="${q.id}" data-category="quotations">حذف</button>
                    </td>`;
            });
            applyPermissions(currentUser.role);
        }
        
        async function refreshInvoices() {
            const q = query(collection(db, 'invoices'), orderBy('invoiceNumber', 'desc'));
            const snapshot = await getDocs(q);
            const invoices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const tableBody = document.getElementById('invoices-table');
            tableBody.innerHTML = '';
            invoices.forEach(i => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${i.invoiceNumber}</td>
                    <td class="whitespace-nowrap">${i.date}</td>
                    <td class="whitespace-nowrap">${i.customerName}</td>
                    <td>${(i.totalAmount || 0).toFixed(2)} ${appSettings.currency}</td>
                    <td class="whitespace-nowrap no-export">
                        <button class="btn btn-primary text-sm view-invoice-btn" data-id="${i.id}">عرض</button>
                        <button class="btn btn-danger text-sm delete-btn" data-id="${i.id}" data-category="invoices">حذف</button>
                    </td>`;
            });
            applyPermissions(currentUser.role);
        }
        
		async function populateProductSelects(warehouseId = null) {
			const productsToDisplay = warehouseId ? productsCache.filter(p => p.warehouseId === warehouseId) : productsCache;
			const displayTpl = (p) => `${p.name} (المتاح: ${p.qty})`;

			// For sales form
			populateSelect('s-product', productsToDisplay, 'id', 'name', displayTpl, productsToDisplay.length > 0);

			// For returns form
			populateSelect('r-product', productsToDisplay, 'id', 'name', null, productsToDisplay.length > 0);

			// For purchase form (existing products)
			populateSelect('p-product', productsToDisplay, 'id', 'name', displayTpl, productsToDisplay.length > 0);

			// For invoice items
			document.querySelectorAll('.i-product-select').forEach(select => {
				const selectedValue = select.value;
				const currentWarehouseId = select.closest('.invoice-item-row')?.dataset.warehouseId;
				const productsForInvoiceItem = currentWarehouseId ? productsCache.filter(p => p.warehouseId === currentWarehouseId) : productsCache;
				
				select.innerHTML = `<option value="">اختر منتج</option>`;
				productsForInvoiceItem.forEach(p => {
					const option = document.createElement('option');
					option.value = p.id;
					option.textContent = p.name;
					select.appendChild(option);
				});
				select.value = selectedValue;
			});
		}
        
        async function refreshEmployees() {
            if (currentUser.role !== 'admin') {
                employeesCache = [];
                return;
            }
            const q = query(collection(db, 'employees'), orderBy('name'));
            const snapshot = await getDocs(q);
            employeesCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            // Populate employee table in settings
            const tableBody = document.getElementById('employees-table');
            tableBody.innerHTML = '';
            employeesCache.forEach(emp => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td class="whitespace-nowrap">${emp.name}</td>
                    <td>${emp.position || ''}</td>
                    <td>${emp.employeeId || ''}</td>
                    <td>${emp.phone || ''}</td>
                    <td>${emp.workLocation || ''}</td>
                    <td class="whitespace-nowrap no-export">
                        <button class="btn btn-edit text-sm edit-btn" data-id="${emp.id}" data-category="employee">تعديل</button>
                        <button class="btn btn-danger text-sm delete-btn" data-id="${emp.id}" data-category="employees">حذف</button>
                    </td>`;
            });

            applyPermissions(currentUser.role);
        }

		async function refreshWarehouses() {
			const q = query(collection(db, 'warehouses'), orderBy('name'));
			const snapshot = await getDocs(q);
			
			if (snapshot.empty) {
				// If no warehouses exist, create a default one
				await addDoc(collection(db, 'warehouses'), { name: "المستودع الرئيسي" });
				await refreshWarehouses(); // Re-run to fetch the newly created one
				return;
			}

			warehousesCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

			// Populate management table
			const tableBody = document.getElementById('warehouses-table');
			tableBody.innerHTML = '';
			warehousesCache.forEach(w => {
				const row = tableBody.insertRow();
				row.innerHTML = `
					<td class="whitespace-nowrap">${w.name}</td>
                    <td class="whitespace-nowrap">${w.location || ''}</td>
                    <td class="whitespace-nowrap">${w.responsibleEmployee || ''}</td>
                    <td class="whitespace-nowrap">${w.phone || ''}</td>
					<td class="whitespace-nowrap no-export">
						<button class="btn btn-edit text-sm edit-btn" data-id="${w.id}" data-category="warehouse">تعديل</button>
						<button class="btn btn-danger text-sm delete-btn" data-id="${w.id}" data-category="warehouses">حذف</button>
					</td>`;
			});

			// Populate select dropdowns
			const warehouseFilterSelect = document.getElementById('warehouse-filter');
			const oldFilterValue = warehouseFilterSelect.value;
			warehouseFilterSelect.innerHTML = '<option value="">كل المستودعات</option>';
			warehousesCache.forEach(w => {
				const option = document.createElement('option');
				option.value = w.id;
				option.textContent = w.name;
				warehouseFilterSelect.appendChild(option);
			});
			warehouseFilterSelect.value = oldFilterValue;

			applyPermissions(currentUser.role);
		}

        async function refreshAllDataOnLogin() {
            const safeRefresh = async (refreshFunction, name) => {
                try {
                    await refreshFunction();
                } catch (error) {
                    console.error(`Safe-refresh failed for ${name}:`, error);
                    showMessage(`حدث خطأ أثناء تحميل قسم: ${name}. قد لا تظهر بعض البيانات.`);
                }
            };

            await safeRefresh(loadSettings, 'الإعدادات');
            
            const today = getLocalDate();
            document.getElementById('dashboard-date').value = today;
            await safeRefresh(() => updateDashboard(today), 'لوحة التحكم الرئيسية');

            // Load foundational data first
            await safeRefresh(refreshWarehouses, 'المستودعات');
            await safeRefresh(refreshProductTypes, 'أنواع المنتجات');
            await safeRefresh(refreshSuppliers, 'الموردين');
            await safeRefresh(refreshCustomers, 'العملاء');
            await safeRefresh(refreshEmployees, 'الموظفين');
            await safeRefresh(refreshUsers, 'المستخدمين');
            
            // Then load data that may depend on the above
            await safeRefresh(refreshProducts, 'المنتجات');
            await safeRefresh(refreshSales, 'المبيعات');
            await safeRefresh(refreshReturns, 'المرتجعات');
            await safeRefresh(refreshPurchases, 'المشتريات');
            await safeRefresh(refreshExpenses, 'المصاريف');
            await safeRefresh(refreshQuotations, 'عروض الأسعار');
            await safeRefresh(refreshInvoices, 'الفواتير');
            await safeRefresh(refreshActivityLog, 'سجل النشاط');
            
            // Finally, update dashboard components that summarize data
            await safeRefresh(updateAdvancedDashboardMetrics, 'مقاييس لوحة التحكم المتقدمة');

            // Enable all add buttons now that data is loaded and UI is stable
            document.querySelectorAll('.add-btn-disabled').forEach(btn => {
                btn.disabled = false;
            });
        }

        // --- Dashboard and Reports ---
        async function updateDashboard(date = null) {
            const targetDate = date || getLocalDate();
            
            const salesSnapshot = await getDocs(query(collection(db, 'sales'), where('date', '==', targetDate)));
            let totalSales = 0, totalCostOfGoods = 0;
            salesSnapshot.forEach(doc => {
                const sale = doc.data();
                totalSales += sale.amount;
                totalCostOfGoods += ((sale.cost || 0) * (sale.qty || 1));
            });

            const purchasesSnapshot = await getDocs(query(collection(db, 'purchases'), where('date', '==', targetDate)));
            let totalPurchases = 0;
            purchasesSnapshot.forEach(doc => totalPurchases += doc.data().amount);
            
            const expensesSnapshot = await getDocs(query(collection(db, 'expenses'), where('date', '==', targetDate)));
            let totalExpenses = 0;
            expensesSnapshot.forEach(doc => totalExpenses += doc.data().amount);
            
            const netProfit = (totalSales - totalCostOfGoods) - totalExpenses;
            const dailyNetFlow = totalSales - totalPurchases - totalExpenses;

            document.getElementById('total-sales').textContent = `${totalSales.toFixed(2)} ${appSettings.currency}`;
            document.getElementById('total-purchases').textContent = `${totalPurchases.toFixed(2)} ${appSettings.currency}`;
            document.getElementById('total-expenses').textContent = `${totalExpenses.toFixed(2)} ${appSettings.currency}`;
            document.getElementById('net-profit').textContent = `${netProfit.toFixed(2)} ${appSettings.currency}`;
            document.getElementById('remaining-fund').textContent = `${dailyNetFlow.toFixed(2)} ${appSettings.currency}`;
        }
        
        async function generateReport() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            if (!startDate || !endDate) {
                showMessage("الرجاء تحديد تاريخي البدء والانتهاء.");
                return;
            }
            
            const chartTextColor = '#1e293b';
            const chartGridColor = 'rgba(0, 0, 0, 0.1)';
            
            document.getElementById('report-title').textContent = `تقرير الأداء`;
            document.getElementById('report-date-range').textContent = `للفترة من ${startDate} إلى ${endDate}`;
            document.getElementById('report-company-name').textContent = appSettings.companyName;
            document.getElementById('report-company-address').textContent = appSettings.companyAddress;
            const logoData = localStorage.getItem('companyLogo');
            const reportLogoContainer = document.getElementById('report-logo-container');
            if (logoData) {
                reportLogoContainer.innerHTML = `<img src="${logoData}" alt="Company Logo" class="max-h-20">`;
            } else {
                reportLogoContainer.innerHTML = '';
            }

            const salesQuery = query(collection(db, 'sales'), where('date', '>=', startDate), where('date', '<=', endDate));
            const purchasesQuery = query(collection(db, 'purchases'), where('date', '>=', startDate), where('date', '<=', endDate));
            const expensesQuery = query(collection(db, 'expenses'), where('date', '>=', startDate), where('date', '<=', endDate));

            const [salesSnapshot, purchasesSnapshot, expensesSnapshot] = await Promise.all([
                getDocs(salesQuery),
                getDocs(purchasesQuery),
                getDocs(expensesQuery)
            ]);

            const salesData = salesSnapshot.docs.map(d => d.data());
            const purchasesData = purchasesSnapshot.docs.map(d => d.data());
            const expensesData = expensesSnapshot.docs.map(d => d.data());

            const reportSales = salesData.reduce((sum, s) => sum + s.amount, 0);
            const reportCOGS = salesData.reduce((sum, s) => sum + ((s.cost || 0) * (s.qty || 1)), 0);
            const reportPurchases = purchasesData.reduce((sum, p) => sum + p.amount, 0);
            const reportExpenses = expensesData.reduce((sum, e) => sum + e.amount, 0);
            const reportProfit = (reportSales - reportCOGS) - reportExpenses;

            document.getElementById('report-sales').textContent = `${reportSales.toFixed(2)} ${appSettings.currency}`;
            document.getElementById('report-purchases').textContent = `${reportPurchases.toFixed(2)} ${appSettings.currency}`;
            document.getElementById('report-expenses').textContent = `${reportExpenses.toFixed(2)} ${appSettings.currency}`;
            document.getElementById('report-profit').textContent = `${reportProfit.toFixed(2)} ${appSettings.currency}`;

            // Capital Tracking Calculations
            const initialCapital = productsCache
                .filter(p => p.isOpeningStock)
                .reduce((sum, p) => sum + ((p.cost || 0) * p.qty), 0);
            
            const currentStockValue = productsCache
                .reduce((sum, p) => sum + ((p.cost || 0) * p.qty), 0);

            const capitalGrowth = currentStockValue - initialCapital;
            
            document.getElementById('report-initial-capital').textContent = `${initialCapital.toFixed(2)} ${appSettings.currency}`;
            document.getElementById('report-current-stock-value').textContent = `${currentStockValue.toFixed(2)} ${appSettings.currency}`;
            document.getElementById('report-capital-growth').textContent = `${capitalGrowth.toFixed(2)} ${appSettings.currency}`;

            const growthCard = document.getElementById('report-capital-growth-card');
            growthCard.classList.remove('from-green-500', 'to-emerald-400', 'from-red-500', 'to-rose-400');
            if (capitalGrowth >= 0) {
                growthCard.classList.add('from-green-500', 'to-emerald-400');
            } else {
                 growthCard.classList.add('from-red-500', 'to-rose-400');
            }

            
            // Top Products Table
            const productSales = {};
            salesData.filter(s => s.type === 'product').forEach(s => {
                if (!productSales[s.name]) productSales[s.name] = { totalQty: 0, totalProfit: 0 };
                productSales[s.name].totalQty += s.qty;
                const profit = (s.price - (s.cost || 0)) * (s.qty || 1);
                productSales[s.name].totalProfit += profit;
            });
            const topProducts = Object.entries(productSales).sort((a, b) => b[1].totalProfit - a[1].totalProfit).slice(0, 10);
            document.getElementById('top-products-table').innerHTML = topProducts.length > 0 ? topProducts.map(([name, data]) => `<tr><td>${name}</td><td>${data.totalQty}</td><td>${data.totalProfit.toFixed(2)} ${appSettings.currency}</td></tr>`).join('') : `<tr><td colspan="3" class="text-center">لا توجد بيانات</td></tr>`;
            
            // Top Customers Table
            const customerSales = {};
            salesData.forEach(s => {
                const customer = s.customerName || 'غير محدد';
                customerSales[customer] = (customerSales[customer] || 0) + s.amount;
            });
            const topCustomers = Object.entries(customerSales).sort((a, b) => b[1] - a[1]).slice(0, 10);
             document.getElementById('top-customers-table').innerHTML = topCustomers.length > 0 ? topCustomers.map(([name, total]) => `<tr><td>${name}</td><td>${total.toFixed(2)} ${appSettings.currency}</td></tr>`).join('') : `<tr><td colspan="2" class="text-center">لا توجد بيانات</td></tr>`;

            // Out of Stock Table
            const outOfStockProducts = productsCache.filter(p => p.qty === 0);
            document.getElementById('low-stock-table').innerHTML = outOfStockProducts.length > 0 ? outOfStockProducts.map(p => `<tr><td>${p.name}</td><td>${p.warehouseName}</td><td>${p.qty}</td></tr>`).join('') : `<tr><td colspan="3" class="text-center">لا توجد منتجات نافدة</td></tr>`;

            // Expenses Summary Report
            const expensesReportTable = document.getElementById('detailed-expenses-report-table');
			const expensesReportTableBody = document.getElementById('detailed-expenses-report-table-body');
            
            const expensesByType = expensesData.reduce((acc, expense) => {
                const type = expense.type || 'غير محدد';
                if (!acc[type]) {
                    acc[type] = 0;
                }
                acc[type] += expense.amount;
                return acc;
            }, {});

            const sortedExpenses = Object.entries(expensesByType).sort(([,a],[,b]) => b-a);

            const existingTfoot = expensesReportTable.querySelector('tfoot');
            if (existingTfoot) existingTfoot.remove();

			expensesReportTableBody.innerHTML = sortedExpenses.length > 0
				? sortedExpenses.map(([type, totalAmount]) => `
					<tr>
						<td>${type}</td>
						<td>${totalAmount.toFixed(2)} ${appSettings.currency}</td>
					</tr>
				`).join('')
				: `<tr><td colspan="2" class="text-center">لا توجد مصاريف في هذه الفترة</td></tr>`;
            
            if (sortedExpenses.length > 0) {
                const totalExpenses = expensesData.reduce((sum, e) => sum + e.amount, 0);
                const tfoot = document.createElement('tfoot');
                tfoot.innerHTML = `
                    <tr class="font-bold bg-slate-100">
                        <td class="p-2 text-left font-bold">المجموع الكلي</td>
                        <td class="p-2 font-bold">${totalExpenses.toFixed(2)} ${appSettings.currency}</td>
                    </tr>
                `;
                expensesReportTable.appendChild(tfoot);
            }

            // New Salaries Report by Employee
            const salariesData = expensesData.filter(e => e.type === 'رواتب' && e.employeeName);
            const salariesByEmployee = salariesData.reduce((acc, salary) => {
                const name = salary.employeeName;
                if (!acc[name]) {
                    acc[name] = 0;
                }
                acc[name] += salary.amount;
                return acc;
            }, {});

            const salariesReportTableBody = document.getElementById('salaries-by-employee-report-table-body');
            const salariesReportTable = document.getElementById('salaries-by-employee-report-table');
            salariesReportTableBody.innerHTML = ''; // Clear previous data

            const existingSalariesTfoot = salariesReportTable.querySelector('tfoot');
            if(existingSalariesTfoot) existingSalariesTfoot.remove();

            const sortedSalaries = Object.entries(salariesByEmployee).sort(([,a],[,b]) => b-a);

            if (sortedSalaries.length > 0) {
                sortedSalaries.forEach(([name, totalAmount]) => {
                    const row = salariesReportTableBody.insertRow();
                    row.innerHTML = `
                        <td>${name}</td>
                        <td>${totalAmount.toFixed(2)} ${appSettings.currency}</td>
                    `;
                });
                
                const totalSalaries = salariesData.reduce((sum, s) => sum + s.amount, 0);
                const tfoot = document.createElement('tfoot');
                tfoot.innerHTML = `
                    <tr class="font-bold bg-slate-100">
                        <td class="p-2 text-left font-bold">المجموع الكلي للرواتب</td>
                        <td class="p-2 font-bold">${totalSalaries.toFixed(2)} ${appSettings.currency}</td>
                    </tr>
                `;
                salariesReportTable.appendChild(tfoot);

            } else {
                salariesReportTableBody.innerHTML = `<tr><td colspan="2" class="text-center">لا توجد بيانات رواتب في هذه الفترة</td></tr>`;
            }

            // Performance Chart (Bar)
            if (performanceChart) performanceChart.destroy();
            performanceChart = new Chart(document.getElementById('performanceChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['إجمالي المبيعات', 'إجمالي المشتريات', 'إجمالي المصاريف', 'الربح الصافي'],
                    datasets: [{
                        label: `الأداء المالي بـ(${appSettings.currency})`,
                        data: [reportSales, reportPurchases, reportExpenses, reportProfit],
                        backgroundColor: ['#0ea5e9', '#f59e0b', '#ef4444', '#10b981'],
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: chartTextColor },
                            grid: { color: chartGridColor }
                        },
                        x: {
                            ticks: { color: chartTextColor },
                            grid: { color: chartGridColor }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: chartTextColor } }
                    }
                }
            });

            // Sales Distribution Chart (Pie)
            const salesDistribution = salesData.reduce((acc, sale) => {
                acc[sale.name] = (acc[sale.name] || 0) + sale.amount;
                return acc;
            }, {});
            const sortedSales = Object.entries(salesDistribution).sort((a, b) => b[1] - a[1]).slice(0, 7);
            
            if (salesDistributionChart) salesDistributionChart.destroy();
            if (sortedSales.length > 0) {
                 salesDistributionChart = new Chart(document.getElementById('salesDistributionChart').getContext('2d'), {
                     type: 'pie',
                     data: {
                         labels: sortedSales.map(item => item[0]),
                         datasets: [{
                             label: 'إجمالي المبيعات',
                             data: sortedSales.map(item => item[1]),
                             backgroundColor: ['#0ea5e9', '#10b981', '#f59e0b', '#8b5cf6', '#ef4444', '#64748b', '#06b6d4'],
                             hoverOffset: 4
                         }]
                     },
                     options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: chartTextColor
                                }
                            }
                        }
                     }
                 });
            } else {
                 document.getElementById('salesDistributionChart').getContext('2d').clearRect(0,0,300,300);
            }
            
            document.getElementById('report-results').classList.remove('hidden');
        }

        // --- Event Listeners and Form Handlers ---
        function setupEventListeners() {
            document.getElementById('menu-toggle').addEventListener('click', () => {
                document.body.classList.toggle('sidebar-active');
            });
            // Modal listeners
            formModalCloseBtn.addEventListener('click', hideModal);
            formModalCancelBtn.addEventListener('click', hideModal);
            formModalOverlay.addEventListener('click', hideModal);

            // Wire up all "Add New" buttons to their modals
            document.getElementById('show-add-product-modal-btn')?.addEventListener('click', () => showProductModal());
            document.getElementById('show-add-sale-modal-btn')?.addEventListener('click', () => showSaleModal());
            document.getElementById('show-add-purchase-modal-btn')?.addEventListener('click', () => showPurchaseModal_v2());
            document.getElementById('show-add-return-modal-btn')?.addEventListener('click', () => showReturnModal());
            document.getElementById('show-add-expense-modal-btn')?.addEventListener('click', () => showExpenseModal());
            document.getElementById('show-add-customer-modal-btn')?.addEventListener('click', () => showCustomerModal());
            document.getElementById('show-add-supplier-modal-btn')?.addEventListener('click', () => showSupplierModal());
            document.getElementById('show-add-warehouse-modal-btn')?.addEventListener('click', () => showWarehouseModal());
            document.getElementById('show-add-employee-modal-btn')?.addEventListener('click', () => showEmployeeModal());
            document.getElementById('show-add-user-modal-btn')?.addEventListener('click', () => showUserModal());
            document.getElementById('show-add-quotation-modal-btn')?.addEventListener('click', () => showQuotationModal());
            document.getElementById('show-add-invoice-modal-btn')?.addEventListener('click', () => showInvoiceModal());
            document.getElementById('show-add-product-type-modal-btn')?.addEventListener('click', () => showProductTypeModal());
            document.getElementById('show-add-type-modal-btn')?.addEventListener('click', () => showProductTypeModal());

            document.getElementById('product-category-filter')?.addEventListener('change', refreshProducts);
            document.getElementById('nav-tabs').addEventListener('click', (e) => e.target.tagName === 'BUTTON' && switchTab(e.target.dataset.tab));
            document.getElementById('dashboard-date-form').addEventListener('submit', (e) => { e.preventDefault(); updateDashboard(document.getElementById('dashboard-date').value); });
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('reports-form')?.addEventListener('submit', (e) => { e.preventDefault(); generateReport(); });
            document.getElementById('settings-form')?.addEventListener('submit', handleSettingsSave);
            document.getElementById('delete-selected-products-btn')?.addEventListener('click', handleDeleteSelectedProducts);
            document.getElementById('import-products-excel')?.addEventListener('change', importFromExcel);
            
			document.getElementById('product-search-input')?.addEventListener('input', () => refreshProducts());
			document.getElementById('product-supplier-filter')?.addEventListener('change', () => refreshProducts());
			document.getElementById('warehouse-filter')?.addEventListener('change', () => refreshProducts());

            document.getElementById('select-all-products')?.addEventListener('change', (e) => {
                document.querySelectorAll('.product-checkbox').forEach(checkbox => checkbox.checked = e.target.checked);
                toggleDeleteSelectedButton();
            });
            document.getElementById('products-table')?.addEventListener('change', (e) => {
                if (e.target.classList.contains('product-checkbox')) toggleDeleteSelectedButton();
            });
             document.getElementById('alert-ok-btn')?.addEventListener('click', () => {
                 document.getElementById('custom-alert').classList.add('hidden');
                 document.getElementById('custom-overlay').classList.add('hidden');
             });
            document.getElementById('tab-content').addEventListener('click', handleTableActions);

            document.getElementById('invoice-close-btn').addEventListener('click', () => {
                document.getElementById('invoice-view-modal').classList.add('hidden');
                document.getElementById('custom-overlay').classList.add('hidden');
            });
            document.getElementById('quotation-close-btn').addEventListener('click', () => {
                document.getElementById('quotation-view-modal').classList.add('hidden');
                document.getElementById('custom-overlay').classList.add('hidden');
            });
            document.getElementById('invoice-print-btn').addEventListener('click', ()=>exportToPdfWithArabic('printable-invoice', 'فاتورة', `invoice-${currentInvoiceId}.pdf`));
            document.getElementById('quotation-print-btn').addEventListener('click', ()=>exportToPdfWithArabic('printable-quotation', 'عرض سعر', `quotation-${currentQuotationId}.pdf`));

            document.getElementById('print-report-btn').addEventListener('click', () => window.print());
            document.getElementById('export-report-pdf-btn').addEventListener('click', () => exportToPdfWithArabic('printable-content', 'تقرير الأداء', 'PerformanceReport.pdf'));
            
            document.getElementById('export-advanced-report-excel-btn').addEventListener('click', exportAdvancedReportToExcel);
            document.getElementById('user-role-select')?.addEventListener('change', displayRolePermissions);
            
            document.getElementById('sales-filter-form').addEventListener('submit', (e) => { e.preventDefault(); refreshSales(document.getElementById('sales-filter-date').value); });
            document.getElementById('sales-clear-filter').addEventListener('click', () => { document.getElementById('sales-filter-date').value = ''; refreshSales(); });
            document.getElementById('purchases-filter-form').addEventListener('submit', (e) => { e.preventDefault(); refreshPurchases(document.getElementById('purchases-filter-date').value); });
            document.getElementById('purchases-clear-filter').addEventListener('click', () => { document.getElementById('purchases-clear-filter').value = ''; refreshPurchases(); });
            document.getElementById('expenses-filter-form').addEventListener('submit', (e) => { e.preventDefault(); refreshExpenses(document.getElementById('expenses-filter-date').value); });
            document.getElementById('expenses-clear-filter').addEventListener('click', () => { document.getElementById('expenses-clear-filter').value = ''; refreshExpenses(); });

            document.getElementById('export-invoices-excel-btn').addEventListener('click', exportInvoicesToExcel);

            document.getElementById('export-products-btn').addEventListener('click', () => exportToExcel('products-table-export', 'المنتجات', 'Products.xlsx'));
            document.getElementById('export-sales-btn').addEventListener('click', () => exportToExcel('sales-table-export', 'المبيعات', 'Sales.xlsx'));
            document.getElementById('export-purchases-btn').addEventListener('click', () => exportToExcel('purchases-table-export', 'المشتريات', 'Purchases.xlsx'));
            document.getElementById('export-expenses-btn').addEventListener('click', () => exportToExcel('expenses-table-export', 'المصاريف', 'Expenses.xlsx'));
            document.getElementById('export-customers-btn').addEventListener('click', () => exportToExcel('customers-table-export', 'العملاء', 'Customers.xlsx'));
            document.getElementById('export-suppliers-btn').addEventListener('click', () => exportToExcel('suppliers-table-export', 'الموردين', 'Suppliers.xlsx'));
            document.getElementById('export-returns-btn').addEventListener('click', () => exportToExcel('returns-table-export', 'المرتجعات', 'Returns.xlsx'));
            document.getElementById('export-quotations-btn').addEventListener('click', () => exportToExcel('quotations-table-export', 'عروض الأسعار', 'Quotations.xlsx'));
            
            document.getElementById('forgot-password-link').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('forgot-password-modal').classList.remove('hidden');
                document.getElementById('custom-overlay').classList.remove('hidden');
            });
            document.getElementById('forgot-password-form').addEventListener('submit', handlePasswordReset);
            document.getElementById('forgot-password-cancel-btn').addEventListener('click', () => {
                document.getElementById('forgot-password-modal').classList.add('hidden');
                document.getElementById('custom-overlay').classList.add('hidden');
            });

            document.getElementById('export-backup-btn').addEventListener('click', exportBackup);
            document.getElementById('import-backup-input').addEventListener('change', handleImportBackup);
            
            document.getElementById('setting-company-logo').addEventListener('change', handleLogoUpload);
            document.getElementById('remove-logo-btn').addEventListener('click', handleRemoveLogo);
        }
        
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorP = document.getElementById('login-error');
            errorP.classList.add('hidden');
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login failed:", error);
                errorP.textContent = "البريد الإلكتروني أو كلمة المرور غير صحيحة.";
                errorP.classList.remove('hidden');
            }
        }

        function handleLogout() { signOut(auth); }

        async function handlePasswordReset(e) {
            e.preventDefault();
            const email = document.getElementById('reset-email').value;
            if (!email) {
                showMessage('الرجاء إدخال البريد الإلكتروني.');
                return;
            }
            try {
                await sendPasswordResetEmail(auth, email);
                showMessage('تم إرسال رابط إعادة تعيين كلمة المرور إلى بريدك الإلكتروني.');
                document.getElementById('forgot-password-modal').classList.add('hidden');
                document.getElementById('custom-overlay').classList.add('hidden');
            } catch (error) {
                console.error("Password reset error:", error);
                if (error.code === 'auth/user-not-found') {
                    showMessage('هذا البريد الإلكتروني غير مسجل.');
                } else {
                    showMessage('حدث خطأ أثناء إرسال البريد الإلكتروني.');
                }
            }
        }

        // --- NEW Purchase Modal Functions (v2) ---
        function getPurchaseFormHTML_v2(item = null) {
            const supplierOptions = (supplierIdToNameMap ? Array.from(supplierIdToNameMap.entries()) : []).map(([id, name]) => `<option value="${id}" ${item?.supplierId === id ? 'selected' : ''}>${name}</option>`).join('');
            const productOptions = (productsCache || []).map(p => `<option value="${p.id}">${p.name} - ${p.warehouseName}</option>`).join('');
            const warehouseOptions = (warehousesCache || []).map(w => `<option value="${w.id}">${w.name}</option>`).join('');
            const productTypeOptions = (productTypesCache || []).map(pt => `<option value="${pt.name}">${pt.name}</option>`).join('');

            // Determine if we are editing. Old items are always 'expense'.
            const isEditingExpense = !!item;

            return `
        <form id="modal-purchase-form-v2" class="space-y-4">
            <div class="flex flex-col">
                <label class="text-slate-600 mb-1">نوع الشراء</label>
                <select id="modal-purchase-type-v2" class="select" ${isEditingExpense ? 'disabled' : ''}>
                    <option value="expense" ${isEditingExpense ? 'selected' : ''}>مصروف عام (فاتورة خدمات، الخ)</option>
                    <option value="stock">إضافة للمخزون (شراء بضاعة)</option>
                </select>
            </div>

            <!-- Fields for General Expense -->
            <div id="purchase-expense-fields-v2" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="flex flex-col">
                    <label for="modal-p-date-expense-v2" class="text-slate-600 mb-1">التاريخ</label>
                    <input type="date" id="modal-p-date-expense-v2" class="input" value="${item?.date || getLocalDate()}" required>
                </div>
                <div class="flex flex-col">
                    <label for="modal-p-supplier-expense-v2" class="text-slate-600 mb-1">المورد</label>
                    <select id="modal-p-supplier-expense-v2" class="select">
                        <option value="">اختر مورد</option>
                        ${supplierOptions}
                    </select>
                </div>
                <div class="flex flex-col col-span-full">
                    <label for="modal-p-item-name-expense-v2" class="text-slate-600 mb-1">اسم البند/الخدمة</label>
                    <input type="text" id="modal-p-item-name-expense-v2" class="input" value="${item?.itemName || ''}" required>
                </div>
                <div class="flex flex-col col-span-full">
                    <label for="modal-p-amount-expense-v2" class="text-slate-600 mb-1">المبلغ الإجمالي</label>
                    <input type="number" id="modal-p-amount-expense-v2" class="input" min="0" step="0.01" value="${item?.amount || ''}" required>
                </div>
            </div>

            <!-- Fields for Adding Stock -->
            <div id="purchase-stock-fields-v2" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4 border-t pt-4">
                <div class="col-span-full text-center text-sky-700 font-semibold bg-sky-50 p-2 rounded-lg">قسم إضافة المخزون</div>
                 <div class="flex flex-col col-span-full">
                    <label for="modal-p-warehouse-stock-v2" class="text-slate-600 mb-1">المستودع</label>
                    <select id="modal-p-warehouse-stock-v2" class="select" required>
                        <option value="">اختر مستودع</option>
                        ${warehouseOptions}
                    </select>
                </div>
                <div class="flex flex-col">
                    <label for="modal-p-category-stock-v2" class="text-slate-600 mb-1">نوع المنتج</label>
                    <select id="modal-p-category-stock-v2" class="select" required>
                        <option value="">اختر نوع</option>
                        ${productTypeOptions}
                    </select>
                </div>
                <div class="flex flex-col">
                    <label for="modal-p-new-product-name-v2" class="text-slate-600 mb-1">اسم المنتج</label>
                    <input type="text" id="modal-p-new-product-name-v2" class="input" required>
                </div>
                <div class="flex flex-col">
                    <label for="modal-p-qty-stock-v2" class="text-slate-600 mb-1">الكمية</label>
                    <input type="number" id="modal-p-qty-stock-v2" class="input" min="1" required>
                </div>
                 <div class="flex flex-col">
                    <label for="modal-p-cost-stock-v2" class="text-slate-600 mb-1">سعر التكلفة (للقطعة)</label>
                    <input type="number" id="modal-p-cost-stock-v2" class="input" min="0" step="0.01" required>
                </div>
                 <div class="flex flex-col">
                    <label for="modal-p-supplier-stock-v2" class="text-slate-600 mb-1">المورد</label>
                    <select id="modal-p-supplier-stock-v2" class="select">
                        <option value="">شراء مباشر (بدون مورد)</option>
                        ${supplierOptions}
                    </select>
                </div>
                <div class="flex flex-col">
                    <label for="modal-p-date-stock-v2" class="text-slate-600 mb-1">التاريخ</label>
                    <input type="date" id="modal-p-date-stock-v2" class="input" value="${getLocalDate()}" required>
                </div>
            </div>
        </form>
    `;
        }

        function showPurchaseModal_v2(item = null) {
            const title = item ? 'تعديل عملية شراء' : 'إضافة عملية شراء';
            const formHTML = getPurchaseFormHTML_v2(item);
            showModal(title, formHTML, async () => {
                const form = document.getElementById('modal-purchase-form-v2');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                await handlePurchaseFormSubmit_v2(item?.id);
            });

            // Post-render logic
            const purchaseTypeSelect = document.getElementById('modal-purchase-type-v2');
            const expenseFields = document.getElementById('purchase-expense-fields-v2');
            const stockFields = document.getElementById('purchase-stock-fields-v2');

            const handlePurchaseTypeChange = () => {
                const isExpense = purchaseTypeSelect.value === 'expense';
                expenseFields.style.display = isExpense ? 'grid' : 'none';
                stockFields.style.display = isExpense ? 'none' : 'grid';

                // Toggle required attributes for validation
                expenseFields.querySelectorAll('input, select').forEach(el => el.required = isExpense);
                stockFields.querySelectorAll('input, select').forEach(el => el.required = !isExpense);

                // Supplier is not required in either form
                document.getElementById('modal-p-supplier-expense-v2').required = false;
                document.getElementById('modal-p-supplier-stock-v2').required = false;
            };

            purchaseTypeSelect.addEventListener('change', handlePurchaseTypeChange);

            // Logic for editing: old purchases are always 'expense' type
            if (item) {
                purchaseTypeSelect.value = 'expense';
                document.getElementById('modal-p-supplier-expense-v2').value = item.supplierId || '';
            }

            // Initial setup
            handlePurchaseTypeChange();
        }

        async function handlePurchaseFormSubmit_v2(id = null) {
            const purchaseType = document.getElementById('modal-purchase-type-v2').value;

            if (id || purchaseType === 'expense') {
                // Logic for general expense or editing an existing purchase
                const supplierDocId = document.getElementById('modal-p-supplier-expense-v2').value;
                const supplierName = supplierIdToNameMap.get(supplierDocId) || 'غير محدد';

                const data = {
                    date: document.getElementById('modal-p-date-expense-v2').value,
                    itemName: document.getElementById('modal-p-item-name-expense-v2').value,
                    amount: Math.abs(parseFloat(document.getElementById('modal-p-amount-expense-v2').value)),
                    supplierId: supplierDocId || null,
                    supplierName: supplierName,
                    isStock: false // Mark as non-stock purchase
                };

                if (await addOrUpdateItem('purchases', data, id, {
                    add: `إضافة شراء: ${data.itemName}`,
                    update: `تعديل شراء: ${data.itemName}`
                })) {
                    hideModal();
                    await refreshPurchases();
                    await updateDashboard();
                    showMessage('تم تسجيل المصروف بنجاح!');
                }
            } else { // purchaseType === 'stock'
                // Logic for adding new stock
                const qty = Math.abs(parseInt(document.getElementById('modal-p-qty-stock-v2').value));
                const cost = Math.abs(parseFloat(document.getElementById('modal-p-cost-stock-v2').value));
                const warehouseId = document.getElementById('modal-p-warehouse-stock-v2').value;
                const category = document.getElementById('modal-p-category-stock-v2').value;
                const newProductName = document.getElementById('modal-p-new-product-name-v2').value.trim();
                const supplierId = document.getElementById('modal-p-supplier-stock-v2').value;
                const supplierName = supplierIdToNameMap.get(supplierId) || 'شراء مباشر';
                const date = document.getElementById('modal-p-date-stock-v2').value;

                if (isNaN(qty) || isNaN(cost) || !warehouseId || !category || !newProductName) {
                    return showMessage('الرجاء تعبئة جميع حقول المخزون المطلوبة.');
                }

                const totalAmount = qty * cost;

                try {
                    await runTransaction(db, async (transaction) => {
                        const warehouse = warehousesCache.find(w => w.id === warehouseId);
                        
                        // Check if a product with the same name and warehouse already exists
                        const existingProductQuery = query(collection(db, 'products'),
                            where('name', '==', newProductName),
                            where('warehouseId', '==', warehouseId)
                        );
                        const existingProductSnapshot = await getDocs(existingProductQuery);

                        let productId;
                        if (!existingProductSnapshot.empty) {
                            // Product exists, update it
                            const existingProductDoc = existingProductSnapshot.docs[0];
                            productId = existingProductDoc.id;
                            const productRef = doc(db, 'products', productId);
                            transaction.update(productRef, {
                                qty: increment(qty),
                                cost: cost, // Update cost to the latest purchase price
                                category: category,
                                supplierId: supplierId || null,
                                supplierName: supplierName,
                                updatedAt: serverTimestamp()
                            });
                        } else {
                            // Product does not exist, create a new one
                            const newProductData = {
                                name: newProductName, category, cost, qty, warehouseId,
                                warehouseName: warehouse.name,
                                supplierId: supplierId || null,
                                supplierName: supplierName,
                                isOpeningStock: false,
                                createdAt: serverTimestamp(),
                                updatedAt: serverTimestamp()
                            };
                            const newProdRef = doc(collection(db, 'products'));
                            transaction.set(newProdRef, newProductData);
                            productId = newProdRef.id;
                        }

                        // Create a purchase record for financial tracking
                        const purchaseData = {
                            date,
                            itemName: `شراء بضاعة: ${newProductName}`,
                            amount: totalAmount,
                            supplierId: supplierId || null,
                            supplierName,
                            productId: productId,
                            qty,
                            cost,
                            isStock: true, // Mark as stock purchase
                            createdAt: serverTimestamp(),
                            updatedAt: serverTimestamp()
                        };
                        const newPurchaseRef = doc(collection(db, 'purchases'));
                        transaction.set(newPurchaseRef, purchaseData);
                    });

                    await logActivity('إضافة مخزون', `المنتج: ${newProductName}, الكمية: ${qty}`);
                    hideModal();
                    await refreshProducts();
                    await refreshPurchases();
                    await updateDashboard();
                    showMessage('تمت إضافة المخزون وتسجيل الشراء بنجاح!');

                } catch (error) {
                    console.error('Stock purchase failed:', error);
                    showMessage(`حدث خطأ: ${error.message}`);
                }
            }
        }

        async function handleTableActions(e) {
            const target = e.target.closest('button'); if (!target) return;
            const id = target.dataset.id;
            
            if(target.tagName !== 'BUTTON') return;

            const category = target.dataset.category;
            if (target.classList.contains('view-invoice-btn')) { if (id) await viewInvoice(id); return; }
            if (target.classList.contains('view-quotation-btn')) { if (id) await viewQuotation(id); return; }
            if (target.classList.contains('create-invoice-from-sale-btn')) { if (id) await createInvoiceFromSale(id); return; }
            if (target.classList.contains('convert-quotation-btn')) { if (id) await convertQuotationToInvoice(id); return; }
            if (!category) return;

            let collectionName = category.endsWith('s') ? category : category + 's';
            if (category === 'user') collectionName = 'users';
            if (category === 'quotation') collectionName = 'quotations';


            if (target.classList.contains('edit-btn') && category === 'product') {
                 const itemDoc = await getDoc(doc(db, 'products', id));
                 if (itemDoc.exists()) showProductModal({ id: itemDoc.id, ...itemDoc.data() });
                 return;
            }
            if (target.classList.contains('edit-btn') && category === 'sale') {
                const itemDoc = await getDoc(doc(db, 'sales', id));
                if (itemDoc.exists()) showSaleModal({ id: itemDoc.id, ...itemDoc.data() });
                return;
            }
            if (target.classList.contains('edit-btn') && category === 'purchase') {
                const itemDoc = await getDoc(doc(db, 'purchases', id));
                if (itemDoc.exists()) showPurchaseModal_v2({ id: itemDoc.id, ...itemDoc.data() });
                return;
            }
            if (target.classList.contains('edit-btn') && category === 'expense') {
                const itemDoc = await getDoc(doc(db, 'expenses', id));
                if (itemDoc.exists()) showExpenseModal({ id: itemDoc.id, ...itemDoc.data() });
                return;
            }
            if (target.classList.contains('edit-btn') && category === 'customer') {
                const itemDoc = await getDoc(doc(db, 'customers', id));
                if (itemDoc.exists()) showCustomerModal({ id: itemDoc.id, ...itemDoc.data() });
                return;
            }
            if (target.classList.contains('edit-btn') && category === 'supplier') {
                const itemDoc = await getDoc(doc(db, 'suppliers', id));
                if (itemDoc.exists()) showSupplierModal({ id: itemDoc.id, ...itemDoc.data() });
                return;
            }
            if (target.classList.contains('edit-btn') && category === 'warehouse') {
                const itemDoc = await getDoc(doc(db, 'warehouses', id));
                if (itemDoc.exists()) showWarehouseModal({ id: itemDoc.id, ...itemDoc.data() });
                return;
            }
            if (target.classList.contains('edit-btn') && category === 'employee') {
                const itemDoc = await getDoc(doc(db, 'employees', id));
                if (itemDoc.exists()) showEmployeeModal({ id: itemDoc.id, ...itemDoc.data() });
                return;
            }
            if (target.classList.contains('edit-btn') && category === 'product-type') {
                const itemDoc = await getDoc(doc(db, 'product-types', id));
                if (itemDoc.exists()) showProductTypeModal({ id: itemDoc.id, ...itemDoc.data() });
                return;
            }
            if (target.classList.contains('edit-btn') && category === 'quotation') {
                const itemDoc = await getDoc(doc(db, 'quotations', id));
                if (itemDoc.exists()) showQuotationModal({ id: itemDoc.id, ...itemDoc.data() });
                return;
            }
            if (target.classList.contains('delete-btn')) {
                showConfirm('هل أنت متأكد من الحذف؟', async () => {
                    if (await deleteItem(collectionName, id)) {
                        const refreshMap = {
                            products: [refreshProducts], sales: [refreshSales, refreshProducts, updateDashboard], purchases: [refreshPurchases, refreshProducts, updateDashboard],
                            expenses: [refreshExpenses, updateDashboard], customers: [refreshCustomers, refreshSales, refreshInvoices], 
                            suppliers: [refreshSuppliers, refreshProducts, refreshPurchases], invoices: [refreshInvoices],
                            users: [refreshUsers], employees: [refreshEmployees], warehouses: [refreshWarehouses, refreshProducts],
                            returns: [refreshReturns, refreshProducts], quotations: [refreshQuotations]
                        };
                        if (refreshMap[collectionName]) {
                            for(const func of refreshMap[collectionName]) await func();
                        }
                        showMessage("تم الحذف بنجاح.");
                    }
                });
            }
        }

        async function createInvoiceFromSale(saleId) {
            const saleDoc = await getDoc(doc(db, 'sales', saleId));
            if(!saleDoc.exists()) return showMessage('لم يتم العثور على عملية البيع');
            const sale = saleDoc.data();

            if (!sale.customerId) {
                return showMessage('لا يمكن إنشاء فاتورة لعملية بيع بدون عميل محدد. يرجى تعديل عملية البيع وإضافة عميل.');
            }
            
            const customerDoc = await getDoc(doc(db, 'customers', sale.customerId));
            if (!customerDoc.exists()) return showMessage('العميل المرتبط بعملية البيع هذه غير موجود');
            
            const settingsDocRef = doc(db, 'settings', 'appConfig');
            
            try {
                let newInvoiceNumber;
                await runTransaction(db, async (transaction) => {
                    const settingsDoc = await transaction.get(settingsDocRef);
                    newInvoiceNumber = (settingsDoc.data()?.lastInvoiceNumber || 0) + 1;
                    
                    const invoiceItems = [];
                    if (sale.type === 'product') {
                         invoiceItems.push({ 
                             type: 'product',
                             productId: sale.productId,
                             productName: sale.name,
							 warehouseId: sale.warehouseId,
							 warehouseName: sale.warehouseName,
                             qty: sale.qty,
                             price: sale.price,
                             total: sale.amount
                         });
                    } else {
                        invoiceItems.push({ 
                            type: 'manual',
                            productName: sale.name,
                            qty: 1,
                            price: sale.price,
                            total: sale.amount
                        });
                    }

                    const invoiceData = {
                        invoiceNumber: newInvoiceNumber,
                        date: sale.date,
                        customerId: sale.customerId,
                        customerName: sale.customerName,
                        customerDetails: customerDoc.data(),
                        items: invoiceItems,
                        totalAmount: sale.amount
                    };
                    
                    const newInvoiceRef = doc(collection(db, 'invoices'));
                    transaction.set(newInvoiceRef, invoiceData);
                    transaction.update(settingsDocRef, { lastInvoiceNumber: newInvoiceNumber });
                });

                await refreshInvoices();
                await logActivity('إنشاء فاتورة', `من عملية بيع للعميل: ${sale.customerName}, فاتورة رقم ${newInvoiceNumber}`);
                showMessage(`تم إنشاء الفاتورة رقم ${newInvoiceNumber} بنجاح.`);

            } catch (error) {
                console.error("Invoice creation failed: ", error);
                showMessage("فشل إنشاء الفاتورة. الرجاء المحاولة مرة أخرى.");
            }
        }
        
        // --- Product Modal Functions ---
        function getProductFormHTML(item = null) {
            const warehouseOptions = (warehousesCache || []).map(w => `<option value="${w.id}" ${item?.warehouseId === w.id ? 'selected' : ''}>${w.name}</option>`).join('');
            const productTypeOptions = (productTypesCache || []).map(pt => `<option value="${pt.name}" ${item?.category === pt.name ? 'selected' : ''}>${pt.name}</option>`).join('');

            return `
                <form id="modal-product-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex flex-col">
                        <label for="modal-p-category" class="text-slate-600 mb-1">نوع المنتج</label>
                        <select id="modal-p-category" class="select" required>
                            <option value="">اختر نوع</option>
                            ${productTypeOptions}
                        </select>
                    </div>
                    <div class="flex flex-col">
                        <label for="modal-p-name" class="text-slate-600 mb-1">اسم المنتج</label>
                        <input type="text" id="modal-p-name" class="input" value="${item?.name || ''}" required>
                    </div>
                    <div class="flex flex-col">
                        <label for="modal-p-warehouse" class="text-slate-600 mb-1">المستودع</label>
                        <select id="modal-p-warehouse" class="select" required>
                            <option value="">اختر مستودع</option>
                            ${warehouseOptions}
                        </select>
                    </div>
                    <div class="flex flex-col">
                        <label for="modal-p-qty" class="text-slate-600 mb-1">الكمية</label>
                        <input type="number" id="modal-p-qty" class="input" min="0" value="${item?.qty || ''}" required>
                    </div>
                    <div class="flex flex-col">
                        <label for="modal-p-cost" class="text-slate-600 mb-1">سعر التكلفة</label>
                        <input type="number" id="modal-p-cost" class="input" min="0" step="0.01" value="${item?.cost || ''}" required>
                    </div>
                    <div class="flex items-center col-span-full">
                        <input type="checkbox" id="modal-p-is-opening" class="w-4 h-4 text-sky-600 bg-gray-100 border-gray-300 rounded focus:ring-sky-500" ${item?.isOpeningStock ? 'checked' : ''}>
                        <label for="modal-p-is-opening" class="mr-2 text-sm font-medium text-gray-900">هل هذه بضاعة أول المدة؟ (سيتم احتسابها ضمن رأس المال)</label>
                    </div>
                </form>
            `;
        }

        function showProductModal(item = null) {
            const title = item ? 'تعديل منتج' : 'إضافة منتج جديد';
            const formHTML = getProductFormHTML(item);
            showModal(title, formHTML, async () => {
                const form = document.getElementById('modal-product-form');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                await handleProductFormSubmit(item?.id);
            });
            // Populate selects inside the modal after it's rendered
            if (item) {
                 document.getElementById('modal-p-supplier').value = item.supplierId || '';
                 document.getElementById('modal-p-warehouse').value = item.warehouseId || '';
            }
        }

        async function handleProductFormSubmit(id = null) {
            const warehouseId = document.getElementById('modal-p-warehouse').value;
            const warehouse = warehousesCache.find(w => w.id === warehouseId);

            if (!warehouse) return showMessage("الرجاء اختيار مستودع صالح.");

            const data = { 
                name: document.getElementById('modal-p-name').value, 
                category: document.getElementById('modal-p-category').value,
                cost: Math.abs(parseFloat(document.getElementById('modal-p-cost').value)), 
                qty: Math.abs(parseInt(document.getElementById('modal-p-qty').value)), 
                warehouseId: warehouseId,
                warehouseName: warehouse.name,
                isOpeningStock: document.getElementById('modal-p-is-opening').checked,
                supplierName: document.getElementById('modal-p-is-opening').checked ? 'بضاعة أول المدة' : 'شراء مباشر'
            };

            if (await addOrUpdateItem('products', data, id, { add: `إضافة منتج: ${data.name}`, update: `تعديل منتج: ${data.name}` })) {
                hideModal();
                await refreshProducts(); 
                showMessage('تم حفظ المنتج بنجاح!');
            }
        }

        // --- Sale Modal Functions ---
        function getSaleFormHTML(item = null) {
            const customerOptions = (customersCache || []).map(c => `<option value="${c.id}" ${item?.customerId === c.id ? 'selected' : ''}>${c.name}</option>`).join('');
            const warehouseOptions = (warehousesCache || []).map(w => `<option value="${w.id}" ${item?.warehouseId === w.id ? 'selected' : ''}>${w.name}</option>`).join('');
            
            return `
                <form id="modal-sale-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <input type="hidden" id="modal-s-id" value="${item?.id || ''}">
                    <div class="flex flex-col">
                        <label for="modal-s-date" class="text-slate-600 mb-1">التاريخ</label>
                        <input type="date" id="modal-s-date" class="input" value="${item?.date || getLocalDate()}" required>
                    </div>
                    <div class="flex flex-col">
                        <label for="modal-s-type" class="text-slate-600 mb-1">نوع البيع</label>
                        <select id="modal-s-type" class="select">
                            <option value="product" ${item?.type === 'product' ? 'selected' : ''}>منتج</option>
                            <option value="service" ${item?.type === 'service' ? 'selected' : ''}>خدمة (صيانة)</option>
                        </select>
                    </div>
                     <div class="flex flex-col">
                        <label for="modal-s-customer" class="text-slate-600 mb-1">العميل</label>
                        <select id="modal-s-customer" class="select">
                            <option value="">اختر عميل</option>
                            ${customerOptions}
                        </select>
                    </div>
                    <div class="flex flex-col" id="modal-s-warehouse-container">
						<label for="modal-s-warehouse" class="text-slate-600 mb-1">المستودع</label>
						<select id="modal-s-warehouse" class="select" required>
							<option value="">اختر مستودع</option>
                            ${warehouseOptions}
						</select>
					</div>
                    <div class="flex flex-col" id="modal-s-product-container">
                        <label for="modal-s-product" class="text-slate-600 mb-1">المنتج</label>
                        <select id="modal-s-product" class="select" required></select>
                    </div>
                    <div class="flex flex-col hidden" id="modal-s-service-container">
                        <label for="modal-s-service-name" class="text-slate-600 mb-1">اسم الخدمة</label>
                        <input type="text" id="modal-s-service-name" class="input" value="${item?.type === 'service' ? item.name : ''}">
                    </div>
                    <div class="flex flex-col" id="modal-s-qty-container">
                        <label for="modal-s-qty" class="text-slate-600 mb-1">الكمية</label>
                        <input type="number" id="modal-s-qty" class="input" min="1" value="${item?.qty || 1}" required>
                    </div>
                    <div class="flex flex-col">
						<label for="modal-s-cost" class="text-slate-600 mb-1">سعر التكلفة</label>
						<input type="number" id="modal-s-cost" class="input" min="0" step="0.01" placeholder="تلقائي للمنتج" value="${item?.cost || ''}" required>
					</div>
                    <div class="flex flex-col">
                        <label for="modal-s-price" class="text-slate-600 mb-1">سعر البيع</label>
                        <input type="number" id="modal-s-price" class="input" min="0" step="0.01" value="${item?.price || ''}" required>
                    </div>
                </form>
            `;
        }

        async function showSaleModal(item = null) {
            const title = item ? 'تعديل عملية بيع' : 'تسجيل عملية بيع';
            const formHTML = getSaleFormHTML(item);
            showModal(title, formHTML, async () => {
                 const form = document.getElementById('modal-sale-form');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                await handleSaleFormSubmit(item);
            });

            // Post-render logic to attach event listeners
            const typeSelect = document.getElementById('modal-s-type');
            const warehouseSelect = document.getElementById('modal-s-warehouse');
            const productSelect = document.getElementById('modal-s-product');

            const handleTypeChange = () => {
                const isService = typeSelect.value === 'service';
                document.getElementById('modal-s-product-container').classList.toggle('hidden', isService);
                document.getElementById('modal-s-qty-container').classList.toggle('hidden', isService);
                document.getElementById('modal-s-warehouse-container').classList.toggle('hidden', isService);
                document.getElementById('modal-s-service-container').classList.toggle('hidden', !isService);
                document.getElementById('modal-s-product').required = !isService;
                document.getElementById('modal-s-warehouse').required = !isService;
                document.getElementById('modal-s-service-name').required = isService;
                document.getElementById('modal-s-qty').required = !isService;
                document.getElementById('modal-s-cost').readOnly = !isService;
                if(isService) document.getElementById('modal-s-cost').value = '';
            };
            
            const handleProductChange = () => {
                const productId = productSelect.value;
                const product = productsCache.find(p => p.id === productId);

                if (product) {
                    document.getElementById('modal-s-cost').value = product.cost;
                    const productInstances = productsCache.filter(p => p.name === product.name && p.qty > 0);
                    const warehouseIdsWithStock = [...new Set(productInstances.map(p => p.warehouseId))];
                    const warehousesWithProduct = warehousesCache.filter(w => warehouseIdsWithStock.includes(w.id));
                    populateSelect(warehouseSelect.id, warehousesWithProduct, 'id', 'name', (w) => {
                        const instance = productInstances.find(p => p.warehouseId === w.id);
                        return `${w.name} (المتاح: ${instance.qty})`;
                    }, true);
                } else {
                    // This is the fix: if no product is selected, show all warehouses.
                    populateSelect(warehouseSelect.id, warehousesCache, 'id', 'name', null, true);
                    document.getElementById('modal-s-cost').value = ''; // Clear cost field
                }
            };

            typeSelect.addEventListener('change', handleTypeChange);
            productSelect.addEventListener('change', handleProductChange);

            // Initial state setup
            populateSelect(productSelect.id, productsCache, 'id', 'name', null, true);
            if (item) {
                document.getElementById('modal-s-customer').value = item.customerId || '';
                productSelect.value = item.productId || '';
            }
            handleTypeChange();
            handleProductChange(); // Trigger once on load to populate warehouses for selected item
        }

        async function handleSaleFormSubmit(item) {
            const id = item?.id;
            const type = document.getElementById('modal-s-type').value;

            // If editing a product sale, we first add the old quantity back to stock to check availability correctly.
            if (id && item?.type === 'product' && item.productId) {
                 await updateDoc(doc(db, 'products', item.productId), { qty: increment(item.qty) });
            }
            
            const customerId = document.getElementById('modal-s-customer').value;
            let customerName = 'غير محدد';
            if(customerId) {
                const customerDoc = await getDoc(doc(db, 'customers', customerId));
                if(customerDoc.exists()) customerName = customerDoc.data().name;
            }

			const warehouseId = document.getElementById('modal-s-warehouse').value;
			const warehouse = warehousesCache.find(w => w.id === warehouseId);
			if (type === 'product' && !warehouse) {
                // Revert stock if we changed it
                if (id && item?.type === 'product' && item.productId) {
                    await updateDoc(doc(db, 'products', item.productId), { qty: increment(-item.qty) });
                }
                return showMessage("الرجاء اختيار المستودع.");
            }

            const salePrice = Math.abs(parseFloat(document.getElementById('modal-s-price').value));
            const saleCost = Math.abs(parseFloat(document.getElementById('modal-s-cost').value)) || 0;
            let saleName, saleQty, amount, productId = null;

            if (type === 'product') {
                productId = document.getElementById('modal-s-product').value;
                if (!productId) {
                    if (id && item?.type === 'product' && item.productId) { await updateDoc(doc(db, 'products', item.productId), { qty: increment(-item.qty) }); }
                    return showMessage('الرجاء اختيار منتج.');
                }
                saleQty = Math.abs(parseInt(document.getElementById('modal-s-qty').value));
                const productRef = doc(db, 'products', productId);
                const productDoc = await getDoc(productRef);

                if (!productDoc.exists() || productDoc.data().warehouseId !== warehouseId) {
                    if (id && item?.type === 'product' && item.productId) { await updateDoc(doc(db, 'products', item.productId), { qty: increment(-item.qty) }); }
                    return showMessage('المنتج المحدد غير موجود في هذا المستودع.');
                }
                if (productDoc.data().qty < saleQty) {
                     if (id && item?.type === 'product' && item.productId) { await updateDoc(doc(db, 'products', item.productId), { qty: increment(-item.qty) }); }
                    return showMessage(`الكمية المتوفرة غير كافية. متاح: ${productDoc.data().qty}`);
                }
                saleName = productDoc.data().name; amount = salePrice * saleQty;
                await updateDoc(productRef, { qty: increment(-saleQty) });

            } else { // type === 'service'
                saleName = document.getElementById('modal-s-service-name').value; 
                if (!saleName) return showMessage("الرجاء إدخال اسم الخدمة.");
                saleQty = 1; 
                amount = salePrice;
            }

            const data = { 
                date: document.getElementById('modal-s-date').value, 
                type, name: saleName, qty: saleQty, price: salePrice, cost: saleCost, customerId: customerId || null, customerName, amount, productId, 
                warehouseId: type === 'product' ? warehouseId : null, 
                warehouseName: type === 'product' ? (warehouse ? warehouse.name : '') : '' 
            };

            if (await addOrUpdateItem('sales', data, id, { add: `إضافة مبيعات: ${data.name}`, update: `تعديل مبيعات: ${data.name}` })) {
                
                if (customerId && appSettings.loyaltyPointsRate > 0) {
                    let pointsChange = 0;
                    const newPoints = Math.floor(amount / appSettings.loyaltyPointsRate);

                    if (id && item?.customerId === customerId) { // Editing a sale for the same customer
                        const oldPoints = Math.floor(item.amount / appSettings.loyaltyPointsRate);
                        pointsChange = newPoints - oldPoints;
                    } else if (id && item?.customerId && item?.customerId !== customerId) { // Customer changed during edit
                        const oldPoints = Math.floor(item.amount / appSettings.loyaltyPointsRate);
                        if (oldPoints > 0) await updateDoc(doc(db, 'customers', item.customerId), { loyaltyPoints: increment(-oldPoints) });
                        pointsChange = newPoints;
                    } else if (!id) { // New sale
                        pointsChange = newPoints;
                    }

                    if(pointsChange !== 0) await updateDoc(doc(db, 'customers', customerId), { loyaltyPoints: increment(pointsChange) });
                }

                hideModal();
                await refreshSales(); 
                await refreshProducts();
                await updateDashboard();
                await refreshCustomers();
                showMessage('تم تسجيل عملية البيع بنجاح!');
            } else {
                // If the final save fails, revert ALL stock changes.
                if (type === 'product') await updateDoc(doc(db, 'products', productId), { qty: increment(saleQty) });
                if (id && item?.type === 'product' && item.productId) await updateDoc(doc(db, 'products', item.productId), { qty: increment(-item.qty) });
            }
        }

        // --- Product Type Modal Functions ---
        function getProductTypeFormHTML(item = null) {
            return `
                <form id="modal-product-type-form" class="space-y-4">
                    <div class="flex flex-col">
                        <label for="modal-pt-name" class="text-slate-600 mb-1">اسم نوع المنتج</label>
                        <input type="text" id="modal-pt-name" class="input" value="${item?.name || ''}" required>
                    </div>
                </form>
            `;
        }

        function showProductTypeModal(item = null) {
            const title = item ? 'تعديل نوع المنتج' : 'إضافة نوع منتج جديد';
            const formHTML = getProductTypeFormHTML(item);
            showModal(title, formHTML, async () => {
                const form = document.getElementById('modal-product-type-form');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                await handleProductTypeFormSubmit(item?.id);
            });
        }

        async function handleProductTypeFormSubmit(id = null) {
            const name = document.getElementById('modal-pt-name').value.trim();
            if (!name) return showMessage("اسم النوع مطلوب.");

            const data = { name };
            if (await addOrUpdateItem('product-types', data, id, { add: `إضافة نوع منتج: ${name}`, update: `تعديل نوع منتج: ${name}` })) {
                hideModal();
                await refreshProductTypes();
                showMessage('تم حفظ نوع المنتج بنجاح!');
            }
        }

        async function refreshProductTypes() {
            const q = query(collection(db, 'product-types'), orderBy('name'));
            const snapshot = await getDocs(q);
            productTypesCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            const tableBody = document.getElementById('product-types-table');
            tableBody.innerHTML = '';
            productTypesCache.forEach(pt => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td class="whitespace-nowrap">${pt.name}</td>
                    <td class="whitespace-nowrap no-export">
                        <button class="btn btn-edit text-sm edit-btn" data-id="${pt.id}" data-category="product-type">تعديل</button>
                        <button class="btn btn-danger text-sm delete-btn" data-id="${pt.id}" data-category="product-types">حذف</button>
                    </td>`;
            });

            // Also refresh the category filter on the products page
            const categoryFilterSelect = document.getElementById('product-category-filter');
            const currentCategory = categoryFilterSelect.value;
            categoryFilterSelect.innerHTML = '<option value="">فلترة حسب النوع</option>';
            productTypesCache.forEach(pt => {
                const option = document.createElement('option');
                option.value = pt.name;
                option.textContent = pt.name;
                categoryFilterSelect.appendChild(option);
            });
            categoryFilterSelect.value = currentCategory;

            applyPermissions(currentUser.role);
        }


        // --- Return Modal Functions (Refactored) ---
        function getReturnFormHTML(item = null) {
            const productOptions = (productsCache || []).map(p => `<option value="${p.id}">${p.name} (${p.warehouseName})</option>`).join('');

            return `
                <form id="modal-return-form" class="space-y-4">
                    <div class="flex flex-col">
                        <label class="text-slate-600 mb-1">نوع الإرجاع</label>
                        <div class="flex gap-4 p-2 bg-slate-100 rounded-lg">
                            <label class="flex-1 text-center p-2 rounded-md cursor-pointer has-[:checked]:bg-white has-[:checked]:shadow">
                                <input type="radio" name="returnType" value="product" class="sr-only" checked> إرجاع منتج للمخزون
                            </label>
                            <label class="flex-1 text-center p-2 rounded-md cursor-pointer has-[:checked]:bg-white has-[:checked]:shadow">
                                <input type="radio" name="returnType" value="service" class="sr-only"> إرجاع خدمة/بيع يدوي
                            </label>
                        </div>
                    </div>

                    <!-- Product Return Fields -->
                    <div id="return-product-fields" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex flex-col">
                            <label for="modal-r-product" class="text-slate-600 mb-1">المنتج</label>
                             <select id="modal-r-product" class="select" required>
                                <option value="">اختر منتج من المخزون</option>
                                ${productOptions}
                            </select>
                        </div>
                        <div class="flex flex-col">
                            <label for="modal-r-qty" class="text-slate-600 mb-1">الكمية المرتجعة</label>
                            <input type="number" id="modal-r-qty" class="input" min="1" value="1" required>
                        </div>
                    </div>

                    <!-- Service/Manual Return Fields (Initially Hidden) -->
                    <div id="return-service-fields" class="hidden space-y-4">
                        <p class="text-sm text-slate-600">ابحث عن عملية البيع الأصلية لإنشاء إدخال مالي معاكس (مرتجع).</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                            <input type="date" id="service-search-date" class="input" placeholder="بحث بالتاريخ">
                            <input type="text" id="service-search-name" class="input" placeholder="بحث باسم البند">
                            <input type="text" id="service-search-customer" class="input" placeholder="بحث باسم العميل">
                        </div>
                        <div id="service-search-results" class="data-table-container max-h-40"></div>
                    </div>
                    
                    <div class="flex flex-col col-span-full">
                        <label for="modal-r-date" class="text-slate-600 mb-1">تاريخ الإرجاع</label>
                        <input type="date" id="modal-r-date" class="input" value="${getLocalDate()}" required>
                    </div>
                    <div class="flex flex-col col-span-full">
                        <label for="modal-r-reason" class="text-slate-600 mb-1">سبب الإرجاع (اختياري)</label>
                        <textarea id="modal-r-reason" class="input" rows="2"></textarea>
                    </div>
                </form>
            `;
        }
        
        function showReturnModal() {
            const title = 'تسجيل عملية إرجاع';
            const formHTML = getReturnFormHTML();
            showModal(title, formHTML, async () => {
                await handleReturnFormSubmit();
            });

            // Event listener for toggling between return types
            document.querySelectorAll('input[name="returnType"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const isProductReturn = e.target.value === 'product';
                    document.getElementById('return-product-fields').style.display = isProductReturn ? 'grid' : 'none';
                    document.getElementById('return-service-fields').style.display = isProductReturn ? 'none' : 'block';
                });
            });

            // Event listeners for service search
            const searchInputs = ['service-search-date', 'service-search-name', 'service-search-customer'];
            searchInputs.forEach(id => document.getElementById(id).addEventListener('input', searchSalesForReturn));
            searchSalesForReturn(); // Initial search
        }

        async function searchSalesForReturn() {
            const date = document.getElementById('service-search-date').value;
            const name = document.getElementById('service-search-name').value.toLowerCase();
            const customer = document.getElementById('service-search-customer').value.toLowerCase();

            // Search for manual/service sales that are not returns themselves (amount > 0)
            let conditions = [where('type', '==', 'service'), where('amount', '>', 0)];
            if (date) conditions.push(where('date', '==', date));
            
            const q = query(collection(db, 'sales'), ...conditions, orderBy('date', 'desc'), limit(50));
            const snapshot = await getDocs(q);

            let sales = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            if (name) sales = sales.filter(s => s.name.toLowerCase().includes(name));
            if (customer) sales = sales.filter(s => s.customerName.toLowerCase().includes(customer));

            const resultsDiv = document.getElementById('service-search-results');
            resultsDiv.innerHTML = '';
            if (sales.length === 0) {
                resultsDiv.innerHTML = '<p class="p-4 text-center text-slate-500">لا توجد عمليات بيع تطابق البحث.</p>';
                return;
            }
            
            const table = document.createElement('table');
            table.className = 'data-table';
            table.innerHTML = `<thead><tr><th>اختر</th><th>التاريخ</th><th>البند</th><th>العميل</th><th>المبلغ</th></tr></thead><tbody></tbody>`;
            const tbody = table.querySelector('tbody');
            sales.forEach(s => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><input type="radio" name="saleReturnSelection" value="${s.id}" data-sale='${JSON.stringify(s)}'></td>
                    <td>${s.date}</td>
                    <td>${s.name}</td>
                    <td>${s.customerName}</td>
                    <td>${s.amount.toFixed(2)}</td>
                `;
            });
            resultsDiv.appendChild(table);
        }

        async function handleReturnFormSubmit() {
            const returnType = document.querySelector('input[name="returnType"]:checked').value;
            const date = document.getElementById('modal-r-date').value;
            const reason = document.getElementById('modal-r-reason').value.trim();

            if (returnType === 'product') {
                const productId = document.getElementById('modal-r-product').value;
                const qty = Math.abs(parseInt(document.getElementById('modal-r-qty').value));

                if (!productId || !qty) return showMessage("الرجاء اختيار منتج وتحديد الكمية.");
                
                const product = productsCache.find(p => p.id === productId);
                if (!product) return showMessage("المنتج المحدد غير صالح.");

                try {
                    const productRef = doc(db, 'products', productId);
                    await updateDoc(productRef, { qty: increment(qty) });
                        
                    const returnData = { date, reason, type: 'product', productName: product.name, productId: productId, qty, warehouseId: product.warehouseId, warehouseName: product.warehouseName };
                    await addOrUpdateItem('returns', returnData, null, { add: `إرجاع منتج: ${product.name}` });
                    
                    hideModal();
                    await refreshReturns();
                    await refreshProducts();
                    showMessage('تم تسجيل إرجاع المنتج بنجاح وزيادة المخزون.');

                } catch(error) {
                    console.error("Product return failed:", error);
                    showMessage("فشل إرجاع المنتج: " + error.message);
                }

            } else { // Service/Manual Return
                const selectedSaleRadio = document.querySelector('input[name="saleReturnSelection"]:checked');
                if (!selectedSaleRadio) return showMessage("الرجاء اختيار عملية بيع لإرجاعها.");

                const originalSale = JSON.parse(selectedSaleRadio.dataset.sale);

                const returnSaleData = {
                    date,
                    type: 'service', // All manual returns are logged as service type
                    name: `مرتجع: ${originalSale.name}`,
                    amount: -Math.abs(originalSale.amount), // Ensure it's a negative value
                    price: -Math.abs(originalSale.price),
                    qty: originalSale.qty,
                    cost: 0, // No cost impact for service returns
                    customerId: originalSale.customerId,
                    customerName: originalSale.customerName,
                    notes: `مرتبط بالبيع الأصلي بتاريخ ${originalSale.date}`
                };
                
                if (await addOrUpdateItem('sales', returnSaleData, null, { add: `إرجاع بيع يدوي: ${originalSale.name}` })) {
                    hideModal();
                    await refreshSales();
                    await updateDashboard();
                    showMessage('تم تسجيل المرتجع المالي بنجاح.');
                }
            }
        }
        
        // --- Purchase Modal Functions (Refactored for financial entries only) ---
        function getPurchaseFormHTML(item = null) {
            const supplierOptions = (supplierIdToNameMap ? Array.from(supplierIdToNameMap.entries()) : []).map(([id, name]) => `<option value="${id}" ${item?.supplierId === id ? 'selected' : ''}>${name}</option>`).join('');
            const productOptions = (productsCache || []).map(p => `<option value="${p.id}">${p.name} - ${p.warehouseName}</option>`).join('');
            const warehouseOptions = (warehousesCache || []).map(w => `<option value="${w.id}">${w.name}</option>`).join('');

            return `
                <form id="modal-purchase-form" class="space-y-4">
                    <div class="flex flex-col">
                        <label class="text-slate-600 mb-1">نوع الشراء</label>
                        <select id="modal-purchase-type" class="select">
                            <option value="expense">مصروف عام (فاتورة خدمات، الخ)</option>
                            <option value="stock">إضافة للمخزون (شراء بضاعة)</option>
                        </select>
                    </div>

                    <div id="purchase-expense-fields" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex flex-col">
                            <label for="modal-p-date-expense" class="text-slate-600 mb-1">التاريخ</label>
                            <input type="date" id="modal-p-date-expense" class="input" value="${item?.date || getLocalDate()}" required>
                        </div>
                        <div class="flex flex-col">
                            <label for="modal-p-supplier-expense" class="text-slate-600 mb-1">المورد</label>
                            <select id="modal-p-supplier-expense" class="select">
                                <option value="">اختر مورد</option>
                                ${supplierOptions}
                            </select>
                        </div>
                        <div class="flex flex-col col-span-full">
                            <label for="modal-p-item-name-expense" class="text-slate-600 mb-1">اسم البند/الخدمة</label>
                            <input type="text" id="modal-p-item-name-expense" class="input" value="${item?.itemName || ''}" required>
                        </div>
                        <div class="flex flex-col col-span-full">
                            <label for="modal-p-amount-expense" class="text-slate-600 mb-1">المبلغ الإجمالي</label>
                            <input type="number" id="modal-p-amount-expense" class="input" min="0" step="0.01" value="${item?.amount || ''}" required>
                        </div>
                    </div>

                    <div id="purchase-stock-fields" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4 border-t pt-4">
                        <div class="col-span-full text-center text-sky-700 font-semibold bg-sky-50 p-2 rounded-lg">قسم إضافة المخزون</div>
                        <div class="flex flex-col">
                            <label for="modal-p-date-stock" class="text-slate-600 mb-1">التاريخ</label>
                            <input type="date" id="modal-p-date-stock" class="input" value="${getLocalDate()}" required>
                        </div>
                        <div class="flex flex-col">
                            <label for="modal-p-supplier-stock" class="text-slate-600 mb-1">المورد</label>
                            <select id="modal-p-supplier-stock" class="select">
                                <option value="">اختر مورد</option>
                                ${supplierOptions}
                            </select>
                        </div>
                        <div class="flex flex-col">
                            <label for="modal-p-product-stock" class="text-slate-600 mb-1">المنتج الموجود</label>
                            <select id="modal-p-product-stock" class="select">
                                <option value="">اختر منتج لتزويده</option>
                                ${productOptions}
                            </select>
                        </div>
                        <div class="flex flex-col">
                            <label for="modal-p-new-product-name" class="text-slate-600 mb-1">أو اسم منتج جديد</label>
                            <input type="text" id="modal-p-new-product-name" class="input" placeholder="في حال كان المنتج غير موجود">
                        </div>
                        <div class="flex flex-col">
                            <label for="modal-p-warehouse-stock" class="text-slate-600 mb-1">المستودع</label>
                            <select id="modal-p-warehouse-stock" class="select" required>
                                <option value="">اختر مستودع</option>
                                ${warehouseOptions}
                            </select>
                        </div>
                        <div class="flex flex-col">
                            <label for="modal-p-category-stock" class="text-slate-600 mb-1">نوع المنتج</label>
                            <select id="modal-p-category-stock" class="select" required>
                                <option value="">اختر نوع</option>
                                <!-- Populated by JS -->
                            </select>
                        </div>
                        <div class="flex flex-col">
                            <label for="modal-p-qty-stock" class="text-slate-600 mb-1">الكمية</label>
                            <input type="number" id="modal-p-qty-stock" class="input" min="1" required>
                        </div>
                         <div class="flex flex-col">
                            <label for="modal-p-cost-stock" class="text-slate-600 mb-1">سعر التكلفة (للقطعة)</label>
                            <input type="number" id="modal-p-cost-stock" class="input" min="0" step="0.01" required>
                        </div>
                    </div>
                </form>
            `;
        }

        function showPurchaseModal(item = null) {
            const title = item ? 'تعديل عملية شراء' : 'إضافة عملية شراء';
            const formHTML = getPurchaseFormHTML(item);
            showModal(title, formHTML, async () => {
                const form = document.getElementById('modal-purchase-form');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                await handlePurchaseFormSubmit(item?.id);
            });

            // Post-render logic
            const purchaseTypeSelect = document.getElementById('modal-purchase-type');
            const expenseFields = document.getElementById('purchase-expense-fields');
            const stockFields = document.getElementById('purchase-stock-fields');
            
            const handlePurchaseTypeChange = () => {
                const isExpense = purchaseTypeSelect.value === 'expense';
                expenseFields.style.display = isExpense ? 'grid' : 'none';
                stockFields.style.display = isExpense ? 'none' : 'grid';

                // Toggle required attributes for validation
                expenseFields.querySelectorAll('input, select').forEach(el => el.required = isExpense);
                stockFields.querySelectorAll('input, select').forEach(el => el.required = !isExpense);
                
                // Special cases for non-required fields
                document.getElementById('modal-p-supplier-expense').required = false;
                document.getElementById('modal-p-supplier-stock').required = false;
                document.getElementById('modal-p-product-stock').required = false;
                document.getElementById('modal-p-new-product-name').required = false;
            };

            purchaseTypeSelect.addEventListener('change', handlePurchaseTypeChange);
            
            // Populate dynamic selects
            populateSelect('modal-p-category-stock', productTypesCache, 'name', 'name', null, true);

            // Logic for editing: old purchases are always 'expense' type
            if (item) {
                purchaseTypeSelect.value = 'expense';
                document.getElementById('modal-p-supplier-expense').value = item.supplierId || '';
            }
            
            // Initial setup
            handlePurchaseTypeChange();

            // Link existing product selection to fields
            document.getElementById('modal-p-product-stock').addEventListener('change', (e) => {
                const productId = e.target.value;
                const newProductNameInput = document.getElementById('modal-p-new-product-name');
                if (productId) {
                    const product = productsCache.find(p => p.id === productId);
                    if (product) {
                        document.getElementById('modal-p-cost-stock').value = product.cost;
                        document.getElementById('modal-p-category-stock').value = product.category;
                        document.getElementById('modal-p-warehouse-stock').value = product.warehouseId;
                        newProductNameInput.value = '';
                        newProductNameInput.disabled = true;
                    }
                } else {
                    newProductNameInput.disabled = false;
                }
            });
        }

        async function handlePurchaseFormSubmit(id = null) {
            const purchaseType = document.getElementById('modal-purchase-type').value;

            if (id || purchaseType === 'expense') {
                // Logic for general expense or editing (old purchases are always expenses)
                const supplierDocId = document.getElementById('modal-p-supplier-expense').value;
                const supplierName = supplierIdToNameMap.get(supplierDocId) || 'غير محدد';
                
                const data = {
                    date: document.getElementById('modal-p-date-expense').value,
                    itemName: document.getElementById('modal-p-item-name-expense').value,
                    amount: Math.abs(parseFloat(document.getElementById('modal-p-amount-expense').value)),
                    supplierId: supplierDocId || null,
                    supplierName: supplierName
                };

                if (await addOrUpdateItem('purchases', data, id, { add: `إضافة شراء: ${data.itemName}`, update: `تعديل شراء: ${data.itemName}` })) {
                    hideModal();
                    await refreshPurchases();
                    await updateDashboard();
                    showMessage('تم تسجيل المصروف بنجاح!');
                }
            } else { // purchaseType === 'stock'
                // Logic for adding new stock
                const existingProductId = document.getElementById('modal-p-product-stock').value;
                const newProductName = document.getElementById('modal-p-new-product-name').value.trim();
                
                if (!existingProductId && !newProductName) {
                    return showMessage('الرجاء اختيار منتج موجود أو إدخال اسم منتج جديد.');
                }
                if (existingProductId && newProductName) {
                    return showMessage('لا يمكن اختيار منتج موجود وإدخال اسم منتج جديد في نفس الوقت.');
                }

                const qty = Math.abs(parseInt(document.getElementById('modal-p-qty-stock').value));
                const cost = Math.abs(parseFloat(document.getElementById('modal-p-cost-stock').value));
                const warehouseId = document.getElementById('modal-p-warehouse-stock').value;
                const category = document.getElementById('modal-p-category-stock').value;
                const supplierId = document.getElementById('modal-p-supplier-stock').value;
                const supplierName = supplierIdToNameMap.get(supplierId) || 'شراء مباشر';
                const date = document.getElementById('modal-p-date-stock').value;

                if (isNaN(qty) || isNaN(cost) || !warehouseId || !category) {
                    return showMessage('الرجاء تعبئة جميع حقول المخزون المطلوبة.');
                }

                const totalAmount = qty * cost;
                let productName = '';
                let productId = null;

                try {
                    await runTransaction(db, async (transaction) => {
                        if (existingProductId) {
                            // Update existing product
                            const productRef = doc(db, 'products', existingProductId);
                            transaction.update(productRef, { qty: increment(qty) });
                            const productDoc = await transaction.get(productRef); // Re-read in transaction
                            productName = productDoc.data().name;
                            productId = existingProductId;
                        } else {
                            // Add new product
                            const warehouse = warehousesCache.find(w => w.id === warehouseId);
                            productName = newProductName;
                            const newProductData = {
                                name: productName, category, cost, qty, warehouseId,
                                warehouseName: warehouse.name,
                                supplierId: supplierId || null,
                                supplierName: supplierName,
                                isOpeningStock: false,
                                createdAt: serverTimestamp(),
                                updatedAt: serverTimestamp()
                            };
                            const newProdRef = doc(collection(db, 'products'));
                            transaction.set(newProdRef, newProductData);
                            productId = newProdRef.id;
                        }

                        // Create a purchase record for financial tracking
                        const purchaseData = {
                            date,
                            itemName: `شراء بضاعة: ${productName}`,
                            amount: totalAmount,
                            supplierId: supplierId || null,
                            supplierName,
                            productId: productId,
                            qty,
                            cost,
                            createdAt: serverTimestamp(),
                            updatedAt: serverTimestamp()
                        };
                        const newPurchaseRef = doc(collection(db, 'purchases'));
                        transaction.set(newPurchaseRef, purchaseData);
                    });

                    await logActivity('إضافة مخزون', `المنتج: ${productName}, الكمية: ${qty}`);
                    hideModal();
                    await refreshProducts();
                    await refreshPurchases();
                    await updateDashboard();
                    showMessage('تمت إضافة المخزون وتسجيل الشراء بنجاح!');

                } catch (error) {
                    console.error('Stock purchase failed:', error);
                    showMessage(`حدث خطأ: ${error.message}`);
                }
            }
        }
        
        // --- Expense Modal Functions ---
        function getExpenseFormHTML(item = null) {
            const employeeOptions = (employeesCache || []).map(emp => `<option value="${emp.id}" ${item?.employeeId === emp.id ? 'selected' : ''}>${emp.name}</option>`).join('');
            return `
                <form id="modal-expense-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex flex-col">
                        <label for="modal-e-date" class="text-slate-600 mb-1">التاريخ</label>
                        <input type="date" id="modal-e-date" name="modal-e-date" class="input" value="${item?.date || getLocalDate()}" required>
                    </div>
                    <div class="flex flex-col">
                        <label for="modal-e-type" class="text-slate-600 mb-1">نوع المصروف</label>
                        <select id="modal-e-type" name="modal-e-type" class="select" required>
                            <option value="رواتب" ${item?.type === 'رواتب' ? 'selected' : ''}>رواتب</option>
                            <option value="مصاريف اخرى" ${item?.type === 'مصاريف اخرى' ? 'selected' : ''}>مصاريف اخرى</option>
                        </select>
                    </div>
                    <div class="flex flex-col hidden" id="modal-e-employee-container">
                        <label for="modal-e-employee" class="text-slate-600 mb-1">الموظف</label>
                        <select id="modal-e-employee" name="modal-e-employee" class="select">
                            <option value="">اختر موظف</option>
                            ${employeeOptions}
                        </select>
                    </div>
                    <div class="flex flex-col">
                        <label for="modal-e-amount" class="text-slate-600 mb-1">المبلغ</label>
                        <input type="number" id="modal-e-amount" name="modal-e-amount" class="input" min="0" step="0.01" value="${item?.amount || ''}" required>
                    </div>
                    <div class="flex flex-col col-span-full">
                        <label for="modal-e-desc" class="text-slate-600 mb-1">الوصف</label>
                        <textarea id="modal-e-desc" name="modal-e-desc" class="input" rows="3">${item?.description || ''}</textarea>
                    </div>
                </form>
            `;
        }

        function showExpenseModal(item = null) {
            const title = item ? 'تعديل مصروف' : 'تسجيل مصروف جديد';
            const formHTML = getExpenseFormHTML(item);
            showModal(title, formHTML, async () => {
                const form = document.getElementById('modal-expense-form');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                await handleExpenseFormSubmit(item?.id);
            });

            const typeSelect = document.getElementById('modal-e-type');
            const employeeContainer = document.getElementById('modal-e-employee-container');
            const handleTypeChange = () => {
                employeeContainer.classList.toggle('hidden', typeSelect.value !== 'رواتب');
            };
            typeSelect.addEventListener('change', handleTypeChange);
            
            if (item) {
                document.getElementById('modal-e-employee').value = item.employeeId || '';
            }
            handleTypeChange();
        }

        async function handleExpenseFormSubmit(id = null) {
            const expenseType = document.getElementById('modal-e-type').value;
            const data = {
                date: document.getElementById('modal-e-date').value,
                type: expenseType,
                amount: Math.abs(parseFloat(document.getElementById('modal-e-amount').value)),
                description: document.getElementById('modal-e-desc').value
            };
            if (expenseType === 'رواتب') {
                const employeeSelect = document.getElementById('modal-e-employee');
                data.employeeId = employeeSelect.value;
                data.employeeName = employeeSelect.options[employeeSelect.selectedIndex].text;
            }
            if (await addOrUpdateItem('expenses', data, id, { add: `إضافة مصروف: ${data.type}`, update: `تعديل مصروف: ${data.type}` })) {
                hideModal();
                await refreshExpenses();
                await updateDashboard();
                showMessage('تم تسجيل المصروف بنجاح!');
            }
        }

        // --- Customer Modal Functions ---
        function getCustomerFormHTML(item = null) {
            return `
                <form id="modal-customer-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex flex-col">
                        <label for="modal-c-name" class="text-slate-600 mb-1">اسم العميل</label>
                        <input type="text" id="modal-c-name" class="input" value="${item?.name || ''}" required>
                    </div>
                    <div class="flex flex-col">
                        <label for="modal-c-phone" class="text-slate-600 mb-1">رقم الهاتف</label>
                        <input type="text" id="modal-c-phone" class="input" value="${item?.phone || ''}">
                    </div>
                    <div class="flex flex-col">
                        <label for="modal-c-email" class="text-slate-600 mb-1">البريد الإلكتروني</label>
                        <input type="email" id="modal-c-email" class="input" value="${item?.email || ''}">
                    </div>
                    <div class="flex flex-col col-span-full">
                        <label for="modal-c-address" class="text-slate-600 mb-1">العنوان</label>
                        <textarea id="modal-c-address" class="input" rows="3">${item?.address || ''}</textarea>
                    </div>
                </form>
            `;
        }

        function showCustomerModal(item = null) {
            const title = item ? 'تعديل عميل' : 'إضافة عميل جديد';
            const formHTML = getCustomerFormHTML(item);
            showModal(title, formHTML, async () => {
                const form = document.getElementById('modal-customer-form');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                await handleCustomerFormSubmit(item?.id);
            });
        }
        
        async function handleCustomerFormSubmit(id = null) {
            const data = {
                name: document.getElementById('modal-c-name').value,
                phone: document.getElementById('modal-c-phone').value,
                email: document.getElementById('modal-c-email').value,
                address: document.getElementById('modal-c-address').value
            };
            if(!id) {
                data.loyaltyPoints = 0;
            }

            if (await addOrUpdateItem('customers', data, id, { add: `إضافة عميل: ${data.name}`, update: `تعديل عميل: ${data.name}` })) {
                hideModal();
                await refreshCustomers();
                showMessage('تم حفظ العميل بنجاح!');
            }
        }
        
        // --- Supplier Modal Functions ---
        function getSupplierFormHTML(item = null) {
            return `
                <form id="modal-supplier-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex flex-col">
                        <label for="modal-sup-name" class="text-slate-600 mb-1">اسم المورد</label>
                        <input type="text" id="modal-sup-name" class="input" value="${item?.name || ''}" required>
                    </div>
                    <div class="flex flex-col">
                        <label for="modal-sup-phone" class="text-slate-600 mb-1">رقم الهاتف</label>
                        <input type="text" id="modal-sup-phone" class="input" value="${item?.phone || ''}">
                    </div>
                    <div class="flex flex-col">
                        <label for="modal-sup-email" class="text-slate-600 mb-1">البريد الإلكتروني</label>
                        <input type="email" id="modal-sup-email" class="input" value="${item?.email || ''}">
                    </div>
                    <div class="flex flex-col col-span-full">
                        <label for="modal-sup-address" class="text-slate-600 mb-1">العنوان</label>
                        <textarea id="modal-sup-address" class="input" rows="3">${item?.address || ''}</textarea>
                    </div>
                </form>
            `;
        }

        function showSupplierModal(item = null) {
            const title = item ? 'تعديل مورد' : 'إضافة مورد جديد';
            const formHTML = getSupplierFormHTML(item);
            showModal(title, formHTML, async () => {
                const form = document.getElementById('modal-supplier-form');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                await handleSupplierFormSubmit(item?.id);
            });
        }

        async function handleSupplierFormSubmit(id = null) {
            const data = {
                name: document.getElementById('modal-sup-name').value,
                phone: document.getElementById('modal-sup-phone').value,
                email: document.getElementById('modal-sup-email').value,
                address: document.getElementById('modal-sup-address').value
            };

            if (id) {
                if (await addOrUpdateItem('suppliers', data, id, { update: `تعديل مورد: ${data.name}` })) {
                    hideModal();
                    await refreshSuppliers();
                    showMessage('تم تحديث المورد بنجاح!');
                }
            } else {
                 const settingsRef = doc(db, 'settings', 'appConfig');
                 try {
                      await runTransaction(db, async (transaction) => {
                          const settingsDoc = await transaction.get(settingsRef);
                          const newNumericId = (settingsDoc.data()?.supplierCounter || 0) + 1;
                          transaction.update(settingsRef, { supplierCounter: newNumericId });
                          data.supplierNumericId = newNumericId;
                          const newSupplierRef = doc(collection(db, 'suppliers'));
                          transaction.set(newSupplierRef, data);
                      });
                      await logActivity('إضافة مورد', `الاسم: ${data.name}`);
                     hideModal();
                     await refreshSuppliers();
                     showMessage('تم إضافة المورد بنجاح!');
                 } catch (error) {
                     console.error("Failed to add supplier with transaction: ", error);
                     showMessage("فشل إضافة المورد، يرجى المحاولة مرة أخرى.");
                 }
            }
        }
        
        // --- Employee Modal Functions ---
        function getEmployeeFormHTML(item = null) {
            return `
                <form id="modal-employee-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex flex-col">
                        <label for="modal-emp-name" class="text-slate-600 mb-1">اسم الموظف</label>
                        <input type="text" id="modal-emp-name" class="input" value="${item?.name || ''}" required>
                    </div>
                    <div class="flex flex-col">
                        <label for="modal-emp-position" class="text-slate-600 mb-1">المسمى الوظيفي</label>
                        <input type="text" id="modal-emp-position" class="input" value="${item?.position || ''}">
                    </div>
                    <div class="flex flex-col">
                        <label for="modal-emp-id" class="text-slate-600 mb-1">الرقم الوظيفي</label>
                        <input type="text" id="modal-emp-id" class="input" value="${item?.employeeId || ''}">
                    </div>
                    <div class="flex flex-col">
                        <label for="modal-emp-phone" class="text-slate-600 mb-1">رقم الهاتف</label>
                        <input type="text" id="modal-emp-phone" class="input" value="${item?.phone || ''}">
                    </div>
                    <div class="flex flex-col">
                        <label for="modal-emp-location" class="text-slate-600 mb-1">موقع العمل</label>
                        <input type="text" id="modal-emp-location" class="input" value="${item?.workLocation || ''}">
                    </div>
                </form>
            `;
        }

        function showEmployeeModal(item = null) {
            const title = item ? 'تعديل موظف' : 'إضافة موظف جديد';
            const formHTML = getEmployeeFormHTML(item);
            showModal(title, formHTML, async () => {
                const form = document.getElementById('modal-employee-form');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                await handleEmployeeFormSubmit(item?.id);
            });
        }

        async function handleEmployeeFormSubmit(id = null) {
            const data = {
                name: document.getElementById('modal-emp-name').value,
                position: document.getElementById('modal-emp-position').value,
                employeeId: document.getElementById('modal-emp-id').value,
                phone: document.getElementById('modal-emp-phone').value,
                workLocation: document.getElementById('modal-emp-location').value,
            };
            if (await addOrUpdateItem('employees', data, id, { add: `إضافة موظف: ${data.name}`, update: `تعديل موظف: ${data.name}` })) {
                hideModal();
                await refreshEmployees();
                showMessage('تم حفظ الموظف بنجاح!');
            }
        }

        // --- Warehouse Modal Functions ---
        function getWarehouseFormHTML(item = null) {
            return `
                <form id="modal-warehouse-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex flex-col">
                        <label for="modal-w-name" class="text-slate-600 mb-1">اسم المستودع</label>
                        <input type="text" id="modal-w-name" class="input" value="${item?.name || ''}" required>
                    </div>
                    <div class="flex flex-col">
                        <label for="modal-w-location" class="text-slate-600 mb-1">الموقع</label>
                        <input type="text" id="modal-w-location" class="input" value="${item?.location || ''}">
                    </div>
                    <div class="flex flex-col">
                        <label for="modal-w-employee" class="text-slate-600 mb-1">الموظف المسؤول</label>
                        <input type="text" id="modal-w-employee" class="input" value="${item?.responsibleEmployee || ''}">
                    </div>
                    <div class="flex flex-col">
                        <label for="modal-w-phone" class="text-slate-600 mb-1">رقم الهاتف</label>
                        <input type="text" id="modal-w-phone" class="input" value="${item?.phone || ''}">
                    </div>
                </form>
            `;
        }

        function showWarehouseModal(item = null) {
            const title = item ? 'تعديل مستودع' : 'إضافة مستودع جديد';
            const formHTML = getWarehouseFormHTML(item);
            showModal(title, formHTML, async () => {
                const form = document.getElementById('modal-warehouse-form');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                await handleWarehouseFormSubmit(item?.id);
            });
        }

        async function handleWarehouseFormSubmit(id = null) {
            const data = {
                name: document.getElementById('modal-w-name').value,
                location: document.getElementById('modal-w-location').value,
                responsibleEmployee: document.getElementById('modal-w-employee').value,
                phone: document.getElementById('modal-w-phone').value,
            };
            if (await addOrUpdateItem('warehouses', data, id, { add: `إضافة مستودع: ${data.name}`, update: `تعديل مستودع: ${data.name}` })) {
                hideModal();
                await refreshWarehouses();
                showMessage('تم حفظ المستودع بنجاح!');
            }
        }

        // --- Quotation Modal Functions ---
        function getQuotationFormHTML(item = null) {
            const customerOptions = (customersCache || []).map(c => `<option value="${c.id}" ${item?.customerId === c.id ? 'selected' : ''}>${c.name}</option>`).join('');
            return `
                <form id="modal-quotation-form" class="space-y-4">
                    <input type="hidden" id="modal-quotation-id" value="${item?.id || ''}">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="modal-q-customer" class="block text-sm font-medium text-slate-700">العميل</label>
                            <select id="modal-q-customer" class="input" required>
                                <option value="">اختر عميل</option>
                                ${customerOptions}
                            </select>
                        </div>
                        <div>
                            <label for="modal-q-date" class="block text-sm font-medium text-slate-700">تاريخ عرض السعر</label>
                            <input type="date" id="modal-q-date" class="input" value="${item?.date || getLocalDate()}" required>
                        </div>
                        <div>
                            <label for="modal-q-expiry-date" class="block text-sm font-medium text-slate-700">تاريخ الانتهاء</label>
                            <input type="date" id="modal-q-expiry-date" class="input" value="${item?.expiryDate || ''}">
                        </div>
                    </div>

                    <div>
                        <h4 class="block text-sm font-medium text-slate-700 mb-2">بنود عرض السعر</h4>
                        <div id="modal-quotation-items-container" class="space-y-2">
                            <!-- Quotation item rows will be added here dynamically -->
                        </div>
                        <button type="button" id="modal-add-quotation-item-btn" class="mt-2 btn bg-green-500 text-white hover:bg-green-600 text-sm"><i class="fas fa-plus mr-2"></i>إضافة بند</button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4 border-t">
                        <div>
                            <label for="modal-q-notes" class="block text-sm font-medium text-slate-700">ملاحظات</label>
                            <textarea id="modal-q-notes" rows="4" class="input mt-1">${item?.notes || ''}</textarea>
                        </div>
                        <div id="modal-quotation-summary" class="space-y-2 p-4 bg-slate-50 rounded-lg">
                            <div class="flex justify-between items-center">
                                <span class="text-slate-600">المجموع الفرعي:</span>
                                <span id="modal-quotation-subtotal" class="font-semibold">0.00</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <label for="modal-q-discount" class="text-slate-600">خصم (%):</label>
                                <input type="number" id="modal-q-discount" value="${item?.discount || 0}" min="0" class="input w-24 text-center">
                            </div>
                            <div class="flex justify-between items-center">
                                <span>قيمة الخصم:</span>
                                <span id="modal-quotation-discount-amount" class="font-semibold text-red-600">-0.00</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <label for="modal-q-tax" class="text-slate-600">ضريبة (%):</label>
                                <input type="number" id="modal-q-tax" value="${item?.tax || 0}" min="0" class="input w-24 text-center">
                            </div>
                            <div class="flex justify-between items-center">
                                <span>قيمة الضريبة:</span>
                                <span id="modal-quotation-tax-amount" class="font-semibold text-green-600">+0.00</span>
                            </div>
                            <div class="flex justify-between items-center text-xl font-bold text-slate-800 border-t pt-2 mt-2">
                                <span>الإجمالي:</span>
                                <span id="modal-quotation-total">0.00</span>
                            </div>
                        </div>
                    </div>
                </form>
            `;
        }

        function showQuotationModal(item = null) {
            const title = item ? 'تعديل عرض سعر' : 'إنشاء عرض سعر جديد';
            const formHTML = getQuotationFormHTML(item);
            showModal(title, formHTML, async () => {
                const form = document.getElementById('modal-quotation-form');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                await handleQuotationFormSubmit(item);
            });

            // Post-render logic
            if (item && item.items) {
                item.items.forEach(addQuotationItemRow);
            } else {
                addQuotationItemRow(); // Start with one empty row
            }
            updateQuotationTotal();

            document.getElementById('modal-add-quotation-item-btn').addEventListener('click', () => addQuotationItemRow());
            document.getElementById('modal-quotation-summary').addEventListener('input', updateQuotationTotal);
        }

        function addQuotationItemRow(item = null) {
            const container = document.getElementById('modal-quotation-items-container');
            const rowId = `q-item-${Date.now()}-${container.children.length}`;
            const row = document.createElement('div');
            row.className = 'grid grid-cols-12 gap-2 items-center quotation-item-row';
            row.id = rowId;
            row.innerHTML = `
                <div class="col-span-5"><input type="text" class="input q-item-name" placeholder="اسم البند/الخدمة" value="${item?.productName || ''}" required></div>
                <div class="col-span-3"><input type="number" step="1" min="1" class="input q-item-qty" placeholder="الكمية" value="${item?.qty || '1'}" required></div>
                <div class="col-span-3"><input type="number" step="0.01" min="0" class="input q-item-price" placeholder="السعر" value="${item?.price || ''}" required></div>
                <div class="col-span-1"><button type="button" class="w-full btn btn-danger remove-quotation-item-btn"><i class="fas fa-trash"></i></button></div>
            `;
            container.appendChild(row);
            row.querySelector('.remove-quotation-item-btn').addEventListener('click', () => {
                row.remove();
                updateQuotationTotal();
            });
            row.querySelectorAll('input').forEach(input => input.addEventListener('input', updateQuotationTotal));
        }

        function updateQuotationTotal() {
            let subtotal = 0;
            document.querySelectorAll('#modal-quotation-items-container .quotation-item-row').forEach(row => {
                const qty = parseFloat(row.querySelector('.q-item-qty').value) || 0;
                const price = parseFloat(row.querySelector('.q-item-price').value) || 0;
                subtotal += qty * price;
            });
            
            const discountPercent = parseFloat(document.getElementById('modal-q-discount').value) || 0;
            const taxPercent = parseFloat(document.getElementById('modal-q-tax').value) || 0;

            const discountAmount = subtotal * (discountPercent / 100);
            const subtotalAfterDiscount = subtotal - discountAmount;
            const taxAmount = subtotalAfterDiscount * (taxPercent / 100);
            const finalTotal = subtotalAfterDiscount + taxAmount;

            document.getElementById('modal-quotation-subtotal').textContent = `${subtotal.toFixed(2)}`;
            document.getElementById('modal-quotation-discount-amount').textContent = `-${discountAmount.toFixed(2)}`;
            document.getElementById('modal-quotation-tax-amount').textContent = `+${taxAmount.toFixed(2)}`;
            document.getElementById('modal-quotation-total').textContent = `${finalTotal.toFixed(2)}`;
        }


        async function handleQuotationFormSubmit(item) {
            const id = item?.id;
            const customerId = document.getElementById('modal-q-customer').value;
            if (!customerId) return showMessage('الرجاء اختيار عميل.');
            const customerDoc = await getDoc(doc(db, 'customers', customerId));
            if (!customerDoc.exists()) return showMessage('العميل المحدد غير موجود');

            const quotationItems = [];
            document.querySelectorAll('#modal-quotation-items-container .quotation-item-row').forEach(row => {
                const item = {
                    productName: row.querySelector('.q-item-name').value.trim(),
                    qty: Math.abs(parseInt(row.querySelector('.q-item-qty').value) || 0),
                    price: Math.abs(parseFloat(row.querySelector('.q-item-price').value) || 0)
                };
                item.total = item.qty * item.price;
                quotationItems.push(item);
            });

            if (quotationItems.length === 0 || quotationItems.some(item => !item.productName || !item.qty || isNaN(item.price))) {
                return showMessage('الرجاء تعبئة جميع الحقول في بنود عرض السعر.');
            }

            const subtotal = quotationItems.reduce((sum, item) => sum + item.total, 0);
            const discount = parseFloat(document.getElementById('modal-q-discount').value) || 0;
            const tax = parseFloat(document.getElementById('modal-q-tax').value) || 0;
            const discountAmount = subtotal * (discount / 100);
            const subtotalAfterDiscount = subtotal - discountAmount;
            const taxAmount = subtotalAfterDiscount * (tax / 100);
            const finalTotal = subtotalAfterDiscount + taxAmount;
            
            const quotationData = {
                date: document.getElementById('modal-q-date').value,
                expiryDate: document.getElementById('modal-q-expiry-date').value,
                customerId,
                customerName: customerDoc.data().name,
                customerDetails: customerDoc.data(),
                items: quotationItems,
                subtotal: subtotal,
                discount: discount,
                tax: tax,
                totalAmount: finalTotal,
                notes: document.getElementById('modal-q-notes').value.trim(),
                status: 'new' // Always new on creation/update, conversion to invoice changes it
            };

            if (id) {
                 quotationData.quotationNumber = item.quotationNumber; // Preserve original number on edit
                 if (await addOrUpdateItem('quotations', quotationData, id, { update: `تعديل عرض السعر رقم: ${quotationData.quotationNumber}` })) {
                    hideModal();
                    await refreshQuotations();
                    showMessage(`تم تحديث عرض السعر بنجاح.`);
                }
            } else {
                const settingsDocRef = doc(db, 'settings', 'appConfig');
                try {
                    let newQuotationNumber;
                    await runTransaction(db, async (transaction) => {
                        const settingsDoc = await transaction.get(settingsDocRef);
                        newQuotationNumber = (settingsDoc.data()?.lastQuotationNumber || 0) + 1;
                        quotationData.quotationNumber = newQuotationNumber;
                        
                        const newQuotationRef = doc(collection(db, 'quotations'));
                        transaction.set(newQuotationRef, quotationData);
                        transaction.update(settingsDocRef, { lastQuotationNumber: increment(1) });
                    });

                    await logActivity('إنشاء عرض سعر', `رقم: ${newQuotationNumber}, للعميل: ${customerDoc.data().name}`);
                    hideModal();
                    await refreshQuotations();
                    showMessage(`تم إنشاء عرض السعر رقم ${newQuotationNumber} بنجاح.`);

                } catch (error) {
                    console.error("Quotation creation failed: ", error);
                    showMessage("فشل إنشاء عرض السعر. الرجاء المحاولة مرة أخرى.");
                }
            }
        }

        // --- Invoice Modal Functions ---
        function getInvoiceFormHTML(quoteToConvert = null) {
             const customerOptions = (customersCache || []).map(c => `<option value="${c.id}" ${quoteToConvert?.customerId === c.id ? 'selected' : ''}>${c.name}</option>`).join('');
             const isConverting = !!quoteToConvert;

            return `
                 <form id="modal-invoice-form" class="space-y-4">
                     <input type="hidden" id="modal-invoice-source-quotation-id" value="${quoteToConvert?.id || ''}">
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="modal-i-date" class="block text-sm font-medium text-slate-700">تاريخ الفاتورة</label>
                            <input type="date" id="modal-i-date" class="input" value="${getLocalDate()}" required>
                        </div>
                        <div>
                            <label for="modal-i-customer" class="block text-sm font-medium text-slate-700">العميل</label>
                            <select id="modal-i-customer" class="select" required ${isConverting ? 'disabled' : ''}>
                                <option value="">اختر عميل</option>
                                ${customerOptions}
                            </select>
                        </div>
                     </div>

                     <div>
                         <h4 class="block text-sm font-medium text-slate-700 mb-2">تفاصيل الفاتورة</h4>
                         <div id="modal-invoice-items-container" class="space-y-2">
                             <!-- Invoice item rows will be added here -->
                         </div>
                         <div class="flex gap-2 mt-2">
                             <button type="button" id="modal-add-invoice-item-btn" class="btn btn-primary self-start text-sm"><i class="fas fa-plus mr-2"></i>إضافة منتج</button>
                             <button type="button" id="modal-add-manual-invoice-item-btn" class="btn bg-green-500 text-white self-start text-sm"><i class="fas fa-edit mr-2"></i>إضافة بند يدوي</button>
                         </div>
                     </div>

                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4 border-t">
                         <div>
                           <label for="modal-i-notes" class="text-slate-600 mb-1">ملاحظات</label>
                           <textarea id="modal-i-notes" class="input" rows="3">${quoteToConvert?.notes || ''}</textarea>
                        </div>
                        <div id="modal-invoice-summary" class="flex flex-col gap-2 p-4 bg-slate-50 rounded-lg">
                            <div class="flex justify-between items-center">
                                <span class="text-slate-600">المجموع الفرعي:</span>
                                <span id="modal-invoice-subtotal" class="font-semibold">0.00</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <label for="modal-i-discount" class="text-slate-600">خصم (%):</label>
                                <input type="number" id="modal-i-discount" value="${quoteToConvert?.discount || 0}" min="0" class="input w-24 text-center">
                            </div>
                            <div class="flex justify-between items-center text-red-600">
                                <span>قيمة الخصم:</span>
                                <span id="modal-invoice-discount-amount" class="font-semibold">-0.00</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <label for="modal-i-tax" class="text-slate-600">ضريبة (%):</label>
                                <input type="number" id="modal-i-tax" value="${quoteToConvert?.tax || 0}" min="0" class="input w-24 text-center">
                            </div>
                            <div class="flex justify-between items-center text-green-600">
                                <span>قيمة الضريبة:</span>
                                <span id="modal-invoice-tax-amount" class="font-semibold">+0.00</span>
                            </div>
                            <div class="flex justify-between items-center text-xl font-bold text-slate-800 border-t pt-2 mt-2">
                                <span>الإجمالي:</span>
                                <span id="modal-invoice-total">0.00</span>
                            </div>
                        </div>
                    </div>
                 </form>
            `;
        }

        function showInvoiceModal(quoteToConvert = null) {
            const title = 'إنشاء فاتورة جديدة';
            const formHTML = getInvoiceFormHTML(quoteToConvert);
            showModal(title, formHTML, async () => {
                const form = document.getElementById('modal-invoice-form');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                await handleInvoiceFormSubmit();
            });

            // Post-render logic
            if (quoteToConvert && quoteToConvert.items) {
                 quoteToConvert.items.forEach(item => addInvoiceItemRow(true, item));
            } else {
                addInvoiceItemRow(false); // Start with one empty product row
            }
            updateInvoiceTotal();

            document.getElementById('modal-add-invoice-item-btn').addEventListener('click', () => addInvoiceItemRow(false));
            document.getElementById('modal-add-manual-invoice-item-btn').addEventListener('click', () => addInvoiceItemRow(true));
            document.getElementById('modal-invoice-summary').addEventListener('input', updateInvoiceTotal);
        }

        async function addInvoiceItemRow(isManual = false, item = null) {
             const container = document.getElementById('modal-invoice-items-container');
             const rowId = `i-item-${Date.now()}-${container.children.length}`;
             const row = document.createElement('div');
             row.className = 'grid grid-cols-12 gap-2 items-center invoice-item-row';
             row.id = rowId;
             row.dataset.type = isManual ? 'manual' : 'product';

            if (isManual) {
                row.innerHTML = `
                    <div class="col-span-5"><input type="text" class="input i-manual-name" placeholder="اسم البند اليدوي" value="${item?.productName || ''}" required></div>
                    <div class="col-span-3"><input type="number" step="1" min="1" class="input i-manual-qty" placeholder="الكمية" value="${item?.qty || 1}" required></div>
                    <div class="col-span-3"><input type="number" step="0.01" min="0" class="input i-manual-price" placeholder="السعر" value="${item?.price || ''}" required></div>
                    <div class="col-span-1"><button type="button" class="w-full btn btn-danger remove-invoice-item-btn"><i class="fas fa-trash"></i></button></div>
                `;
            } else {
                 row.innerHTML = `
					<div class="col-span-3"><select class="select i-warehouse-select" required><option value="">اختر مستودع</option></select></div>
                    <div class="col-span-4"><select class="select i-product-select" required><option value="">اختر منتج</option></select></div>
                    <div class="col-span-2"><input type="number" class="input i-qty" placeholder="الكمية" min="1" value="1" required></div>
                    <div class="col-span-2"><input type="number" step="0.01" min="0" class="input i-price" placeholder="سعر البيع" required></div>
                    <div class="col-span-1"><button type="button" class="w-full btn btn-danger remove-invoice-item-btn"><i class="fas fa-trash"></i></button></div>
                `;
            }
            container.appendChild(row);
            if (!isManual) {
                const productSelect = row.querySelector('.i-product-select');
                const warehouseSelect = row.querySelector('.i-warehouse-select');
                
                // 1. Populate products first from the main cache
                populateSelect(productSelect.id, productsCache, 'id', 'name', null, true);

                // 2. When a product is selected, filter and populate the warehouses
                productSelect.addEventListener('change', (e) => {
                    const productId = e.target.value;
                    const product = productsCache.find(p => p.id === productId);
                    
                    warehouseSelect.innerHTML = '<option value="">اختر مستودع</option>'; // Reset warehouses
                    
                    if (product) {
                        row.querySelector('.i-price').value = product.price || '';
                        
                        // Find all instances of this product to get its warehouses
                        const productInstances = productsCache.filter(p => p.name === product.name && p.qty > 0);
                        const warehouseIdsWithStock = [...new Set(productInstances.map(p => p.warehouseId))];
                        const warehousesWithProduct = warehousesCache.filter(w => warehouseIdsWithStock.includes(w.id));

                        populateSelect(warehouseSelect.id, warehousesWithProduct, 'id', 'name', (w) => {
                            const instance = productInstances.find(p => p.warehouseId === w.id);
                            return `${w.name} (المتاح: ${instance.qty})`;
                        }, warehousesWithProduct.length > 0);

                    }
                });

                warehouseSelect.addEventListener('change', (e) => {
                    row.dataset.warehouseId = e.target.value;
                });
			}

            row.querySelectorAll('input').forEach(input => input.addEventListener('input', updateInvoiceTotal));
            row.querySelector('.remove-invoice-item-btn').addEventListener('click', () => { row.remove(); updateInvoiceTotal(); });
        }
        
        function updateInvoiceTotal() {
            let subtotal = 0;
            document.querySelectorAll('#modal-invoice-items-container .invoice-item-row').forEach(row => {
                const type = row.dataset.type;
                let qty, price;
                if (type === 'product') {
                    qty = parseFloat(row.querySelector('.i-qty').value) || 0;
                    price = parseFloat(row.querySelector('.i-price').value) || 0;
                } else {
                    qty = parseFloat(row.querySelector('.i-manual-qty').value) || 0;
                    price = parseFloat(row.querySelector('.i-manual-price').value) || 0;
                }
                subtotal += qty * price;
            });
            const discountPercent = parseFloat(document.getElementById('modal-i-discount').value) || 0;
            const taxPercent = parseFloat(document.getElementById('modal-i-tax').value) || 0;
            const discountAmount = subtotal * (discountPercent / 100);
            const subtotalAfterDiscount = subtotal - discountAmount;
            const taxAmount = subtotalAfterDiscount * (taxPercent / 100);
            const finalTotal = subtotalAfterDiscount + taxAmount;

            document.getElementById('modal-invoice-subtotal').textContent = `${subtotal.toFixed(2)}`;
            document.getElementById('modal-invoice-discount-amount').textContent = `-${discountAmount.toFixed(2)}`;
            document.getElementById('modal-invoice-tax-amount').textContent = `+${taxAmount.toFixed(2)}`;
            document.getElementById('modal-invoice-total').textContent = `${finalTotal.toFixed(2)}`;
        }

        async function handleInvoiceFormSubmit() {
            const customerId = document.getElementById('modal-i-customer').value;
            if (!customerId) return showMessage("الرجاء اختيار العميل.");
            
            const customerDoc = await getDoc(doc(db, 'customers', customerId));
            if (!customerDoc.exists()) return showMessage('العميل المحدد غير موجود.');
            
            const sourceQuotationId = document.getElementById('modal-invoice-source-quotation-id').value;

            const invoiceItems = [];
            let formIsValid = true;
            document.querySelectorAll('#modal-invoice-items-container .invoice-item-row').forEach(row => {
                const type = row.dataset.type;
                let item = { type };
                if (type === 'product') {
                    item.warehouseId = row.querySelector('.i-warehouse-select').value;
                    const warehouse = warehousesCache.find(w => w.id === item.warehouseId);
                    item.warehouseName = warehouse ? warehouse.name : '';
                    item.productId = row.querySelector('.i-product-select').value;
                    item.productName = item.productId ? productsCache.find(p => p.id === item.productId)?.name : '';
                    item.qty = Math.abs(parseInt(row.querySelector('.i-qty').value));
                    item.price = Math.abs(parseFloat(row.querySelector('.i-price').value));
                    if (!item.warehouseId || !item.productId || isNaN(item.qty) || isNaN(item.price)) formIsValid = false;
                } else { // manual
                    item.productName = row.querySelector('.i-manual-name').value;
                    item.qty = Math.abs(parseInt(row.querySelector('.i-manual-qty').value)) || 1;
                    item.price = Math.abs(parseFloat(row.querySelector('.i-manual-price').value));
                     if (!item.productName || isNaN(item.qty) || isNaN(item.price)) formIsValid = false;
                }
                item.total = item.qty * item.price;
                invoiceItems.push(item);
            });

            if (!formIsValid || invoiceItems.length === 0) {
                return showMessage('الرجاء تعبئة جميع الحقول في بنود الفاتورة بشكل صحيح.');
            }

            for (const item of invoiceItems) {
                if (item.type === 'product') {
                    const product = productsCache.find(p => p.id === item.productId);
                    if (!product || product.qty < item.qty) {
                        return showMessage(`الكمية غير كافية للمنتج: ${item.productName}. المتاح: ${product?.qty || 0}`);
                    }
                }
            }

            const totalAmount = parseFloat(document.getElementById('modal-invoice-total').textContent);
            
            try {
                let newInvoiceNumber;
                await runTransaction(db, async (transaction) => {
                    const settingsDocRef = doc(db, 'settings', 'appConfig');
                    const settingsDoc = await transaction.get(settingsDocRef);
                    newInvoiceNumber = (settingsDoc.data()?.lastInvoiceNumber || 0) + 1;

                    const invoiceData = {
                        invoiceNumber: newInvoiceNumber,
                        date: document.getElementById('modal-i-date').value,
                        customerId,
                        customerName: customerDoc.data().name,
                        customerDetails: customerDoc.data(),
                        items: invoiceItems,
                        subtotal: parseFloat(document.getElementById('modal-invoice-subtotal').textContent),
                        discount: parseFloat(document.getElementById('modal-i-discount').value) || 0,
                        tax: parseFloat(document.getElementById('modal-i-tax').value) || 0,
                        totalAmount: totalAmount,
                        notes: document.getElementById('modal-i-notes').value,
                        sourceQuotationId: sourceQuotationId || null
                    };

                    const newInvoiceRef = doc(collection(db, 'invoices'));
                    transaction.set(newInvoiceRef, invoiceData);
                    transaction.update(settingsDocRef, { lastInvoiceNumber: newInvoiceNumber });

                    if (sourceQuotationId) {
                        const quotationRef = doc(db, 'quotations', sourceQuotationId);
                        transaction.update(quotationRef, { status: 'converted' });
                    }

                    for (const item of invoiceItems) {
                        const saleData = {
                            date: invoiceData.date, customerId: customerId, customerName: invoiceData.customerName,
                            name: item.productName, price: item.price, qty: item.qty, amount: item.total,
                        };

                        if (item.type === 'product') {
                            const productRef = doc(db, 'products', item.productId);
                            const product = productsCache.find(p => p.id === item.productId);
                            transaction.update(productRef, { qty: increment(-item.qty) });
                            
                            Object.assign(saleData, {
                                type: 'product', cost: product.cost || 0, productId: item.productId,
								warehouseId: item.warehouseId, warehouseName: item.warehouseName
                            });
                        } else {
                             Object.assign(saleData, { type: 'service', cost: 0, productId: null, warehouseId: null, warehouseName: '' });
                        }
                        const newSaleRef = doc(collection(db, 'sales'));
                        transaction.set(newSaleRef, saleData);
                    }
                });

                await logActivity('إنشاء فاتورة ومبيعات', `فاتورة رقم ${newInvoiceNumber} للعميل: ${customerDoc.data().name}`);
                hideModal();
                await refreshInvoices();
                await refreshSales();
                await refreshProducts();
                await refreshQuotations();
                await updateDashboard();
                showMessage(`تم إنشاء الفاتورة والمبيعات المرتبطة بها بنجاح.`);

            } catch (error) {
                console.error("Invoice creation transaction failed: ", error);
                showMessage(`فشل إنشاء الفاتورة: ${error.message}`);
            }
        }

        async function handleDeleteSelectedProducts() {
            const selectedIds = Array.from(document.querySelectorAll('.product-checkbox:checked')).map(cb => cb.dataset.id);
            if (selectedIds.length === 0) return;
            showConfirm(`هل أنت متأكد من حذف ${selectedIds.length} منتج(ات)؟`, async () => {
                const batch = writeBatch(db);
                selectedIds.forEach(id => batch.delete(doc(db, 'products', id)));
                await batch.commit();
                await logActivity('حذف متعدد للمنتجات', `عدد: ${selectedIds.length}`);
                await refreshProducts(); 
                showMessage(`تم حذف ${selectedIds.length} منتج(ات) بنجاح.`);
            });
        }

        async function convertQuotationToInvoice(quotationId) {
            const quotationDoc = await getDoc(doc(db, 'quotations', quotationId));
            if (!quotationDoc.exists()) return showMessage('عرض السعر غير موجود.');
            const quote = { id: quotationDoc.id, ...quotationDoc.data() };

            showInvoiceModal(quote);
            showMessage('تم نقل بيانات عرض السعر إلى فاتورة جديدة. يرجى المراجعة والضغط على "حفظ".');
        }

        async function viewInvoice(invoiceId) {
             const invoiceDoc = await getDoc(doc(db, 'invoices', invoiceId));
             if (!invoiceDoc.exists()) return showMessage('الفاتورة غير موجودة');
             const invoice = invoiceDoc.data();
             currentInvoiceId = invoiceId;
             const contentEl = document.getElementById('invoice-view-content');
             const logoData = localStorage.getItem('companyLogo');
             const logoImgHtml = logoData ? `<img src="${logoData}" alt="Company Logo" class="max-h-20 mb-4">` : '';
             
             const subtotal = invoice.subtotal || invoice.items.reduce((sum, item) => sum + item.total, 0);
             const discount = invoice.discount || 0;
             const tax = invoice.tax || 0;
             const discountAmount = subtotal * (discount / 100);
             const taxAmount = (subtotal - discountAmount) * (tax / 100);
             const totalAmount = invoice.totalAmount;
             
             contentEl.innerHTML = `
                 <div id="printable-invoice">
                     <div class="p-8 text-right">
                         <div class="flex justify-between items-start mb-8">
                             <div>
                                 ${logoImgHtml}
                                 <h2 class="text-2xl font-bold text-sky-600">${appSettings.companyName}</h2>
                                 <p>${appSettings.companyAddress || ''}</p>
                                 <p>${appSettings.companyPhone || ''}</p>
                             </div>
                             <div class="text-left">
                                 <h3 class="text-2xl font-bold">فاتورة</h3>
                                 <p>رقم الفاتورة: #${invoice.invoiceNumber}</p>
                                 <p>التاريخ: ${invoice.date}</p>
                             </div>
                         </div>
                         <div class="mb-8 p-4 bg-slate-50 rounded-lg">
                             <h4 class="font-bold mb-2">فاتورة إلى:</h4>
                             <p>${invoice.customerName}</p>
                             <p>${invoice.customerDetails?.address || ''}</p>
                             <p>${invoice.customerDetails?.phone || ''}</p>
                         </div>
                         <table class="w-full text-right mb-4">
                             <thead class="bg-slate-100">
                                 <tr>
                                     <th class="p-2 text-right">البند</th>
									 <th class="p-2 text-center">الكمية</th>
                                     <th class="p-2 text-center">سعر الوحدة</th>
                                     <th class="p-2 text-left">الإجمالي</th>
                                 </tr>
                             </thead>
                             <tbody>
                                 ${invoice.items.map(item => `
                                     <tr class="border-b">
                                         <td class="p-2">${item.productName}</td>
										 <td class="p-2 text-center">${item.qty}</td>
                                         <td class="p-2 text-center">${(item.price || 0).toFixed(2)}</td>
                                         <td class="p-2 text-left">${(item.total || 0).toFixed(2)}</td>
                                     </tr>
                                 `).join('')}
                             </tbody>
                         </table>
                         <div class="flex justify-end">
                            <div class="w-full md:w-1/2">
                                <table class="w-full">
                                    <tbody>
                                        <tr>
                                            <td class="p-2 font-semibold">المجموع الفرعي:</td>
                                            <td class="p-2 text-left">${subtotal.toFixed(2)} ${appSettings.currency}</td>
                                        </tr>
                                        <tr>
                                            <td class="p-2 font-semibold">الخصم (${discount}%):</td>
                                            <td class="p-2 text-left text-red-600">-${discountAmount.toFixed(2)} ${appSettings.currency}</td>
                                        </tr>
                                        <tr>
                                            <td class="p-2 font-semibold">الضريبة (${tax}%):</td>
                                            <td class="p-2 text-left text-green-600">+${taxAmount.toFixed(2)} ${appSettings.currency}</td>
                                        </tr>
                                        <tr class="border-t-2 font-bold text-lg">
                                            <td class="p-2">الإجمالي:</td>
                                            <td class="p-2 text-left">${totalAmount.toFixed(2)} ${appSettings.currency}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                         </div>
                         ${invoice.notes ? `<div class="mt-8 pt-4 border-t"><h4 class="font-bold mb-2">ملاحظات:</h4><p class="text-slate-600">${invoice.notes}</p></div>` : ''}
                     </div>
                 </div>
             `;
            document.getElementById('invoice-view-modal').classList.remove('hidden');
            document.getElementById('custom-overlay').classList.remove('hidden');
        }
        
        async function viewQuotation(quotationId) {
             const quotationDoc = await getDoc(doc(db, 'quotations', quotationId));
             if (!quotationDoc.exists()) return showMessage('عرض السعر غير موجود');
             const quote = quotationDoc.data();
             currentQuotationId = quotationId;
             const contentEl = document.getElementById('quotation-view-content');
             const logoData = localStorage.getItem('companyLogo');
             const logoImgHtml = logoData ? `<img src="${logoData}" alt="Company Logo" class="max-h-20 mb-4">` : '';
             
             const subtotal = quote.subtotal || quote.items.reduce((sum, item) => sum + (item.price * item.qty), 0);
             const discount = quote.discount || 0;
             const tax = quote.tax || 0;
             const discountAmount = subtotal * (discount / 100);
             const taxAmount = (subtotal - discountAmount) * (tax / 100);
             const totalAmount = quote.totalAmount;
             
             contentEl.innerHTML = `
                 <div id="printable-quotation">
                     <div class="p-8 text-right">
                         <div class="flex justify-between items-start mb-8">
                             <div>
                                 ${logoImgHtml}
                                 <h2 class="text-2xl font-bold text-sky-600">${appSettings.companyName}</h2>
                                 <p>${appSettings.companyAddress || ''}</p>
                                 <p>${appSettings.companyPhone || ''}</p>
                             </div>
                             <div class="text-left">
                                 <h3 class="text-2xl font-bold">عرض سعر</h3>
                                 <p>رقم العرض: #${quote.quotationNumber}</p>
                                 <p>التاريخ: ${quote.date}</p>
                                 <p>صالح لغاية: ${quote.expiryDate || 'N/A'}</p>
                             </div>
                         </div>
                         <div class="mb-8 p-4 bg-slate-50 rounded-lg">
                             <h4 class="font-bold mb-2">عرض سعر إلى:</h4>
                             <p>${quote.customerName}</p>
                             <p>${quote.customerDetails?.address || ''}</p>
                             <p>${quote.customerDetails?.phone || ''}</p>
                         </div>
                         <table class="w-full text-right mb-4">
                             <thead class="bg-slate-100">
                                 <tr>
                                     <th class="p-2 text-right">البند/الخدمة</th>
									 <th class="p-2 text-center">الكمية</th>
                                     <th class="p-2 text-center">سعر الوحدة</th>
                                     <th class="p-2 text-left">الإجمالي</th>
                                 </tr>
                             </thead>
                             <tbody>
                                 ${quote.items.map(item => `
                                     <tr class="border-b">
                                         <td class="p-2">${item.productName}</td>
										 <td class="p-2 text-center">${item.qty}</td>
                                         <td class="p-2 text-center">${(item.price || 0).toFixed(2)}</td>
                                         <td class="p-2 text-left">${(item.qty * (item.price || 0)).toFixed(2)}</td>
                                     </tr>
                                 `).join('')}
                             </tbody>
                         </table>
                         <div class="flex justify-end">
                            <div class="w-full md:w-1/2">
                                <table class="w-full">
                                    <tbody>
                                        <tr>
                                            <td class="p-2 font-semibold">المجموع الفرعي:</td>
                                            <td class="p-2 text-left">${subtotal.toFixed(2)} ${appSettings.currency}</td>
                                        </tr>
                                        <tr>
                                            <td class="p-2 font-semibold">الخصم (${discount}%):</td>
                                            <td class="p-2 text-left text-red-600">-${discountAmount.toFixed(2)} ${appSettings.currency}</td>
                                        </tr>
                                        <tr>
                                            <td class="p-2 font-semibold">الضريبة (${tax}%):</td>
                                            <td class="p-2 text-left text-green-600">+${taxAmount.toFixed(2)} ${appSettings.currency}</td>
                                        </tr>
                                        <tr class="border-t-2 font-bold text-lg">
                                            <td class="p-2">الإجمالي:</td>
                                            <td class="p-2 text-left">${totalAmount.toFixed(2)} ${appSettings.currency}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                         </div>
                         ${quote.notes ? `<div class="mt-8 pt-4 border-t"><h4 class="font-bold mb-2">ملاحظات وشروط:</h4><p class="text-slate-600 whitespace-pre-wrap">${quote.notes}</p></div>` : ''}
                     </div>
                 </div>
             `;
            document.getElementById('quotation-view-modal').classList.remove('hidden');
            document.getElementById('custom-overlay').classList.remove('hidden');
        }

        function exportToExcel(tableId, sheetName, fileName) {
            const table = document.getElementById(tableId);
            if (!table) return showMessage('لم يتم العثور على جدول للتصدير.');
            const tableClone = table.cloneNode(true);
            Array.from(tableClone.querySelectorAll('.no-export')).forEach(el => el.remove());
            const ws = XLSX.utils.table_to_sheet(tableClone);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
            XLSX.writeFile(wb, fileName);
        }

		async function importFromExcel(event) {
			const file = event.target.files[0];
			if (!file) return;
			await refreshSuppliers(); // Ensure maps are fresh

			const reader = new FileReader();
			reader.onload = async (e) => {
				try {
					const data = new Uint8Array(e.target.result);
					const workbook = XLSX.read(data, { type: 'array' });
					const firstSheetName = workbook.SheetNames[0];
					const worksheet = workbook.Sheets[firstSheetName];
					const jsonData = XLSX.utils.sheet_to_json(worksheet);

					if (jsonData.length === 0) return showMessage("الملف فارغ أو غير صحيح.");

					const mappedData = jsonData.map(item => ({
						name: item['الاسم'] || item['name'],
						category: item['نوع المنتج'] || item['category'],
						cost: item['سعر التكلفة'] || item['cost'],
						qty: item['الكمية'] || item['qty'],
						supplierId: item['ID المورد (للاستيراد)'] || item['supplierId']
					}));

					showConfirm(`تم العثور على ${mappedData.length} منتج. هل تريد استيرادها؟`, async () => {
						const batch = writeBatch(db);
						let importedCount = 0;
						mappedData.forEach(item => {
							if (item.name) {
								const productRef = doc(collection(db, 'products'));
								const supplierNumericId = item.supplierId;
								
								let supplierDocId = null;
								let supplierName = 'غير محدد';

								if (supplierNumericId && !isNaN(parseInt(supplierNumericId))) {
									const numericIdStr = String(parseInt(supplierNumericId)).trim();
									supplierDocId = supplierNumericIdToDocIdMap.get(numericIdStr) || null;
									supplierName = supplierNumericIdToNameMap.get(numericIdStr) || 'مورد غير معروف';
								}
								
								const productData = {
									name: item.name,
									category: item.category || 'عام',
									cost: parseFloat(item.cost || 0),
									qty: parseInt(item.qty || 0),
									supplierId: supplierDocId,
									supplierNumericId: supplierNumericId ? parseInt(supplierNumericId) : null,
									supplierName: supplierName
								};
								batch.set(productRef, productData);
								importedCount++;
							}
						});

						if (importedCount > 0) {
							await batch.commit();
							await logActivity('استيراد منتجات', `عدد: ${importedCount}`);
							await refreshProducts();
							showMessage(`تم استيراد ${importedCount} منتج بنجاح.`);
						} else {
							showMessage("لم يتم العثور على منتجات صالحة للاستيراد. يرجى التأكد من أن الملف يحتوي على عمود 'الاسم' على الأقل.");
						}
					});
				} catch (error) {
					console.error("Error during Excel import:", error);
					showMessage("حدث خطأ أثناء قراءة الملف. يرجى التأكد من أن الملف بالتنسيق الصحيح.");
				} finally {
					event.target.value = '';
				}
			};
			reader.readAsArrayBuffer(file);
		}


        async function exportToPdfWithArabic(elementId, title, fileName) {
            const { jsPDF } = window.jspdf;
            const element = document.getElementById(elementId);
             if(!element) {
                 showMessage('عنصر التصدير غير موجود.');
                 return;
             }

            html2canvas(element, { scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgProps= pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(fileName);
            });
        }
        
        async function exportAdvancedReportToExcel() {
            const type = document.getElementById('advanced-export-type').value;
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            if (!startDate || !endDate) {
                return showMessage("الرجاء تحديد فترة التقرير أولاً.");
            }
            
            const wb = XLSX.utils.book_new();

            const fetchAndSheet = async (collectionName, sheetName, fieldMapping) => {
                const q = query(collection(db, collectionName), where('date', '>=', startDate), where('date', '<=', endDate));
                const snapshot = await getDocs(q);
                const data = snapshot.docs.map(doc => {
                    const docData = doc.data();
                    let row = {};
                    for(const key in fieldMapping){
                        row[fieldMapping[key]] = docData[key];
                    }
                    return row;
                });
                if(data.length > 0) {
                     const ws = XLSX.utils.json_to_sheet(data);
                     XLSX.utils.book_append_sheet(wb, ws, sheetName);
                }
            };
            
            const typesToExport = type === 'all' 
                ? ['sales', 'purchases', 'expenses', 'invoices', 'profits', 'inventory']
                : [type];

            for (const reportType of typesToExport) {
                if (reportType === 'sales') {
                    await fetchAndSheet('sales', 'المبيعات', {date: 'التاريخ', name: 'الاسم/المنتج', qty: 'الكمية', price: 'سعر البيع', cost: 'التكلفة', amount: 'الإجمالي', customerName: 'العميل'});
                }
                 if (reportType === 'purchases') {
                    await fetchAndSheet('purchases', 'المشتريات', {date: 'التاريخ', productName: 'المنتج', qty: 'الكمية', cost: 'تكلفة الوحدة', amount: 'الإجمالي', supplierName: 'المورد'});
                }
                 if (reportType === 'expenses') {
                    await fetchAndSheet('expenses', 'المصاريف', {date: 'التاريخ', type: 'النوع', amount: 'المبلغ', description: 'الوصف'});
                }
                if (reportType === 'invoices') {
                    await fetchAndSheet('invoices', 'الفواتير', {invoiceNumber: 'رقم الفاتورة', date: 'التاريخ', customerName: 'العميل', totalAmount: 'المبلغ الإجمالي'});
                }
                if (reportType === 'inventory') {
                    const invData = productsCache.map(p => ({
                        'المنتج': p.name, 'النوع': p.category, 'الكمية الحالية': p.qty, 'سعر التكلفة': p.cost, 'قيمة المخزون': p.qty * p.cost, 'المورد': p.supplierName
                    }));
                     const ws = XLSX.utils.json_to_sheet(invData);
                     XLSX.utils.book_append_sheet(wb, ws, 'المستودع');
                }
                if (reportType === 'profits') {
                     const salesQuery = query(collection(db, 'sales'), where('date', '>=', startDate), where('date', '<=', endDate));
                     const expensesQuery = query(collection(db, 'expenses'), where('date', '>=', startDate), where('date', '<=', endDate));
                     const [salesSnapshot, expensesSnapshot] = await Promise.all([getDocs(salesQuery), getDocs(expensesQuery)]);

                     const salesData = salesSnapshot.docs.map(d => d.data());
                     const expensesData = expensesSnapshot.docs.map(d => d.data());
                     
                     const totalRevenue = salesData.reduce((sum, s) => sum + s.amount, 0);
                     const totalCost = salesData.reduce((sum, s) => sum + ((s.cost || 0) * (s.qty || 1)), 0);
                     const totalExpenses = expensesData.reduce((sum, e) => sum + e.amount, 0);
                     const netProfit = totalRevenue - totalCost - totalExpenses;

                     const profitData = [
                         {'البيان': 'إجمالي الإيرادات (المبيعات)', 'المبلغ': totalRevenue},
                         {'البيان': 'إجمالي تكلفة البضاعة المباعة', 'المبلغ': totalCost},
                         {'البيان': 'إجمالي المصاريف الأخرى', 'المبلغ': totalExpenses},
                         {'البيان': 'صافي الربح', 'المبلغ': netProfit},
                     ];
                     const ws = XLSX.utils.json_to_sheet(profitData);
                     XLSX.utils.book_append_sheet(wb, ws, 'الأرباح');
                }
            }

            if(wb.SheetNames.length > 0) {
                 XLSX.writeFile(wb, `Report_${type}_${startDate}_to_${endDate}.xlsx`);
            } else {
                showMessage('لا توجد بيانات للتصدير في الفترة المحددة.');
            }
        }

        async function exportInvoicesToExcel() {
             let q = collection(db, 'invoices');
             const startDate = document.getElementById('invoice-start-date').value;
             const endDate = document.getElementById('invoice-end-date').value;
             let conditions = [];
             if (startDate) conditions.push(where('date', '>=', startDate));
             if (endDate) conditions.push(where('date', '<=', endDate));
             conditions.push(orderBy('date', 'desc'));
             
             const snapshot = await getDocs(query(q, ...conditions));
             const invoices = snapshot.docs.map(doc => {
                 const data = doc.data();
                 return {
                     'رقم الفاتورة': data.invoiceNumber,
                     'التاريخ': data.date,
                     'العميل': data.customerName,
                     'المبلغ الإجمالي': data.totalAmount.toFixed(2)
                 };
             });

             if (invoices.length === 0) return showMessage('لا توجد فواتير للتصدير في هذا النطاق الزمني.');
             
             const ws = XLSX.utils.json_to_sheet(invoices);
             const wb = XLSX.utils.book_new();
             XLSX.utils.book_append_sheet(wb, ws, "الفواتير");
             XLSX.writeFile(wb, `Invoices_${startDate || 'start'}_to_${endDate || 'end'}.xlsx`);
        }

        function toggleDeleteSelectedButton() {
            const selectedCount = document.querySelectorAll('.product-checkbox:checked').length;
            const btn = document.getElementById('delete-selected-products-btn');
            if (btn) {
                btn.disabled = selectedCount === 0;
                const textSpan = btn.querySelector('span');
                if (textSpan) textSpan.textContent = selectedCount > 0 ? `حذف المحدد (${selectedCount})` : 'حذف المحدد';
            }
        }
        
        async function loadSettings() {
            const settingsDoc = await getDoc(doc(db, 'settings', 'appConfig'));
            if (settingsDoc.exists()) {
                 appSettings = { ...appSettings, ...settingsDoc.data() }
                 if(!settingsDoc.data().supplierCounter) {
                   await setDoc(doc(db, 'settings', 'appConfig'), { supplierCounter: 0 }, { merge: true });
                 }
                 if(!settingsDoc.data().lastQuotationNumber) {
                   await setDoc(doc(db, 'settings', 'appConfig'), { lastQuotationNumber: 0 }, { merge: true });
                 }
            } else {
                 await setDoc(doc(db, 'settings', 'appConfig'), { 
                    supplierCounter: 0,
                    lastQuotationNumber: 0,
                    lastInvoiceNumber: 0,
                    companyName: 'شركتك',
                    currency: 'د.أ',
                    initialFund: 0,
                    loyaltyPointsRate: 0,
                    companyAddress: '',
                    companyPhone: ''
                 });
            }
            document.getElementById('setting-company-name').value = appSettings.companyName;
            document.getElementById('setting-company-address').value = appSettings.companyAddress;
            document.getElementById('setting-company-phone').value = appSettings.companyPhone;
            document.getElementById('setting-currency').value = appSettings.currency;
            document.getElementById('setting-initial-fund').value = appSettings.initialFund;
            document.getElementById('setting-loyalty-points').value = appSettings.loyaltyPointsRate;
            document.getElementById('header-company-name').textContent = appSettings.companyName || 'إدارة الأعمال';
            loadAndDisplayLogo();
        }

        async function handleSettingsSave(e) {
            e.preventDefault();
            const settingsToSave = {
                companyName: document.getElementById('setting-company-name').value,
                companyAddress: document.getElementById('setting-company-address').value,
                companyPhone: document.getElementById('setting-company-phone').value,
                currency: document.getElementById('setting-currency').value,
                initialFund: parseFloat(document.getElementById('setting-initial-fund').value) || 0,
                loyaltyPointsRate: parseInt(document.getElementById('setting-loyalty-points').value) || 0
            };
            await setDoc(doc(db, 'settings', 'appConfig'), settingsToSave, { merge: true });
            await logActivity('تحديث الإعدادات', 'تم تحديث معلومات الشركة والإعدادات المالية');
            await loadSettings();
            showMessage("تم حفظ الإعدادات بنجاح.");
        }

        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (file.size > 1024 * 1024) {
                showMessage("حجم الصورة كبير جداً. يجب أن يكون أقل من 1MB.");
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                const imgData = e.target.result;
                localStorage.setItem('companyLogo', imgData);
                displayLogo(imgData);
                showMessage("تم حفظ الشعار مؤقتاً. سيظهر في التقارير المطبوعة.");
            };
            reader.readAsDataURL(file);
        }
        
        function handleRemoveLogo() {
            localStorage.removeItem('companyLogo');
            displayLogo(null);
            showMessage("تم إزالة الشعار.");
        }

        function loadAndDisplayLogo() {
            const logoData = localStorage.getItem('companyLogo');
            displayLogo(logoData);
        }

        function displayLogo(logoData) {
            const preview = document.getElementById('company-logo-preview');
            const removeBtn = document.getElementById('remove-logo-btn');
            const headerLogo = document.getElementById('header-logo');
            const headerIcon = document.getElementById('header-default-icon');

            if (logoData) {
                preview.src = logoData;
                preview.classList.remove('hidden');
                removeBtn.classList.remove('hidden');
                headerLogo.src = logoData;
                headerLogo.classList.remove('hidden');
                headerIcon.classList.add('hidden');
            } else {
                preview.src = '';
                preview.classList.add('hidden');
                removeBtn.classList.add('hidden');
                headerLogo.src = '';
                headerLogo.classList.add('hidden');
                headerIcon.classList.remove('hidden');
            }
        }
        
        // --- User Modal Functions ---
        function getUserFormHTML() {
            return `
                <form id="modal-user-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex flex-col">
                        <label for="modal-user-email" class="text-slate-600 mb-1">البريد الإلكتروني</label>
                        <input type="email" id="modal-user-email" class="input" required>
                    </div>
                    <div class="flex flex-col">
                        <label for="modal-user-password" class="text-slate-600 mb-1">كلمة المرور</label>
                        <input type="password" id="modal-user-password" class="input" required autocomplete="new-password">
                    </div>
                    <div class="flex flex-col">
                        <label for="modal-user-role" class="text-slate-600 mb-1">الصلاحية</label>
                        <select id="modal-user-role" class="select" required>
                            <option value="admin">مدير</option>
                            <option value="user">مستخدم</option>
                            <option value="visitor">زائر</option>
                        </select>
                    </div>
                     <div id="modal-permissions-display" class="hidden col-span-full p-4 mt-2 text-sm border rounded-lg bg-sky-50 border-sky-200 text-sky-800">
				        <!-- Permissions will be displayed here -->
			         </div>
                </form>
            `;
        }

        function showUserModal() {
            const title = 'إنشاء مستخدم جديد';
            const formHTML = getUserFormHTML();
            showModal(title, formHTML, async () => {
                const form = document.getElementById('modal-user-form');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                await handleUserFormSubmit();
            });
        }
        
        async function handleUserFormSubmit() {
            const email = document.getElementById('modal-user-email').value;
            const password = document.getElementById('modal-user-password').value;
            const role = document.getElementById('modal-user-role').value;

            try {
                // Use the secondary auth instance to create the user
                const userCredential = await createUserWithEmailAndPassword(secondaryAuth, email, password);
                const user = userCredential.user;
                
                // Now, set the user's role in Firestore
                await setDoc(doc(db, "users", user.uid), {
                    email: email,
                    role: role
                });

                await logActivity('إنشاء مستخدم', `البريد الإلكتروني: ${email}, الصلاحية: ${role}`);
                hideModal();
                await refreshUsers();
                showMessage('تم إنشاء المستخدم بنجاح!');
                
                // Important: Sign out the new user from the secondary app instance
                // so it doesn't interfere with the currently logged-in admin.
                await signOut(secondaryAuth);
                
            } catch (error) {
                console.error("Error creating user:", error);
                if (error.code === 'auth/email-already-in-use') {
                    showMessage('هذا البريد الإلكتروني مستخدم بالفعل.');
                } else if (error.code === 'auth/weak-password') {
                     showMessage('كلمة المرور ضعيفة جداً. يجب أن تتكون من 6 أحرف على الأقل.');
                } else {
                    showMessage('حدث خطأ أثناء إنشاء المستخدم: ' + error.message);
                }
            }
        }
        
        async function refreshUsers() {
            if (currentUser.role !== 'admin') {
                document.getElementById('user-management-section').style.display = 'none';
                return;
            }
            document.getElementById('user-management-section').style.display = 'block';

            const snapshot = await getDocs(collection(db, 'users'));
            const users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            const tableBody = document.getElementById('users-table');
            tableBody.innerHTML = '';
            users.forEach(user => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${user.email}</td>
                    <td>${translateRole(user.role)}</td>
                    <td>
                        ${ currentUser.auth.uid !== user.id ? `<button class="btn btn-danger text-sm delete-btn" data-id="${user.id}" data-category="users">حذف</button>` : 'لا يمكن حذف المستخدم الحالي' }
                    </td>
                `;
            });
             applyPermissions(currentUser.role);
        }

        // --- Permissions ---
        function applyPermissions(role) {
            const permissions = {
                admin: {
                    can_add: true,
                    can_edit: true,
                    can_delete: true,
                    view_tabs: ['dashboard', 'products', 'sales', 'purchases', 'returns', 'expenses', 'customers', 'suppliers', 'quotations', 'invoices', 'reports', 'settings', 'activity_log']
                },
                user: {
                    can_add: true,
                    can_edit: true,
                    can_delete: false,
                    view_tabs: ['dashboard', 'products', 'sales', 'purchases', 'returns', 'expenses', 'customers', 'suppliers', 'quotations', 'invoices', 'reports']
                },
                visitor: {
                    can_add: false,
                    can_edit: false,
                    can_delete: false,
                    view_tabs: ['dashboard']
                }
            };
            
            const userPermissions = permissions[role] || permissions.visitor;
            
            // Show/hide tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                const tab = btn.dataset.tab;
                btn.style.display = userPermissions.view_tabs.includes(tab) ? 'flex' : 'none';
            });

            // If the current active tab is now hidden, switch to dashboard
            const activeTab = document.querySelector('.tab-btn.active');
            if (activeTab && activeTab.style.display === 'none') {
                switchTab('dashboard');
            }
            
            // Show/hide sections in settings
            document.getElementById('user-management-section').style.display = role === 'admin' ? 'block' : 'none';
            document.getElementById('employee-management-section').style.display = role === 'admin' ? 'block' : 'none';
            document.getElementById('backup-management-section').style.display = role === 'admin' ? 'block' : 'none';
            document.getElementById('activity-log-tab-btn').style.display = role === 'admin' ? 'flex' : 'none';

            // Enable/disable add buttons
            document.querySelectorAll('[id^="show-add-"]').forEach(btn => {
                btn.disabled = !userPermissions.can_add;
            });

            // Enable/disable edit buttons
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.disabled = !userPermissions.can_edit;
                 btn.style.display = userPermissions.can_edit ? 'inline-flex' : 'none';
            });

            // Enable/disable delete buttons
            document.querySelectorAll('.delete-btn, #delete-selected-products-btn').forEach(btn => {
                btn.disabled = !userPermissions.can_delete;
                btn.style.display = userPermissions.can_delete ? 'inline-flex' : 'none';
            });
             document.querySelectorAll('.copy-btn').forEach(btn => {
                btn.style.display = 'inline-flex';
            });
        }
        
        function displayRolePermissions() {
            const role = document.getElementById('modal-user-role').value;
            const displayDiv = document.getElementById('modal-permissions-display');
            const permissionsText = {
                admin: 'المدير: صلاحيات كاملة على كل شيء، بما في ذلك إدارة المستخدمين والإعدادات.',
                user: 'مستخدم: يمكنه إضافة وتعديل معظم البيانات (مبيعات، مشتريات، منتجات)، لكن لا يمكنه الحذف أو الوصول للإعدادات الحساسة.',
                visitor: 'زائر: يمكنه فقط عرض لوحة المعلومات الرئيسية بدون أي صلاحيات تعديل.'
            };
            displayDiv.textContent = permissionsText[role] || '';
            displayDiv.classList.remove('hidden');
        }

        // --- Activity Log ---
        async function logActivity(action, details) {
            if (!currentUser.auth) return; // Don't log if no user is signed in
            try {
                await addDoc(collection(db, 'activity_log'), {
                    timestamp: serverTimestamp(),
                    userEmail: currentUser.auth.email,
                    action: action,
                    details: details
                });
            } catch (error) {
                console.error("Error logging activity:", error);
            }
        }
        
        async function refreshActivityLog() {
             if (currentUser.role !== 'admin') return;
             const q = query(collection(db, 'activity_log'), orderBy('timestamp', 'desc'), limit(100));
             const snapshot = await getDocs(q);
             const logs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

             const tableBody = document.getElementById('activity-log-table');
             tableBody.innerHTML = '';
             logs.forEach(log => {
                 const row = tableBody.insertRow();
                 const timestamp = log.timestamp?.toDate ? log.timestamp.toDate().toLocaleString('ar-EG') : 'غير متوفر';
                 row.innerHTML = `
                     <td>${timestamp}</td>
                     <td>${log.userEmail}</td>
                     <td>${log.action}</td>
                     <td class="allow-wrap">${log.details}</td>
                 `;
             });
        }

        // --- Backup and Restore ---
        async function exportBackup() {
            if (currentUser.role !== 'admin') return showMessage('غير مصرح لك.');
            showConfirm('هل أنت متأكد من رغبتك في تصدير نسخة احتياطية كاملة؟', async () => {
                const collectionsToBackup = ['products', 'sales', 'purchases', 'expenses', 'customers', 'suppliers', 'returns', 'quotations', 'invoices', 'settings', 'users', 'employees', 'warehouses', 'product-types'];
                const backupData = {};

                for (const collectionName of collectionsToBackup) {
                    const snapshot = await getDocs(collection(db, collectionName));
                    backupData[collectionName] = snapshot.docs.map(doc => ({ _id: doc.id, ...doc.data() }));
                }

                const jsonString = JSON.stringify(backupData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                showMessage('تم تصدير النسخة الاحتياطية بنجاح.');
            });
        }

        function handleImportBackup(event) {
            if (currentUser.role !== 'admin') return showMessage('غير مصرح لك.');
            const file = event.target.files[0];
            if (!file) return;

            showConfirm('تحذير: هذه العملية ستحذف جميع البيانات الحالية بشكل نهائي وتستبدلها ببيانات الملف. هل أنت متأكد من المتابعة؟', () => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        // Delete all existing data
                        for (const collectionName in backupData) {
                            const snapshot = await getDocs(collection(db, collectionName));
                            const batch = writeBatch(db);
                            snapshot.docs.forEach(doc => batch.delete(doc.ref));
                            await batch.commit();
                        }

                        // Import new data
                        for (const collectionName in backupData) {
                             const batch = writeBatch(db);
                             backupData[collectionName].forEach(item => {
                                 const { _id, ...data } = item;
                                 // Convert serverTimestamp placeholders back to actual ServerValue
                                 Object.keys(data).forEach(key => {
                                     if(data[key] && data[key].__type === 'serverTimestamp') {
                                         data[key] = serverTimestamp();
                                     }
                                 });
                                 const docRef = doc(db, collectionName, _id);
                                 batch.set(docRef, data);
                             });
                             await batch.commit();
                        }
                        
                        await logActivity('استعادة نسخة احتياطية', `تم استعادة البيانات من ملف: ${file.name}`);
                        showMessage('تم استعادة النسخة الاحتياطية بنجاح. سيتم إعادة تحميل الصفحة.');
                        setTimeout(() => window.location.reload(), 2000);

                    } catch (error) {
                        console.error('Backup restore error:', error);
                        showMessage('فشل استعادة النسخة الاحتياطية. تأكد من أن الملف صحيح.');
                    } finally {
                        event.target.value = ''; // Reset file input
                    }
                };
                reader.readAsText(file);
            });
        }

        // --- Draggable Dashboard Cards ---
        function initializeDragAndDrop() {
            const container = document.getElementById('dashboard-metrics');
            if (container) {
                new Sortable(container, {
                    animation: 150,
                    handle: '.handle',
                    ghostClass: 'sortable-ghost',
                    onEnd: function (evt) {
                        const cardOrder = Array.from(container.children).map(card => card.dataset.id);
                        localStorage.setItem('dashboardCardOrder', JSON.stringify(cardOrder));
                    }
                });
                applyCardOrder();
            }
        }

        function applyCardOrder() {
            const container = document.getElementById('dashboard-metrics');
            const savedOrder = JSON.parse(localStorage.getItem('dashboardCardOrder'));
            if (savedOrder && container) {
                savedOrder.forEach(cardId => {
                    const card = container.querySelector(`[data-id="${cardId}"]`);
                    if (card) {
                        container.appendChild(card);
                    }
                });
            }
        }

        // --- Initial App Load ---
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            initializeDragAndDrop();
        });
        
        // --- Auto-Logout Timer (Optional) ---
        // let inactivityTimer;
        // function resetTimer() {
        //     clearTimeout(inactivityTimer);
        //     inactivityTimer = setTimeout(() => {
        //         if (currentUser.auth) {
        //             showMessage("تم تسجيل الخروج تلقائياً بسبب عدم النشاط.");
        //             signOut(auth);
        //         }
        //     }, 30 * 60 * 1000); // 30 minutes
        // }
        // window.onload = resetTimer;
        // document.onmousemove = resetTimer;
        // document.onkeypress = resetTimer;
        
    </script>
</body>
</html>
