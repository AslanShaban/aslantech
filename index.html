<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>تطبيق إدارة الأعمال الشامل</title>
	<script src="https://cdn.tailwindcss.com"></script>
	
	<!-- مكتبات خارجية -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
	<style>
		@import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');
		:root {
			--background-primary: #f8fafc;
			--background-secondary: #ffffff;
            --background-secondary-hover: #f1f5f9;
			--text-primary: #1e293b;
			--text-secondary: #64748b;
			--accent-primary: #0ea5e9;
			--accent-primary-hover: #0284c7;
			--shadow-color: rgba(0, 0, 0, 0.07);
            --border-color: #e2e8f0;
		}
        html.dark-mode {
            --background-primary: #1e293b;
            --background-secondary: #334155;
            --background-secondary-hover: #475569;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --shadow-color: rgba(0, 0, 0, 0.2);
            --border-color: #475569;
        }
		body {
			font-family: 'Cairo', sans-serif;
			background-color: var(--background-primary);
			color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
		}
		.container {
			max-width: 1600px;
			margin: 0 auto;
			padding: 1rem;
		}
		@media (min-width: 640px) {
			.container {
				padding: 2rem;
			}
		}
		.dashboard-card, .form-section, .data-table-container, .settings-card {
			background-color: var(--background-secondary);
			border-radius: 1rem;
			box-shadow: 0 4px 6px -1px var(--shadow-color), 0 2px 4px -2px var(--shadow-color);
			padding: 1.5rem;
			transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s;
		}
		.dashboard-card:hover {
			transform: translateY(-5px);
			box-shadow: 0 10px 15px -3px var(--shadow-color), 0 4px 6px -4px var(--shadow-color);
		}
        .dashboard-card.sortable-ghost {
            background: rgba(14, 165, 233, 0.2);
            border: 2px dashed var(--accent-primary);
        }
        .dashboard-card .handle { cursor: grab; }
        .dashboard-card .handle:active { cursor: grabbing; }

		.form-section, .settings-card {
			margin-bottom: 2rem;
		}
		.data-table-container {
			overflow-x: auto;
			max-height: 550px; /* Or any desired height */
			overflow-y: auto;
		}
		.data-table {
			width: 100%;
			border-collapse: collapse;
		}
		.data-table th, .data-table td {
			padding: 1rem;
			text-align: right;
			border-bottom: 1px solid var(--border-color);
		}
		.data-table thead {
            border-bottom: 2px solid var(--border-color);
		}
		/* --- Fix for Sticky Table Headers --- */
		.data-table th {
			background-color: var(--background-secondary);
			color: var(--text-primary);
			font-weight: 700;
			position: sticky;
			top: 0; /* Changed from -1px */
			z-index: 20;
            /* Added shadow for better separation */
            box-shadow: 0 2px 2px -1px var(--shadow-color); 
		}
		.data-table tbody tr {
			transition: background-color 0.2s ease;
		}
		.data-table tbody tr:hover {
			background-color: var(--background-secondary-hover);
		}
		.btn {
			padding: 0.6rem 1.25rem;
			border-radius: 0.75rem;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.2s ease-in-out;
			display: inline-flex;
			align-items: center;
			justify-content: center;
			gap: 0.5rem;
			border: 1px solid transparent;
			box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
		}
		.btn:disabled {
			opacity: 0.6;
			cursor: not-allowed;
		}
		.btn-primary {
			background-color: var(--accent-primary);
			color: #ffffff;
		}
		.btn-primary:hover:not(:disabled) {
			background-color: var(--accent-primary-hover);
			transform: translateY(-2px);
			box-shadow: 0 4px 8px rgba(2, 132, 199, 0.2);
		}
		.btn-danger { background-color: #ef4444; color: #ffffff; }
		.btn-danger:hover:not(:disabled) { background-color: #dc2626; }
		.btn-edit { background-color: #f59e0b; color: #ffffff; }
		.btn-edit:hover:not(:disabled) { background-color: #d97706; }
		.input, .select {
			width: 100%;
			padding: 0.75rem 1rem;
			border-radius: 0.75rem;
			border: 1px solid var(--border-color);
			margin-top: 0.25rem;
			transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.3s, color 0.3s;
			background-color: var(--background-secondary);
			color: var(--text-primary);
		}
        html.dark-mode .input::placeholder, html.dark-mode .select::placeholder { color: var(--text-secondary); }
		.input:focus, .select:focus {
			outline: none;
			border-color: var(--accent-primary);
			box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2);
		}
		.tab-btn {
			padding: 0.75rem 1.5rem;
			font-weight: 600;
			border-radius: 0.75rem;
			transition: all 0.3s ease;
			color: var(--text-secondary);
			border-bottom: 3px solid transparent;
		}
		.tab-btn.active {
			color: var(--accent-primary);
			border-bottom-color: var(--accent-primary);
		}
		.tab-btn:not(.active):hover {
			color: var(--text-primary);
		}
		#nav-tabs {
			border-bottom: 1px solid var(--border-color);
		}
		#invoice-view-modal, #customer-profile-modal {
			max-height: 90vh;
			overflow-y: auto;
		}
		.report-kpi-card-new {
			background-image: linear-gradient(135deg, var(--tw-gradient-stops));
			color: white;
			border-radius: 1rem;
			padding: 1.5rem;
			display: flex;
			flex-direction: column;
			justify-content: space-between;
			min-height: 140px;
		}
		.report-table {
			width: 100%;
			border-collapse: collapse;
			margin-top: 1rem;
		}
		.report-table th, .report-table td {
			padding: 0.75rem 1rem;
			border: 1px solid var(--border-color);
		}
		.report-table thead th {
			background-color: var(--background-secondary-hover);
			font-weight: bold;
		}
		.report-table tbody tr:nth-of-type(even) {
			background-color: var(--background-primary);
		}
		.copy-btn {
			background-color: var(--background-secondary-hover);
			border: 1px solid var(--border-color);
			padding: 0.25rem 0.5rem;
			font-size: 0.75rem;
			cursor: pointer;
			border-radius: 0.5rem;
		}
		.copy-btn:hover {
			background-color: var(--border-color);
		}
		/* --- Added for Dark Mode --- */
		.login-screen-bg { background-color: var(--background-primary); }
		.login-card { background-color: var(--background-secondary); }
		.app-container-bg { background-color: var(--background-secondary); }
	</style>
</head>
<body class="p-0 sm:p-4">
	
	<!-- شاشة تسجيل الدخول -->
	<div id="login-screen" class="fixed inset-0 login-screen-bg flex items-center justify-center z-50">
		<div class="login-card p-8 rounded-xl shadow-lg w-full max-w-sm text-center">
			<h2 class="text-3xl font-bold text-sky-600 mb-4">تسجيل الدخول</h2>
			<p class="text-gray-500 mb-6">الرجاء إدخال البريد الإلكتروني وكلمة المرور للوصول.</p>
			<form id="login-form">
				<div class="mb-4 text-right">
					<label for="username" class="block text-gray-700 font-semibold mb-2">البريد الإلكتروني</label>
					<input type="email" id="username" class="input" required>
				</div>
				<div class="mb-6 text-right">
					<label for="password" class="block text-gray-700 font-semibold mb-2">كلمة المرور</label>
					<input type="password" id="password" class="input" required>
				</div>
				 <p id="login-error" class="text-red-500 mb-4 hidden">البريد الإلكتروني أو كلمة المرور غير صحيحة.</p>
				<button type="submit" class="btn btn-primary w-full text-lg">دخول</button>
                 <div class="mt-4">
                    <a href="#" id="forgot-password-link" class="text-sm text-sky-600 hover:underline">هل نسيت كلمة المرور؟</a>
                </div>
			</form>
		</div>
	</div>

	<!-- حاوية التطبيق الرئيسية -->
	<div id="app-container" class="container app-container-bg rounded-none sm:rounded-2xl shadow-lg p-4 sm:p-8 hidden">
		<header class="mb-8 pb-6 border-b border-slate-200">
			<div class="flex flex-wrap justify-between items-center gap-4">
				<div class="flex items-center gap-4">
					 <i class="fas fa-tasks text-4xl text-sky-500"></i>
					<div>
						<h1 class="text-3xl sm:text-4xl font-bold text-sky-600 mb-1" id="header-company-name">إدارة الأعمال</h1>
						<p class="text-slate-500">لوحة تحكم شاملة لإدارة أعمالك بفعالية.</p>
					</div>
				</div>
				<div class="flex items-center gap-4">
                     <button id="dark-mode-toggle" class="btn bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600">
                         <i class="fas fa-moon"></i>
                     </button>
					<div id="user-info" class="text-right">
						 <p id="user-email" class="text-slate-700 font-semibold hidden sm:block"></p>
						 <p id="user-role-display" class="text-sm text-sky-600 font-bold"></p>
					</div>
					<button id="logout-btn" class="btn btn-danger">
						<i class="fas fa-sign-out-alt"></i>
						<span class="hidden sm:inline">تسجيل الخروج</span>
					</button>
				</div>
			</div>
		</header>

		<!-- أزرار التنقل -->
		<div class="flex flex-wrap justify-center gap-2 mb-8" id="nav-tabs">
			<button class="tab-btn active" data-tab="dashboard">الرئيسية</button>
			<button class="tab-btn" data-tab="products">المستودع</button>
			<button class="tab-btn" data-tab="sales">المبيعات</button>
			<button class="tab-btn" data-tab="purchases">المشتريات</button>
			<button class="tab-btn" data-tab="expenses">المصاريف</button>
			<button class="tab-btn" data-tab="customers">العملاء</button>
			<button class="tab-btn" data-tab="suppliers">الموردين</button>
			<button class="tab-btn" data-tab="invoices">الفواتير</button>
			<button class="tab-btn" data-tab="reports">التقارير</button>
            <button class="tab-btn" data-tab="activity_log" id="activity-log-tab-btn" style="display: none;">سجل النشاط</button>
			<button class="tab-btn" data-tab="settings" id="settings-tab-btn">الإعدادات</button>
		</div>

		<!-- محتوى التبويبات -->
		<div id="tab-content">
			<!-- تبويب الرئيسية -->
			<div id="dashboard" class="tab-pane">
				<h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">لوحة التحكم</h2>
				<div class="form-section">
					<h3 class="text-2xl font-semibold mb-4">عرض البيانات حسب التاريخ</h3>
					<form id="dashboard-date-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
						<div class="flex flex-col">
							<label for="dashboard-date" class="text-gray-600 mb-1">تحديد التاريخ</label>
							<input type="date" id="dashboard-date" class="input" required>
						</div>
						<button type="submit" class="btn btn-primary w-full md:w-auto">عرض البيانات</button>
					</form>
				</div>
				<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8" id="dashboard-metrics">
					<!-- IMPROVEMENT: Added a handle for drag-and-drop functionality -->
					<div class="dashboard-card" data-id="total-sales-card">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-lg font-bold">إجمالي المبيعات (اليوم)</p>
                                <p class="text-3xl font-extrabold" id="total-sales">0</p>
                            </div>
							<div class="flex items-center gap-4">
								<i class="fas fa-chart-line text-4xl text-sky-500 opacity-50"></i>
								<i class="fas fa-arrows-alt handle text-gray-400 cursor-grab" title="تحريك"></i>
							</div>
                        </div>
                    </div>
					<div class="dashboard-card" data-id="total-purchases-card">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-lg font-bold">إجمالي المشتريات (اليوم)</p>
                                <p class="text-3xl font-extrabold" id="total-purchases">0</p>
                            </div>
                            <div class="flex items-center gap-4">
								<i class="fas fa-shopping-cart text-4xl text-green-500 opacity-50"></i>
								<i class="fas fa-arrows-alt handle text-gray-400 cursor-grab" title="تحريك"></i>
							</div>
                        </div>
                    </div>
					<div class="dashboard-card" data-id="total-expenses-card">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-lg font-bold">إجمالي المصاريف (اليوم)</p>
                                <p class="text-3xl font-extrabold" id="total-expenses">0</p>
                            </div>
							<div class="flex items-center gap-4">
								<i class="fas fa-wallet text-4xl text-yellow-500 opacity-50"></i>
								<i class="fas fa-arrows-alt handle text-gray-400 cursor-grab" title="تحريك"></i>
							</div>
                        </div>
                    </div>
					<div class="dashboard-card" data-id="net-profit-card">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-lg font-bold">الربح الصافي (اليوم)</p>
                                <p class="text-3xl font-extrabold" id="net-profit">0</p>
                            </div>
							<div class="flex items-center gap-4">
								<i class="fas fa-money-bill-wave text-4xl text-purple-500 opacity-50"></i>
								<i class="fas fa-arrows-alt handle text-gray-400 cursor-grab" title="تحريك"></i>
							</div>
                        </div>
                    </div>
					<div class="dashboard-card" data-id="remaining-fund-card">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-lg font-bold">صافي الصندوق (اليوم)</p>
                                <p class="text-3xl font-extrabold" id="remaining-fund">0</p>
                            </div>
							<div class="flex items-center gap-4">
								<i class="fas fa-cash-register text-4xl text-teal-500 opacity-50"></i>
								<i class="fas fa-arrows-alt handle text-gray-400 cursor-grab" title="تحريك"></i>
							</div>
                        </div>
                    </div>
                    <div class="dashboard-card md:col-span-2 lg:col-span-1" data-id="profitable-products-card">
						<div class="flex justify-between items-center">
							<h4 class="font-bold mb-2">المنتجات الأكثر ربحاً</h4>
							<i class="fas fa-arrows-alt handle text-gray-400 cursor-grab" title="تحريك"></i>
						</div>
                        <div id="most-profitable-products">
                            <p class="text-sm text-gray-500">لا توجد بيانات كافية.</p>
                        </div>
                    </div>
				</div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="dashboard-card">
                        <h3 class="text-xl font-semibold mb-4">مقارنة المبيعات الشهرية (آخر 6 أشهر)</h3>
                        <canvas id="monthly-sales-chart"></canvas>
                    </div>
                    <div class="dashboard-card">
                        <h3 class="text-xl font-semibold mb-4">مؤشرات الأداء الرئيسية</h3>
                        <div id="kpi-container" class="space-y-4">
                            <!-- KPIs will be injected here -->
                        </div>
                    </div>
                </div>
			</div>

			<!-- تبويب المستودع (المنتجات) -->
			<div id="products" class="tab-pane hidden">
				<h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">إدارة المستودع</h2>
				<div class="form-section">
					<h3 class="text-2xl font-semibold mb-4" id="product-form-title">إضافة منتج جديد</h3>
					<form id="add-product-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
						<input type="hidden" id="product-id">
						<div class="flex flex-col">
							<label for="p-name" class="text-gray-600 mb-1">اسم المنتج</label>
							<input type="text" id="p-name" class="input" required>
						</div>
						<div class="flex flex-col">
							<label for="p-cost" class="text-gray-600 mb-1">سعر التكلفة</label>
							<input type="number" id="p-cost" class="input" min="0" step="0.01" required>
						</div>
						<div class="flex flex-col">
							<label for="p-qty" class="text-gray-600 mb-1">الكمية</label>
							<input type="number" id="p-qty" class="input" min="0" required>
						</div>
						<div class="flex flex-col">
							<label for="p-supplier" class="text-gray-600 mb-1">المورد</label>
							<select id="p-supplier" class="select">
								<option value="">اختر مورد</option>
							</select>
						</div>
						<div class="flex items-end col-span-full gap-2">
							<button type="submit" class="btn btn-primary w-full" id="product-form-submit-btn">إضافة المنتج</button>
							 <button type="button" class="btn bg-gray-500 text-white w-full hidden" id="product-form-cancel-btn">إلغاء التعديل</button>
						</div>
					</form>
				</div>
				<div class="bg-white rounded-2xl shadow-lg p-4 sm:p-6">
					<div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6 text-center">
						<div class="p-4 bg-sky-50 dark:bg-sky-900/50 rounded-lg">
							<h4 class="text-sm font-semibold text-sky-800 dark:text-sky-200">إجمالي المنتجات</h4>
							<p id="stats-total-products" class="text-2xl font-bold text-sky-900 dark:text-sky-100">0</p>
						</div>
						<div class="p-4 bg-green-50 dark:bg-green-900/50 rounded-lg">
							<h4 class="text-sm font-semibold text-green-800 dark:text-green-200">قيمة المخزون</h4>
							<p id="stats-stock-value" class="text-2xl font-bold text-green-900 dark:text-green-100">0</p>
						</div>
						<div class="p-4 bg-yellow-50 dark:bg-yellow-900/50 rounded-lg">
							<h4 class="text-sm font-semibold text-yellow-800 dark:text-yellow-200">منتجات منخفضة المخزون</h4>
							<p id="stats-low-stock" class="text-2xl font-bold text-yellow-900 dark:text-yellow-100">0</p>
						</div>
						<div class="p-4 bg-red-50 dark:bg-red-900/50 rounded-lg">
							<h4 class="text-sm font-semibold text-red-800 dark:text-red-200">منتجات نافدة</h4>
							<p id="stats-out-of-stock" class="text-2xl font-bold text-red-900 dark:text-red-100">0</p>
						</div>
					</div>
					<div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-4 pb-4 border-b border-gray-200">
						<div class="w-full md:w-2/5">
							<div class="relative">
								<span class="absolute inset-y-0 left-0 flex items-center pl-3"><i class="fas fa-search text-gray-400"></i></span>
								<input type="text" id="product-search-input" class="input w-full pl-10" placeholder="ابحث عن منتج بالاسم...">
							</div>
						</div>
						<div class="flex flex-wrap justify-end items-center gap-2">
							<button id="delete-selected-products-btn" class="btn btn-danger" disabled><i class="fas fa-trash-alt"></i><span>حذف المحدد</span></button>
							<label class="btn bg-green-600 hover:bg-green-700 text-white cursor-pointer"><i class="fas fa-file-excel"></i><span>استيراد</span><input type="file" id="import-products-excel" class="hidden" accept=".xlsx, .xls, .csv"></label>
							<button id="export-products-btn" class="btn bg-sky-600 hover:bg-sky-700 text-white"><i class="fas fa-file-download"></i><span>تصدير Excel</span></button>
						</div>
					</div>
					<div class="data-table-container">
						<table class="data-table" id="products-table-export">
							<thead>
								<tr>
									<th class="no-export"><input type="checkbox" id="select-all-products"></th>
									<th>الاسم</th>
									<th>سعر التكلفة</th>
									<th>الكمية</th>
									<th>المورد</th>
									<th class="no-export">الإجراءات</th>
								</tr>
							</thead>
							<tbody id="products-table"></tbody>
						</table>
					</div>
				</div>
			</div>

			<!-- تبويب المبيعات -->
			<div id="sales" class="tab-pane hidden">
				<h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">إدارة المبيعات</h2>
				<div class="form-section">
					 <h3 class="text-2xl font-semibold mb-4" id="sale-form-title">تسجيل عملية البيع</h3>
					 <form id="add-sale-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
						 <input type="hidden" id="sale-id">
						 <div class="flex flex-col">
							 <label for="s-date" class="text-gray-600 mb-1">التاريخ</label>
							 <input type="date" id="s-date" class="input" required>
						 </div>
						 <div class="flex flex-col">
							 <label for="s-type" class="text-gray-600 mb-1">نوع البيع</label>
							 <select id="s-type" class="select">
								 <option value="product">منتج</option>
								 <option value="service">خدمة (صيانة)</option>
							 </select>
						 </div>
						 <div class="flex flex-col" id="s-product-container">
							 <label for="s-product" class="text-gray-600 mb-1">المنتج</label>
                             <select id="s-product" class="select" required></select>
						 </div>
						 <div class="flex flex-col hidden" id="s-service-container">
							 <label for="s-service-name" class="text-gray-600 mb-1">اسم الخدمة</label>
							 <input type="text" id="s-service-name" class="input">
						 </div>
						 <div class="flex flex-col" id="s-qty-container">
							 <label for="s-qty" class="text-gray-600 mb-1">الكمية</label>
							 <input type="number" id="s-qty" class="input" min="1" required>
						 </div>
						 <div class="flex flex-col" id="s-cost-container">
							<label for="s-cost" class="text-gray-600 mb-1">سعر التكلفة</label>
							<input type="number" id="s-cost" class="input" min="0" step="0.01" placeholder="تلقائي للمنتج / يدوي للخدمة" required>
						</div>
						 <div class="flex flex-col" id="s-price-container">
							 <label for="s-price" class="text-gray-600 mb-1">سعر البيع</label>
							 <input type="number" id="s-price" class="input" min="0" step="0.01" required>
						 </div>
						 <div class="flex flex-col">
							 <label for="s-customer" class="text-gray-600 mb-1">العميل</label>
							 <select id="s-customer" class="select">
								 <option value="">اختر عميل</option>
							 </select>
						 </div>
						 <div class="flex items-end col-span-full gap-2">
							 <button type="submit" class="btn btn-primary w-full" id="sale-form-submit-btn">تسجيل عملية البيع</button>
							 <button type="button" class="btn bg-gray-500 text-white w-full hidden" id="sale-form-cancel-btn">إلغاء التعديل</button>
						 </div>
					 </form>
				</div>
				<div class="data-table-container">
					 <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
						 <h3 class="text-2xl font-semibold">سجل المبيعات</h3>
						 <form id="sales-filter-form" class="flex flex-wrap items-end gap-2">
							<input type="date" id="sales-filter-date" class="input text-sm p-2 w-48">
							<button type="submit" class="btn btn-primary text-sm">عرض</button>
							<button type="button" id="sales-clear-filter" class="btn bg-gray-300 text-sm">عرض الكل</button>
						</form>
						 <div class="flex flex-wrap gap-2">
							 <button id="export-sales-btn" class="btn btn-primary bg-sky-500 hover:bg-sky-600"><i class="fas fa-file-excel"></i> تصدير Excel</button>
						 </div>
					</div>
					<table class="data-table" id="sales-table-export">
						<thead>
							<tr>
								<th>التاريخ</th>
								<th>النوع</th>
								<th>الاسم/المنتج</th>
								<th>الكمية</th>
								<th>العميل</th>
								<th>المبلغ</th>
								<th class="no-export">الإجراءات</th>
							</tr>
						</thead>
						<tbody id="sales-table"></tbody>
					</table>
				</div>
			</div>

			 <!-- تبويب المشتريات -->
			<div id="purchases" class="tab-pane hidden">
				 <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">إدارة المشتريات</h2>
				 <div class="form-section">
					 <h3 class="text-2xl font-semibold mb-4" id="purchase-form-title">تسجيل شراء جديد</h3>
					 <form id="add-purchase-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
						 <input type="hidden" id="purchase-id">
						 <div class="flex flex-col">
							 <label for="p-date" class="text-gray-600 mb-1">التاريخ</label>
							 <input type="date" id="p-date" class="input" required>
						 </div>
						 <div class="flex flex-col">
							 <label for="p-type" class="text-gray-600 mb-1">نوع الشراء</label>
							 <select id="p-type" class="select">
								 <option value="product">منتج من المخزون</option>
								 <option value="other">منتج آخر</option>
							 </select>
						 </div>
						 <div class="flex flex-col" id="p-product-container">
							 <label for="p-product" class="text-gray-600 mb-1">المنتج</label>
                             <select id="p-product" class="select"></select>
						 </div>
						 <div class="flex flex-col hidden" id="p-other-product-container">
							 <label for="p-other-product-name" class="text-gray-600 mb-1">اسم المنتج</label>
							 <input type="text" id="p-other-product-name" class="input">
						 </div>
						  <div class="flex flex-col">
							 <label for="p-cost-input" class="text-gray-600 mb-1">سعر الشراء</label>
							 <input type="number" id="p-cost-input" class="input" min="0" step="0.01" required>
						 </div>
						 <div class="flex flex-col">
							 <label for="p-qty-input" class="text-gray-600 mb-1">الكمية</label>
							 <input type="number" id="p-qty-input" class="input" min="1" required>
						 </div>
						 <div class="flex flex-col">
							 <label for="p-supplier-purchase" class="text-gray-600 mb-1">المورد</label>
							 <select id="p-supplier-purchase" class="select">
								 <option value="">اختر مورد</option>
							 </select>
						 </div>
						 <div class="flex items-end col-span-full gap-2">
							 <button type="submit" class="btn btn-primary w-full" id="purchase-form-submit-btn">تسجيل الشراء</button>
							 <button type="button" class="btn bg-gray-500 text-white w-full hidden" id="purchase-form-cancel-btn">إلغاء التعديل</button>
						 </div>
					 </form>
				 </div>
				 <div class="data-table-container">
					 <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
						 <h3 class="text-2xl font-semibold">سجل المشتريات</h3>
						 <form id="purchases-filter-form" class="flex flex-wrap items-end gap-2">
							<input type="date" id="purchases-filter-date" class="input text-sm p-2 w-48">
							<button type="submit" class="btn btn-primary text-sm">عرض</button>
							<button type="button" id="purchases-clear-filter" class="btn bg-gray-300 text-sm">عرض الكل</button>
						</form>
						  <div class="flex flex-wrap gap-2">
							 <button id="export-purchases-btn" class="btn btn-primary bg-sky-500 hover:bg-sky-600"><i class="fas fa-file-excel"></i> تصدير Excel</button>
						 </div>
					</div>
					 <table class="data-table" id="purchases-table-export">
						 <thead>
							 <tr>
								 <th>التاريخ</th>
								 <th>المنتج</th>
								 <th>الكمية</th>
								 <th>المورد</th>
								 <th>المبلغ</th>
								 <th class="no-export">الإجراءات</th>
							 </tr>
						 </thead>
						 <tbody id="purchases-table"></tbody>
					 </table>
				 </div>
			</div>

			<!-- تبويب المصاريف -->
			<div id="expenses" class="tab-pane hidden">
				<h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">إدارة المصاريف</h2>
				 <div class="form-section">
					 <h3 class="text-2xl font-semibold mb-4" id="expense-form-title">تسجيل مصروف جديد</h3>
					 <form id="add-expense-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-end">
						 <input type="hidden" id="expense-id">
						 <div class="flex flex-col">
							 <label for="e-date" class="text-gray-600 mb-1">التاريخ</label>
							 <input type="date" id="e-date" class="input" required>
						 </div>
						 <div class="flex flex-col">
							 <label for="e-type" class="text-gray-600 mb-1">نوع المصروف</label>
							 <select id="e-type" class="select" required>
								 <option value="رواتب">رواتب</option>
								 <option value="مصاريف اخرى">مصاريف اخرى</option>
							 </select>
						 </div>
						 <div class="flex flex-col">
							 <label for="e-amount" class="text-gray-600 mb-1">المبلغ</label>
							 <input type="number" id="e-amount" class="input" min="0" step="0.01" required>
						 </div>
						 <div class="flex flex-col col-span-full">
							 <label for="e-desc" class="text-gray-600 mb-1">الوصف</label>
							 <textarea id="e-desc" class="input" rows="2"></textarea>
						 </div>
						 <div class="flex items-end col-span-full gap-2">
							 <button type="submit" class="btn btn-primary w-full" id="expense-form-submit-btn">تسجيل المصروف</button>
							 <button type="button" class="btn bg-gray-500 text-white w-full hidden" id="expense-form-cancel-btn">إلغاء التعديل</button>
						 </div>
					 </form>
				 </div>
				 <div class="data-table-container">
					 <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
						 <h3 class="text-2xl font-semibold">سجل المصاريف</h3>
						 <form id="expenses-filter-form" class="flex flex-wrap items-end gap-2">
							<input type="date" id="expenses-filter-date" class="input text-sm p-2 w-48">
							<button type="submit" class="btn btn-primary text-sm">عرض</button>
							<button type="button" id="expenses-clear-filter" class="btn bg-gray-300 text-sm">عرض الكل</button>
						</form>
						 <div class="flex flex-wrap gap-2">
							 <button id="export-expenses-btn" class="btn btn-primary bg-sky-500 hover:bg-sky-600"><i class="fas fa-file-excel"></i> تصدير Excel</button>
						 </div>
					</div>
					 <table class="data-table" id="expenses-table-export">
						 <thead>
							 <tr>
								 <th>التاريخ</th>
								 <th>النوع</th>
								 <th>المبلغ</th>
								 <th>الوصف</th>
								 <th class="no-export">الإجراءات</th>
							 </tr>
						 </thead>
						 <tbody id="expenses-table"></tbody>
					 </table>
				 </div>
			</div>

			<!-- تبويب العملاء -->
			<div id="customers" class="tab-pane hidden">
				<h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">إدارة العملاء</h2>
				 <div class="form-section">
					 <h3 class="text-2xl font-semibold mb-4" id="customer-form-title">إضافة عميل جديد</h3>
					 <form id="add-customer-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
						 <input type="hidden" id="customer-id">
						 <div class="flex flex-col">
							 <label for="c-name" class="text-gray-600 mb-1">اسم العميل</label>
							 <input type="text" id="c-name" class="input" required>
						 </div>
						 <div class="flex flex-col">
							 <label for="c-phone" class="text-gray-600 mb-1">رقم الهاتف</label>
							 <input type="text" id="c-phone" class="input">
						 </div>
						 <div class="flex flex-col">
							 <label for="c-email" class="text-gray-600 mb-1">البريد الإلكتروني</label>
							 <input type="email" id="c-email" class="input">
						 </div>
						 <div class="flex flex-col col-span-full">
							 <label for="c-address" class="text-gray-600 mb-1">العنوان</label>
							 <textarea id="c-address" class="input" rows="2"></textarea>
						 </div>
						 <div class="flex items-end col-span-full gap-2">
							 <button type="submit" class="btn btn-primary w-full" id="customer-form-submit-btn">إضافة العميل</button>
							 <button type="button" class="btn bg-gray-500 text-white w-full hidden" id="customer-form-cancel-btn">إلغاء التعديل</button>
						 </div>
					 </form>
				 </div>
				 <div class="data-table-container">
					 <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
						 <h3 class="text-2xl font-semibold">قائمة العملاء</h3>
						 <div class="flex flex-wrap gap-2">
							 <button id="export-customers-btn" class="btn btn-primary bg-sky-500 hover:bg-sky-600"><i class="fas fa-file-excel"></i> تصدير Excel</button>
						 </div>
					</div>
					 <table class="data-table" id="customers-table-export">
						 <thead>
							 <tr>
								 <th>الاسم</th>
								 <th>رقم الهاتف</th>
								 <th>البريد الإلكتروني</th>
                                 <th>نقاط الولاء</th>
								 <th>العنوان</th>
								 <th class="no-export">الإجراءات</th>
							 </tr>
						 </thead>
						 <tbody id="customers-table"></tbody>
					 </table>
				 </div>
			</div>

			<!-- تبويب الموردين -->
			<div id="suppliers" class="tab-pane hidden">
				 <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">إدارة الموردين</h2>
				 <div class="form-section">
					 <h3 class="text-2xl font-semibold mb-4" id="supplier-form-title">إضافة مورد جديد</h3>
					 <form id="add-supplier-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
						 <input type="hidden" id="supplier-id">
						 <div class="flex flex-col">
							 <label for="sup-name" class="text-gray-600 mb-1">اسم المورد</label>
							 <input type="text" id="sup-name" class="input" required>
						 </div>
						 <div class="flex flex-col">
							 <label for="sup-phone" class="text-gray-600 mb-1">رقم الهاتف</label>
							 <input type="text" id="sup-phone" class="input">
						 </div>
						 <div class="flex flex-col">
							 <label for="sup-email" class="text-gray-600 mb-1">البريد الإلكتروني</label>
							 <input type="email" id="sup-email" class="input">
						 </div>
						 <div class="flex flex-col col-span-full">
							 <label for="sup-address" class="text-gray-600 mb-1">العنوان</label>
							 <textarea id="sup-address" class="input" rows="2"></textarea>
						 </div>
						 <div class="flex items-end col-span-full gap-2">
							 <button type="submit" class="btn btn-primary w-full" id="supplier-form-submit-btn">إضافة المورد</button>
							   <button type="button" class="btn bg-gray-500 text-white w-full hidden" id="supplier-form-cancel-btn">إلغاء التعديل</button>
						 </div>
					 </form>
				 </div>
				 <div class="data-table-container">
					 <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
						 <h3 class="text-2xl font-semibold">قائمة الموردين</h3>
						 <div class="flex flex-wrap gap-2">
							 <button id="export-suppliers-btn" class="btn btn-primary bg-sky-500 hover:bg-sky-600"><i class="fas fa-file-excel"></i> تصدير Excel</button>
						 </div>
					</div>
					 <table class="data-table" id="suppliers-table-export">
						 <thead>
							 <tr>
								 <th>ID المورد <span class="text-xs text-slate-400">(للاستيراد)</span></th>
								 <th>الاسم</th>
								 <th>رقم الهاتف</th>
								 <th>البريد الإلكتروني</th>
								 <th>العنوان</th>
								 <th class="no-export">الإجراءات</th>
							 </tr>
						 </thead>
						 <tbody id="suppliers-table"></tbody>
					 </table>
				 </div>
			</div>

			<!-- تبويب الفواتير -->
			<div id="invoices" class="tab-pane hidden">
				 <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">إدارة الفواتير</h2>
				 <div class="form-section">
					 <h3 class="text-2xl font-semibold mb-4">إنشاء فاتورة جديدة</h3>
					 <form id="add-invoice-form" class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
						 <div class="flex flex-col">
							 <label for="i-date" class="text-gray-600 mb-1">تاريخ الفاتورة</label>
							 <input type="date" id="i-date" class="input" required>
						 </div>
						 <div class="flex flex-col">
							 <label for="i-customer" class="text-gray-600 mb-1">العميل</label>
							 <select id="i-customer" class="select" required>
								 <option value="">اختر عميل</option>
							 </select>
						 </div>
						 <div class="flex flex-col col-span-full">
							 <label class="text-gray-600 mb-1">تفاصيل المنتجات</label>
							 <div id="invoice-items-container" class="space-y-4">
								 <!-- صفوف بنود الفاتورة ستضاف هنا -->
							 </div>
							  <div class="flex gap-2 mt-4">
								 <button type="button" id="add-invoice-item-btn" class="btn btn-primary self-start">إضافة منتج آخر</button>
								 <button type="button" id="add-manual-invoice-item-btn" class="btn bg-green-600 text-white self-start">إضافة بند يدوي</button>
							 </div>
						 </div>
						 <div class="flex flex-col col-span-full">
							 <p class="text-lg font-bold">المجموع الكلي: <span id="invoice-total">0.00</span></p>
						 </div>
						 <div class="flex items-end col-span-full">
							 <button type="submit" class="btn btn-primary w-full">إنشاء الفاتورة</button>
						 </div>
					 </form>
				 </div>
				 <div class="data-table-container">
					 <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
						  <h3 class="text-2xl font-semibold">قائمة الفواتير</h3>
						  <div class="flex-grow">
							  <form id="invoice-export-form" class="grid grid-cols-1 sm:grid-cols-3 gap-2 items-end">
								  <div>
									  <label for="invoice-start-date" class="text-xs">من تاريخ</label>
									  <input type="date" id="invoice-start-date" class="input p-2 text-sm">
								  </div>
								  <div>
									  <label for="invoice-end-date" class="text-xs">إلى تاريخ</label>
									  <input type="date" id="invoice-end-date" class="input p-2 text-sm">
								  </div>
								  <div class="flex gap-2">
									  <button type="button" id="export-invoices-excel-btn" class="btn btn-primary bg-green-600 hover:bg-green-700 w-full text-sm"><i class="fas fa-file-excel"></i> تصدير Excel</button>
									  <button type="button" id="export-invoices-pdf-btn" class="btn btn-primary bg-red-600 hover:bg-red-700 w-full text-sm"><i class="fas fa-file-pdf"></i> تصدير PDF</button>
								  </div>
							  </form>
						  </div>
					 </div>
					  <table class="data-table" id="invoices-table-export">
						  <thead>
							  <tr>
								  <th>رقم الفاتورة</th>
								  <th>التاريخ</th>
								  <th>العميل</th>
								  <th>المبلغ الإجمالي</th>
								  <th class="no-export">الإجراءات</th>
							  </tr>
						  </thead>
						  <tbody id="invoices-table"></tbody>
					  </table>
				 </div>
			</div>

			<!-- تبويب التقارير -->
			  <div id="reports" class="tab-pane hidden">
				  <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">التقارير المتقدمة</h2>
				  <div class="form-section no-print">
					  <h3 class="text-2xl font-semibold">تحديد فترة التقرير</h3>
					  <form id="reports-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end mt-4">
						  <div class="flex flex-col">
							  <label for="start-date" class="text-gray-600 mb-1">تاريخ البدء</label>
							  <input type="date" id="start-date" class="input" required>
						  </div>
						  <div class="flex flex-col">
							  <label for="end-date" class="text-gray-600 mb-1">تاريخ الانتهاء</label>
							  <input type="date" id="end-date" class="input" required>
						  </div>
						  <button type="submit" class="btn btn-primary w-full">عرض التقرير</button>
					  </form>
				  </div>
				 
				  <div id="report-results" class="hidden">
					  <div id="printable-content">
						  <!-- بداية رأس التقرير -->
						  <div class="p-6 bg-white rounded-lg shadow-md mb-6">
							  <div class="flex justify-between items-center pb-4 border-b border-gray-200">
								  <div>
									  <h3 class="text-2xl font-bold text-sky-600" id="report-company-name">اسم الشركة</h3>
									  <p class="text-sm text-gray-500" id="report-company-address">عنوان الشركة</p>
								  </div>
								  <div class="text-right">
									  <h4 class="text-xl font-bold" id="report-title">تقرير الأداء</h4>
									  <p class="text-sm text-gray-500" id="report-date-range">للفترة من ... إلى ...</p>
								  </div>
							  </div>
							  <div class="flex justify-end mt-4 gap-2 no-print">
								  <button id="print-report-btn" class="btn btn-primary"><i class="fas fa-print"></i> طباعة</button>
								  <button id="export-report-pdf-btn" class="btn bg-red-500 text-white"><i class="fas fa-file-pdf"></i> تصدير PDF</button>
								  <div class="flex items-center gap-2">
									  <select id="advanced-export-type" class="select p-2 text-sm">
										  <option value="all">تقرير شامل (Excel)</option>
										  <option value="sales">تقرير المبيعات</option>
										  <option value="purchases">تقرير المشتريات</option>
										  <option value="expenses">تقرير المصاريف</option>
										  <option value="invoices">تقرير الفواتير</option>
										  <option value="profits">تقرير الأرباح</option>
										  <option value="inventory">تقرير المستودع</option>
									  </select>
									  <button id="export-advanced-report-excel-btn" class="btn bg-green-500 text-white"><i class="fas fa-file-excel"></i> تصدير</button>
								  </div>
							  </div>
						  </div>
						  	<!-- نهاية رأس التقرير -->

						  <!-- بطاقات مؤشرات الأداء الرئيسية -->
						  <div class="p-6">
							  <h4 class="text-xl font-semibold mb-4 text-gray-700">ملخص الأداء</h4>
							  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
								  <div class="report-kpi-card-new from-sky-500 to-cyan-400">
									  <div class="flex justify-between items-center">
										  <p class="font-bold">إجمالي المبيعات</p>
										  <i class="fas fa-dollar-sign text-2xl opacity-70"></i>
									  </div>
									  <p class="text-3xl font-extrabold text-right" id="report-sales">0</p>
								  </div>
								   <div class="report-kpi-card-new from-emerald-500 to-green-400">
									  <div class="flex justify-between items-center">
										  <p class="font-bold">الربح الصافي</p>
										  <i class="fas fa-chart-line text-2xl opacity-70"></i>
									  </div>
									  <p class="text-3xl font-extrabold text-right" id="report-profit">0</p>
								  </div>
								  <div class="report-kpi-card-new from-amber-500 to-yellow-400">
									  <div class="flex justify-between items-center">
										  <p class="font-bold">إجمالي المشتريات</p>
										  <i class="fas fa-shopping-cart text-2xl opacity-70"></i>
									  </div>
									  <p class="text-3xl font-extrabold text-right" id="report-purchases">0</p>
								  </div>
								  <div class="report-kpi-card-new from-rose-500 to-red-400">
									  <div class="flex justify-between items-center">
										  <p class="font-bold">إجمالي المصاريف</p>
										  <i class="fas fa-wallet text-2xl opacity-70"></i>
									  </div>
									  <p class="text-3xl font-extrabold text-right" id="report-expenses">0</p>
								  </div>
							  </div>

							  <!-- الرسوم البيانية -->
							  <h4 class="text-xl font-semibold mb-4 text-gray-700 mt-10">تحليلات بيانية</h4>
							  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
								  <div class="dashboard-card">
									  <h4 class="text-xl font-semibold mb-4">ملخص الأداء المالي</h4>
									  <canvas id="performanceChart" style="max-height: 350px;"></canvas>
								  </div>
								  <div class="dashboard-card">
									  <h4 class="text-xl font-semibold mb-4">أعلى المبيعات (منتجات وخدمات)</h4>
									  <canvas id="salesDistributionChart" style="max-height: 350px;"></canvas>
								  </div>
							  </div>
							 
							  <!-- الجداول التفصيلية -->
							  <h4 class="text-xl font-semibold mb-4 text-gray-700 mt-10">بيانات تفصيلية</h4>
							  <div class="space-y-8">
								  <div class="dashboard-card">
									  <h4 class="text-lg font-semibold mb-4">المنتجات الأكثر مبيعاً</h4>
									  <table class="report-table" id="top-products-table-export">
										  <thead><tr><th>المنتج</th><th>الكمية المباعة</th><th>إجمالي الإيرادات</th></tr></thead>
										  <tbody id="top-products-table"></tbody>
									  </table>
								  </div>
								  <div class="dashboard-card">
									  <h4 class="text-lg font-semibold mb-4">أفضل العملاء</h4>
									  <table class="report-table" id="top-customers-table-export">
										  <thead><tr><th>العميل</th><th>إجمالي المشتريات</th></tr></thead>
										  <tbody id="top-customers-table"></tbody>
									  </table>
								  </div>
								   <div class="dashboard-card">
									  <h4 class="text-lg font-semibold mb-4">تقرير المصاريف</h4>
									  <table class="report-table" id="salaries-report-table-export">
										  <thead><tr><th>النوع</th><th>المبلغ الإجمالي</th></tr></thead>
										  <tbody id="salaries-report-table"></tbody>
									  </table>
								  </div>
								  <div class="dashboard-card">
									  <h4 class="text-lg font-semibold mb-4">تنبيهات نفاد المخزون (الكمية صفر)</h4>
									  <table class="report-table" id="low-stock-table-export">
										  <thead><tr><th>المنتج</th><th>الكمية المتبقية</th></tr></thead>
										  <tbody id="low-stock-table"></tbody>
									  </table>
								  </div>
							  </div>
						  </div>

					  </div>
				  </div>
			  </div>

            <!-- تبويب سجل النشاط -->
            <div id="activity_log" class="tab-pane hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">سجل نشاط المستخدمين</h2>
                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>الوقت والتاريخ</th>
                                <th>المستخدم</th>
                                <th>الإجراء</th>
                                <th>التفاصيل</th>
                            </tr>
                        </thead>
                        <tbody id="activity-log-table"></tbody>
                    </table>
                </div>
            </div>


			<!-- تبويب الإعدادات -->
			<div id="settings" class="tab-pane hidden">
				<h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">الإعدادات</h2>
				 <div class="settings-card">
					 <h3 class="text-2xl font-semibold mb-4 border-b pb-2">معلومات الشركة والإعدادات المالية</h3>
					 <form id="settings-form" class="space-y-4">
						 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
							 <div>
								 <label for="setting-company-name" class="block text-gray-700 font-semibold mb-1">اسم الشركة</label>
								 <input type="text" id="setting-company-name" class="input">
							 </div>
							 <div>
								 <label for="setting-company-phone" class="block text-gray-700 font-semibold mb-1">الهاتف</label>
								 <input type="text" id="setting-company-phone" class="input">
							 </div>
						 </div>
						 <div>
							 <label for="setting-company-address" class="block text-gray-700 font-semibold mb-1">العنوان</label>
							 <input type="text" id="setting-company-address" class="input">
						 </div>
						  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
							 <div>
								 <label for="setting-currency" class="block text-gray-700 font-semibold mb-1">رمز العملة</label>
								 <input type="text" id="setting-currency" class="input" placeholder="e.g., JOD, USD, SAR">
							 </div>
							 <div>
								 <label for="setting-initial-fund" class="block text-gray-700 font-semibold mb-1">رأس مال الصندوق الأولي</label>
								 <input type="number" step="0.01" id="setting-initial-fund" class="input">
							 </div>
						 </div>
                          <div>
                            <label for="setting-loyalty-points" class="block text-gray-700 font-semibold mb-1">نقاط الولاء (نقطة لكل X مبلغ)</label>
                            <input type="number" step="1" id="setting-loyalty-points" class="input" placeholder="مثال: 10 (نقطة لكل 10 دنانير)">
                          </div>
						 <div class="text-left">
							 <button type="submit" class="btn btn-primary">حفظ الإعدادات</button>
						 </div>
					 </form>
				 </div>
				 <div id="user-management-section" class="settings-card">
					 <h3 class="text-2xl font-semibold mb-4 border-b pb-2">إدارة المستخدمين</h3>
					 <div class="form-section p-0 m-0 shadow-none">
						 <h4 class="text-xl font-semibold mb-4" id="user-form-title">إنشاء مستخدم جديد</h4>
						 <form id="add-user-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
							 <div class="flex flex-col">
								 <label for="user-email-input" class="text-gray-600 mb-1">البريد الإلكتروني</label>
								 <input type="email" id="user-email-input" class="input" required>
							 </div>
							  <div class="flex flex-col">
								 <label for="user-password-input" class="text-gray-600 mb-1">كلمة المرور</label>
								 <input type="password" id="user-password-input" class="input" required>
							 </div>
							 <div class="flex flex-col">
								 <label for="user-role-select" class="text-gray-600 mb-1">الصلاحية</label>
								 <select id="user-role-select" class="select" required>
									 <option value="admin">مدير</option>
									 <option value="user">مستخدم</option>
									 <option value="visitor">زائر</option>
								 </select>
							 </div>
							 <div id="permissions-display" class="col-span-full bg-sky-50 p-4 rounded-lg border border-sky-200 text-sky-800 text-sm mt-2 hidden">
								 <!-- Permissions will be displayed here -->
							 </div>
							 <div class="col-span-full">
								 <button type="submit" class="btn btn-primary w-full">إنشاء المستخدم</button>
							 </div>
						 </form>
					 </div>
					  <div class="data-table-container mt-8">
						  <h4 class="text-xl font-semibold mb-4">قائمة المستخدمين</h4>
						  <table class="data-table">
							  <thead>
								  <tr>
									  <th>البريد الإلكتروني</th>
									  <th>الصلاحية</th>
									  <th>الإجراءات</th>
								  </tr>
							  </thead>
							  <tbody id="users-table">
								  <!-- User rows will be inserted here -->
							  </tbody>
						  </table>
					  </div>
				 </div>
                 <div id="backup-management-section" class="settings-card" style="display: none;">
                     <h3 class="text-2xl font-semibold mb-4 border-b pb-2">النسخ الاحتياطي والاستعادة</h3>
                     <div class="flex flex-wrap gap-4 items-center">
                         <button id="export-backup-btn" class="btn btn-primary bg-sky-600 hover:bg-sky-700">
                             <i class="fas fa-file-export"></i> تصدير نسخة احتياطية
                         </button>
                         <label class="btn bg-green-600 hover:bg-green-700 text-white cursor-pointer">
                             <i class="fas fa-file-import"></i> استيراد نسخة احتياطية
                             <input type="file" id="import-backup-input" class="hidden" accept=".json">
                         </label>
                     </div>
                     <p class="mt-4 text-sm text-red-600 bg-red-50 p-3 rounded-lg"><i class="fas fa-exclamation-triangle mr-2"></i><strong>تحذير:</strong> استيراد نسخة احتياطية سيقوم بحذف جميع البيانات الحالية بشكل نهائي واستبدالها ببيانات الملف الذي تم رفعه. يرجى توخي الحذر الشديد.</p>
                 </div>
			</div>


		</div>
	</div>

	<!-- Modals -->
	<div id="custom-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden flex items-center justify-center"></div>
	<div id="custom-alert" class="fixed z-50 p-6 rounded-lg shadow-lg bg-white max-w-sm w-full hidden transform -translate-x-1/2 -translate-y-1/2 top-1/2 left-1/2">
		<p id="alert-message" class="text-center text-lg font-semibold mb-4"></p>
		<div class="flex justify-center">
			<button id="alert-ok-btn" class="btn btn-primary w-1/2">حسناً</button>
		</div>
	</div>
	<div id="custom-confirm" class="fixed z-50 p-6 rounded-lg shadow-lg bg-white max-w-sm w-full hidden transform -translate-x-1/2 -translate-y-1/2 top-1/2 left-1/2">
		<p id="confirm-message" class="text-center text-lg font-semibold mb-6"></p>
		<div class="flex justify-center gap-4">
			<button id="confirm-ok-btn" class="btn btn-danger w-1/2">تأكيد</button>
			<button id="confirm-cancel-btn" class="btn bg-gray-200 hover:bg-gray-300 w-1/2">إلغاء</button>
		</div>
	</div>
	<div id="invoice-view-modal" class="fixed z-50 p-4 md:p-8 rounded-lg shadow-2xl bg-white max-w-4xl w-full hidden transform -translate-x-1/2 -translate-y-1/2 top-1/2 left-1/2">
		<div id="invoice-view-content"></div>
		<div class="flex justify-end gap-4 p-4 bg-gray-50 rounded-b-lg mt-4 no-print">
			<button id="invoice-print-btn" class="btn btn-primary"><i class="fas fa-print"></i> طباعة / حفظ PDF</button>
			<button id="invoice-close-btn" class="btn btn-danger bg-gray-500 hover:bg-gray-600">إغلاق</button>
		</div>
	</div>
    <div id="forgot-password-modal" class="fixed z-50 p-6 rounded-lg shadow-lg bg-white max-w-sm w-full hidden transform -translate-x-1/2 -translate-y-1/2 top-1/2 left-1/2">
		<h3 class="text-xl font-bold text-center mb-4">إعادة تعيين كلمة المرور</h3>
        <p class="text-center text-gray-600 mb-6">أدخل بريدك الإلكتروني وسنرسل لك رابطاً لإعادة تعيين كلمة مرورك.</p>
		<form id="forgot-password-form">
            <div class="mb-4">
                <label for="reset-email" class="block text-gray-700 font-semibold mb-2 text-right">البريد الإلكتروني</label>
                <input type="email" id="reset-email" class="input" required>
            </div>
            <div class="flex justify-center gap-4 mt-6">
                <button type="submit" class="btn btn-primary w-1/2">إرسال الرابط</button>
                <button type="button" id="forgot-password-cancel-btn" class="btn bg-gray-200 hover:bg-gray-300 w-1/2">إلغاء</button>
            </div>
        </form>
	</div>
    <!-- Customer Profile Modal Removed -->
	
    <script type="module">
        // --- Firebase SDKs (Modern Modular Version) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, 
            signOut, 
            createUserWithEmailAndPassword,
            sendPasswordResetEmail
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            addDoc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            getDoc, 
            getDocs, 
            query, 
            where, 
            orderBy, 
            limit,
            runTransaction,
            writeBatch,
            serverTimestamp,
            increment
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Settings ---
        const firebaseConfig = {
			apiKey: "AIzaSyCTqQyFH8EOslPZiyPm89cM9CMrY2G88WA",
			authDomain: "aslantech.firebaseapp.com",
			projectId: "aslantech",
			storageBucket: "aslantech.appspot.com",
			messagingSenderId: "305255252292",
			appId: "1:305255252292:web:4107992083514d8eef5711"
        };
        
        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        // A secondary app instance for creating users without signing out the admin
        const secondaryApp = initializeApp(firebaseConfig, "secondary");
        const secondaryAuth = getAuth(secondaryApp);

        // --- Global Variables ---
        let appSettings = { currency: 'د.أ', initialFund: 0, companyName: 'شركتك', companyAddress: '', companyPhone: '', loyaltyPointsRate: 0 };
        let itemToEdit = null;
        let performanceChart = null;
        let salesDistributionChart = null;
        let monthlySalesChart = null;
        let currentInvoiceId = null;
        let currentUser = {
            auth: null,
            role: 'visitor' // Default role
        };
        let supplierIdToNameMap = new Map();
        let supplierNumericIdToNameMap = new Map();
        let productsCache = [];
        
        // --- User Feedback Functions ---
        const showMessage = (message) => {
            document.getElementById('alert-message').textContent = message;
            document.getElementById('custom-alert').classList.remove('hidden');
            document.getElementById('custom-overlay').classList.remove('hidden');
        };

        function showConfirm(message, onConfirm) {
            const confirmModal = document.getElementById('custom-confirm');
            const overlay = document.getElementById('custom-overlay');
            document.getElementById('confirm-message').textContent = message;
            confirmModal.classList.remove('hidden');
            overlay.classList.remove('hidden');
            const okBtn = document.getElementById('confirm-ok-btn');
            const cancelBtn = document.getElementById('confirm-cancel-btn');
            const confirmHandler = () => { onConfirm(); closeHandler(); };
            const closeHandler = () => {
                confirmModal.classList.add('hidden');
                overlay.classList.add('hidden');
                okBtn.removeEventListener('click', confirmHandler);
                cancelBtn.removeEventListener('click', closeHandler);
            };
            okBtn.addEventListener('click', confirmHandler, { once: true });
            cancelBtn.addEventListener('click', closeHandler, { once: true });
        }
        
        // --- Utility Functions ---
        function getLocalDate() {
            const date = new Date();
            const offset = date.getTimezoneOffset();
            const localDate = new Date(date.getTime() - (offset*60*1000));
            return localDate.toISOString().split('T')[0];
        }

        function copyToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showMessage('تم نسخ ID المورد بنجاح!');
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
                showMessage('فشل النسخ.');
            }
            document.body.removeChild(textArea);
        }

        // --- NEW FUNCTION: updateAdvancedDashboardMetrics ---
        async function updateAdvancedDashboardMetrics() {
            // 1. Most Profitable Products
            const salesSnapshot = await getDocs(collection(db, 'sales'));
            const profitableProducts = {};
            salesSnapshot.docs.forEach(doc => {
                const sale = doc.data();
                const profit = (sale.price - sale.cost) * (sale.qty || 1);
                if (sale.type === 'product' && profit > 0) {
                    profitableProducts[sale.name] = (profitableProducts[sale.name] || 0) + profit;
                }
            });
            const topProducts = Object.entries(profitableProducts)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 5);

            const profitableProductsDiv = document.getElementById('most-profitable-products');
            if (topProducts.length > 0) {
                profitableProductsDiv.innerHTML = topProducts.map(([name, profit]) => `
                    <div class="flex justify-between items-center text-sm py-1 border-b border-gray-200 dark:border-gray-700">
                        <span>${name}</span>
                        <span class="font-bold text-green-600 dark:text-green-400">${profit.toFixed(2)} ${appSettings.currency}</span>
                    </div>
                `).join('');
            } else {
                profitableProductsDiv.innerHTML = `<p class="text-sm text-gray-500">لا توجد بيانات كافية.</p>`;
            }

            // 2. Monthly Sales Chart
            const sixMonthsAgo = new Date();
            sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
            const monthlySales = {};
            const salesForChart = salesSnapshot.docs
                .map(doc => doc.data())
                .filter(sale => new Date(sale.date) >= sixMonthsAgo);

            for(let i=5; i>=0; i--) {
                const d = new Date();
                d.setMonth(d.getMonth() - i);
                const monthKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                monthlySales[monthKey] = 0;
            }

            salesForChart.forEach(sale => {
                const monthKey = sale.date.substring(0, 7); // YYYY-MM
                if (monthlySales.hasOwnProperty(monthKey)) {
                    monthlySales[monthKey] += sale.amount;
                }
            });

            const isDarkMode = document.documentElement.classList.contains('dark-mode');
            const chartTextColor = isDarkMode ? '#f8fafc' : '#1e293b';
            const chartGridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

            if (monthlySalesChart) {
                monthlySalesChart.destroy();
            }
            monthlySalesChart = new Chart(document.getElementById('monthly-sales-chart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: Object.keys(monthlySales),
                    datasets: [{
                        label: 'إجمالي المبيعات',
                        data: Object.values(monthlySales),
                        borderColor: '#0ea5e9',
                        backgroundColor: 'rgba(14, 165, 233, 0.2)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: chartTextColor },
                            grid: { color: chartGridColor }
                        },
                        x: {
                            ticks: { color: chartTextColor },
                            grid: { color: chartGridColor }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: chartTextColor } }
                    }
                }
            });

            // 3. Other KPIs
            const customersSnapshot = await getDocs(collection(db, 'customers'));
            const totalCustomers = customersSnapshot.size;
            const averageSale = salesSnapshot.size > 0 ? (salesSnapshot.docs.reduce((sum, doc) => sum + doc.data().amount, 0) / salesSnapshot.size) : 0;

            const kpiContainer = document.getElementById('kpi-container');
            kpiContainer.innerHTML = `
                <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-slate-700 rounded-lg">
                    <span class="font-semibold">إجمالي عدد العملاء</span>
                    <span class="font-bold text-lg text-sky-600 dark:text-sky-400">${totalCustomers}</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-slate-700 rounded-lg">
                    <span class="font-semibold">متوسط قيمة الفاتورة</span>
                    <span class="font-bold text-lg text-sky-600 dark:text-sky-400">${averageSale.toFixed(2)} ${appSettings.currency}</span>
                </div>
            `;
        }
        
        // --- Firebase Core Functions ---
        async function addOrUpdateItem(collectionName, data, id = null, actionDetails = null) {
            try {
                if (id) {
                    await setDoc(doc(db, collectionName, id), data, { merge: true });
                    if(actionDetails) await logActivity(actionDetails.update, `ID: ${id}`);
                } else {
                    const docRef = await addDoc(collection(db, collectionName), data);
                    if(actionDetails) await logActivity(actionDetails.add, `ID: ${docRef.id}`);
                }
                return true;
            } catch (e) {
                console.error("Add/Update error:", e);
                showMessage(`حدث خطأ أثناء إضافة/تحديث البيانات: ${e.message}`);
                return false;
            }
        }
        
        async function deleteItem(collectionName, id, itemName = '') {
             try {
                 if (collectionName === 'sales') {
                     const saleDocRef = doc(db, 'sales', id);
                     const saleDoc = await getDoc(saleDocRef);
                     if (!saleDoc.exists()) return;
                     const saleToDelete = saleDoc.data();
                     itemName = saleToDelete.name;
                     if (saleToDelete && saleToDelete.type === 'product' && saleToDelete.productId) {
                         const productRef = doc(db, 'products', saleToDelete.productId);
                         await updateDoc(productRef, { qty: increment(saleToDelete.qty) });
                     }
                 } else if (collectionName === 'purchases') {
                     const purchaseDocRef = doc(db, 'purchases', id);
                     const purchaseDoc = await getDoc(purchaseDocRef);
                     if (!purchaseDoc.exists()) return;
                     const purchaseToDelete = purchaseDoc.data();
                     itemName = purchaseToDelete.productName;
                     if (purchaseToDelete && purchaseToDelete.type === 'product' && purchaseToDelete.productId) {
                         const productRef = doc(db, 'products', purchaseToDelete.productId);
                         await updateDoc(productRef, { qty: increment(-purchaseToDelete.qty) });
                     }
                 } else if (['products', 'customers', 'suppliers', 'expenses', 'invoices', 'users'].includes(collectionName)) {
                     const itemDoc = await getDoc(doc(db, collectionName, id));
                     if(itemDoc.exists()) {
                         itemName = itemDoc.data().name || itemDoc.data().productName || itemDoc.data().type || itemDoc.data().email || `فاتورة رقم ${itemDoc.data().invoiceNumber}`;
                     }
                 }
                 await deleteDoc(doc(db, collectionName, id));
                 await logActivity(`حذف ${collectionName}`, `"${itemName}" (ID: ${id})`);
                 return true;
             } catch (e) {
                 console.error("Delete error:", e);
                 showMessage(`حدث خطأ أثناء حذف البيانات: ${e.message}`);
                 return false;
             }
        }

        // --- Authentication ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    const userDoc = await getDoc(doc(db, 'users', user.uid));
                    if (userDoc.exists()) {
                        currentUser.role = userDoc.data().role;
                    } else {
                        console.warn(`User ${user.uid} exists in Auth but not in Firestore 'users' collection.`);
                        currentUser.role = 'visitor'; 
                    }
                    currentUser.auth = user;

                    document.getElementById('user-email').textContent = user.email;
                    document.getElementById('user-role-display').textContent = translateRole(currentUser.role);
                    
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('app-container').classList.remove('hidden');

                    await refreshAllDataOnLogin();
                    
                    applyPermissions(currentUser.role);
                } catch (error) {
                    console.error("Error during post-login data refresh:", error);
                    showMessage("حدث خطأ أثناء تحميل بيانات التطبيق. يرجى محاولة تسجيل الخروج والدخول مرة أخرى.");
                    await signOut(auth);
                }
            } else {
                currentUser = { auth: null, role: 'visitor' };
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-container').classList.add('hidden');
                document.getElementById('user-email').textContent = '';
                document.getElementById('user-role-display').textContent = '';
                clearAllTables();
            }
        });

        function translateRole(role) {
            const roles = { admin: 'مدير', user: 'مستخدم', visitor: 'زائر' };
            return roles[role] || role;
        }

        function clearAllTables() {
            const tableIds = ['products-table', 'sales-table', 'purchases-table', 'expenses-table', 'customers-table', 'suppliers-table', 'invoices-table', 'activity-log-table', 'users-table'];
            tableIds.forEach(id => {
                const table = document.getElementById(id);
                if(table) table.innerHTML = '';
            });
            if (monthlySalesChart) monthlySalesChart.destroy();
            if (performanceChart) performanceChart.destroy();
            if (salesDistributionChart) salesDistributionChart.destroy();
        }


        // --- UI and Tab Management ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabId).classList.remove('hidden');
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            
            const today = getLocalDate();
            if (tabId === 'sales') {
                document.getElementById('sales-filter-date').value = today;
                refreshSales(today);
            } else if (tabId === 'purchases') {
                document.getElementById('purchases-filter-date').value = today;
                refreshPurchases(today);
            } else if (tabId === 'expenses') {
                document.getElementById('expenses-filter-date').value = today;
                refreshExpenses(today);
            } else if (tabId === 'activity_log') {
                refreshActivityLog();
            }
        }

        function populateSelect(selectId, data, valueField, textField, displayTpl = null) {
            const select = document.getElementById(selectId);
            const currentValue = select.value;
            select.innerHTML = `<option value="">اختر</option>`;
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item[valueField];
                option.textContent = displayTpl ? displayTpl(item) : item[textField];
                select.appendChild(option);
            });
            select.value = currentValue;
        }
        
        // --- Data Refresh and Display Functions ---
        async function refreshProducts(searchTerm = '') {
            let q = query(collection(db, 'products'), orderBy('name'));
            const snapshot = await getDocs(q);
            productsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            const filteredProducts = productsCache.filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase()));

            const tableBody = document.getElementById('products-table');
            tableBody.innerHTML = '';
            let totalValue = 0, lowStockCount = 0, outOfStockCount = 0;
            filteredProducts.forEach(p => {
                totalValue += p.cost * p.qty;
                if (p.qty === 0) outOfStockCount++;
                else if (p.qty > 0 && p.qty <= 10) lowStockCount++;
                const row = tableBody.insertRow();
                let qtyClass = p.qty <= 0 ? 'bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-200 font-bold' : (p.qty <= 10 ? 'bg-yellow-100 dark:bg-yellow-900/50 text-yellow-700 dark:text-yellow-200' : '');
                row.innerHTML = `
                    <td class="no-export"><input type="checkbox" class="product-checkbox" data-id="${p.id}"></td>
                    <td class="whitespace-nowrap">${p.name}</td>
                    <td>${(p.cost || 0).toFixed(2)} ${appSettings.currency}</td>
                    <td class="${qtyClass} text-center">${p.qty}</td>
                    <td>${p.supplierName || 'غير محدد'}</td>
                    <td class="whitespace-nowrap no-export">
                        <button class="btn btn-edit text-sm edit-btn" data-id="${p.id}" data-category="product">تعديل</button>
                        <button class="btn btn-danger text-sm delete-btn" data-id="${p.id}" data-category="products">حذف</button>
                    </td>`;
            });
            document.getElementById('stats-total-products').textContent = filteredProducts.length;
            document.getElementById('stats-stock-value').textContent = `${totalValue.toFixed(2)} ${appSettings.currency}`;
            document.getElementById('stats-low-stock').textContent = lowStockCount;
            document.getElementById('stats-out-of-stock').textContent = outOfStockCount;
            toggleDeleteSelectedButton();
            await populateProductSelects(); 
            applyPermissions(currentUser.role);
        }

        async function refreshSales(date) {
            let q;
            if(date) {
                q = query(collection(db, 'sales'), where('date', '==', date), orderBy('date', 'desc'));
            } else {
                q = query(collection(db, 'sales'), orderBy('date', 'desc'));
            }
            const snapshot = await getDocs(q);
            const sales = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const tableBody = document.getElementById('sales-table');
            tableBody.innerHTML = '';
            sales.forEach(s => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td class="whitespace-nowrap">${s.date}</td>
                    <td>${s.type === 'product' ? 'منتج' : 'خدمة'}</td>
                    <td class="whitespace-nowrap">${s.name}</td>
                    <td>${s.qty || 1}</td>
                    <td class="whitespace-nowrap">${s.customerName || 'غير محدد'}</td>
                    <td>${(s.amount || 0).toFixed(2)} ${appSettings.currency}</td>
                    <td class="whitespace-nowrap no-export">
                        <button class="btn bg-green-500 text-white text-sm create-invoice-from-sale-btn" data-id="${s.id}">إنشاء فاتورة</button>
                        <button class="btn btn-edit text-sm edit-btn" data-id="${s.id}" data-category="sale">تعديل</button>
                        <button class="btn btn-danger text-sm delete-btn" data-id="${s.id}" data-category="sales">حذف</button>
                    </td>`;
            });
            applyPermissions(currentUser.role);
        }
        
        async function refreshPurchases(date) {
            let q;
            if (date) {
                q = query(collection(db, 'purchases'), where('date', '==', date), orderBy('date', 'desc'));
            } else {
                q = query(collection(db, 'purchases'), orderBy('date', 'desc'));
            }
            const snapshot = await getDocs(q);
            const purchases = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const tableBody = document.getElementById('purchases-table');
            tableBody.innerHTML = '';
            purchases.forEach(p => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td class="whitespace-nowrap">${p.date}</td>
                    <td class="whitespace-nowrap">${p.productName}</td>
                    <td>${p.qty}</td>
                    <td class="whitespace-nowrap">${p.supplierName || 'غير محدد'}</td>
                    <td>${(p.amount || 0).toFixed(2)} ${appSettings.currency}</td>
                    <td class="whitespace-nowrap no-export">
                        <button class="btn btn-edit text-sm edit-btn" data-id="${p.id}" data-category="purchase">تعديل</button>
                        <button class="btn btn-danger text-sm delete-btn" data-id="${p.id}" data-category="purchases">حذف</button>
                    </td>`;
            });
            applyPermissions(currentUser.role);
        }

        async function refreshExpenses(date) {
            let q;
            if (date) {
                q = query(collection(db, 'expenses'), where('date', '==', date), orderBy('date', 'desc'));
            } else {
                q = query(collection(db, 'expenses'), orderBy('date', 'desc'));
            }
            const snapshot = await getDocs(q);
            const expenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const tableBody = document.getElementById('expenses-table');
            tableBody.innerHTML = '';
            expenses.forEach(e => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${e.date}</td>
                    <td>${e.type}</td>
                    <td>${(e.amount || 0).toFixed(2)} ${appSettings.currency}</td>
                    <td>${e.description || ''}</td>
                    <td class="whitespace-nowrap no-export">
                        <button class="btn btn-edit text-sm edit-btn" data-id="${e.id}" data-category="expense">تعديل</button>
                        <button class="btn btn-danger text-sm delete-btn" data-id="${e.id}" data-category="expenses">حذف</button>
                    </td>`;
            });
            applyPermissions(currentUser.role);
        }

        async function refreshCustomers() {
            const q = query(collection(db, 'customers'), orderBy('name'));
            const snapshot = await getDocs(q);
            const customers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const tableBody = document.getElementById('customers-table');
            tableBody.innerHTML = '';
            customers.forEach(c => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td class="whitespace-nowrap">${c.name}</td>
                    <td>${c.phone || ''}</td>
                    <td>${c.email || ''}</td>
                    <td>${c.loyaltyPoints || 0}</td>
                    <td>${c.address || ''}</td>
                    <td class="whitespace-nowrap no-export">
                        <button class="btn btn-edit text-sm edit-btn" data-id="${c.id}" data-category="customer">تعديل</button>
                        <button class="btn btn-danger text-sm delete-btn" data-id="${c.id}" data-category="customers">حذف</button>
                    </td>`;
            });
            populateSelect('s-customer', customers, 'id', 'name');
            populateSelect('i-customer', customers, 'id', 'name');
            applyPermissions(currentUser.role);
        }

        async function refreshSuppliers() {
            const q = query(collection(db, 'suppliers'), orderBy('supplierNumericId'));
            const snapshot = await getDocs(q);
            const suppliers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            supplierIdToNameMap.clear();
            supplierNumericIdToNameMap.clear();
            suppliers.forEach(s => {
                supplierIdToNameMap.set(s.id, s.name);
                if (s.supplierNumericId) {
                    supplierNumericIdToNameMap.set(s.supplierNumericId.toString(), s.name);
                }
            });

            const tableBody = document.getElementById('suppliers-table');
            tableBody.innerHTML = '';
            suppliers.forEach(s => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td class="whitespace-nowrap">
                        <div class="flex items-center gap-2">
                            <span>${s.supplierNumericId || 'N/A'}</span>
                            <button class="copy-btn" data-id="${s.supplierNumericId || ''}"><i class="fas fa-copy"></i></button>
                        </div>
                    </td>
                    <td class="whitespace-nowrap">${s.name}</td>
                    <td>${s.phone || ''}</td>
                    <td>${s.email || ''}</td>
                    <td>${s.address || ''}</td>
                    <td class="whitespace-nowrap no-export">
                        <button class="btn btn-edit text-sm edit-btn" data-id="${s.id}" data-category="supplier">تعديل</button>
                        <button class="btn btn-danger text-sm delete-btn" data-id="${s.id}" data-category="suppliers">حذف</button>
                    </td>`;
            });
             document.querySelectorAll('.copy-btn').forEach(button => {
                 button.addEventListener('click', (e) => {
                     const id = e.currentTarget.dataset.id;
                     if(id) {
                         copyToClipboard(id);
                     }
                 });
             });
            populateSelect('p-supplier', suppliers, 'id', 'name');
            populateSelect('p-supplier-purchase', suppliers, 'id', 'name');
            applyPermissions(currentUser.role);
        }
        
        async function refreshInvoices() {
            const q = query(collection(db, 'invoices'), orderBy('invoiceNumber', 'desc'));
            const snapshot = await getDocs(q);
            const invoices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const tableBody = document.getElementById('invoices-table');
            tableBody.innerHTML = '';
            invoices.forEach(i => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${i.invoiceNumber}</td>
                    <td class="whitespace-nowrap">${i.date}</td>
                    <td class="whitespace-nowrap">${i.customerName}</td>
                    <td>${(i.totalAmount || 0).toFixed(2)} ${appSettings.currency}</td>
                    <td class="whitespace-nowrap no-export">
                        <button class="btn btn-primary text-sm view-invoice-btn" data-id="${i.id}">عرض</button>
                        <button class="btn btn-danger text-sm delete-btn" data-id="${i.id}" data-category="invoices">حذف</button>
                    </td>`;
            });
            applyPermissions(currentUser.role);
        }
        
        async function populateProductSelects() {
            const displayTpl = (p) => `${p.name} (المتاح: ${p.qty})`;
            
            document.querySelectorAll('#s-product, #p-product').forEach(select => {
                 	populateSelect(select.id, productsCache, 'id', 'name', displayTpl);
            });
            
            document.querySelectorAll('.i-product-select').forEach(select => {
                const selectedValue = select.value;
                select.innerHTML = `<option value="">اختر منتج</option>`;
                productsCache.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = p.name;
                    select.appendChild(option);
                });
                select.value = selectedValue;
            });
        }

        async function refreshAllDataOnLogin() {
            await loadSettings();
            const today = getLocalDate();
            document.getElementById('dashboard-date').value = today;
            await updateDashboard(today);
            await Promise.all([
                refreshSuppliers(), // Must run first to populate supplier maps
                refreshProducts(), 
                refreshSales(today), 
                refreshPurchases(today), 
                refreshExpenses(today), 
                refreshCustomers(), 
                refreshInvoices(), 
                refreshUsers(),
                refreshActivityLog()
            ]);
            updateAdvancedDashboardMetrics();
        }

        // --- Dashboard and Reports ---
        async function updateDashboard(date = null) {
            const targetDate = date || getLocalDate();
            
            const salesSnapshot = await getDocs(query(collection(db, 'sales'), where('date', '==', targetDate)));
            let totalSales = 0, totalCostOfGoods = 0;
            salesSnapshot.forEach(doc => {
                const sale = doc.data();
                totalSales += sale.amount;
                totalCostOfGoods += (sale.cost * (sale.qty || 1));
            });

            const purchasesSnapshot = await getDocs(query(collection(db, 'purchases'), where('date', '==', targetDate)));
            let totalPurchases = 0;
            purchasesSnapshot.forEach(doc => totalPurchases += doc.data().amount);
            
            const expensesSnapshot = await getDocs(query(collection(db, 'expenses'), where('date', '==', targetDate)));
            let totalExpenses = 0;
            expensesSnapshot.forEach(doc => totalExpenses += doc.data().amount);
            
            const netProfit = (totalSales - totalCostOfGoods) - totalExpenses;

            // FIX: Change remaining fund to be daily net cash flow instead of lifetime total
            const dailyNetFlow = totalSales - totalPurchases - totalExpenses;

            document.getElementById('total-sales').textContent = `${totalSales.toFixed(2)} ${appSettings.currency}`;
            document.getElementById('total-purchases').textContent = `${totalPurchases.toFixed(2)} ${appSettings.currency}`;
            document.getElementById('total-expenses').textContent = `${totalExpenses.toFixed(2)} ${appSettings.currency}`;
            document.getElementById('net-profit').textContent = `${netProfit.toFixed(2)} ${appSettings.currency}`;
            document.getElementById('remaining-fund').textContent = `${dailyNetFlow.toFixed(2)} ${appSettings.currency}`;
        }
        
        async function generateReport() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            if (!startDate || !endDate) {
                showMessage("الرجاء تحديد تاريخي البدء والانتهاء.");
                return;
            }
            
            document.getElementById('report-title').textContent = `تقرير الأداء`;
            document.getElementById('report-date-range').textContent = `للفترة من ${startDate} إلى ${endDate}`;
            document.getElementById('report-company-name').textContent = appSettings.companyName;
            document.getElementById('report-company-address').textContent = appSettings.companyAddress;

            const salesQuery = query(collection(db, 'sales'), where('date', '>=', startDate), where('date', '<=', endDate));
            const purchasesQuery = query(collection(db, 'purchases'), where('date', '>=', startDate), where('date', '<=', endDate));
            const expensesQuery = query(collection(db, 'expenses'), where('date', '>=', startDate), where('date', '<=', endDate));

            const [salesSnapshot, purchasesSnapshot, expensesSnapshot] = await Promise.all([
                getDocs(salesQuery),
                getDocs(purchasesQuery),
                getDocs(expensesQuery)
            ]);

            const salesData = salesSnapshot.docs.map(d => d.data());
            const purchasesData = purchasesSnapshot.docs.map(d => d.data());
            const expensesData = expensesSnapshot.docs.map(d => d.data());

            const reportSales = salesData.reduce((sum, s) => sum + s.amount, 0);
            const reportCOGS = salesData.reduce((sum, s) => sum + (s.cost * (s.qty || 1)), 0);
            const reportPurchases = purchasesData.reduce((sum, p) => sum + p.amount, 0);
            const reportExpenses = expensesData.reduce((sum, e) => sum + e.amount, 0);
            const reportProfit = (reportSales - reportCOGS) - reportExpenses;

            document.getElementById('report-sales').textContent = `${reportSales.toFixed(2)} ${appSettings.currency}`;
            document.getElementById('report-purchases').textContent = `${reportPurchases.toFixed(2)} ${appSettings.currency}`;
            document.getElementById('report-expenses').textContent = `${reportExpenses.toFixed(2)} ${appSettings.currency}`;
            document.getElementById('report-profit').textContent = `${reportProfit.toFixed(2)} ${appSettings.currency}`;
            
            // Top Products Table
            const productSales = {};
            salesData.filter(s => s.type === 'product').forEach(s => {
                if (!productSales[s.name]) productSales[s.name] = { totalQty: 0, totalRevenue: 0 };
                productSales[s.name].totalQty += s.qty;
                productSales[s.name].totalRevenue += s.amount;
            });
            const topProducts = Object.entries(productSales).sort((a, b) => b[1].totalRevenue - a[1].totalRevenue).slice(0, 10);
            document.getElementById('top-products-table').innerHTML = topProducts.length > 0 ? topProducts.map(([name, data]) => `<tr><td>${name}</td><td>${data.totalQty}</td><td>${data.totalRevenue.toFixed(2)} ${appSettings.currency}</td></tr>`).join('') : `<tr><td colspan="3" class="text-center">لا توجد بيانات</td></tr>`;
            
            // Top Customers Table
            const customerSales = {};
            salesData.forEach(s => {
                const customer = s.customerName || 'غير محدد';
                customerSales[customer] = (customerSales[customer] || 0) + s.amount;
            });
            const topCustomers = Object.entries(customerSales).sort((a, b) => b[1] - a[1]).slice(0, 10);
             document.getElementById('top-customers-table').innerHTML = topCustomers.length > 0 ? topCustomers.map(([name, total]) => `<tr><td>${name}</td><td>${total.toFixed(2)} ${appSettings.currency}</td></tr>`).join('') : `<tr><td colspan="2" class="text-center">لا توجد بيانات</td></tr>`;

            // Out of Stock Table
            const outOfStockProducts = productsCache.filter(p => p.qty === 0);
            document.getElementById('low-stock-table').innerHTML = outOfStockProducts.length > 0 ? outOfStockProducts.map(p => `<tr><td>${p.name}</td><td>${p.qty}</td></tr>`).join('') : `<tr><td colspan="2" class="text-center">لا توجد منتجات نافدة</td></tr>`;

            // Expenses report
            const expenseTypes = expensesData.reduce((acc, e) => {
                acc[e.type] = (acc[e.type] || 0) + e.amount;
                return acc;
            }, {});
             document.getElementById('salaries-report-table').innerHTML = Object.keys(expenseTypes).length > 0 ? Object.entries(expenseTypes).map(([type, total]) => `<tr><td>${type}</td><td>${total.toFixed(2)} ${appSettings.currency}</td></tr>`).join('') : `<tr><td colspan="2" class="text-center">لا توجد مصاريف</td></tr>`;

            // Performance Chart (Bar)
            if (performanceChart) performanceChart.destroy();
            performanceChart = new Chart(document.getElementById('performanceChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['إجمالي المبيعات', 'إجمالي المشتريات', 'إجمالي المصاريف', 'الربح الصافي'],
                    datasets: [{
                        label: `الأداء المالي بـ(${appSettings.currency})`,
                        data: [reportSales, reportPurchases, reportExpenses, reportProfit],
                        backgroundColor: ['#0ea5e9', '#f59e0b', '#ef4444', '#10b981'],
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // Sales Distribution Chart (Pie)
            const salesDistribution = salesData.reduce((acc, sale) => {
                acc[sale.name] = (acc[sale.name] || 0) + sale.amount;
                return acc;
            }, {});
            const sortedSales = Object.entries(salesDistribution).sort((a, b) => b[1] - a[1]).slice(0, 7);
            
            if (salesDistributionChart) salesDistributionChart.destroy();
            if (sortedSales.length > 0) {
                 salesDistributionChart = new Chart(document.getElementById('salesDistributionChart').getContext('2d'), {
                    type: 'pie',
                    data: {
                        labels: sortedSales.map(item => item[0]),
                        datasets: [{
                            label: 'إجمالي المبيعات',
                            data: sortedSales.map(item => item[1]),
                            backgroundColor: [
                                 '#0ea5e9', '#10b981', '#f59e0b', '#8b5cf6',
                                 '#ef4444', '#64748b', '#06b6d4'
                             ],
                             hoverOffset: 4
                        }]
                    },
                    options: { 
                         responsive: true, 
                         maintainAspectRatio: false
                     }
                });
            } else {
                 document.getElementById('salesDistributionChart').getContext('2d').clearRect(0,0,300,300);
            }
            
            document.getElementById('report-results').classList.remove('hidden');
        }

        // --- Event Listeners and Form Handlers ---
        function setupEventListeners() {
            document.getElementById('nav-tabs').addEventListener('click', (e) => e.target.tagName === 'BUTTON' && switchTab(e.target.dataset.tab));
            document.getElementById('dashboard-date-form').addEventListener('submit', (e) => { e.preventDefault(); updateDashboard(document.getElementById('dashboard-date').value); });
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('add-product-form').addEventListener('submit', handleProductFormSubmit);
            document.getElementById('product-form-cancel-btn').addEventListener('click', () => resetForm('add-product-form'));
            document.getElementById('add-sale-form').addEventListener('submit', handleSaleFormSubmit);
            document.getElementById('sale-form-cancel-btn').addEventListener('click', () => resetForm('add-sale-form'));
            document.getElementById('add-purchase-form').addEventListener('submit', handlePurchaseFormSubmit);
            document.getElementById('purchase-form-cancel-btn').addEventListener('click', () => resetForm('add-purchase-form'));
            document.getElementById('add-expense-form').addEventListener('submit', handleExpenseFormSubmit);
            document.getElementById('expense-form-cancel-btn').addEventListener('click', () => resetForm('add-expense-form'));
            document.getElementById('add-customer-form').addEventListener('submit', handleCustomerFormSubmit);
            document.getElementById('customer-form-cancel-btn').addEventListener('click', () => resetForm('add-customer-form'));
            document.getElementById('add-supplier-form').addEventListener('submit', handleSupplierFormSubmit);
            document.getElementById('supplier-form-cancel-btn').addEventListener('click', () => resetForm('add-supplier-form'));
            document.getElementById('add-invoice-form').addEventListener('submit', handleInvoiceFormSubmit);
            document.getElementById('reports-form').addEventListener('submit', (e) => { e.preventDefault(); generateReport(); });
            document.getElementById('settings-form').addEventListener('submit', handleSettingsSave);
            document.getElementById('add-user-form').addEventListener('submit', handleUserFormSubmit);
            document.getElementById('delete-selected-products-btn').addEventListener('click', handleDeleteSelectedProducts);
            document.getElementById('import-products-excel').addEventListener('change', importFromExcel);
            document.getElementById('product-search-input').addEventListener('input', (e) => refreshProducts(e.target.value));
            document.getElementById('select-all-products').addEventListener('change', (e) => {
                document.querySelectorAll('.product-checkbox').forEach(checkbox => checkbox.checked = e.target.checked);
                toggleDeleteSelectedButton();
            });
            document.getElementById('products-table').addEventListener('change', (e) => {
                if (e.target.classList.contains('product-checkbox')) toggleDeleteSelectedButton();
            });
             document.getElementById('alert-ok-btn').addEventListener('click', () => {
                document.getElementById('custom-alert').classList.add('hidden');
                document.getElementById('custom-overlay').classList.add('hidden');
            });
            document.getElementById('tab-content').addEventListener('click', handleTableActions);
            document.getElementById('s-type').addEventListener('change', handleSaleTypeChange);
            document.getElementById('s-product').addEventListener('change', handleProductSelectionForSale);
            document.getElementById('p-type').addEventListener('change', togglePurchaseFields);
            document.getElementById('add-invoice-item-btn').addEventListener('click', () => addInvoiceItemRow(false));
            document.getElementById('add-manual-invoice-item-btn').addEventListener('click', () => addInvoiceItemRow(true));
            document.getElementById('invoice-items-container').addEventListener('change', updateInvoiceTotal);
            document.getElementById('invoice-close-btn').addEventListener('click', () => {
                document.getElementById('invoice-view-modal').classList.add('hidden');
                document.getElementById('custom-overlay').classList.add('hidden');
            });
            document.getElementById('invoice-print-btn').addEventListener('click', ()=>exportToPdfWithArabic('printable-invoice', 'فاتورة', `invoice-${currentInvoiceId}.pdf`));

            document.getElementById('print-report-btn').addEventListener('click', () => window.print());
            document.getElementById('export-report-pdf-btn').addEventListener('click', () => exportToPdfWithArabic('printable-content', 'تقرير الأداء', 'PerformanceReport.pdf'));
            
            // New Listeners
            document.getElementById('export-advanced-report-excel-btn').addEventListener('click', exportAdvancedReportToExcel);
            document.getElementById('user-role-select').addEventListener('change', displayRolePermissions);
            
            // Daily filter listeners
            document.getElementById('sales-filter-form').addEventListener('submit', (e) => { e.preventDefault(); refreshSales(document.getElementById('sales-filter-date').value); });
            document.getElementById('sales-clear-filter').addEventListener('click', () => { document.getElementById('sales-filter-date').value = ''; refreshSales(); });
            document.getElementById('purchases-filter-form').addEventListener('submit', (e) => { e.preventDefault(); refreshPurchases(document.getElementById('purchases-filter-date').value); });
            document.getElementById('purchases-clear-filter').addEventListener('click', () => { document.getElementById('purchases-filter-date').value = ''; refreshPurchases(); });
            document.getElementById('expenses-filter-form').addEventListener('submit', (e) => { e.preventDefault(); refreshExpenses(document.getElementById('expenses-filter-date').value); });
            document.getElementById('expenses-clear-filter').addEventListener('click', () => { document.getElementById('expenses-filter-date').value = ''; refreshExpenses(); });

            // Invoices export listeners
            document.getElementById('export-invoices-excel-btn').addEventListener('click', exportInvoicesToExcel);
            document.getElementById('export-invoices-pdf-btn').addEventListener('click', exportInvoicesToPdf);

            // Export buttons that were using onclick
            document.getElementById('export-products-btn').addEventListener('click', () => exportToExcel('products-table-export', 'المنتجات', 'Products.xlsx'));
            document.getElementById('export-sales-btn').addEventListener('click', () => exportToExcel('sales-table-export', 'المبيعات', 'Sales.xlsx'));
            document.getElementById('export-purchases-btn').addEventListener('click', () => exportToExcel('purchases-table-export', 'المشتريات', 'Purchases.xlsx'));
            document.getElementById('export-expenses-btn').addEventListener('click', () => exportToExcel('expenses-table-export', 'المصاريف', 'Expenses.xlsx'));
            document.getElementById('export-customers-btn').addEventListener('click', () => exportToExcel('customers-table-export', 'العملاء', 'Customers.xlsx'));
            document.getElementById('export-suppliers-btn').addEventListener('click', () => exportToExcel('suppliers-table-export', 'الموردين', 'Suppliers.xlsx'));
            
            // Forgot Password Listener
            document.getElementById('forgot-password-link').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('forgot-password-modal').classList.remove('hidden');
                document.getElementById('custom-overlay').classList.remove('hidden');
            });
            document.getElementById('forgot-password-form').addEventListener('submit', handlePasswordReset);
            document.getElementById('forgot-password-cancel-btn').addEventListener('click', () => {
                document.getElementById('forgot-password-modal').classList.add('hidden');
                document.getElementById('custom-overlay').classList.add('hidden');
            });

            // Backup & Restore Listeners
            document.getElementById('export-backup-btn').addEventListener('click', exportBackup);
            document.getElementById('import-backup-input').addEventListener('change', handleImportBackup);

            // Dark Mode Toggle
            const toggle = document.getElementById('dark-mode-toggle');
            toggle.addEventListener('click', () => {
                const isDarkMode = document.documentElement.classList.toggle('dark-mode');
                localStorage.setItem('darkMode', isDarkMode);
                toggle.innerHTML = isDarkMode ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
                updateAdvancedDashboardMetrics();
            });
        }
        
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorP = document.getElementById('login-error');
            errorP.classList.add('hidden');
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login failed:", error);
                errorP.textContent = "البريد الإلكتروني أو كلمة المرور غير صحيحة.";
                errorP.classList.remove('hidden');
            }
        }

        function handleLogout() { signOut(auth); }

        async function handlePasswordReset(e) {
            e.preventDefault();
            const email = document.getElementById('reset-email').value;
            if (!email) {
                showMessage('الرجاء إدخال البريد الإلكتروني.');
                return;
            }
            try {
                await sendPasswordResetEmail(auth, email);
                showMessage('تم إرسال رابط إعادة تعيين كلمة المرور إلى بريدك الإلكتروني.');
                document.getElementById('forgot-password-modal').classList.add('hidden');
                document.getElementById('custom-overlay').classList.add('hidden');
            } catch (error) {
                console.error("Password reset error:", error);
                if (error.code === 'auth/user-not-found') {
                    showMessage('هذا البريد الإلكتروني غير مسجل.');
                } else {
                    showMessage('حدث خطأ أثناء إرسال البريد الإلكتروني.');
                }
            }
        }

        async function handleTableActions(e) {
            const target = e.target.closest('button, td'); if (!target) return;
            const id = target.dataset.id;
            
            if(target.tagName !== 'BUTTON') return;

            const category = target.dataset.category; // e.g., "product", "sales", "users"
            if (target.classList.contains('view-invoice-btn')) { if (id) await viewInvoice(id); return; }
            if (target.classList.contains('create-invoice-from-sale-btn')) { if (id) await createInvoiceFromSale(id); return; }
            if (!category) return;

            let collectionName = category.endsWith('s') ? category : category + 's';
            if (category === 'user') collectionName = 'users';


            if (target.classList.contains('edit-btn')) {
                const itemDoc = await getDoc(doc(db, collectionName, id));
                if (itemDoc.exists()) {
                    const item = { id: itemDoc.id, ...itemDoc.data()};
                    itemToEdit = { ...item, category };
                    const editFunctions = { product: prepareProductEdit, sale: prepareSaleEdit, purchase: preparePurchaseEdit, expense: prepareExpenseEdit, customer: prepareCustomerEdit, supplier: prepareSupplierEdit };
                    if (editFunctions[category]) {
                        editFunctions[category](item);
                        switchTab(collectionName);
                    }
                }
            } else if (target.classList.contains('delete-btn')) {
                showConfirm('هل أنت متأكد من الحذف؟', async () => {
                    if (await deleteItem(collectionName, id)) {
                         const refreshMap = {
                            products: [refreshProducts], sales: [refreshSales, refreshProducts, updateDashboard], purchases: [refreshPurchases, refreshProducts, updateDashboard],
                            expenses: [refreshExpenses, updateDashboard], customers: [refreshCustomers, refreshSales, refreshInvoices], 
                            suppliers: [refreshSuppliers, refreshProducts, refreshPurchases], invoices: [refreshInvoices],
                            users: [refreshUsers]
                        };
                         if (refreshMap[collectionName]) {
                            for(const func of refreshMap[collectionName]) await func();
                         }
                        showMessage("تم الحذف بنجاح.");
                    }
                });
            }
        }

        async function createInvoiceFromSale(saleId) {
            const saleDoc = await getDoc(doc(db, 'sales', saleId));
            if(!saleDoc.exists()) return showMessage('لم يتم العثور على عملية البيع');
            const sale = saleDoc.data();
            
            const customerDoc = await getDoc(doc(db, 'customers', sale.customerId));
            if (!customerDoc.exists) return showMessage('العميل المرتبط بعملية البيع هذه غير موجود');
            
            const settingsDocRef = doc(db, 'settings', 'appConfig');
            
            try {
                let newInvoiceNumber;
                await runTransaction(db, async (transaction) => {
                    const settingsDoc = await transaction.get(settingsDocRef);
                    newInvoiceNumber = (settingsDoc.data()?.lastInvoiceNumber || 0) + 1;
                    
                    const invoiceItems = [];
                    if (sale.type === 'product') {
                         invoiceItems.push({ 
                            type: 'product',
                            productId: sale.productId,
                            productName: sale.name,
                            qty: sale.qty,
                            price: sale.price,
                            total: sale.amount
                        });
                    } else { // service
                        invoiceItems.push({ 
                            type: 'manual',
                            productName: sale.name,
                            qty: 1,
                            price: sale.price,
                            total: sale.amount
                        });
                    }

                    const invoiceData = {
                        invoiceNumber: newInvoiceNumber,
                        date: sale.date,
                        customerId: sale.customerId,
                        customerName: sale.customerName,
                        customerDetails: customerDoc.data(),
                        items: invoiceItems,
                        totalAmount: sale.amount
                    };
                    
                    const newInvoiceRef = doc(collection(db, 'invoices'));
                    transaction.set(newInvoiceRef, invoiceData);
                    transaction.update(settingsDocRef, { lastInvoiceNumber: newInvoiceNumber });
                });

                await refreshInvoices();
                await logActivity('إنشاء فاتورة', `من عملية بيع للعميل: ${sale.customerName}, فاتورة رقم ${newInvoiceNumber}`);
                showMessage(`تم إنشاء الفاتورة رقم ${newInvoiceNumber} بنجاح.`);

            } catch (error) {
                console.error("Invoice creation failed: ", error);
                showMessage("فشل إنشاء الفاتورة. الرجاء المحاولة مرة أخرى.");
            }
        }

        async function handleProductFormSubmit(e) {
            e.preventDefault();
            const supplierDocId = document.getElementById('p-supplier').value;
            let supplierName = supplierIdToNameMap.get(supplierDocId) || 'غير محدد';
            let supplierNumericId = null;

            if(supplierDocId) {
                const supDoc = await getDoc(doc(db, 'suppliers', supplierDocId));
                if(supDoc.exists()) {
                    supplierNumericId = supDoc.data().supplierNumericId || null;
                }
            }

            const data = { 
                name: document.getElementById('p-name').value, 
                cost: Math.abs(parseFloat(document.getElementById('p-cost').value)), 
                qty: Math.abs(parseInt(document.getElementById('p-qty').value)), 
                supplierId: supplierDocId || null,
                supplierNumericId: supplierNumericId,
                supplierName: supplierName
            };
            const id = document.getElementById('product-id').value;
            if (await addOrUpdateItem('products', data, id || null, { add: `إضافة منتج: ${data.name}`, update: `تعديل منتج: ${data.name}` })) {
                resetForm('add-product-form');
                await refreshProducts(); 
                showMessage('تم حفظ المنتج بنجاح!');
            }
        }

        async function handleSaleFormSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('sale-id').value;
            const type = document.getElementById('s-type').value;

            // Revert original stock if editing
            if (id && itemToEdit?.category === 'sale' && itemToEdit.type === 'product' && itemToEdit.productId) {
                 await updateDoc(doc(db, 'products', itemToEdit.productId), { qty: increment(itemToEdit.qty) });
            }
            
            const customerId = document.getElementById('s-customer').value;
            let customerName = 'غير محدد';
            if(customerId) {
                const customerDoc = await getDoc(doc(db, 'customers', customerId));
                if(customerDoc.exists()) customerName = customerDoc.data().name;
            }

            const salePrice = Math.abs(parseFloat(document.getElementById('s-price').value));
            const saleCost = Math.abs(parseFloat(document.getElementById('s-cost').value)) || 0;
            let saleName, saleQty, amount, productId = null;

            if (type === 'product') {
                productId = document.getElementById('s-product').value;
                saleQty = Math.abs(parseInt(document.getElementById('s-qty').value));
                const productRef = doc(db, 'products', productId);
                const productDoc = await getDoc(productRef);

                if (!productDoc.exists() || productDoc.data().qty < saleQty) {
                    showMessage(!productDoc.exists() ? 'المنتج المحدد غير موجود.' : `الكمية المتوفرة غير كافية. متاح: ${productDoc.data().qty}`);
                    // Re-apply original deduction if edit fails
                    if (id && itemToEdit?.category === 'sale' && itemToEdit.type === 'product' && itemToEdit.productId) {
                          await updateDoc(doc(db, 'products', itemToEdit.productId), { qty: increment(-itemToEdit.qty) });
                    }
                    return; 
                }
                saleName = productDoc.data().name; amount = salePrice * saleQty;
                await updateDoc(productRef, { qty: increment(-saleQty) });

            } else { 
                saleName = document.getElementById('s-service-name').value; saleQty = 1; amount = salePrice;
            }

            const data = { date: document.getElementById('s-date').value, type, name: saleName, qty: saleQty, price: salePrice, cost: saleCost, customerId: customerId || null, customerName, amount, productId };
            if (await addOrUpdateItem('sales', data, id || null, { add: `إضافة مبيعات: ${data.name}`, update: `تعديل مبيعات: ${data.name}` })) {
                
                // Award loyalty points
                if (customerId && appSettings.loyaltyPointsRate > 0) {
                    const pointsToAdd = Math.floor(amount / appSettings.loyaltyPointsRate);
                    if(pointsToAdd > 0) {
                        await updateDoc(doc(db, 'customers', customerId), {
                            loyaltyPoints: increment(pointsToAdd)
                        });
                    }
                }

                resetForm('add-sale-form');
                await refreshSales(getLocalDate()); 
                await refreshProducts();
                await updateDashboard();
                await refreshCustomers();
                showMessage('تم تسجيل عملية البيع بنجاح!');
            }
        }
        
        async function handlePurchaseFormSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('purchase-id').value;
            const type = document.getElementById('p-type').value;

            // Revert stock change if editing an existing inventory-linked purchase
            if (id && itemToEdit?.category === 'purchase' && itemToEdit.type === 'product' && itemToEdit.productId) {
                await updateDoc(doc(db, 'products', itemToEdit.productId), { qty: increment(-itemToEdit.qty) });
            }

            const supplierDocId = document.getElementById('p-supplier-purchase').value;
            let supplierName = supplierIdToNameMap.get(supplierDocId) || 'غير محدد';
            let supplierNumericId = null;
             if(supplierDocId) {
                const supDoc = await getDoc(doc(db, 'suppliers', supplierDocId));
                if(supDoc.exists()) {
                    supplierNumericId = supDoc.data().supplierNumericId || null;
                }
            }


            const purchaseCost = Math.abs(parseFloat(document.getElementById('p-cost-input').value));
            const purchaseQty = Math.abs(parseInt(document.getElementById('p-qty-input').value));
            let productName, productId = null;
            
            if (type === 'product') {
                productId = document.getElementById('p-product').value;
                if (!productId) {
                    showMessage('الرجاء اختيار منتج.');
                    return;
                }
                const productRef = doc(db, 'products', productId);
                const productDoc = await getDoc(productRef);
                if (!productDoc.exists()) {
                    showMessage('المنتج المحدد غير موجود.');
                    // Re-apply original increment if edit fails due to deleted product
                    if (id && itemToEdit?.category === 'purchase' && itemToEdit.type === 'product' && itemToEdit.productId) {
                         await updateDoc(doc(db, 'products', itemToEdit.productId), { qty: increment(itemToEdit.qty) });
                    }
                    return;
                }
                productName = productDoc.data().name;
                await updateDoc(productRef, { qty: increment(purchaseQty) });

            } else { // type === 'other'
                productName = document.getElementById('p-other-product-name').value.trim();
                if (!productName) {
                    showMessage('الرجاء إدخال اسم المنتج.');
                    return;
                }

                // Create the new product in the inventory
                const newProductData = {
                    name: productName,
                    cost: purchaseCost,
                    qty: purchaseQty,
                    supplierId: supplierDocId || null,
                    supplierNumericId: supplierNumericId,
                    supplierName: supplierName
                };
                const newProductRef = await addDoc(collection(db, 'products'), newProductData);
                await logActivity('إضافة منتج عبر المشتريات', `الاسم: ${newProductData.name}`);
                
                // Use the new product's ID for the purchase record
                productId = newProductRef.id;
            }

            const data = { 
                date: document.getElementById('p-date').value, 
                type, 
                productName, 
                qty: purchaseQty, 
                cost: purchaseCost, 
                supplierId: supplierDocId || null, 
                supplierName, 
                amount: purchaseCost * purchaseQty, 
                productId: productId // Ensure this is saved
            };

            if (await addOrUpdateItem('purchases', data, id || null, { add: `إضافة مشتريات: ${data.productName}`, update: `تعديل مشتريات: ${data.productName}` })) {
                resetForm('add-purchase-form');
                await refreshPurchases(getLocalDate());
                await refreshProducts(); // Crucial to show the new product
                await updateDashboard();
                showMessage('تم تسجيل عملية الشراء وإضافة المنتج للمستودع بنجاح!');
            }
        }

        async function handleExpenseFormSubmit(e) {
            e.preventDefault();
            const data = {
                date: document.getElementById('e-date').value,
                type: document.getElementById('e-type').value,
                amount: Math.abs(parseFloat(document.getElementById('e-amount').value)),
                description: document.getElementById('e-desc').value
            };
            const id = document.getElementById('expense-id').value;
            if (await addOrUpdateItem('expenses', data, id || null, { add: `إضافة مصروف: ${data.type}`, update: `تعديل مصروف: ${data.type}` })) {
                resetForm('add-expense-form');
                await refreshExpenses(getLocalDate());
                await updateDashboard();
                showMessage('تم تسجيل المصروف بنجاح!');
            }
        }

        async function handleCustomerFormSubmit(e) {
            e.preventDefault();
            const data = {
                name: document.getElementById('c-name').value,
                phone: document.getElementById('c-phone').value,
                email: document.getElementById('c-email').value,
                address: document.getElementById('c-address').value
            };
            const id = document.getElementById('customer-id').value;
            if(!id) {
                data.loyaltyPoints = 0;
            } else {
                delete data.loyaltyPoints;
            }

            if (await addOrUpdateItem('customers', data, id || null, { add: `إضافة عميل: ${data.name}`, update: `تعديل عميل: ${data.name}` })) {
                resetForm('add-customer-form');
                await refreshCustomers();
                showMessage('تم حفظ العميل بنجاح!');
            }
        }
        
        async function handleSupplierFormSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('supplier-id').value;
            
            const data = {
                name: document.getElementById('sup-name').value,
                phone: document.getElementById('sup-phone').value,
                email: document.getElementById('sup-email').value,
                address: document.getElementById('sup-address').value
            };

            if (id) {
                if (await addOrUpdateItem('suppliers', data, id, { update: `تعديل مورد: ${data.name}` })) {
                    resetForm('add-supplier-form');
                    await refreshSuppliers();
                    showMessage('تم تحديث المورد بنجاح!');
                }
            } else {
                 const settingsRef = doc(db, 'settings', 'appConfig');
                 try {
                     await runTransaction(db, async (transaction) => {
                         const settingsDoc = await transaction.get(settingsRef);
                         const newNumericId = (settingsDoc.data()?.supplierCounter || 0) + 1;
                         transaction.update(settingsRef, { supplierCounter: newNumericId });
                         data.supplierNumericId = newNumericId;
                         const newSupplierRef = doc(collection(db, 'suppliers'));
                         transaction.set(newSupplierRef, data);
                     });
                     await logActivity('إضافة مورد', `الاسم: ${data.name}`);
                    resetForm('add-supplier-form');
                    await refreshSuppliers();
                    showMessage('تم إضافة المورد بنجاح!');
                 } catch (error) {
                    console.error("Failed to add supplier with transaction: ", error);
                    showMessage("فشل إضافة المورد، يرجى المحاولة مرة أخرى.");
                 }
            }
        }
        
        async function handleInvoiceFormSubmit(e) {
            e.preventDefault();
            const customerId = document.getElementById('i-customer').value;
            const customerDoc = await getDoc(doc(db, 'customers', customerId));
            if (!customerDoc.exists()) return showMessage('العميل المحدد غير موجود');

            const invoiceItems = [];
            document.querySelectorAll('.invoice-item-row').forEach(row => {
                const type = row.dataset.type;
                let item = { type };
                if (type === 'product') {
                    item.productId = row.querySelector('.i-product-select').value;
                    item.productName = row.querySelector('.i-product-select').options[row.querySelector('.i-product-select').selectedIndex].text;
                    item.qty = Math.abs(parseInt(row.querySelector('.i-qty').value));
                    item.price = Math.abs(parseFloat(row.querySelector('.i-price').value));
                } else {
                    item.productName = row.querySelector('.i-manual-name').value;
                    item.qty = 1;
                    item.price = Math.abs(parseFloat(row.querySelector('.i-manual-price').value));
                }
                item.total = item.qty * item.price;
                invoiceItems.push(item);
            });

            if (invoiceItems.some(item => !item.productName || !item.price || (item.type === 'product' && !item.qty) )) {
                 return showMessage('الرجاء تعبئة جميع الحقول في بنود الفاتورة.');
            }

            // --- NEW: Stock validation ---
            for (const item of invoiceItems) {
                if (item.type === 'product') {
                    const product = productsCache.find(p => p.id === item.productId);
                    if (!product || product.qty < item.qty) {
                        return showMessage(`الكمية غير كافية للمنتج: ${item.productName}. المتاح: ${product?.qty || 0}`);
                    }
                }
            }

            const totalAmount = invoiceItems.reduce((sum, item) => sum + item.total, 0);
            
            try {
                let newInvoiceNumber;
                await runTransaction(db, async (transaction) => {
                    const settingsDocRef = doc(db, 'settings', 'appConfig');
                    const settingsDoc = await transaction.get(settingsDocRef);
                    newInvoiceNumber = (settingsDoc.data()?.lastInvoiceNumber || 0) + 1;

                    const invoiceData = {
                        invoiceNumber: newInvoiceNumber,
                        date: document.getElementById('i-date').value,
                        customerId,
                        customerName: customerDoc.data().name,
                        customerDetails: customerDoc.data(),
                        items: invoiceItems,
                        totalAmount
                    };

                    // 1. Create the invoice
                    const newInvoiceRef = doc(collection(db, 'invoices'));
                    transaction.set(newInvoiceRef, invoiceData);

                    // 2. Update invoice counter
                    transaction.update(settingsDocRef, { lastInvoiceNumber: newInvoiceNumber });

                    // 3. Update stock and create corresponding sale records for each item
                    for (const item of invoiceItems) {
                        const saleData = {
                            date: invoiceData.date,
                            customerId: customerId,
                            customerName: invoiceData.customerName,
                            name: item.productName,
                            price: item.price,
                        };

                        if (item.type === 'product') {
                            const productRef = doc(db, 'products', item.productId);
                            const product = productsCache.find(p => p.id === item.productId);
                            transaction.update(productRef, { qty: increment(-item.qty) });
                            
                            Object.assign(saleData, {
                                type: 'product',
                                qty: item.qty,
                                cost: product.cost || 0,
                                amount: item.total,
                                productId: item.productId
                            });

                        } else { // Manual/Service item
                            Object.assign(saleData, {
                                type: 'service',
                                qty: 1,
                                cost: 0, // No cost for manual items unless specified
                                amount: item.total,
                                productId: null
                            });
                        }
                        const newSaleRef = doc(collection(db, 'sales'));
                        transaction.set(newSaleRef, saleData);
                    }
                });

                await logActivity('إنشاء فاتورة ومبيعات', `فاتورة رقم ${newInvoiceNumber} للعميل: ${customerDoc.data().name}`);
                resetForm('add-invoice-form');
                document.getElementById('invoice-items-container').innerHTML = '';
                addInvoiceItemRow(false);
                await refreshInvoices();
                await refreshSales();
                await refreshProducts();
                await updateDashboard();
                showMessage(`تم إنشاء الفاتورة والمبيعات المرتبطة بها بنجاح.`);

            } catch (error) {
                console.error("Invoice creation transaction failed: ", error);
                showMessage(`فشل إنشاء الفاتورة: ${error.message}`);
            }
        }

        async function handleDeleteSelectedProducts() {
            const selectedIds = Array.from(document.querySelectorAll('.product-checkbox:checked')).map(cb => cb.dataset.id);
            if (selectedIds.length === 0) return;
            showConfirm(`هل أنت متأكد من حذف ${selectedIds.length} منتج(ات)؟`, async () => {
                const batch = writeBatch(db);
                selectedIds.forEach(id => batch.delete(doc(db, 'products', id)));
                await batch.commit();
                await logActivity('حذف متعدد للمنتجات', `عدد: ${selectedIds.length}`);
                await refreshProducts(); 
                showMessage(`تم حذف ${selectedIds.length} منتج(ات) بنجاح.`);
            });
        }
        
        function resetForm(formId) {
             document.getElementById(formId)?.reset();
             const form = document.getElementById(formId);
             if(!form) return;
             const idField = form.querySelector('input[type="hidden"]');
             if(idField) idField.value = '';
             const category = formId.replace('add-', '').replace('-form', '');
             const title = document.getElementById(`${category}-form-title`);
             const submitBtn = document.getElementById(`${category}-form-submit-btn`);
             const cancelBtn = document.getElementById(`${category}-form-cancel-btn`);
             const originalTitles = { 'product': 'إضافة منتج جديد', 'sale': 'تسجيل عملية البيع', 'purchase': 'تسجيل شراء جديد', 'expense': 'تسجيل مصروف جديد', 'customer': 'إضافة عميل جديد', 'supplier': 'إضافة مورد جديد' };
             const originalButtons = { 'product': 'إضافة المنتج', 'sale': 'تسجيل عملية البيع', 'purchase': 'تسجيل الشراء', 'expense': 'تسجيل المصروف', 'customer': 'إضافة العميل', 'supplier': 'إضافة المورد' };
             if(title) title.textContent = originalTitles[category];
             if(submitBtn) submitBtn.textContent = originalButtons[category];
             if(cancelBtn) cancelBtn.classList.add('hidden');
             if(category === 'sale') handleSaleTypeChange();
             if(category === 'purchase') togglePurchaseFields();
             itemToEdit = null;
        }
        
        function prepareFormForEdit(category, item) {
             const title = document.getElementById(`${category}-form-title`);
             const submitBtn = document.getElementById(`${category}-form-submit-btn`);
             const cancelBtn = document.getElementById(`${category}-form-cancel-btn`);
             if(title) title.textContent = `تعديل ${title.textContent.replace('إضافة', '').replace('جديد', '')}`;
             if(submitBtn) submitBtn.textContent = 'حفظ التعديلات';
             if(cancelBtn) cancelBtn.classList.remove('hidden');
        }

        function prepareProductEdit(item) {
            prepareFormForEdit('product', item);
            document.getElementById('product-id').value = item.id;
            document.getElementById('p-name').value = item.name;
            document.getElementById('p-cost').value = item.cost;
            document.getElementById('p-qty').value = item.qty;
            document.getElementById('p-supplier').value = item.supplierId;
        }

        async function prepareSaleEdit(item) {
            prepareFormForEdit('sale', item);
            document.getElementById('sale-id').value = item.id;
            document.getElementById('s-date').value = item.date;
            document.getElementById('s-type').value = item.type;
            handleSaleTypeChange(); // Call this to set UI correctly
            if (item.type === 'product') {
                await populateProductSelects(); // Make sure the list is fresh
                document.getElementById('s-product').value = item.productId;
                document.getElementById('s-qty').value = item.qty;
            } else {
                document.getElementById('s-service-name').value = item.name;
            }
            document.getElementById('s-price').value = item.price;
            document.getElementById('s-cost').value = item.cost;
            document.getElementById('s-customer').value = item.customerId;
        }

        async function preparePurchaseEdit(item) {
            prepareFormForEdit('purchase', item);
            document.getElementById('purchase-id').value = item.id;
            document.getElementById('p-date').value = item.date;
            document.getElementById('p-type').value = item.type;
            togglePurchaseFields();
            if (item.type === 'product') {
                await populateProductSelects(); // Make sure the list is fresh
                document.getElementById('p-product').value = item.productId;
            } else {
                document.getElementById('p-other-product-name').value = item.productName;
            }
            document.getElementById('p-cost-input').value = item.cost;
            document.getElementById('p-qty-input').value = item.qty;
            document.getElementById('p-supplier-purchase').value = item.supplierId;
        }
        
        function prepareExpenseEdit(item) {
            prepareFormForEdit('expense', item);
            document.getElementById('expense-id').value = item.id;
            document.getElementById('e-date').value = item.date;
            document.getElementById('e-type').value = item.type;
            document.getElementById('e-amount').value = item.amount;
            document.getElementById('e-desc').value = item.description;
        }
        
        function prepareCustomerEdit(item) {
            prepareFormForEdit('customer', item);
            document.getElementById('customer-id').value = item.id;
            document.getElementById('c-name').value = item.name;
            document.getElementById('c-phone').value = item.phone;
            document.getElementById('c-email').value = item.email;
            document.getElementById('c-address').value = item.address;
        }

        function prepareSupplierEdit(item) {
            prepareFormForEdit('supplier', item);
            document.getElementById('supplier-id').value = item.id;
            document.getElementById('sup-name').value = item.name;
            document.getElementById('sup-phone').value = item.phone;
            document.getElementById('sup-email').value = item.email;
            document.getElementById('sup-address').value = item.address;
        }

        async function addInvoiceItemRow(isManual = false) {
             const container = document.getElementById('invoice-items-container');
             const row = document.createElement('div');
             row.className = 'grid grid-cols-12 gap-2 items-center invoice-item-row';
             row.dataset.type = isManual ? 'manual' : 'product';

            if (isManual) {
                row.innerHTML = `
                    <div class="col-span-6"><input type="text" class="input i-manual-name" placeholder="اسم البند اليدوي"></div>
                    <div class="col-span-4"><input type="number" step="0.01" min="0" class="input i-manual-price" placeholder="السعر"></div>
                    <div class="col-span-2"><button type="button" class="btn btn-danger w-full remove-invoice-item-btn"><i class="fas fa-trash"></i></button></div>
                `;
            } else {
                 row.innerHTML = `
                    <div class="col-span-5"><select class="select i-product-select"></select></div>
                    <div class="col-span-3"><input type="number" class="input i-qty" placeholder="الكمية" min="1" value="1"></div>
                    <div class="col-span-3"><input type="number" step="0.01" min="0" class="input i-price" placeholder="سعر البيع"></div>
                    <div class="col-span-1"><button type="button" class="btn btn-danger w-full remove-invoice-item-btn"><i class="fas fa-trash"></i></button></div>
                `;
            }
            container.appendChild(row);
            if (!isManual) await populateProductSelects();
            row.querySelector('.remove-invoice-item-btn').addEventListener('click', () => { row.remove(); updateInvoiceTotal(); });
        }
        
        function updateInvoiceTotal() {
            let total = 0;
            document.querySelectorAll('.invoice-item-row').forEach(row => {
                const type = row.dataset.type;
                if (type === 'product') {
                    const qty = Math.abs(parseInt(row.querySelector('.i-qty').value)) || 0;
                    const price = Math.abs(parseFloat(row.querySelector('.i-price').value)) || 0;
                    total += qty * price;
                } else {
                    const price = Math.abs(parseFloat(row.querySelector('.i-manual-price').value)) || 0;
                    total += price;
                }
            });
            document.getElementById('invoice-total').textContent = `${total.toFixed(2)} ${appSettings.currency}`;
        }
        
        async function viewInvoice(invoiceId) {
             const invoiceDoc = await getDoc(doc(db, 'invoices', invoiceId));
             if (!invoiceDoc.exists()) return showMessage('الفاتورة غير موجودة');
             const invoice = invoiceDoc.data();
             currentInvoiceId = invoiceId;
             const contentEl = document.getElementById('invoice-view-content');
             contentEl.innerHTML = `
                 <div id="printable-invoice">
                     <div class="p-8">
                         <div class="flex justify-between items-start mb-8">
                             <div>
                                 <h2 class="text-3xl font-bold text-sky-600">${appSettings.companyName}</h2>
                                 <p>${appSettings.companyAddress || ''}</p>
                                 <p>${appSettings.companyPhone || ''}</p>
                             </div>
                             <div class="text-right">
                                 <h3 class="text-2xl font-bold">فاتورة</h3>
                                 <p>رقم: ${invoice.invoiceNumber}</p>
                                 <p>التاريخ: ${invoice.date}</p>
                             </div>
                         </div>
                         <div class="mb-8 p-4 bg-gray-50 rounded-lg">
                             <h4 class="font-bold mb-2">فاتورة إلى:</h4>
                             <p>${invoice.customerName}</p>
                             <p>${invoice.customerDetails.address || ''}</p>
                             <p>${invoice.customerDetails.phone || ''}</p>
                         </div>
                         <table class="w-full text-right mb-8">
                             <thead class="bg-gray-100">
                                 <tr>
                                     <th class="p-2">البند</th>
                                     <th class="p-2">الكمية</th>
                                     <th class="p-2">السعر</th>
                                     <th class="p-2">الإجمالي</th>
                                 </tr>
                             </thead>
                             <tbody>
                                 ${invoice.items.map(item => `
                                     <tr class="border-b">
                                         <td class="p-2">${item.productName}</td>
                                         <td class="p-2">${item.qty}</td>
                                         <td class="p-2">${item.price.toFixed(2)}</td>
                                         <td class="p-2">${(item.qty * item.price).toFixed(2)}</td>
                                     </tr>
                                 `).join('')}
                             </tbody>
                         </table>
                         <div class="text-left">
                             <p class="text-xl font-bold">المجموع الكلي: ${invoice.totalAmount.toFixed(2)} ${appSettings.currency}</p>
                         </div>
                     </div>
                 </div>
             `;
            document.getElementById('invoice-view-modal').classList.remove('hidden');
            document.getElementById('custom-overlay').classList.remove('hidden');
        }
        
        function exportToExcel(tableId, sheetName, fileName) {
            const table = document.getElementById(tableId);
            if (!table) return showMessage('لم يتم العثور على جدول للتصدير.');
            const tableClone = table.cloneNode(true);
            Array.from(tableClone.querySelectorAll('.no-export')).forEach(el => el.remove());
            const ws = XLSX.utils.table_to_sheet(tableClone);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
            XLSX.writeFile(wb, fileName);
        }

         async function importFromExcel(event) {
             const file = event.target.files[0];
             if (!file) return;
             await refreshSuppliers(); // Ensure suppliers are loaded before import

             const reader = new FileReader();
             reader.onload = async (e) => {
                 const data = new Uint8Array(e.target.result);
                 const workbook = XLSX.read(data, { type: 'array' });
                 const firstSheetName = workbook.SheetNames[0];
                 const worksheet = workbook.Sheets[firstSheetName];
                 const jsonData = XLSX.utils.sheet_to_json(worksheet);
                 
                 if (jsonData.length === 0) return showMessage("الملف فارغ أو غير صحيح.");
                 
                 showConfirm(`هل تريد استيراد ${jsonData.length} منتج؟ سيتم إضافتها إلى المخزون.`, async () => {
                     const batch = writeBatch(db);
                     let importedCount = 0;
                     jsonData.forEach(item => {
                         const productRef = doc(collection(db, 'products'));
                         const supplierNumericId = item.supplierId;
                         const supplierName = supplierNumericIdToNameMap.get(supplierNumericId.toString()) || 'غير محدد';
                         
                         const productData = {
                             name: item.name,
                             cost: parseFloat(item.cost || 0),
                             qty: parseInt(item.qty || 0),
                             supplierId: null, // We primarily use numericId now
                             supplierNumericId: supplierNumericId || null,
                             supplierName: supplierName
                         };

                         if(productData.name && productData.supplierNumericId) {
                             batch.set(productRef, productData);
                             importedCount++;
                         }
                     });
                     await batch.commit();
                     await logActivity('استيراد منتجات', `عدد: ${importedCount}`);
                     await refreshProducts();
                     showMessage(`تم استيراد ${importedCount} منتج بنجاح.`);
                 });
             };
             reader.readAsArrayBuffer(file);
             event.target.value = ''; // Reset file input
        }

        async function exportToPdfWithArabic(elementId, title, fileName) {
            const { jsPDF } = window.jspdf;
            const element = document.getElementById(elementId);
             if(!element) {
                 showMessage('عنصر التصدير غير موجود.');
                 return;
             }

            html2canvas(element, { scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgProps= pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(fileName);
            });
        }
        
        async function exportAdvancedReportToExcel() {
            const type = document.getElementById('advanced-export-type').value;
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            if (!startDate || !endDate) {
                return showMessage("الرجاء تحديد فترة التقرير أولاً.");
            }
            
            const wb = XLSX.utils.book_new();

            const fetchAndSheet = async (collectionName, sheetName, fieldMapping) => {
                const q = query(collection(db, collectionName), where('date', '>=', startDate), where('date', '<=', endDate));
                const snapshot = await getDocs(q);
                const data = snapshot.docs.map(doc => {
                    const docData = doc.data();
                    let row = {};
                    for(const key in fieldMapping){
                        row[fieldMapping[key]] = docData[key];
                    }
                    return row;
                });
                if(data.length > 0) {
                     const ws = XLSX.utils.json_to_sheet(data);
                     XLSX.utils.book_append_sheet(wb, ws, sheetName);
                }
            };
            
            const typesToExport = type === 'all' 
                ? ['sales', 'purchases', 'expenses', 'invoices', 'profits', 'inventory']
                : [type];

            for (const reportType of typesToExport) {
                if (reportType === 'sales') {
                    await fetchAndSheet('sales', 'المبيعات', {date: 'التاريخ', name: 'الاسم/المنتج', qty: 'الكمية', price: 'سعر البيع', cost: 'التكلفة', amount: 'الإجمالي', customerName: 'العميل'});
                }
                 if (reportType === 'purchases') {
                    await fetchAndSheet('purchases', 'المشتريات', {date: 'التاريخ', productName: 'المنتج', qty: 'الكمية', cost: 'تكلفة الوحدة', amount: 'الإجمالي', supplierName: 'المورد'});
                }
                 if (reportType === 'expenses') {
                    await fetchAndSheet('expenses', 'المصاريف', {date: 'التاريخ', type: 'النوع', amount: 'المبلغ', description: 'الوصف'});
                }
                if (reportType === 'invoices') {
                    await fetchAndSheet('invoices', 'الفواتير', {invoiceNumber: 'رقم الفاتورة', date: 'التاريخ', customerName: 'العميل', totalAmount: 'المبلغ الإجمالي'});
                }
                if (reportType === 'inventory') {
                    const invData = productsCache.map(p => ({
                        'المنتج': p.name, 'الكمية الحالية': p.qty, 'سعر التكلفة': p.cost, 'قيمة المخزون': p.qty * p.cost, 'المورد': p.supplierName
                    }));
                      const ws = XLSX.utils.json_to_sheet(invData);
                      XLSX.utils.book_append_sheet(wb, ws, 'المستودع');
                }
                if (reportType === 'profits') {
                      const salesQuery = query(collection(db, 'sales'), where('date', '>=', startDate), where('date', '<=', endDate));
                      const expensesQuery = query(collection(db, 'expenses'), where('date', '>=', startDate), where('date', '<=', endDate));
                      const [salesSnapshot, expensesSnapshot] = await Promise.all([getDocs(salesQuery), getDocs(expensesQuery)]);

                      const salesData = salesSnapshot.docs.map(d => d.data());
                      const expensesData = expensesSnapshot.docs.map(d => d.data());
                      
                      const totalRevenue = salesData.reduce((sum, s) => sum + s.amount, 0);
                      const totalCost = salesData.reduce((sum, s) => sum + (s.cost * (s.qty || 1)), 0);
                      const totalExpenses = expensesData.reduce((sum, e) => sum + e.amount, 0);
                      const netProfit = totalRevenue - totalCost - totalExpenses;

                      const profitData = [
                          {'البيان': 'إجمالي الإيرادات (المبيعات)', 'المبلغ': totalRevenue},
                          {'البيان': 'إجمالي تكلفة البضاعة المباعة', 'المبلغ': totalCost},
                          {'البيان': 'إجمالي المصاريف الأخرى', 'المبلغ': totalExpenses},
                          {'البيان': 'صافي الربح', 'المبلغ': netProfit},
                      ];
                      const ws = XLSX.utils.json_to_sheet(profitData);
                      XLSX.utils.book_append_sheet(wb, ws, 'الأرباح');
                }
            }

            if(wb.SheetNames.length > 0) {
                 XLSX.writeFile(wb, `Report_${type}_${startDate}_to_${endDate}.xlsx`);
            } else {
                showMessage('لا توجد بيانات للتصدير في الفترة المحددة.');
            }
        }

        async function exportInvoicesToExcel() {
             let q = collection(db, 'invoices');
             const startDate = document.getElementById('invoice-start-date').value;
             const endDate = document.getElementById('invoice-end-date').value;
             let conditions = [];
             if (startDate) conditions.push(where('date', '>=', startDate));
             if (endDate) conditions.push(where('date', '<=', endDate));
             conditions.push(orderBy('date', 'desc'));
             
             const snapshot = await getDocs(query(q, ...conditions));
             const invoices = snapshot.docs.map(doc => {
                 const data = doc.data();
                 return {
                     'رقم الفاتورة': data.invoiceNumber,
                     'التاريخ': data.date,
                     'العميل': data.customerName,
                     'المبلغ الإجمالي': data.totalAmount.toFixed(2)
                 };
             });

             if (invoices.length === 0) return showMessage('لا توجد فواتير للتصدير في هذا النطاق الزمني.');
             
             const ws = XLSX.utils.json_to_sheet(invoices);
             const wb = XLSX.utils.book_new();
             XLSX.utils.book_append_sheet(wb, ws, "الفواتير");
             XLSX.writeFile(wb, `Invoices_${startDate || 'start'}_to_${endDate || 'end'}.xlsx`);
        }

        async function exportInvoicesToPdf() {
            let q = collection(db, 'invoices');
            const startDate = document.getElementById('invoice-start-date').value;
            const endDate = document.getElementById('invoice-end-date').value;
            let conditions = [];
            if (startDate) conditions.push(where('date', '>=', startDate));
            if (endDate) conditions.push(where('date', '<=', endDate));
            conditions.push(orderBy('date', 'desc'));
             
            const snapshot = await getDocs(query(q, ...conditions));
            const invoices = snapshot.docs.map(doc => doc.data());
            if (invoices.length === 0) return showMessage('لا توجد فواتير للتصدير في هذا النطاق الزمني.');

            // Create a temporary printable version of the invoices
            const tempDiv = document.createElement('div');
            tempDiv.id = 'temp-invoice-export';
            tempDiv.style.display = 'none'; // Hide it
            invoices.forEach(invoice => {
                const invoiceHtml = `
                    <div class="p-8 border-b-2 border-dashed">
                         <div class="flex justify-between items-start mb-8">
                             <div>
                                 <h2 class="text-3xl font-bold text-sky-600">${appSettings.companyName}</h2>
                             </div>
                             <div class="text-right">
                                 <h3 class="text-2xl font-bold">فاتورة</h3>
                                 <p>رقم: ${invoice.invoiceNumber}</p><p>التاريخ: ${invoice.date}</p>
                             </div>
                         </div>
                         <div class="mb-8 p-4 bg-gray-50 rounded-lg">
                             <h4 class="font-bold mb-2">فاتورة إلى: ${invoice.customerName}</h4>
                         </div>
                         <table class="w-full text-right mb-8">
                             <thead class="bg-gray-100"><tr><th class="p-2">البند</th><th class="p-2">الكمية</th><th class="p-2">السعر</th><th class="p-2">الإجمالي</th></tr></thead>
                             <tbody>${invoice.items.map(item => `<tr><td class="p-2">${item.productName}</td><td class="p-2">${item.qty}</td><td class="p-2">${item.price.toFixed(2)}</td><td class="p-2">${(item.qty * item.price).toFixed(2)}</td></tr>`).join('')}</tbody>
                         </table>
                         <div class="text-left"><p class="text-xl font-bold">المجموع: ${invoice.totalAmount.toFixed(2)} ${appSettings.currency}</p></div>
                    </div>`;
                tempDiv.innerHTML += invoiceHtml;
            });
            document.body.appendChild(tempDiv);
            await exportToPdfWithArabic('temp-invoice-export', 'الفواتير', `Invoices_${startDate || 'start'}_to_${endDate || 'end'}.pdf`);
            document.body.removeChild(tempDiv);
        }

        function toggleDeleteSelectedButton() {
            const selectedCount = document.querySelectorAll('.product-checkbox:checked').length;
            const btn = document.getElementById('delete-selected-products-btn');
            btn.disabled = selectedCount === 0;
            const textSpan = btn.querySelector('span');
            if (textSpan) textSpan.textContent = selectedCount > 0 ? `حذف المحدد (${selectedCount})` : 'حذف المحدد';
        }

        function handleSaleTypeChange() {
             const type = document.getElementById('s-type').value;
             const isService = type === 'service';
             document.getElementById('s-product-container').classList.toggle('hidden', isService);
             document.getElementById('s-qty-container').classList.toggle('hidden', isService);
             document.getElementById('s-service-container').classList.toggle('hidden', !isService);
             
             document.getElementById('s-product').required = !isService;
             document.getElementById('s-service-name').required = isService;
             document.getElementById('s-qty').required = !isService;

             const costInput = document.getElementById('s-cost');
             costInput.readOnly = !isService;
             if(isService){
                 costInput.value = '';
                 costInput.placeholder = 'أدخل التكلفة يدوياً';
             } else {
                handleProductSelectionForSale();
             }
        }
        
        function handleProductSelectionForSale() {
            const productId = document.getElementById('s-product').value;
            const costInput = document.getElementById('s-cost');
            const product = productsCache.find(p => p.id === productId);
            if(product){
                costInput.value = product.cost;
            } else {
                costInput.value = '';
            }
        }

        function togglePurchaseFields() {
            const type = document.getElementById('p-type').value;
            const isOther = type === 'other';

            document.getElementById('p-product-container').classList.toggle('hidden', isOther);
            document.getElementById('p-other-product-container').classList.toggle('hidden', !isOther);
            
            document.getElementById('p-product').required = !isOther;
            document.getElementById('p-other-product-name').required = isOther;
        }
        
        async function loadSettings() {
            const settingsDoc = await getDoc(doc(db, 'settings', 'appConfig'));
            if (settingsDoc.exists()) {
                 appSettings = { ...appSettings, ...settingsDoc.data() }
                 if(!settingsDoc.data().supplierCounter) {
                     await setDoc(doc(db, 'settings', 'appConfig'), { supplierCounter: 0 }, { merge: true });
                 }
            } else {
                 await setDoc(doc(db, 'settings', 'appConfig'), { supplierCounter: 0 });
            }
            document.getElementById('setting-company-name').value = appSettings.companyName;
            document.getElementById('setting-company-address').value = appSettings.companyAddress;
            document.getElementById('setting-company-phone').value = appSettings.companyPhone;
            document.getElementById('setting-currency').value = appSettings.currency;
            document.getElementById('setting-initial-fund').value = appSettings.initialFund;
            document.getElementById('setting-loyalty-points').value = appSettings.loyaltyPointsRate;
            document.getElementById('header-company-name').textContent = appSettings.companyName || 'إدارة الأعمال';
        }

        async function handleSettingsSave(e) {
            e.preventDefault();
            const settingsToSave = {
                companyName: document.getElementById('setting-company-name').value,
                companyAddress: document.getElementById('setting-company-address').value,
                companyPhone: document.getElementById('setting-company-phone').value,
                currency: document.getElementById('setting-currency').value,
                initialFund: parseFloat(document.getElementById('setting-initial-fund').value) || 0,
                loyaltyPointsRate: parseInt(document.getElementById('setting-loyalty-points').value) || 0
            };
            await setDoc(doc(db, 'settings', 'appConfig'), settingsToSave, { merge: true });
            await logActivity('تحديث الإعدادات', 'تم تحديث معلومات الشركة والإعدادات المالية');
            await loadSettings();
            showMessage("تم حفظ الإعدادات بنجاح.");
        }

        // --- User Management and Permissions ---
        const ROLES_PERMISSIONS = {
            admin: {
                name: 'مدير',
                permissions: [
                    'عرض جميع البيانات',
                    'إضافة وتعديل وحذف جميع البيانات (منتجات، مبيعات، فواتير... إلخ)',
                    'الوصول إلى الإعدادات الكاملة',
                    'إنشاء وتعديل وحذف المستخدمين وتحديد صلاحياتهم'
                ]
            },
            user: {
                name: 'مستخدم',
                permissions: [
                    'عرض جميع البيانات',
                    'إضافة وتعديل وحذف البيانات التشغيلية (منتجات، مبيعات، فواتير... إلخ)',
                    'لا يمكنه الوصول إلى إعدادات الشركة أو إدارة المستخدمين'
                ]
            },
            visitor: {
                name: 'زائر',
                permissions: [
                    'عرض جميع البيانات فقط',
                    'لا يمكنه إضافة أو تعديل أو حذف أي بيانات',
                    'لا يمكنه الوصول إلى الإعدادات'
                ]
            }
        };

        function displayRolePermissions() {
            const role = document.getElementById('user-role-select').value;
            const displayDiv = document.getElementById('permissions-display');
            if (role && ROLES_PERMISSIONS[role]) {
                const info = ROLES_PERMISSIONS[role];
                displayDiv.innerHTML = `<strong>صلاحيات دور "${info.name}":</strong><ul class="list-disc pr-4 mt-2">${info.permissions.map(p => `<li>${p}</li>`).join('')}</ul>`;
                displayDiv.classList.remove('hidden');
            } else {
                displayDiv.classList.add('hidden');
            }
        }

        async function handleUserFormSubmit(e) {
            e.preventDefault();
            const email = document.getElementById('user-email-input').value;
            const password = document.getElementById('user-password-input').value;
            const role = document.getElementById('user-role-select').value;
            
            showMessage('ميزة إنشاء المستخدمين تتطلب إعدادات من جانب الخادم (Cloud Function) وهي معطلة في هذه النسخة التجريبية.');
        }

        async function refreshUsers() {
            if (currentUser.role !== 'admin') return;
            const snapshot = await getDocs(collection(db, 'users'));
            const users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const tableBody = document.getElementById('users-table');
            tableBody.innerHTML = '';
            users.forEach(user => {
                 const row = tableBody.insertRow();
                 row.innerHTML = `
                    <td>${user.email}</td>
                    <td>${ROLES_PERMISSIONS[user.role]?.name || user.role}</td>
                    <td>
                        ${ currentUser.auth?.uid !== user.id ? `<button class="btn btn-danger text-sm delete-btn" data-id="${user.id}" data-category="users">حذف</button>` : 'الحساب الحالي'}
                    </td>
                 `;
            });
        }
        
        function applyPermissions(role) {
            const isVisitor = role === 'visitor';
            const isAdmin = role === 'admin';

            document.getElementById('settings-tab-btn').style.display = isAdmin ? 'flex' : 'none';
            document.getElementById('activity-log-tab-btn').style.display = isAdmin ? '' : 'none';

            document.getElementById('backup-management-section').style.display = isAdmin ? '' : 'none';
            document.getElementById('user-management-section').style.display = isAdmin ? '' : 'none';
            
            if (!isAdmin && document.querySelector('.tab-btn.active[data-tab="settings"]')) {
                switchTab('dashboard');
            }
            if (!isAdmin && document.querySelector('.tab-btn.active[data-tab="activity_log"]')) {
                switchTab('dashboard');
            }
            
            document.getElementById('user-role-display').textContent = `الصلاحية: ${ROLES_PERMISSIONS[role]?.name || role}`;

            const restrictedElements = document.querySelectorAll(`
                form button[type="submit"], 
                .edit-btn, 
                .delete-btn, 
                .create-invoice-from-sale-btn,
                #delete-selected-products-btn, 
                #import-products-excel, 
                #add-invoice-item-btn, 
                #add-manual-invoice-item-btn
            `);

            restrictedElements.forEach(el => {
                const targetEl = el.id === 'import-products-excel' ? el.parentElement : el;
                if (isVisitor) {
                    targetEl.style.display = 'none';
                } else {
                    targetEl.style.display = '';
                    targetEl.disabled = false;
                    targetEl.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            });
        }
        
        async function logActivity(action, details) {
            if (!currentUser.auth) return;
            try {
                await addDoc(collection(db, 'activity_log'), {
                    userEmail: currentUser.auth.email,
                    action: action,
                    details: details,
                    timestamp: serverTimestamp()
                });
            } catch (error) {
                console.error("Error logging activity:", error);
            }
        }

        async function refreshActivityLog() {
            if (currentUser.role !== 'admin') return;
            const q = query(collection(db, 'activity_log'), orderBy('timestamp', 'desc'), limit(200));
            const snapshot = await getDocs(q);
            const logs = snapshot.docs.map(doc => doc.data());
            const tableBody = document.getElementById('activity-log-table');
            tableBody.innerHTML = '';
            logs.forEach(log => {
                const row = tableBody.insertRow();
                const timestamp = log.timestamp ? log.timestamp.toDate().toLocaleString('ar-JO') : '...';
                row.innerHTML = `
                    <td class="whitespace-nowrap">${timestamp}</td>
                    <td>${log.userEmail}</td>
                    <td>${log.action}</td>
                    <td class="whitespace-normal">${log.details}</td>
                `;
            });
        }


        async function exportBackup() {
            showMessage('جاري تحضير النسخة الاحتياطية... قد يستغرق هذا بعض الوقت.');
            const backupData = {};
            const collectionsToBackup = ['products', 'sales', 'purchases', 'expenses', 'customers', 'suppliers', 'invoices', 'users', 'activity_log'];

            try {
                for (const collectionName of collectionsToBackup) {
                    const snapshot = await getDocs(collection(db, collectionName));
                    backupData[collectionName] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }
                
                const settingsDoc = await getDoc(doc(db, 'settings', 'appConfig'));
                if (settingsDoc.exists()) {
                    backupData['settings'] = [{ id: 'appConfig', ...settingsDoc.data() }];
                }

                const jsonString = JSON.stringify(backupData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const today = getLocalDate();
                a.href = url;
                a.download = `backup-${today}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                document.getElementById('custom-alert').classList.add('hidden');
                document.getElementById('custom-overlay').classList.add('hidden');
            } catch (error) {
                console.error("Backup failed:", error);
                showMessage(`فشل تصدير النسخة الاحتياطية: ${error.message}`);
            }
        }

        function handleImportBackup(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    showConfirm(`هل أنت متأكد من استعادة هذه النسخة الاحتياطية؟ سيتم حذف جميع البيانات الحالية بشكل نهائي واستبدالها ببيانات الملف. هذه العملية لا يمكن التراجع عنها.`, async () => {
                        showMessage('جاري استعادة النسخة الاحتياطية... الرجاء عدم إغلاق الصفحة.');
                        
                        try {
                            const allCollections = ['products', 'sales', 'purchases', 'expenses', 'customers', 'suppliers', 'invoices', 'users', 'settings', 'activity_log'];
                            
                            for (const collectionName of allCollections) {
                                const snapshot = await getDocs(collection(db, collectionName));
                                if (snapshot.size > 0) {
                                    const batch = writeBatch(db);
                                    snapshot.docs.forEach(doc => batch.delete(doc.ref));
                                    await batch.commit();
                                }
                            }

                            for (const collectionName in backupData) {
                                const items = backupData[collectionName];
                                if (items && items.length > 0) {
                                    const batch = writeBatch(db);
                                    items.forEach(item => {
                                        const { id, ...data } = item;
                                        const docRef = id ? doc(db, collectionName, id) : doc(collection(db, collectionName));
                                        batch.set(docRef, data);
                                    });
                                    await batch.commit();
                                }
                            }
                            await logActivity('استيراد نسخة احتياطية', 'تم استبدال جميع بيانات النظام.');
                            await refreshAllDataOnLogin();
                            showMessage('تم استعادة النسخة الاحتياطية بنجاح!');

                        } catch (importError) {
                            console.error("Import failed:", importError);
                            showMessage(`فشل استيراد النسخة الاحتياطية: ${importError.message}`);
                        }
                    });

                } catch (parseError) {
                    console.error("File parse error:", parseError);
                    showMessage('ملف النسخة الاحتياطية غير صالح أو تالف.');
                } finally {
                    event.target.value = ''; // Reset file input
                }
            };
            reader.readAsText(file);
        }

        // --- Initialization ---
        function main() {
            setupEventListeners();
            addInvoiceItemRow(false);
            const today = getLocalDate();
            ['s-date', 'p-date', 'e-date', 'i-date', 'dashboard-date', 'start-date', 'end-date', 'invoice-start-date', 'invoice-end-date'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = today;
            });

            if (localStorage.getItem('darkMode') === 'true') {
                document.documentElement.classList.add('dark-mode');
                document.getElementById('dark-mode-toggle').innerHTML = '<i class="fas fa-sun"></i>';
            }
            
            onAuthStateChanged(auth, async user => {
                if (user) {
                    const userDocRef = doc(db, 'users', user.uid);
                    const userDoc = await getDoc(userDocRef);
                    currentUser.auth = user;

                    if (userDoc.exists() && userDoc.data().role) {
                        currentUser.role = userDoc.data().role;
                    } else {
                        const allUsersSnapshot = await getDocs(query(collection(db, 'users'), limit(1)));
                        if (allUsersSnapshot.empty) {
                            currentUser.role = 'admin';
                            await setDoc(userDocRef, { email: user.email, role: 'admin' }, { merge: true });
                        } else {
                            currentUser.role = 'visitor'; // Default for safety if doc is missing
                        }
                    }
                    
                    document.getElementById('user-email').textContent = user.email;
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('app-container').classList.remove('hidden');
                    
                    await refreshAllDataOnLogin();
                    applyPermissions(currentUser.role);
					setupDraggableDashboard(); // NEW: Initialize drag-and-drop
                    switchTab('dashboard');
                } else {
                    currentUser = { auth: null, role: 'visitor' };
                    document.getElementById('login-screen').classList.remove('hidden');
                    document.getElementById('app-container').classList.add('hidden');
                    document.getElementById('login-form').reset();
                }
            });
        }
		
		// NEW FEATURE: Draggable Dashboard
		function setupDraggableDashboard() {
			const grid = document.getElementById('dashboard-metrics');
			const sortable = Sortable.create(grid, {
				animation: 150,
				ghostClass: 'sortable-ghost',
				handle: '.handle', 
				onEnd: function (evt) {
					const cardOrder = Array.from(grid.children).map(card => card.dataset.id);
					localStorage.setItem('dashboardCardOrder', JSON.stringify(cardOrder));
				},
			});

			// Load and apply saved order
			const savedOrder = localStorage.getItem('dashboardCardOrder');
			if (savedOrder) {
				const cardOrder = JSON.parse(savedOrder);
				cardOrder.forEach(cardId => {
					const card = grid.querySelector(`[data-id="${cardId}"]`);
					if (card) {
						grid.appendChild(card);
					}
				});
			}
		}

        main();
    </script>
</body>
</html>

