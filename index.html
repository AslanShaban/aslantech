<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق إدارة الأعمال الشامل</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- مكتبات لتصدير PDF و Excel وإنشاء الفواتير -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');
        :root {
            --background-primary: #f3f4f6;
            --background-secondary: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --accent-primary: #3b82f6;
            --accent-primary-hover: #2563eb;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }
        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--background-primary);
            color: var(--text-primary);
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }
        @media (min-width: 640px) {
            .container {
                padding: 2rem;
            }
        }
        .dashboard-card, .form-section, .data-table-container, .settings-card {
            background-color: var(--background-secondary);
            border-radius: 12px;
            box-shadow: 0 4px 6px var(--shadow-color);
            padding: 1.5rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px var(--shadow-color);
        }
        .form-section, .settings-card {
            margin-bottom: 2rem;
        }
        .data-table-container {
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        .data-table th, .data-table td {
            padding: 0.75rem 1rem;
            text-align: right;
            border-bottom: 1px solid var(--background-primary);
        }
        .data-table th {
            background-color: var(--background-primary);
            color: var(--text-primary);
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            border: 1px solid transparent;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary {
            background-color: var(--accent-primary);
            color: #ffffff;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: var(--accent-primary-hover);
            transform: translateY(-2px);
        }
        .btn-danger { background-color: #ef4444; color: #ffffff; }
        .btn-danger:hover:not(:disabled) { background-color: #dc2626; }
        .btn-edit { background-color: #f59e0b; color: #ffffff; }
        .btn-edit:hover:not(:disabled) { background-color: #d97706; }
        .input, .select {
            width: 100%;
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            margin-top: 0.25rem;
            transition: border-color 0.3s ease;
            background-color: var(--background-secondary);
            color: var(--text-primary);
        }
        .input:focus, .select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .tab-btn {
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.3s ease;
            color: var(--text-secondary);
        }
        .tab-btn.active {
            background-color: var(--accent-primary);
            color: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .tab-btn:not(.active):hover {
            background-color: var(--background-secondary);
            color: var(--text-primary);
        }
        #invoice-view-modal {
            max-height: 90vh;
            overflow-y: auto;
        }
        /* Report Page Specific Styles */
        .report-kpi-card {
            background-color: var(--background-secondary);
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            border-left: 5px solid;
        }
        .report-kpi-card .icon {
            font-size: 2rem;
            padding: 0.75rem;
            border-radius: 50%;
            color: white;
        }
        .kpi-trend {
            font-size: 0.8rem;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        .kpi-trend.positive { color: #10b981; }
        .kpi-trend.negative { color: #ef4444; }

        @media print {
            body * {
                visibility: hidden;
            }
            #printable-content, #printable-content * {
                visibility: visible;
            }
            #printable-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="p-0 sm:p-4">
    
    <!-- شاشة تسجيل الدخول -->
    <div id="login-screen" class="fixed inset-0 bg-gray-200 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm text-center">
            <h2 class="text-3xl font-bold text-blue-600 mb-4">تسجيل الدخول</h2>
            <p class="text-gray-500 mb-6">الرجاء إدخال البريد الإلكتروني وكلمة المرور للوصول.</p>
            <form id="login-form">
                <div class="mb-4 text-right">
                    <label for="username" class="block text-gray-700 font-semibold mb-2">البريد الإلكتروني</label>
                    <input type="email" id="username" class="input" required>
                </div>
                <div class="mb-6 text-right">
                    <label for="password" class="block text-gray-700 font-semibold mb-2">كلمة المرور</label>
                    <input type="password" id="password" class="input" required>
                </div>
                 <p id="login-error" class="text-red-500 mb-4 hidden">البريد الإلكتروني أو كلمة المرور غير صحيحة.</p>
                <button type="submit" class="btn btn-primary w-full text-lg">دخول</button>
            </form>
        </div>
    </div>

    <!-- حاوية التطبيق الرئيسية -->
    <div id="app-container" class="container bg-white rounded-none sm:rounded-xl shadow-lg p-4 sm:p-8 hidden">
        <header class="mb-8">
            <div class="flex flex-wrap justify-between items-center gap-4">
                <div>
                    <h1 class="text-3xl sm:text-4xl font-bold text-blue-600 mb-2" id="header-company-name">تطبيق إدارة الأعمال</h1>
                    <p class="text-gray-500">لوحة تحكم لإدارة المخزون، المبيعات، الفواتير، والعملاء والموردين.</p>
                </div>
                <div class="flex items-center gap-4">
                    <p id="user-email" class="text-gray-600 font-semibold hidden sm:block"></p>
                    <button id="logout-btn" class="btn btn-danger">
                        <i class="fas fa-sign-out-alt"></i>
                       <span class="hidden sm:inline">تسجيل الخروج</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- أزرار التنقل -->
        <div class="flex flex-wrap justify-center gap-2 mb-8" id="nav-tabs">
            <button class="tab-btn active" data-tab="dashboard">الرئيسية</button>
            <button class="tab-btn" data-tab="products">المستودع</button>
            <button class="tab-btn" data-tab="sales">المبيعات</button>
            <button class="tab-btn" data-tab="purchases">المشتريات</button>
            <button class="tab-btn" data-tab="expenses">المصاريف</button>
            <button class="tab-btn" data-tab="customers">العملاء</button>
            <button class="tab-btn" data-tab="suppliers">الموردين</button>
            <button class="tab-btn" data-tab="invoices">الفواتير</button>
            <button class="tab-btn" data-tab="reports">التقارير</button>
            <button class="tab-btn" data-tab="settings" id="settings-tab-btn">الإعدادات</button>
        </div>

        <!-- محتوى التبويبات -->
        <div id="tab-content">
            <!-- تبويب الرئيسية -->
            <div id="dashboard" class="tab-pane">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">لوحة التحكم</h2>
                <div class="form-section">
                    <h3 class="text-2xl font-semibold mb-4">عرض البيانات حسب التاريخ</h3>
                    <form id="dashboard-date-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div class="flex flex-col">
                            <label for="dashboard-date" class="text-gray-600 mb-1">تحديد التاريخ</label>
                            <input type="date" id="dashboard-date" class="input" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-full md:w-auto">عرض البيانات</button>
                    </form>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8" id="dashboard-metrics">
                    <div class="dashboard-card bg-blue-500 text-white flex items-center justify-between">
                        <div>
                            <p class="text-lg font-bold">إجمالي المبيعات</p>
                            <p class="text-3xl font-extrabold" id="total-sales">0</p>
                        </div>
                        <i class="fas fa-chart-line text-4xl opacity-50"></i>
                    </div>
                    <div class="dashboard-card bg-green-500 text-white flex items-center justify-between">
                        <div>
                            <p class="text-lg font-bold">إجمالي المشتريات</p>
                            <p class="text-3xl font-extrabold" id="total-purchases">0</p>
                        </div>
                        <i class="fas fa-shopping-cart text-4xl opacity-50"></i>
                    </div>
                    <div class="dashboard-card bg-yellow-500 text-white flex items-center justify-between">
                        <div>
                            <p class="text-lg font-bold">إجمالي المصاريف</p>
                            <p class="text-3xl font-extrabold" id="total-expenses">0</p>
                        </div>
                        <i class="fas fa-wallet text-4xl opacity-50"></i>
                    </div>
                    <div class="dashboard-card bg-purple-500 text-white flex items-center justify-between">
                        <div>
                            <p class="text-lg font-bold">الربح الصافي</p>
                            <p class="text-3xl font-extrabold" id="net-profit">0</p>
                        </div>
                        <i class="fas fa-money-bill-wave text-4xl opacity-50"></i>
                    </div>
                    <div class="dashboard-card bg-teal-500 text-white flex items-center justify-between">
                        <div>
                            <p class="text-lg font-bold">صافي الصندوق</p>
                            <p class="text-3xl font-extrabold" id="remaining-fund">0</p>
                        </div>
                        <i class="fas fa-cash-register text-4xl opacity-50"></i>
                    </div>
                </div>
            </div>

            <!-- تبويب المستودع (المنتجات) -->
            <div id="products" class="tab-pane hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">إدارة المستودع</h2>
                <div class="form-section">
                    <h3 class="text-2xl font-semibold mb-4" id="product-form-title">إضافة منتج جديد</h3>
                    <form id="add-product-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                        <input type="hidden" id="product-id">
                        <div class="flex flex-col">
                            <label for="p-name" class="text-gray-600 mb-1">اسم المنتج</label>
                            <input type="text" id="p-name" class="input" required>
                        </div>
                        <div class="flex flex-col">
                            <label for="p-cost" class="text-gray-600 mb-1">سعر التكلفة</label>
                            <input type="number" id="p-cost" class="input" step="0.01" required>
                        </div>
                        <div class="flex flex-col">
                            <label for="p-qty" class="text-gray-600 mb-1">الكمية</label>
                            <input type="number" id="p-qty" class="input" required>
                        </div>
                        <div class="flex flex-col">
                            <label for="p-supplier" class="text-gray-600 mb-1">المورد</label>
                            <select id="p-supplier" class="select">
                                <option value="">اختر مورد</option>
                            </select>
                        </div>
                        <div class="flex items-end col-span-full gap-2">
                            <button type="submit" class="btn btn-primary w-full" id="product-form-submit-btn">إضافة المنتج</button>
                             <button type="button" class="btn bg-gray-500 text-white w-full hidden" id="product-form-cancel-btn">إلغاء التعديل</button>
                        </div>
                    </form>
                </div>
                <div class="bg-white rounded-2xl shadow-lg p-4 sm:p-6">
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6 text-center">
                        <div class="p-4 bg-blue-50 rounded-lg">
                            <h4 class="text-sm font-semibold text-blue-800">إجمالي المنتجات</h4>
                            <p id="stats-total-products" class="text-2xl font-bold text-blue-900">0</p>
                        </div>
                        <div class="p-4 bg-green-50 rounded-lg">
                            <h4 class="text-sm font-semibold text-green-800">قيمة المخزون</h4>
                            <p id="stats-stock-value" class="text-2xl font-bold text-green-900">0</p>
                        </div>
                        <div class="p-4 bg-yellow-50 rounded-lg">
                            <h4 class="text-sm font-semibold text-yellow-800">منتجات منخفضة المخزون</h4>
                            <p id="stats-low-stock" class="text-2xl font-bold text-yellow-900">0</p>
                        </div>
                        <div class="p-4 bg-red-50 rounded-lg">
                            <h4 class="text-sm font-semibold text-red-800">منتجات نافدة</h4>
                            <p id="stats-out-of-stock" class="text-2xl font-bold text-red-900">0</p>
                        </div>
                    </div>
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-4 pb-4 border-b border-gray-200">
                        <div class="w-full md:w-2/5">
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3"><i class="fas fa-search text-gray-400"></i></span>
                                <input type="text" id="product-search-input" class="input w-full pl-10" placeholder="ابحث عن منتج بالاسم...">
                            </div>
                        </div>
                        <div class="flex flex-wrap justify-end items-center gap-2">
                            <button id="delete-selected-products-btn" class="btn btn-danger" disabled><i class="fas fa-trash-alt"></i><span>حذف المحدد</span></button>
                            <label class="btn bg-green-600 hover:bg-green-700 text-white cursor-pointer"><i class="fas fa-file-excel"></i><span>استيراد</span><input type="file" id="import-products-excel" class="hidden" accept=".xlsx, .xls, .csv"></label>
                            <button class="btn bg-blue-600 hover:bg-blue-700 text-white" onclick="exportToExcel('products-table-export', 'المنتجات', 'Products.xlsx')"><i class="fas fa-file-download"></i><span>تصدير Excel</span></button>
                        </div>
                    </div>
                    <div class="data-table-container">
                        <table class="data-table" id="products-table-export">
                            <thead>
                                <tr>
                                    <th class="no-export"><input type="checkbox" id="select-all-products"></th>
                                    <th>الاسم</th>
                                    <th>سعر التكلفة</th>
                                    <th>الكمية</th>
                                    <th>المورد</th>
                                    <th class="no-export">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="products-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- تبويب المبيعات -->
            <div id="sales" class="tab-pane hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">إدارة المبيعات</h2>
                <div class="form-section">
                     <h3 class="text-2xl font-semibold mb-4" id="sale-form-title">تسجيل عملية البيع</h3>
                     <form id="add-sale-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                         <input type="hidden" id="sale-id">
                         <div class="flex flex-col">
                             <label for="s-date" class="text-gray-600 mb-1">التاريخ</label>
                             <input type="date" id="s-date" class="input" required>
                         </div>
                         <div class="flex flex-col">
                             <label for="s-type" class="text-gray-600 mb-1">نوع البيع</label>
                             <select id="s-type" class="select">
                                 <option value="product">منتج</option>
                                 <option value="service">خدمة (صيانة)</option>
                             </select>
                         </div>
                         <div class="flex flex-col" id="s-product-container">
                             <label for="s-product" class="text-gray-600 mb-1">المنتج</label>
                             <select id="s-product" class="select" required></select>
                         </div>
                         <div class="flex flex-col hidden" id="s-service-container">
                             <label for="s-service-name" class="text-gray-600 mb-1">اسم الخدمة</label>
                             <input type="text" id="s-service-name" class="input">
                         </div>
                         <div class="flex flex-col" id="s-qty-container">
                             <label for="s-qty" class="text-gray-600 mb-1">الكمية</label>
                             <input type="number" id="s-qty" class="input" required>
                         </div>
                         <div class="flex flex-col" id="s-cost-container">
                             <label for="s-cost" class="text-gray-600 mb-1">سعر التكلفة</label>
                             <input type="number" id="s-cost" class="input" step="0.01" placeholder="أدخل التكلفة يدوياً" required>
                         </div>
                         <div class="flex flex-col" id="s-price-container">
                             <label for="s-price" class="text-gray-600 mb-1">سعر البيع</label>
                             <input type="number" id="s-price" class="input" step="0.01" required>
                         </div>
                         <div class="flex flex-col">
                             <label for="s-customer" class="text-gray-600 mb-1">العميل</label>
                             <select id="s-customer" class="select">
                                 <option value="">اختر عميل</option>
                             </select>
                         </div>
                         <div class="flex items-end col-span-full gap-2">
                             <button type="submit" class="btn btn-primary w-full" id="sale-form-submit-btn">تسجيل عملية البيع</button>
                              <button type="button" class="btn bg-gray-500 text-white w-full hidden" id="sale-form-cancel-btn">إلغاء التعديل</button>
                         </div>
                     </form>
                 </div>
                <div class="data-table-container">
                     <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                        <h3 class="text-2xl font-semibold">سجل المبيعات</h3>
                        <div class="flex flex-wrap gap-2">
                            <button class="btn btn-primary bg-blue-500 hover:bg-blue-600" onclick="exportToExcel('sales-table-export', 'المبيعات', 'Sales.xlsx')"><i class="fas fa-file-excel"></i> تصدير Excel</button>
                        </div>
                    </div>
                    <table class="data-table" id="sales-table-export">
                        <thead>
                            <tr>
                                <th>التاريخ</th>
                                <th>النوع</th>
                                <th>الاسم/المنتج</th>
                                <th>الكمية</th>
                                <th>العميل</th>
                                <th>المبلغ</th>
                                <th class="no-export">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="sales-table"></tbody>
                    </table>
                </div>
            </div>

             <!-- تبويب المشتريات -->
            <div id="purchases" class="tab-pane hidden">
                 <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">إدارة المشتريات</h2>
                 <div class="form-section">
                     <h3 class="text-2xl font-semibold mb-4" id="purchase-form-title">تسجيل شراء جديد</h3>
                     <form id="add-purchase-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                         <input type="hidden" id="purchase-id">
                         <div class="flex flex-col">
                             <label for="p-date" class="text-gray-600 mb-1">التاريخ</label>
                             <input type="date" id="p-date" class="input" required>
                         </div>
                         <div class="flex flex-col">
                             <label for="p-type" class="text-gray-600 mb-1">نوع الشراء</label>
                             <select id="p-type" class="select">
                                 <option value="product">منتج من المخزون</option>
                                 <option value="other">منتج آخر</option>
                             </select>
                         </div>
                         <div class="flex flex-col" id="p-product-container">
                             <label for="p-product" class="text-gray-600 mb-1">المنتج</label>
                             <select id="p-product" class="select" required></select>
                         </div>
                         <div class="flex flex-col hidden" id="p-other-product-container">
                             <label for="p-other-product-name" class="text-gray-600 mb-1">اسم المنتج</label>
                             <input type="text" id="p-other-product-name" class="input">
                         </div>
                          <div class="flex flex-col">
                             <label for="p-cost-input" class="text-gray-600 mb-1">سعر الشراء</label>
                             <input type="number" id="p-cost-input" class="input" step="0.01" required>
                         </div>
                         <div class="flex flex-col">
                             <label for="p-qty-input" class="text-gray-600 mb-1">الكمية</label>
                             <input type="number" id="p-qty-input" class="input" required>
                         </div>
                         <div class="flex flex-col">
                             <label for="p-supplier-purchase" class="text-gray-600 mb-1">المورد</label>
                             <select id="p-supplier-purchase" class="select">
                                 <option value="">اختر مورد</option>
                             </select>
                         </div>
                         <div class="flex items-end col-span-full gap-2">
                             <button type="submit" class="btn btn-primary w-full" id="purchase-form-submit-btn">تسجيل الشراء</button>
                              <button type="button" class="btn bg-gray-500 text-white w-full hidden" id="purchase-form-cancel-btn">إلغاء التعديل</button>
                         </div>
                     </form>
                 </div>
                 <div class="data-table-container">
                     <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                         <h3 class="text-2xl font-semibold">سجل المشتريات</h3>
                          <div class="flex flex-wrap gap-2">
                            <button class="btn btn-primary bg-blue-500 hover:bg-blue-600" onclick="exportToExcel('purchases-table-export', 'المشتريات', 'Purchases.xlsx')"><i class="fas fa-file-excel"></i> تصدير Excel</button>
                         </div>
                     </div>
                     <table class="data-table" id="purchases-table-export">
                         <thead>
                             <tr>
                                 <th>التاريخ</th>
                                 <th>المنتج</th>
                                 <th>الكمية</th>
                                 <th>المورد</th>
                                 <th>المبلغ</th>
                                 <th class="no-export">الإجراءات</th>
                             </tr>
                         </thead>
                         <tbody id="purchases-table"></tbody>
                     </table>
                 </div>
            </div>

            <!-- تبويب المصاريف -->
            <div id="expenses" class="tab-pane hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">إدارة المصاريف</h2>
                 <div class="form-section">
                     <h3 class="text-2xl font-semibold mb-4" id="expense-form-title">تسجيل مصروف جديد</h3>
                     <form id="add-expense-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-end">
                         <input type="hidden" id="expense-id">
                         <div class="flex flex-col">
                             <label for="e-date" class="text-gray-600 mb-1">التاريخ</label>
                             <input type="date" id="e-date" class="input" required>
                         </div>
                         <div class="flex flex-col">
                             <label for="e-type" class="text-gray-600 mb-1">نوع المصروف</label>
                             <select id="e-type" class="select" required>
                                 <option value="رواتب">رواتب</option>
                                 <option value="مصاريف اخرى">مصاريف اخرى</option>
                             </select>
                         </div>
                         <div class="flex flex-col">
                             <label for="e-amount" class="text-gray-600 mb-1">المبلغ</label>
                             <input type="number" id="e-amount" class="input" step="0.01" required>
                         </div>
                         <div class="flex flex-col col-span-full">
                             <label for="e-desc" class="text-gray-600 mb-1">الوصف</label>
                             <textarea id="e-desc" class="input" rows="2"></textarea>
                         </div>
                         <div class="flex items-end col-span-full gap-2">
                             <button type="submit" class="btn btn-primary w-full" id="expense-form-submit-btn">تسجيل المصروف</button>
                             <button type="button" class="btn bg-gray-500 text-white w-full hidden" id="expense-form-cancel-btn">إلغاء التعديل</button>
                         </div>
                     </form>
                 </div>
                 <div class="data-table-container">
                     <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                         <h3 class="text-2xl font-semibold">سجل المصاريف</h3>
                         <div class="flex flex-wrap gap-2">
                            <button class="btn btn-primary bg-blue-500 hover:bg-blue-600" onclick="exportToExcel('expenses-table-export', 'المصاريف', 'Expenses.xlsx')"><i class="fas fa-file-excel"></i> تصدير Excel</button>
                         </div>
                     </div>
                     <table class="data-table" id="expenses-table-export">
                         <thead>
                             <tr>
                                 <th>التاريخ</th>
                                 <th>النوع</th>
                                 <th>المبلغ</th>
                                 <th>الوصف</th>
                                 <th class="no-export">الإجراءات</th>
                             </tr>
                         </thead>
                         <tbody id="expenses-table"></tbody>
                     </table>
                 </div>
            </div>

            <!-- تبويب العملاء -->
            <div id="customers" class="tab-pane hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">إدارة العملاء</h2>
                 <div class="form-section">
                     <h3 class="text-2xl font-semibold mb-4" id="customer-form-title">إضافة عميل جديد</h3>
                     <form id="add-customer-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                         <input type="hidden" id="customer-id">
                         <div class="flex flex-col">
                             <label for="c-name" class="text-gray-600 mb-1">اسم العميل</label>
                             <input type="text" id="c-name" class="input" required>
                         </div>
                         <div class="flex flex-col">
                             <label for="c-phone" class="text-gray-600 mb-1">رقم الهاتف</label>
                             <input type="text" id="c-phone" class="input">
                         </div>
                         <div class="flex flex-col">
                             <label for="c-email" class="text-gray-600 mb-1">البريد الإلكتروني</label>
                             <input type="email" id="c-email" class="input">
                         </div>
                         <div class="flex flex-col col-span-full">
                             <label for="c-address" class="text-gray-600 mb-1">العنوان</label>
                             <textarea id="c-address" class="input" rows="2"></textarea>
                         </div>
                         <div class="flex items-end col-span-full gap-2">
                             <button type="submit" class="btn btn-primary w-full" id="customer-form-submit-btn">إضافة العميل</button>
                             <button type="button" class="btn bg-gray-500 text-white w-full hidden" id="customer-form-cancel-btn">إلغاء التعديل</button>
                         </div>
                     </form>
                 </div>
                 <div class="data-table-container">
                     <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                         <h3 class="text-2xl font-semibold">قائمة العملاء</h3>
                         <div class="flex flex-wrap gap-2">
                             <button class="btn btn-primary bg-blue-500 hover:bg-blue-600" onclick="exportToExcel('customers-table-export', 'العملاء', 'Customers.xlsx')"><i class="fas fa-file-excel"></i> تصدير Excel</button>
                         </div>
                     </div>
                     <table class="data-table" id="customers-table-export">
                         <thead>
                             <tr>
                                 <th>الاسم</th>
                                 <th>رقم الهاتف</th>
                                 <th>البريد الإلكتروني</th>
                                 <th>العنوان</th>
                                 <th class="no-export">الإجراءات</th>
                             </tr>
                         </thead>
                         <tbody id="customers-table"></tbody>
                     </table>
                 </div>
            </div>

            <!-- تبويب الموردين -->
            <div id="suppliers" class="tab-pane hidden">
                 <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">إدارة الموردين</h2>
                 <div class="form-section">
                     <h3 class="text-2xl font-semibold mb-4" id="supplier-form-title">إضافة مورد جديد</h3>
                     <form id="add-supplier-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                         <input type="hidden" id="supplier-id">
                         <div class="flex flex-col">
                             <label for="sup-name" class="text-gray-600 mb-1">اسم المورد</label>
                             <input type="text" id="sup-name" class="input" required>
                         </div>
                         <div class="flex flex-col">
                             <label for="sup-phone" class="text-gray-600 mb-1">رقم الهاتف</label>
                             <input type="text" id="sup-phone" class="input">
                         </div>
                         <div class="flex flex-col">
                             <label for="sup-email" class="text-gray-600 mb-1">البريد الإلكتروني</label>
                             <input type="email" id="sup-email" class="input">
                         </div>
                         <div class="flex flex-col col-span-full">
                             <label for="sup-address" class="text-gray-600 mb-1">العنوان</label>
                             <textarea id="sup-address" class="input" rows="2"></textarea>
                         </div>
                         <div class="flex items-end col-span-full gap-2">
                             <button type="submit" class="btn btn-primary w-full" id="supplier-form-submit-btn">إضافة المورد</button>
                              <button type="button" class="btn bg-gray-500 text-white w-full hidden" id="supplier-form-cancel-btn">إلغاء التعديل</button>
                         </div>
                     </form>
                 </div>
                 <div class="data-table-container">
                     <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                         <h3 class="text-2xl font-semibold">قائمة الموردين</h3>
                          <div class="flex flex-wrap gap-2">
                            <button class="btn btn-primary bg-blue-500 hover:bg-blue-600" onclick="exportToExcel('suppliers-table-export', 'الموردين', 'Suppliers.xlsx')"><i class="fas fa-file-excel"></i> تصدير Excel</button>
                         </div>
                     </div>
                     <table class="data-table" id="suppliers-table-export">
                         <thead>
                             <tr>
                                 <th>الاسم</th>
                                 <th>رقم الهاتف</th>
                                 <th>البريد الإلكتروني</th>
                                 <th>العنوان</th>
                                 <th class="no-export">الإجراءات</th>
                             </tr>
                         </thead>
                         <tbody id="suppliers-table"></tbody>
                     </table>
                 </div>
            </div>

            <!-- تبويب الفواتير -->
            <div id="invoices" class="tab-pane hidden">
                 <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">إدارة الفواتير</h2>
                 <div class="form-section">
                     <h3 class="text-2xl font-semibold mb-4">إنشاء فاتورة جديدة</h3>
                     <form id="add-invoice-form" class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                         <div class="flex flex-col">
                             <label for="i-date" class="text-gray-600 mb-1">تاريخ الفاتورة</label>
                             <input type="date" id="i-date" class="input" required>
                         </div>
                         <div class="flex flex-col">
                             <label for="i-customer" class="text-gray-600 mb-1">العميل</label>
                             <select id="i-customer" class="select" required>
                                 <option value="">اختر عميل</option>
                             </select>
                         </div>
                         <div class="flex flex-col col-span-full">
                             <label class="text-gray-600 mb-1">تفاصيل المنتجات</label>
                             <div id="invoice-items-container" class="space-y-4">
                                 <!-- صفوف بنود الفاتورة ستضاف هنا -->
                             </div>
                              <div class="flex gap-2 mt-4">
                                 <button type="button" id="add-invoice-item-btn" class="btn btn-primary self-start">إضافة منتج آخر</button>
                                 <button type="button" id="add-manual-invoice-item-btn" class="btn bg-green-600 text-white self-start">إضافة بند يدوي</button>
                             </div>
                         </div>
                         <div class="flex flex-col col-span-full">
                             <p class="text-lg font-bold">المجموع الكلي: <span id="invoice-total">0.00</span></p>
                         </div>
                         <div class="flex items-end col-span-full">
                             <button type="submit" class="btn btn-primary w-full">إنشاء الفاتورة</button>
                         </div>
                     </form>
                 </div>
                 <div class="data-table-container">
                     <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                         <h3 class="text-2xl font-semibold">قائمة الفواتير</h3>
                         <div class="flex flex-wrap gap-2">
                             <button class="btn btn-primary bg-red-600 hover:bg-red-700" onclick="exportToPdf('invoices-table-export', 'تقرير الفواتير', 'Invoices.pdf')"><i class="fas fa-file-pdf"></i> تصدير PDF</button>
                         </div>
                     </div>
                     <table class="data-table" id="invoices-table-export">
                         <thead>
                             <tr>
                                 <th>رقم الفاتورة</th>
                                 <th>التاريخ</th>
                                 <th>العميل</th>
                                 <th>المبلغ الإجمالي</th>
                                 <th class="no-export">الإجراءات</th>
                             </tr>
                         </thead>
                         <tbody id="invoices-table"></tbody>
                     </table>
                 </div>
            </div>

            <!-- تبويب التقارير -->
             <div id="reports" class="tab-pane hidden">
                 <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">التقارير المتقدمة</h2>
                 <div class="form-section no-print">
                     <h3 class="text-2xl font-semibold">تحديد فترة التقرير</h3>
                     <form id="reports-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end mt-4">
                         <div class="flex flex-col">
                             <label for="start-date" class="text-gray-600 mb-1">تاريخ البدء</label>
                             <input type="date" id="start-date" class="input" required>
                         </div>
                         <div class="flex flex-col">
                             <label for="end-date" class="text-gray-600 mb-1">تاريخ الانتهاء</label>
                             <input type="date" id="end-date" class="input" required>
                         </div>
                         <button type="submit" class="btn btn-primary w-full">عرض التقرير</button>
                     </form>
                 </div>
                 
                 <div id="report-results" class="hidden">
                    <div id="printable-content">
                        <!-- بداية رأس التقرير -->
                        <div class="p-6 bg-white rounded-lg shadow-md mb-6">
                             <div class="flex justify-between items-center pb-4 border-b border-gray-200">
                                 <div>
                                     <h3 class="text-2xl font-bold text-blue-600" id="report-company-name">اسم الشركة</h3>
                                     <p class="text-sm text-gray-500" id="report-company-address">عنوان الشركة</p>
                                 </div>
                                 <div class="text-right">
                                     <h4 class="text-xl font-bold" id="report-title">تقرير الأداء</h4>
                                     <p class="text-sm text-gray-500" id="report-date-range">للفترة من ... إلى ...</p>
                                 </div>
                             </div>
                             <div class="flex justify-end mt-4 gap-2 no-print">
                                 <button id="print-report-btn" class="btn btn-primary"><i class="fas fa-print"></i> طباعة</button>
                                 <button id="export-report-pdf-btn" class="btn bg-red-500 text-white"><i class="fas fa-file-pdf"></i> تصدير PDF</button>
                                 <button id="export-report-excel-btn" class="btn bg-green-500 text-white"><i class="fas fa-file-excel"></i> تصدير Excel</button>
                             </div>
                        </div>
                         <!-- نهاية رأس التقرير -->

                         <!-- بطاقات مؤشرات الأداء الرئيسية -->
                         <h4 class="text-xl font-semibold mb-4 text-gray-700">ملخص الأداء</h4>
                         <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <div class="report-kpi-card" style="border-color: #3b82f6;">
                                <div class="icon bg-blue-500"><i class="fas fa-dollar-sign"></i></div>
                                <div>
                                    <p class="text-sm text-gray-500">إجمالي المبيعات</p>
                                    <p class="text-2xl font-bold" id="report-sales">0</p>
                                </div>
                            </div>
                             <div class="report-kpi-card" style="border-color: #10b981;">
                                <div class="icon bg-green-500"><i class="fas fa-chart-line"></i></div>
                                <div>
                                    <p class="text-sm text-gray-500">الربح الصافي</p>
                                    <p class="text-2xl font-bold" id="report-profit">0</p>
                                </div>
                            </div>
                            <div class="report-kpi-card" style="border-color: #f59e0b;">
                                <div class="icon bg-yellow-500"><i class="fas fa-shopping-cart"></i></div>
                                <div>
                                    <p class="text-sm text-gray-500">إجمالي المشتريات</p>
                                    <p class="text-2xl font-bold" id="report-purchases">0</p>
                                </div>
                            </div>
                            <div class="report-kpi-card" style="border-color: #ef4444;">
                                <div class="icon bg-red-500"><i class="fas fa-wallet"></i></div>
                                <div>
                                    <p class="text-sm text-gray-500">إجمالي المصاريف</p>
                                    <p class="text-2xl font-bold" id="report-expenses">0</p>
                                </div>
                            </div>
                         </div>

                         <!-- الرسوم البيانية -->
                         <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                            <div class="dashboard-card">
                                 <h4 class="text-xl font-semibold mb-4">ملخص الأداء المالي</h4>
                                 <canvas id="performanceChart" style="max-height: 350px;"></canvas>
                             </div>
                             <div class="dashboard-card">
                                 <h4 class="text-xl font-semibold mb-4">توزيع المبيعات</h4>
                                 <canvas id="salesDistributionChart" style="max-height: 350px;"></canvas>
                             </div>
                         </div>
                         
                         <!-- الجداول التفصيلية -->
                         <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                             <div class="data-table-container">
                                 <h4 class="text-xl font-semibold mb-4 text-gray-700">المنتجات الأكثر مبيعاً</h4>
                                 <table class="data-table" id="top-products-table-export">
                                     <thead><tr><th>المنتج</th><th>الكمية المباعة</th><th>إجمالي الإيرادات</th></tr></thead>
                                     <tbody id="top-products-table"></tbody>
                                 </table>
                             </div>
                             <div class="data-table-container">
                                 <h4 class="text-xl font-semibold mb-4 text-gray-700">أفضل العملاء</h4>
                                 <table class="data-table" id="top-customers-table-export">
                                     <thead><tr><th>العميل</th><th>إجمالي المشتريات</th></tr></thead>
                                     <tbody id="top-customers-table"></tbody>
                                 </table>
                             </div>
                         </div>

                         <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
                            <div class="data-table-container">
                                <h4 class="text-xl font-semibold mb-4 text-gray-700">تقرير الرواتب</h4>
                                <table class="data-table" id="salaries-report-table-export">
                                    <thead><tr><th>الوصف</th><th>المبلغ الإجمالي</th></tr></thead>
                                    <tbody id="salaries-report-table"></tbody>
                                </table>
                            </div>
                            <div class="data-table-container">
                                <h4 class="text-xl font-semibold mb-4 text-gray-700">تنبيهات نفاد المخزون</h4>
                                <table class="data-table" id="low-stock-table-export">
                                    <thead><tr><th>المنتج</th><th>الكمية المتبقية</th></tr></thead>
                                    <tbody id="low-stock-table"></tbody>
                                </table>
                            </div>
                        </div>
                     </div>
                 </div>
            </div>

            <!-- تبويب الإعدادات -->
            <div id="settings" class="tab-pane hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">الإعدادات</h2>
                 <div class="settings-card">
                     <h3 class="text-2xl font-semibold mb-4 border-b pb-2">معلومات الشركة والإعدادات المالية</h3>
                     <form id="settings-form" class="space-y-4">
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                             <div>
                                 <label for="setting-company-name" class="block text-gray-700 font-semibold mb-1">اسم الشركة</label>
                                 <input type="text" id="setting-company-name" class="input">
                             </div>
                             <div>
                                 <label for="setting-company-phone" class="block text-gray-700 font-semibold mb-1">الهاتف</label>
                                 <input type="text" id="setting-company-phone" class="input">
                             </div>
                         </div>
                         <div>
                             <label for="setting-company-address" class="block text-gray-700 font-semibold mb-1">العنوان</label>
                             <input type="text" id="setting-company-address" class="input">
                         </div>
                          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                             <div>
                                 <label for="setting-currency" class="block text-gray-700 font-semibold mb-1">رمز العملة</label>
                                 <input type="text" id="setting-currency" class="input" placeholder="e.g., JOD, USD, SAR">
                             </div>
                             <div>
                                 <label for="setting-initial-fund" class="block text-gray-700 font-semibold mb-1">رأس مال الصندوق الأولي</label>
                                 <input type="number" step="0.01" id="setting-initial-fund" class="input">
                             </div>
                         </div>
                         <div class="text-left">
                             <button type="submit" class="btn btn-primary">حفظ الإعدادات</button>
                         </div>
                     </form>
                 </div>
            </div>


        </div>
    </div>

    <!-- Modals -->
    <div id="custom-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden flex items-center justify-center"></div>
    <div id="custom-alert" class="fixed z-50 p-6 rounded-lg shadow-lg bg-white max-w-sm w-full hidden transform -translate-x-1/2 -translate-y-1/2 top-1/2 left-1/2">
        <p id="alert-message" class="text-center text-lg font-semibold mb-4"></p>
        <div class="flex justify-center">
            <button id="alert-ok-btn" class="btn btn-primary w-1/2">حسناً</button>
        </div>
    </div>
    <div id="custom-confirm" class="fixed z-50 p-6 rounded-lg shadow-lg bg-white max-w-sm w-full hidden transform -translate-x-1/2 -translate-y-1/2 top-1/2 left-1/2">
        <p id="confirm-message" class="text-center text-lg font-semibold mb-6"></p>
        <div class="flex justify-center gap-4">
            <button id="confirm-ok-btn" class="btn btn-danger w-1/2">تأكيد</button>
            <button id="confirm-cancel-btn" class="btn bg-gray-200 hover:bg-gray-300 w-1/2">إلغاء</button>
        </div>
    </div>
    <div id="invoice-view-modal" class="fixed z-50 p-4 md:p-8 rounded-lg shadow-2xl bg-white max-w-4xl w-full hidden transform -translate-x-1/2 -translate-y-1/2 top-1/2 left-1/2">
        <div id="invoice-view-content"></div>
        <div class="flex justify-end gap-4 p-4 bg-gray-50 rounded-b-lg mt-4">
            <button id="invoice-print-btn" class="btn btn-primary"><i class="fas fa-print"></i> طباعة / حفظ PDF</button>
            <button id="invoice-close-btn" class="btn btn-danger bg-gray-500 hover:bg-gray-600">إغلاق</button>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Firebase Settings ---
        const firebaseConfig = {
            apiKey: "AIzaSyCTqQyFH8EOslPZiyPm89cM9CMrY2G88WA",
            authDomain: "aslantech.firebaseapp.com",
            projectId: "aslantech",
            storageBucket: "aslantech.firebasestorage.app",
            messagingSenderId: "305255252292",
            appId: "1:305255252292:web:4107992083514d8eef5711",
            measurementId: "G-JKDHFNB1B0"
        };
        
        // --- Initialize Firebase ---
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // --- Global Variables ---
        let appSettings = { currency: 'د.أ', initialFund: 0, companyName: 'شركتك', companyAddress: '', companyPhone: '' };
        let itemToEdit = null;
        let performanceChart = null;
        let salesDistributionChart = null;
        let currentInvoiceId = null;
        let currentUser = null;
        
        // --- User Feedback Functions ---
        const showMessage = (message) => {
            document.getElementById('alert-message').textContent = message;
            document.getElementById('custom-alert').classList.remove('hidden');
            document.getElementById('custom-overlay').classList.remove('hidden');
        };

        function showConfirm(message, onConfirm) {
            const confirmModal = document.getElementById('custom-confirm');
            const overlay = document.getElementById('custom-overlay');
            document.getElementById('confirm-message').textContent = message;
            confirmModal.classList.remove('hidden');
            overlay.classList.remove('hidden');
            const okBtn = document.getElementById('confirm-ok-btn');
            const cancelBtn = document.getElementById('confirm-cancel-btn'); 
            const confirmHandler = () => { onConfirm(); closeHandler(); };
            const closeHandler = () => {
                confirmModal.classList.add('hidden');
                overlay.classList.add('hidden');
                okBtn.removeEventListener('click', confirmHandler);
                cancelBtn.removeEventListener('click', closeHandler);
            };
            okBtn.addEventListener('click', confirmHandler);
            cancelBtn.addEventListener('click', closeHandler);
        }

        // --- Firebase Core Functions ---
        async function addOrUpdateItem(collection, data, id = null) {
            try {
                if (id) {
                    await db.collection(collection).doc(id).set(data, { merge: true });
                } else {
                    await db.collection(collection).add(data);
                }
                return true;
            } catch (e) {
                console.error("Add/Update error:", e);
                showMessage(`حدث خطأ أثناء إضافة/تحديث البيانات: ${e.message}`);
                return false;
            }
        }
        
        async function deleteItem(collection, id) {
             try {
                if (collection === 'sales') {
                    const saleDoc = await db.collection('sales').doc(id).get();
                    if (!saleDoc.exists) return;
                    const saleToDelete = saleDoc.data();
                    if (saleToDelete && saleToDelete.type === 'product' && saleToDelete.productId) {
                        const productRef = db.collection('products').doc(saleToDelete.productId);
                        await db.runTransaction(async (transaction) => {
                            const productDoc = await transaction.get(productRef);
                            if (productDoc.exists) {
                                const newQty = productDoc.data().qty + saleToDelete.qty;
                                transaction.update(productRef, { qty: newQty });
                            }
                        });
                    }
                } else if (collection === 'purchases') {
                     const purchaseDoc = await db.collection('purchases').doc(id).get();
                     if (!purchaseDoc.exists) return;
                     const purchaseToDelete = purchaseDoc.data();
                    if (purchaseToDelete && purchaseToDelete.type === 'product' && purchaseToDelete.productId) {
                         const productRef = db.collection('products').doc(purchaseToDelete.productId);
                        await db.runTransaction(async (transaction) => {
                            const productDoc = await transaction.get(productRef);
                            if (productDoc.exists) {
                                const newQty = productDoc.data().qty - purchaseToDelete.qty;
                                transaction.update(productRef, { qty: newQty });
                            }
                        });
                    }
                }
                await db.collection(collection).doc(id).delete();
                return true;
            } catch (e) {
                console.error("Delete error:", e);
                showMessage(`حدث خطأ أثناء حذف البيانات: ${e.message}`);
                return false;
            }
        }

        // --- UI and Tab Management ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabId).classList.remove('hidden');
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
        }

        function populateSelect(selectId, data, valueField, textField, displayTpl = null) {
            const select = document.getElementById(selectId);
            const currentValue = select.value;
            select.innerHTML = `<option value="">اختر</option>`;
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item[valueField];
                option.textContent = displayTpl ? displayTpl(item) : item[textField];
                select.appendChild(option);
            });
            select.value = currentValue;
        }
        
        // --- Data Refresh and Display Functions ---
        async function refreshProducts(searchTerm = '') {
            let query = db.collection('products').orderBy('name');
            if (searchTerm) {
                query = query.where('name', '>=', searchTerm).where('name', '<=', searchTerm + '\uf8ff');
            }
            const snapshot = await query.get();
            const products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const tableBody = document.getElementById('products-table');
            tableBody.innerHTML = '';
            let totalValue = 0, lowStockCount = 0, outOfStockCount = 0;
            products.forEach(p => {
                totalValue += p.cost * p.qty;
                if (p.qty <= 0) outOfStockCount++;
                else if (p.qty <= 10) lowStockCount++;
                const row = tableBody.insertRow();
                let qtyClass = p.qty <= 0 ? 'bg-red-100 text-red-700 font-bold' : (p.qty <= 10 ? 'bg-yellow-100 text-yellow-700' : '');
                row.innerHTML = `
                    <td class="no-export"><input type="checkbox" class="product-checkbox" data-id="${p.id}"></td>
                    <td class="whitespace-nowrap">${p.name}</td>
                    <td>${(p.cost || 0).toFixed(2)} ${appSettings.currency}</td>
                    <td class="${qtyClass} text-center">${p.qty}</td>
                    <td>${p.supplierName || 'غير محدد'}</td>
                    <td class="whitespace-nowrap no-export">
                        <button class="btn btn-edit text-sm edit-btn" data-id="${p.id}" data-category="product">تعديل</button>
                        <button class="btn btn-danger text-sm delete-btn" data-id="${p.id}" data-category="products">حذف</button>
                    </td>`;
            });
            document.getElementById('stats-total-products').textContent = products.length;
            document.getElementById('stats-stock-value').textContent = `${totalValue.toFixed(2)} ${appSettings.currency}`;
            document.getElementById('stats-low-stock').textContent = lowStockCount;
            document.getElementById('stats-out-of-stock').textContent = outOfStockCount;
            toggleDeleteSelectedButton();
            await populateProductSelects(); 
        }

        async function refreshSales() {
            const snapshot = await db.collection('sales').orderBy('date', 'desc').get();
            const sales = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const tableBody = document.getElementById('sales-table');
            tableBody.innerHTML = '';
            sales.forEach(s => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td class="whitespace-nowrap">${s.date}</td>
                    <td>${s.type === 'product' ? 'منتج' : 'خدمة'}</td>
                    <td class="whitespace-nowrap">${s.name}</td>
                    <td>${s.qty || 1}</td>
                    <td class="whitespace-nowrap">${s.customerName || 'غير محدد'}</td>
                    <td>${(s.amount || 0).toFixed(2)} ${appSettings.currency}</td>
                    <td class="whitespace-nowrap no-export">
                       <button class="btn btn-edit text-sm edit-btn" data-id="${s.id}" data-category="sale">تعديل</button>
                       <button class="btn btn-danger text-sm delete-btn" data-id="${s.id}" data-category="sales">حذف</button>
                    </td>`;
            });
        }
        
        async function refreshPurchases() {
            const snapshot = await db.collection('purchases').orderBy('date', 'desc').get();
            const purchases = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const tableBody = document.getElementById('purchases-table');
            tableBody.innerHTML = '';
            purchases.forEach(p => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td class="whitespace-nowrap">${p.date}</td>
                    <td class="whitespace-nowrap">${p.productName}</td>
                    <td>${p.qty}</td>
                    <td class="whitespace-nowrap">${p.supplierName || 'غير محدد'}</td>
                    <td>${(p.amount || 0).toFixed(2)} ${appSettings.currency}</td>
                    <td class="whitespace-nowrap no-export">
                        <button class="btn btn-edit text-sm edit-btn" data-id="${p.id}" data-category="purchase">تعديل</button>
                        <button class="btn btn-danger text-sm delete-btn" data-id="${p.id}" data-category="purchases">حذف</button>
                    </td>`;
            });
        }

        async function refreshExpenses() {
            const snapshot = await db.collection('expenses').orderBy('date', 'desc').get();
            const expenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const tableBody = document.getElementById('expenses-table');
            tableBody.innerHTML = '';
            expenses.forEach(e => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${e.date}</td>
                    <td>${e.type}</td>
                    <td>${(e.amount || 0).toFixed(2)} ${appSettings.currency}</td>
                    <td>${e.description || ''}</td>
                    <td class="whitespace-nowrap no-export">
                       <button class="btn btn-edit text-sm edit-btn" data-id="${e.id}" data-category="expense">تعديل</button>
                       <button class="btn btn-danger text-sm delete-btn" data-id="${e.id}" data-category="expenses">حذف</button>
                    </td>`;
            });
        }

        async function refreshCustomers() {
            const snapshot = await db.collection('customers').orderBy('name').get();
            const customers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const tableBody = document.getElementById('customers-table');
            tableBody.innerHTML = '';
            customers.forEach(c => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td class="whitespace-nowrap">${c.name}</td>
                    <td>${c.phone || ''}</td>
                    <td>${c.email || ''}</td>
                    <td>${c.address || ''}</td>
                    <td class="whitespace-nowrap no-export">
                       <button class="btn btn-edit text-sm edit-btn" data-id="${c.id}" data-category="customer">تعديل</button>
                       <button class="btn btn-danger text-sm delete-btn" data-id="${c.id}" data-category="customers">حذف</button>
                    </td>`;
            });
            populateSelect('s-customer', customers, 'id', 'name');
            populateSelect('i-customer', customers, 'id', 'name');
        }

        async function refreshSuppliers() {
            const snapshot = await db.collection('suppliers').orderBy('name').get();
            const suppliers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const tableBody = document.getElementById('suppliers-table');
            tableBody.innerHTML = '';
            suppliers.forEach(s => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td class="whitespace-nowrap">${s.name}</td>
                    <td>${s.phone || ''}</td>
                    <td>${s.email || ''}</td>
                    <td>${s.address || ''}</td>
                    <td class="whitespace-nowrap no-export">
                        <button class="btn btn-edit text-sm edit-btn" data-id="${s.id}" data-category="supplier">تعديل</button>
                        <button class="btn btn-danger text-sm delete-btn" data-id="${s.id}" data-category="suppliers">حذف</button>
                    </td>`;
            });
            populateSelect('p-supplier', suppliers, 'id', 'name');
            populateSelect('p-supplier-purchase', suppliers, 'id', 'name');
        }
        
        async function refreshInvoices() {
            const snapshot = await db.collection('invoices').orderBy('invoiceNumber', 'desc').get();
            const invoices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const tableBody = document.getElementById('invoices-table');
            tableBody.innerHTML = '';
            invoices.forEach(i => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${i.invoiceNumber}</td>
                    <td class="whitespace-nowrap">${i.date}</td>
                    <td class="whitespace-nowrap">${i.customerName}</td>
                    <td>${(i.totalAmount || 0).toFixed(2)} ${appSettings.currency}</td>
                    <td class="whitespace-nowrap no-export">
                       <button class="btn btn-primary text-sm view-invoice-btn" data-id="${i.id}">عرض</button>
                       <button class="btn btn-danger text-sm delete-btn" data-id="${i.id}" data-category="invoices">حذف</button>
                    </td>`;
            });
        }
        
        async function populateProductSelects() {
            const snapshot = await db.collection('products').orderBy('name').get();
            const products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const displayTpl = (p) => `${p.name} (المتاح: ${p.qty})`;
            
            document.querySelectorAll('#s-product, #p-product').forEach(select => {
                 populateSelect(select.id, products, 'id', 'name', displayTpl);
            });
            
            document.querySelectorAll('.i-product-select').forEach(select => {
                const selectedValue = select.value;
                select.innerHTML = `<option value="">اختر منتج</option>`;
                products.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = p.name;
                    select.appendChild(option);
                });
                select.value = selectedValue;
            });
        }

        async function refreshAllDataOnLogin() {
            await loadSettings();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dashboard-date').value = today;
            await updateDashboard(today);
            await Promise.all([
                refreshProducts(), refreshSales(), refreshPurchases(), refreshExpenses(), 
                refreshCustomers(), refreshSuppliers(), refreshInvoices()
            ]);
        }

        // --- Dashboard and Reports ---
        async function updateDashboard(date = null) {
            const targetDate = date || new Date().toISOString().split('T')[0];
            
            const salesSnapshot = await db.collection('sales').where('date', '==', targetDate).get();
            let totalSales = 0, profitFromSales = 0;
            salesSnapshot.forEach(doc => {
                const sale = doc.data();
                totalSales += sale.amount;
                profitFromSales += (sale.amount - (sale.cost * (sale.qty || 1) ));
            });

            const purchasesSnapshot = await db.collection('purchases').where('date', '==', targetDate).get();
            let totalPurchases = 0;
            purchasesSnapshot.forEach(doc => totalPurchases += doc.data().amount);
            
            const expensesSnapshot = await db.collection('expenses').where('date', '==', targetDate).get();
            let totalExpenses = 0;
            expensesSnapshot.forEach(doc => totalExpenses += doc.data().amount);
            
            const netProfit = profitFromSales - totalExpenses;

            const allSalesSnapshot = await db.collection('sales').get();
            let lifeSales = 0;
            allSalesSnapshot.forEach(doc => lifeSales += doc.data().amount);

            const allPurchasesSnapshot = await db.collection('purchases').get();
            let lifePurchases = 0;
            allPurchasesSnapshot.forEach(doc => lifePurchases += doc.data().amount);

            const allExpensesSnapshot = await db.collection('expenses').get();
            let lifeExpenses = 0;
            allExpensesSnapshot.forEach(doc => lifeExpenses += doc.data().amount);

            const remainingFund = (appSettings.initialFund || 0) + lifeSales - lifePurchases - lifeExpenses;

            document.getElementById('total-sales').textContent = `${totalSales.toFixed(2)} ${appSettings.currency}`;
            document.getElementById('total-purchases').textContent = `${totalPurchases.toFixed(2)} ${appSettings.currency}`;
            document.getElementById('total-expenses').textContent = `${totalExpenses.toFixed(2)} ${appSettings.currency}`;
            document.getElementById('net-profit').textContent = `${netProfit.toFixed(2)} ${appSettings.currency}`;
            document.getElementById('remaining-fund').textContent = `${remainingFund.toFixed(2)} ${appSettings.currency}`;
        }
        
        async function generateReport() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            if (!startDate || !endDate) {
                showMessage("الرجاء تحديد تاريخي البدء والانتهاء.");
                return;
            }
            
            document.getElementById('report-title').textContent = `تقرير الأداء`;
            document.getElementById('report-date-range').textContent = `للفترة من ${startDate} إلى ${endDate}`;
            document.getElementById('report-company-name').textContent = appSettings.companyName;
            document.getElementById('report-company-address').textContent = appSettings.companyAddress;

            const salesSnapshot = await db.collection('sales').where('date', '>=', startDate).where('date', '<=', endDate).get();
            const salesData = salesSnapshot.docs.map(doc => doc.data());
            const purchasesSnapshot = await db.collection('purchases').where('date', '>=', startDate).where('date', '<=', endDate).get();
            const purchasesData = purchasesSnapshot.docs.map(doc => doc.data());
            const expensesSnapshot = await db.collection('expenses').where('date', '>=', startDate).where('date', '<=', endDate).get();
            const expensesData = expensesSnapshot.docs.map(doc => doc.data());

            const reportSales = salesData.reduce((sum, s) => sum + s.amount, 0);
            const reportProfitFromSales = salesData.reduce((sum, s) => sum + (s.amount - (s.cost * (s.qty || 1))), 0);
            const reportPurchases = purchasesData.reduce((sum, p) => sum + p.amount, 0);
            const reportExpenses = expensesData.reduce((sum, e) => sum + e.amount, 0);
            const reportProfit = reportProfitFromSales - reportExpenses;

            document.getElementById('report-sales').textContent = `${reportSales.toFixed(2)} ${appSettings.currency}`;
            document.getElementById('report-purchases').textContent = `${reportPurchases.toFixed(2)} ${appSettings.currency}`;
            document.getElementById('report-expenses').textContent = `${reportExpenses.toFixed(2)} ${appSettings.currency}`;
            document.getElementById('report-profit').textContent = `${reportProfit.toFixed(2)} ${appSettings.currency}`;
            
            const productSales = {};
            salesData.filter(s => s.type === 'product').forEach(s => {
                if (!productSales[s.name]) productSales[s.name] = { totalQty: 0, totalRevenue: 0 };
                productSales[s.name].totalQty += s.qty;
                productSales[s.name].totalRevenue += s.amount;
            });
            const topProducts = Object.entries(productSales).sort((a, b) => b[1].totalRevenue - a[1].totalRevenue).slice(0, 5);
            document.getElementById('top-products-table').innerHTML = topProducts.length > 0 ? topProducts.map(([name, data]) => `<tr><td>${name}</td><td>${data.totalQty}</td><td>${data.totalRevenue.toFixed(2)} ${appSettings.currency}</td></tr>`).join('') : `<tr><td colspan="3" class="text-center">لا توجد بيانات</td></tr>`;
            
            if (performanceChart) performanceChart.destroy();
            performanceChart = new Chart(document.getElementById('performanceChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['إجمالي المبيعات', 'إجمالي المشتريات', 'إجمالي المصاريف', 'الربح الصافي'],
                    datasets: [{
                        label: `الأداء المالي بـ(${appSettings.currency})`,
                        data: [reportSales, reportPurchases, reportExpenses, reportProfit],
                        backgroundColor: ['#3b82f6', '#f59e0b', '#ef4444', '#10b981'],
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
            
            document.getElementById('report-results').classList.remove('hidden');
        }


        // --- Event Listeners and Form Handlers ---
        function setupEventListeners() {
            document.getElementById('nav-tabs').addEventListener('click', (e) => e.target.tagName === 'BUTTON' && switchTab(e.target.dataset.tab));
            document.getElementById('dashboard-date-form').addEventListener('submit', (e) => { e.preventDefault(); updateDashboard(document.getElementById('dashboard-date').value); });
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('add-product-form').addEventListener('submit', handleProductFormSubmit);
            document.getElementById('product-form-cancel-btn').addEventListener('click', () => resetForm('add-product-form'));
            document.getElementById('add-sale-form').addEventListener('submit', handleSaleFormSubmit);
            document.getElementById('sale-form-cancel-btn').addEventListener('click', () => resetForm('add-sale-form'));
            document.getElementById('add-purchase-form').addEventListener('submit', handlePurchaseFormSubmit);
            document.getElementById('purchase-form-cancel-btn').addEventListener('click', () => resetForm('add-purchase-form'));
            document.getElementById('add-expense-form').addEventListener('submit', handleExpenseFormSubmit);
            document.getElementById('expense-form-cancel-btn').addEventListener('click', () => resetForm('add-expense-form'));
            document.getElementById('add-customer-form').addEventListener('submit', handleCustomerFormSubmit);
            document.getElementById('customer-form-cancel-btn').addEventListener('click', () => resetForm('add-customer-form'));
            document.getElementById('add-supplier-form').addEventListener('submit', handleSupplierFormSubmit);
            document.getElementById('supplier-form-cancel-btn').addEventListener('click', () => resetForm('add-supplier-form'));
            document.getElementById('add-invoice-form').addEventListener('submit', handleInvoiceFormSubmit);
            document.getElementById('reports-form').addEventListener('submit', (e) => { e.preventDefault(); generateReport(); });
            document.getElementById('settings-form').addEventListener('submit', handleSettingsSave);
            document.getElementById('delete-selected-products-btn').addEventListener('click', handleDeleteSelectedProducts);
            document.getElementById('import-products-excel').addEventListener('change', importFromExcel);
            document.getElementById('product-search-input').addEventListener('input', (e) => refreshProducts(e.target.value));
            document.getElementById('select-all-products').addEventListener('change', (e) => {
                document.querySelectorAll('.product-checkbox').forEach(checkbox => checkbox.checked = e.target.checked);
                toggleDeleteSelectedButton();
            });
            document.getElementById('products-table').addEventListener('change', (e) => {
                if (e.target.classList.contains('product-checkbox')) toggleDeleteSelectedButton();
            });
             document.getElementById('alert-ok-btn').addEventListener('click', () => {
                document.getElementById('custom-alert').classList.add('hidden');
                document.getElementById('custom-overlay').classList.add('hidden');
            });
            document.getElementById('tab-content').addEventListener('click', handleTableActions);
            document.getElementById('s-type').addEventListener('change', toggleSaleFields);
            document.getElementById('p-type').addEventListener('change', togglePurchaseFields);
            document.getElementById('add-invoice-item-btn').addEventListener('click', () => addInvoiceItemRow(false));
            document.getElementById('add-manual-invoice-item-btn').addEventListener('click', () => addInvoiceItemRow(true));
            document.getElementById('invoice-items-container').addEventListener('change', updateInvoiceTotal);
            document.getElementById('invoice-close-btn').addEventListener('click', () => {
                document.getElementById('invoice-view-modal').classList.add('hidden');
                document.getElementById('custom-overlay').classList.add('hidden');
            });
            document.getElementById('invoice-print-btn').addEventListener('click', printInvoice);

            document.getElementById('print-report-btn').addEventListener('click', () => window.print());
            document.getElementById('export-report-pdf-btn').addEventListener('click', () => exportToPdf('printable-content', 'تقرير الأداء', 'PerformanceReport.pdf'));
            document.getElementById('export-report-excel-btn').addEventListener('click', exportReportToExcel);

        }
        
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorP = document.getElementById('login-error');
            errorP.classList.add('hidden');
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                console.error("Login failed:", error);
                const errorMessage = JSON.stringify(error.message) || '';
                if (errorMessage.includes("PERMISSION_DENIED") || errorMessage.includes("blocked")) {
                    const loginScreen = document.getElementById('login-screen');
                    loginScreen.innerHTML = `
                        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-2xl text-center">
                            <h2 class="text-3xl font-bold text-red-600 mb-4">خطأ في صلاحيات الربط (Referrer Blocked)</h2>
                            <p class="text-gray-700 mb-4">
                                هذا خطأ أمني. لقد تم حظر الطلب لأن رابط هذا الموقع غير مضاف إلى قائمة المواقع المسموح بها في إعدادات مفتاح الربط الخاص بك على Google Cloud.
                            </p>
                            <p class="text-gray-700 mb-2 font-semibold">لحل المشكلة، اتبع الخطوات التالية:</p>
                            <ol class="text-right list-decimal list-inside bg-gray-50 p-4 rounded-md space-y-2">
                                <li>اذهب إلى <a href="https://console.cloud.google.com/apis/credentials" target="_blank" class="text-blue-600 hover:underline">Google Cloud Console Credentials</a>.</li>
                                <li>اختر مشروعك (<code class="text-sm bg-gray-200 p-1 rounded">${firebaseConfig.projectId}</code>).</li>
                                <li>انقر على اسم مفتاح الربط (API Key) الذي تستخدمه.</li>
                                <li>تحت قسم "Website restrictions"، انقر على "ADD".</li>
                                <li>انسخ الرابط التالي بالكامل وألصقه:</li>
                            </ol>
                            <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 my-4 rounded-md text-sm break-all" dir="ltr">
                                <code>${window.location.origin}</code>
                            </div>
                            <p class="text-gray-600">ثم انقر على "Save" وانتظر دقيقة، ثم قم بتحديث هذه الصفحة.</p>
                        </div>`;
                } else {
                    errorP.textContent = "البريد الإلكتروني أو كلمة المرور غير صحيحة.";
                    errorP.classList.remove('hidden');
                }
            }
        }

        function handleLogout() { auth.signOut(); }

        async function handleTableActions(e) {
            const target = e.target.closest('button'); if (!target) return;
            const id = target.dataset.id;
            const category = target.dataset.category;
            if (target.classList.contains('view-invoice-btn')) { if (id) await viewInvoice(id); return; }
            if (!category) return;

            if (target.classList.contains('edit-btn')) {
                const doc = await db.collection(category + 's').doc(id).get();
                if (doc.exists) {
                    const item = { id: doc.id, ...doc.data()};
                    itemToEdit = { ...item, category };
                    const editFunctions = { product: prepareProductEdit, sale: prepareSaleEdit, purchase: preparePurchaseEdit, expense: prepareExpenseEdit, customer: prepareCustomerEdit, supplier: prepareSupplierEdit };
                    if (editFunctions[category]) {
                        editFunctions[category](item);
                        switchTab(category + 's');
                    }
                }
            } else if (target.classList.contains('delete-btn')) {
                showConfirm('هل أنت متأكد من الحذف؟', async () => {
                    if (await deleteItem(category, id)) {
                        const refreshMap = {
                            products: [refreshProducts], sales: [refreshSales, refreshProducts, updateDashboard], purchases: [refreshPurchases, refreshProducts, updateDashboard],
                            expenses: [refreshExpenses, updateDashboard], customers: [refreshCustomers, refreshSales, refreshInvoices], 
                            suppliers: [refreshSuppliers, refreshProducts, refreshPurchases], invoices: [refreshInvoices]
                        };
                         if (refreshMap[category]) {
                           for(const func of refreshMap[category]) await func();
                        }
                        showMessage("تم الحذف بنجاح.");
                    }
                });
            }
        }

        async function handleProductFormSubmit(e) {
            e.preventDefault();
            const supplierId = document.getElementById('p-supplier').value;
            let supplierName = 'غير محدد';
            if(supplierId){
                const supplierDoc = await db.collection('suppliers').doc(supplierId).get();
                if(supplierDoc.exists) supplierName = supplierDoc.data().name;
            }
            const data = { 
                name: document.getElementById('p-name').value, 
                cost: parseFloat(document.getElementById('p-cost').value), 
                qty: parseInt(document.getElementById('p-qty').value), 
                supplierId: supplierId || null,
                supplierName: supplierName
            };
            const id = document.getElementById('product-id').value;
            if (await addOrUpdateItem('products', data, id || null)) {
                resetForm('add-product-form');
                await refreshProducts(); 
                showMessage('تم حفظ المنتج بنجاح!');
            }
        }

        async function handleSaleFormSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('sale-id').value;
            const type = document.getElementById('s-type').value;

            if (id && itemToEdit?.category === 'sale' && itemToEdit.type === 'product' && itemToEdit.productId) {
                 await db.collection('products').doc(itemToEdit.productId).update({ qty: firebase.firestore.FieldValue.increment(itemToEdit.qty) });
            }
            
            const customerId = document.getElementById('s-customer').value;
            let customerName = 'غير محدد';
            if(customerId) {
                const customerDoc = await db.collection('customers').doc(customerId).get();
                if(customerDoc.exists) customerName = customerDoc.data().name;
            }

            const salePrice = parseFloat(document.getElementById('s-price').value);
            const saleCost = parseFloat(document.getElementById('s-cost').value) || 0;
            let saleName, saleQty, amount, productId = null;

            if (type === 'product') {
                productId = document.getElementById('s-product').value;
                saleQty = parseInt(document.getElementById('s-qty').value);
                const productRef = db.collection('products').doc(productId);
                const productDoc = await productRef.get();

                if (!productDoc.exists || productDoc.data().qty < saleQty) {
                    showMessage(!productDoc.exists ? 'المنتج المحدد غير موجود.' : `الكمية المتوفرة غير كافية. متاح: ${productDoc.data().qty}`);
                    if (id && itemToEdit?.category === 'sale' && itemToEdit.type === 'product' && itemToEdit.productId) {
                         await db.collection('products').doc(itemToEdit.productId).update({ qty: firebase.firestore.FieldValue.increment(-itemToEdit.qty) });
                    }
                    return; 
                }
                saleName = productDoc.data().name; amount = salePrice * saleQty;
                await productRef.update({ qty: firebase.firestore.FieldValue.increment(-saleQty) });

            } else { 
                saleName = document.getElementById('s-service-name').value; saleQty = 1; amount = salePrice;
            }

            const data = { date: document.getElementById('s-date').value, type, name: saleName, qty: saleQty, price: salePrice, cost: saleCost, customerId: customerId || null, customerName, amount, productId };
            if (await addOrUpdateItem('sales', data, id || null)) {
                resetForm('add-sale-form');
                await refreshSales();
                await refreshProducts();
                await updateDashboard();
                showMessage('تم تسجيل عملية البيع بنجاح!');
            }
        }
        
        async function handlePurchaseFormSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('purchase-id').value;
            const type = document.getElementById('p-type').value;

            if (id && itemToEdit?.category === 'purchase' && itemToEdit.type === 'product' && itemToEdit.productId) {
                await db.collection('products').doc(itemToEdit.productId).update({ qty: firebase.firestore.FieldValue.increment(-itemToEdit.qty) });
            }

            const supplierId = document.getElementById('p-supplier-purchase').value;
            let supplierName = 'غير محدد';
            if (supplierId) {
                const supplierDoc = await db.collection('suppliers').doc(supplierId).get();
                if (supplierDoc.exists) supplierName = supplierDoc.data().name;
            }

            const purchaseCost = parseFloat(document.getElementById('p-cost-input').value);
            const purchaseQty = parseInt(document.getElementById('p-qty-input').value);
            let productName, productId = null;
            
            if (type === 'product') {
                productId = document.getElementById('p-product').value;
                const productRef = db.collection('products').doc(productId);
                const productDoc = await productRef.get();
                if (!productDoc.exists) {
                    showMessage('المنتج المحدد غير موجود.');
                    if (id && itemToEdit?.category === 'purchase' && itemToEdit.type === 'product' && itemToEdit.productId) {
                       await db.collection('products').doc(itemToEdit.productId).update({ qty: firebase.firestore.FieldValue.increment(itemToEdit.qty) });
                    }
                    return;
                }
                productName = productDoc.data().name;
                await productRef.update({ qty: firebase.firestore.FieldValue.increment(purchaseQty) });
            } else {
                productName = document.getElementById('p-other-product-name').value;
            }

            const data = { date: document.getElementById('p-date').value, type, productName, qty: purchaseQty, cost: purchaseCost, supplierId: supplierId || null, supplierName, amount: purchaseCost * purchaseQty, productId };
            if (await addOrUpdateItem('purchases', data, id || null)) {
                resetForm('add-purchase-form');
                await refreshPurchases();
                await refreshProducts();
                await updateDashboard();
                showMessage('تم تسجيل عملية الشراء بنجاح!');
            }
        }

        async function handleExpenseFormSubmit(e) {
            e.preventDefault();
            const data = {
                date: document.getElementById('e-date').value,
                type: document.getElementById('e-type').value,
                amount: parseFloat(document.getElementById('e-amount').value),
                description: document.getElementById('e-desc').value
            };
            const id = document.getElementById('expense-id').value;
            if (await addOrUpdateItem('expenses', data, id || null)) {
                resetForm('add-expense-form');
                await refreshExpenses();
                await updateDashboard();
                showMessage('تم تسجيل المصروف بنجاح!');
            }
        }

        async function handleCustomerFormSubmit(e) {
            e.preventDefault();
            const data = {
                name: document.getElementById('c-name').value,
                phone: document.getElementById('c-phone').value,
                email: document.getElementById('c-email').value,
                address: document.getElementById('c-address').value
            };
            const id = document.getElementById('customer-id').value;
            if (await addOrUpdateItem('customers', data, id || null)) {
                resetForm('add-customer-form');
                await refreshCustomers();
                showMessage('تم حفظ العميل بنجاح!');
            }
        }
        
        async function handleSupplierFormSubmit(e) {
            e.preventDefault();
            const data = {
                name: document.getElementById('sup-name').value,
                phone: document.getElementById('sup-phone').value,
                email: document.getElementById('sup-email').value,
                address: document.getElementById('sup-address').value
            };
            const id = document.getElementById('supplier-id').value;
            if (await addOrUpdateItem('suppliers', data, id || null)) {
                resetForm('add-supplier-form');
                await refreshSuppliers();
                showMessage('تم حفظ المورد بنجاح!');
            }
        }
        
        async function handleInvoiceFormSubmit(e) {
            e.preventDefault();
            const customerId = document.getElementById('i-customer').value;
            const customerDoc = await db.collection('customers').doc(customerId).get();
            if (!customerDoc.exists) return showMessage('العميل المحدد غير موجود');
            
            const invoiceItems = [];
            document.querySelectorAll('.invoice-item-row').forEach(row => {
                const type = row.dataset.type;
                let item = { type };
                if (type === 'product') {
                    item.productId = row.querySelector('.i-product-select').value;
                    item.productName = row.querySelector('.i-product-select').options[row.querySelector('.i-product-select').selectedIndex].text;
                    item.qty = parseInt(row.querySelector('.i-qty').value);
                    item.price = parseFloat(row.querySelector('.i-price').value);
                } else {
                    item.productName = row.querySelector('.i-manual-name').value;
                    item.qty = 1;
                    item.price = parseFloat(row.querySelector('.i-manual-price').value);
                }
                item.total = item.qty * item.price;
                invoiceItems.push(item);
            });

            if (invoiceItems.some(item => !item.productName || !item.price || (item.type === 'product' && !item.qty) )) {
                 return showMessage('الرجاء تعبئة جميع الحقول في بنود الفاتورة.');
            }

            const totalAmount = invoiceItems.reduce((sum, item) => sum + item.total, 0);
            const settingsDoc = await db.collection('settings').doc('appConfig').get();
            const currentInvoiceNumber = (settingsDoc.data()?.lastInvoiceNumber || 0) + 1;

            const data = {
                invoiceNumber: currentInvoiceNumber,
                date: document.getElementById('i-date').value,
                customerId,
                customerName: customerDoc.data().name,
                customerDetails: customerDoc.data(),
                items: invoiceItems,
                totalAmount
            };

            if(await addOrUpdateItem('invoices', data)) {
                await db.collection('settings').doc('appConfig').set({ lastInvoiceNumber: currentInvoiceNumber }, { merge: true });
                resetForm('add-invoice-form');
                document.getElementById('invoice-items-container').innerHTML = '';
                addInvoiceItemRow(false);
                await refreshInvoices();
                showMessage(`تم إنشاء الفاتورة بنجاح برقم ${currentInvoiceNumber}.`);
            }
        }

        async function handleDeleteSelectedProducts() {
            const selectedIds = Array.from(document.querySelectorAll('.product-checkbox:checked')).map(cb => cb.dataset.id);
            if (selectedIds.length === 0) return;
            showConfirm(`هل أنت متأكد من حذف ${selectedIds.length} منتج(ات)؟`, async () => {
                const batch = db.batch();
                selectedIds.forEach(id => batch.delete(db.collection('products').doc(id)));
                await batch.commit();
                await refreshProducts(); 
                showMessage(`تم حذف ${selectedIds.length} منتج(ات) بنجاح.`);
            });
        }
        
        function resetForm(formId) {
             document.getElementById(formId)?.reset();
             const form = document.getElementById(formId);
             if(!form) return;
             const idField = form.querySelector('input[type="hidden"]');
             if(idField) idField.value = '';
             const category = formId.replace('add-', '').replace('-form', '');
             const title = document.getElementById(`${category}-form-title`);
             const submitBtn = document.getElementById(`${category}-form-submit-btn`);
             const cancelBtn = document.getElementById(`${category}-form-cancel-btn`);
             const originalTitles = { 'product': 'إضافة منتج جديد', 'sale': 'تسجيل عملية البيع', 'purchase': 'تسجيل شراء جديد', 'expense': 'تسجيل مصروف جديد', 'customer': 'إضافة عميل جديد', 'supplier': 'إضافة مورد جديد' };
             const originalButtons = { 'product': 'إضافة المنتج', 'sale': 'تسجيل عملية البيع', 'purchase': 'تسجيل الشراء', 'expense': 'تسجيل المصروف', 'customer': 'إضافة العميل', 'supplier': 'إضافة المورد' };
             if(title) title.textContent = originalTitles[category];
             if(submitBtn) submitBtn.textContent = originalButtons[category];
             if(cancelBtn) cancelBtn.classList.add('hidden');
             if(category === 'sale') toggleSaleFields();
             if(category === 'purchase') togglePurchaseFields();
             itemToEdit = null;
        }
        
        function prepareFormForEdit(category, item) {
             const title = document.getElementById(`${category}-form-title`);
             const submitBtn = document.getElementById(`${category}-form-submit-btn`);
             const cancelBtn = document.getElementById(`${category}-form-cancel-btn`);
             if(title) title.textContent = `تعديل ${title.textContent.replace('إضافة', '').replace('جديد', '')}`;
             if(submitBtn) submitBtn.textContent = 'حفظ التعديلات';
             if(cancelBtn) cancelBtn.classList.remove('hidden');
        }

        function prepareProductEdit(item) {
            prepareFormForEdit('product', item);
            document.getElementById('product-id').value = item.id;
            document.getElementById('p-name').value = item.name;
            document.getElementById('p-cost').value = item.cost;
            document.getElementById('p-qty').value = item.qty;
            document.getElementById('p-supplier').value = item.supplierId;
        }

        async function prepareSaleEdit(item) {
            prepareFormForEdit('sale', item);
            document.getElementById('sale-id').value = item.id;
            document.getElementById('s-date').value = item.date;
            document.getElementById('s-type').value = item.type;
            toggleSaleFields();
            if (item.type === 'product') {
                await populateProductSelects(); // Make sure the list is fresh
                document.getElementById('s-product').value = item.productId;
                document.getElementById('s-qty').value = item.qty;
            } else {
                document.getElementById('s-service-name').value = item.name;
            }
            document.getElementById('s-price').value = item.price;
            document.getElementById('s-cost').value = item.cost;
            document.getElementById('s-customer').value = item.customerId;
        }

        async function preparePurchaseEdit(item) {
            prepareFormForEdit('purchase', item);
            document.getElementById('purchase-id').value = item.id;
            document.getElementById('p-date').value = item.date;
            document.getElementById('p-type').value = item.type;
            togglePurchaseFields();
            if (item.type === 'product') {
                await populateProductSelects(); // Make sure the list is fresh
                document.getElementById('p-product').value = item.productId;
            } else {
                document.getElementById('p-other-product-name').value = item.productName;
            }
            document.getElementById('p-cost-input').value = item.cost;
            document.getElementById('p-qty-input').value = item.qty;
            document.getElementById('p-supplier-purchase').value = item.supplierId;
        }
        
        function prepareExpenseEdit(item) {
            prepareFormForEdit('expense', item);
            document.getElementById('expense-id').value = item.id;
            document.getElementById('e-date').value = item.date;
            document.getElementById('e-type').value = item.type;
            document.getElementById('e-amount').value = item.amount;
            document.getElementById('e-desc').value = item.description;
        }
        
        function prepareCustomerEdit(item) {
            prepareFormForEdit('customer', item);
            document.getElementById('customer-id').value = item.id;
            document.getElementById('c-name').value = item.name;
            document.getElementById('c-phone').value = item.phone;
            document.getElementById('c-email').value = item.email;
            document.getElementById('c-address').value = item.address;
        }

        function prepareSupplierEdit(item) {
            prepareFormForEdit('supplier', item);
            document.getElementById('supplier-id').value = item.id;
            document.getElementById('sup-name').value = item.name;
            document.getElementById('sup-phone').value = item.phone;
            document.getElementById('sup-email').value = item.email;
            document.getElementById('sup-address').value = item.address;
        }

        async function addInvoiceItemRow(isManual = false) {
             const container = document.getElementById('invoice-items-container');
             const row = document.createElement('div');
             row.className = 'grid grid-cols-12 gap-2 items-center invoice-item-row';
             row.dataset.type = isManual ? 'manual' : 'product';

            if (isManual) {
                row.innerHTML = `
                    <div class="col-span-6"><input type="text" class="input i-manual-name" placeholder="اسم البند اليدوي"></div>
                    <div class="col-span-4"><input type="number" step="0.01" class="input i-manual-price" placeholder="السعر"></div>
                    <div class="col-span-2"><button type="button" class="btn btn-danger w-full remove-invoice-item-btn"><i class="fas fa-trash"></i></button></div>
                `;
            } else {
                 row.innerHTML = `
                    <div class="col-span-5"><select class="select i-product-select"></select></div>
                    <div class="col-span-3"><input type="number" class="input i-qty" placeholder="الكمية" value="1"></div>
                    <div class="col-span-3"><input type="number" step="0.01" class="input i-price" placeholder="سعر البيع"></div>
                    <div class="col-span-1"><button type="button" class="btn btn-danger w-full remove-invoice-item-btn"><i class="fas fa-trash"></i></button></div>
                `;
            }
            container.appendChild(row);
            if (!isManual) await populateProductSelects();
            row.querySelector('.remove-invoice-item-btn').addEventListener('click', () => { row.remove(); updateInvoiceTotal(); });
        }
        
        function updateInvoiceTotal() {
            let total = 0;
            document.querySelectorAll('.invoice-item-row').forEach(row => {
                const type = row.dataset.type;
                if (type === 'product') {
                    const qty = parseInt(row.querySelector('.i-qty').value) || 0;
                    const price = parseFloat(row.querySelector('.i-price').value) || 0;
                    total += qty * price;
                } else {
                    const price = parseFloat(row.querySelector('.i-manual-price').value) || 0;
                    total += price;
                }
            });
            document.getElementById('invoice-total').textContent = `${total.toFixed(2)} ${appSettings.currency}`;
        }
        
        async function viewInvoice(invoiceId) {
             const doc = await db.collection('invoices').doc(invoiceId).get();
             if (!doc.exists) return showMessage('الفاتورة غير موجودة');
             const invoice = doc.data();
             currentInvoiceId = invoiceId;
             const contentEl = document.getElementById('invoice-view-content');
             contentEl.innerHTML = `
                <div id="printable-invoice">
                    <div class="p-8">
                        <div class="flex justify-between items-start mb-8">
                            <div>
                                <h2 class="text-3xl font-bold text-blue-600">${appSettings.companyName}</h2>
                                <p>${appSettings.companyAddress || ''}</p>
                                <p>${appSettings.companyPhone || ''}</p>
                            </div>
                            <div class="text-right">
                                <h3 class="text-2xl font-bold">فاتورة</h3>
                                <p>رقم: ${invoice.invoiceNumber}</p>
                                <p>التاريخ: ${invoice.date}</p>
                            </div>
                        </div>
                        <div class="mb-8 p-4 bg-gray-50 rounded-lg">
                            <h4 class="font-bold mb-2">فاتورة إلى:</h4>
                            <p>${invoice.customerName}</p>
                            <p>${invoice.customerDetails.address || ''}</p>
                            <p>${invoice.customerDetails.phone || ''}</p>
                        </div>
                        <table class="w-full text-right mb-8">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-2">البند</th>
                                    <th class="p-2">الكمية</th>
                                    <th class="p-2">السعر</th>
                                    <th class="p-2">الإجمالي</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${invoice.items.map(item => `
                                    <tr class="border-b">
                                        <td class="p-2">${item.productName}</td>
                                        <td class="p-2">${item.qty}</td>
                                        <td class="p-2">${item.price.toFixed(2)}</td>
                                        <td class="p-2">${(item.qty * item.price).toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div class="text-left">
                            <p class="text-xl font-bold">المجموع الكلي: ${invoice.totalAmount.toFixed(2)} ${appSettings.currency}</p>
                        </div>
                    </div>
                </div>
             `;
            document.getElementById('invoice-view-modal').classList.remove('hidden');
            document.getElementById('custom-overlay').classList.remove('hidden');
        }
        
        function printInvoice() {
            const printContent = document.getElementById('printable-invoice');
            if (printContent) {
                const originalContents = document.body.innerHTML;
                document.body.innerHTML = printContent.innerHTML;
                window.print();
                document.body.innerHTML = originalContents;
                // Re-initialize event listeners as they are lost
                main(); 
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                switchTab('invoices');
                document.getElementById('invoice-view-modal').classList.remove('hidden');
                document.getElementById('custom-overlay').classList.remove('hidden');
                viewInvoice(currentInvoiceId);
            }
        }
        
        function exportToExcel(tableId, sheetName, fileName) {
            const table = document.getElementById(tableId);
            if (!table) return showMessage('لم يتم العثور على جدول للتصدير.');
            const tableClone = table.cloneNode(true);
            Array.from(tableClone.querySelectorAll('.no-export')).forEach(el => el.remove());
            const wb = XLSX.utils.table_to_book(tableClone, { Sheet: sheetName });
            XLSX.writeFile(wb, fileName);
        }

         async function importFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                if (jsonData.length === 0) return showMessage("الملف فارغ أو غير صحيح.");
                
                showConfirm(`هل تريد استيراد ${jsonData.length} منتج؟ سيتم إضافتها إلى المخزون.`, async () => {
                    const batch = db.batch();
                    jsonData.forEach(item => {
                        const productRef = db.collection('products').doc();
                        const productData = {
                            name: item['الاسم'] || item['name'],
                            cost: parseFloat(item['سعر التكلفة'] || item['cost'] || 0),
                            qty: parseInt(item['الكمية'] || item['qty'] || 0),
                            supplierName: item['المورد'] || item['supplierName'] || 'مستورد'
                        };
                        if(productData.name) {
                            batch.set(productRef, productData);
                        }
                    });
                    await batch.commit();
                    await refreshProducts();
                    showMessage(`تم استيراد ${jsonData.length} منتج بنجاح.`);
                });
            };
            reader.readAsArrayBuffer(file);
            event.target.value = ''; // Reset input
        }

        function exportToPdf(elementId, title, fileName) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // To handle Arabic text, you need a font that supports it.
            // This is a complex topic in jsPDF. For simplicity, we'll use autoTable's font handling.
            const table = document.getElementById(elementId);
             if (table) {
                doc.autoTable({ html: `#${elementId}` });
                doc.save(fileName);
            } else {
                const element = document.getElementById(elementId);
                html2canvas(element).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const imgProps = pdf.getImageProperties(imgData);
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                    pdf.save(fileName);
                });
            }
        }
        
        function exportReportToExcel() {
            const wb = XLSX.utils.book_new();
            
            // Add summary data
            const summary = [
                ["المقياس", "القيمة"],
                ["إجمالي المبيعات", document.getElementById('report-sales').textContent],
                ["إجمالي المشتريات", document.getElementById('report-purchases').textContent],
                ["إجمالي المصاريف", document.getElementById('report-expenses').textContent],
                ["الربح الصافي", document.getElementById('report-profit').textContent],
            ];
            const wsSummary = XLSX.utils.aoa_to_sheet(summary);
            XLSX.utils.book_append_sheet(wb, wsSummary, "ملخص الأداء");
            
            // Add top products table
            const topProductsTable = document.getElementById('top-products-table-export');
            if (topProductsTable) {
                const wsTopProducts = XLSX.utils.table_to_sheet(topProductsTable);
                XLSX.utils.book_append_sheet(wb, wsTopProducts, "المنتجات الأكثر مبيعاً");
            }
            
            XLSX.writeFile(wb, "PerformanceReport.xlsx");
        }


        function toggleDeleteSelectedButton() {
            const selectedCount = document.querySelectorAll('.product-checkbox:checked').length;
            const btn = document.getElementById('delete-selected-products-btn');
            btn.disabled = selectedCount === 0;
            const textSpan = btn.querySelector('span');
            if (textSpan) textSpan.textContent = selectedCount > 0 ? `حذف المحدد (${selectedCount})` : 'حذف المحدد';
        }

        function toggleSaleFields() {
             const type = document.getElementById('s-type').value;
             document.getElementById('s-product-container').classList.toggle('hidden', type === 'service');
             document.getElementById('s-qty-container').classList.toggle('hidden', type === 'service');
             document.getElementById('s-service-container').classList.toggle('hidden', type === 'product');
        }

        function togglePurchaseFields() {
            const type = document.getElementById('p-type').value;
            document.getElementById('p-product-container').classList.toggle('hidden', type === 'other');
            document.getElementById('p-other-product-container').classList.toggle('hidden', type === 'product');
        }
        
        async function loadSettings() {
            const settingsDoc = await db.collection('settings').doc('appConfig').get();
            if (settingsDoc.exists) appSettings = { ...appSettings, ...settingsDoc.data() };
            document.getElementById('setting-company-name').value = appSettings.companyName;
            document.getElementById('setting-company-address').value = appSettings.companyAddress;
            document.getElementById('setting-company-phone').value = appSettings.companyPhone;
            document.getElementById('setting-currency').value = appSettings.currency;
            document.getElementById('setting-initial-fund').value = appSettings.initialFund;
            document.getElementById('header-company-name').textContent = appSettings.companyName || 'تطبيق إدارة الأعمال';
        }

        async function handleSettingsSave(e) {
            e.preventDefault();
            const settingsToSave = {
                companyName: document.getElementById('setting-company-name').value,
                companyAddress: document.getElementById('setting-company-address').value,
                companyPhone: document.getElementById('setting-company-phone').value,
                currency: document.getElementById('setting-currency').value,
                initialFund: parseFloat(document.getElementById('setting-initial-fund').value) || 0,
            };
            await db.collection('settings').doc('appConfig').set(settingsToSave, { merge: true });
            await loadSettings();
            showMessage("تم حفظ الإعدادات بنجاح.");
        }

        function main() {
            setupEventListeners();
            addInvoiceItemRow(false);
            const today = new Date().toISOString().split('T')[0];
            ['s-date', 'p-date', 'e-date', 'i-date', 'dashboard-date', 'start-date', 'end-date'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = today;
            });
            
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    document.getElementById('user-email').textContent = user.email;
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('app-container').classList.remove('hidden');
                    refreshAllDataOnLogin();
                    switchTab('dashboard');
                } else {
                    currentUser = null;
                    document.getElementById('login-screen').classList.remove('hidden');
                    document.getElementById('app-container').classList.add('hidden');
                    document.getElementById('login-form').reset();
                }
            });
        }
        
        main();
    });
    </script>
</body>
</html>

